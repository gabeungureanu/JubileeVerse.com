<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Jubilee: Project Manager - JubileeVerse Admin">
  <title>Tasks - Admin - JubileeVerse</title>
  <link rel="icon" type="image/png" href="/images/personas/jubilee.png">
  <link rel="apple-touch-icon" href="/images/personas/jubilee.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin-header.css">
  <link rel="stylesheet" href="/css/admin-sidebar.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #0a0a0a;
      color: #f2f2f2;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: #444 #1a1a1a;
    }

    .app-container {
      display: flex;
      height: calc(100vh - 36px);
      width: 100vw;
      margin-top: 36px;
      overflow-x: hidden;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding-top: 0;
    }

    /* ==================== VELOCITY DASHBOARD - THREE PANEL LAYOUT ==================== */
    .velocity-dashboard {
      display: flex;
      gap: 16px;
      margin: 0;
      flex: 1;
      align-items: stretch;
      justify-content: center;
      background: linear-gradient(180deg, rgba(10,10,10,0.95) 0%, rgba(5,5,5,0.98) 100%);
      border-radius: 16px;
      padding: 16px;
      box-shadow:
        0 0 80px rgba(0, 0, 0, 0.8),
        inset 0 1px 0 rgba(255,255,255,0.02),
        inset 0 -1px 0 rgba(0,0,0,0.5);
      border: 1px solid rgba(60, 60, 60, 0.3);
      position: relative;
    }

    /* Ambient dashboard glow overlay */
    .velocity-dashboard::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 22px;
      background: linear-gradient(135deg,
        rgba(255, 189, 89, 0.03) 0%,
        transparent 50%,
        rgba(34, 197, 94, 0.02) 100%);
      pointer-events: none;
      animation: ambientPulse 6s ease-in-out infinite;
    }

    @keyframes ambientPulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* Dashboard Glow Animation */
    @keyframes dashboardGlow {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    @keyframes subtleFlicker {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.05); }
    }

    @keyframes needleGlow {
      0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 189, 89, 0.5)); }
      50% { filter: drop-shadow(0 0 15px rgba(255, 189, 89, 0.8)); }
    }

    @keyframes textGlow {
      0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.5), 0 0 16px rgba(255, 255, 255, 0.2); }
      50% { text-shadow: 0 0 16px rgba(255, 255, 255, 0.8), 0 0 32px rgba(255, 255, 255, 0.4), 0 0 48px rgba(255, 255, 255, 0.2); }
    }

    @keyframes successGlow {
      0%, 100% { text-shadow: 0 0 10px rgba(34, 197, 94, 0.6), 0 0 20px rgba(34, 197, 94, 0.3); }
      50% { text-shadow: 0 0 20px rgba(34, 197, 94, 1), 0 0 40px rgba(34, 197, 94, 0.5), 0 0 60px rgba(34, 197, 94, 0.3); }
    }

    @keyframes cautionGlow {
      0%, 100% { text-shadow: 0 0 10px rgba(249, 115, 22, 0.6), 0 0 20px rgba(249, 115, 22, 0.3); }
      50% { text-shadow: 0 0 20px rgba(249, 115, 22, 1), 0 0 40px rgba(249, 115, 22, 0.5), 0 0 60px rgba(249, 115, 22, 0.3); }
    }

    @keyframes goldGlow {
      0%, 100% { text-shadow: 0 0 15px rgba(255, 189, 89, 0.6), 0 0 30px rgba(255, 189, 89, 0.3); }
      50% { text-shadow: 0 0 25px rgba(255, 189, 89, 1), 0 0 50px rgba(255, 189, 89, 0.5), 0 0 75px rgba(255, 189, 89, 0.3); }
    }

    @keyframes whiteGlow {
      0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 16px rgba(255, 255, 255, 0.3); }
      50% { text-shadow: 0 0 16px rgba(255, 255, 255, 0.9), 0 0 32px rgba(255, 255, 255, 0.5), 0 0 48px rgba(255, 255, 255, 0.2); }
    }

    @keyframes borderGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.1), inset 0 0 10px rgba(255, 255, 255, 0.05); }
      50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.2), inset 0 0 15px rgba(255, 255, 255, 0.1); }
    }

    /* ==================== PAGE LOAD REVEAL ANIMATION ==================== */
    /* Initial state: reveal lines centered, content hidden */
    .velocity-dashboard.intro-state {
      overflow: visible;
    }

    .velocity-dashboard.intro-state .velocity-side-panel,
    .velocity-dashboard.intro-state .speedometer-panel {
      opacity: 0;
      visibility: hidden;
    }

    /* The reveal lines - positioned absolutely over the dashboard */
    .reveal-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 10px;
      z-index: 100;
      pointer-events: none;
      transition: transform 1.35s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s ease-out;
    }

    .reveal-line-left {
      background: linear-gradient(180deg,
        rgba(249, 115, 22, 0.3) 0%,
        rgba(249, 115, 22, 1) 20%,
        rgba(249, 115, 22, 1) 80%,
        rgba(249, 115, 22, 0.3) 100%);
      box-shadow: 0 0 25px rgba(249, 115, 22, 0.8), 0 0 50px rgba(249, 115, 22, 0.4);
      left: 50%;
      transform: translateX(-15px);
      opacity: 1;
    }

    .reveal-line-right {
      background: linear-gradient(180deg,
        rgba(34, 197, 94, 0.3) 0%,
        rgba(34, 197, 94, 1) 20%,
        rgba(34, 197, 94, 1) 80%,
        rgba(34, 197, 94, 0.3) 100%);
      box-shadow: 0 0 25px rgba(34, 197, 94, 0.8), 0 0 50px rgba(34, 197, 94, 0.4);
      left: 50%;
      transform: translateX(5px);
      opacity: 1;
    }

    /* Animated state: lines slide outward */
    .velocity-dashboard.intro-animating .reveal-line-left {
      transform: translateX(calc(-50vw + 120px));
    }

    .velocity-dashboard.intro-animating .reveal-line-right {
      transform: translateX(calc(50vw - 120px));
    }

    /* Content fade-in during animation - slower and smoother */
    .velocity-dashboard.intro-animating .velocity-side-panel,
    .velocity-dashboard.intro-animating .speedometer-panel {
      opacity: 1;
      visibility: visible;
      transition: opacity 1.05s ease-out 0.45s, visibility 0s 0.45s;
    }

    /* Final state: lines stay at final position and fade out smoothly */
    .velocity-dashboard.intro-complete .reveal-line-left {
      transform: translateX(calc(-50vw + 120px));
      opacity: 0;
      transition: opacity 0.6s ease-out;
    }

    .velocity-dashboard.intro-complete .reveal-line-right {
      transform: translateX(calc(50vw - 120px));
      opacity: 0;
      transition: opacity 0.6s ease-out;
    }

    .velocity-dashboard.intro-complete .velocity-side-panel,
    .velocity-dashboard.intro-complete .speedometer-panel {
      opacity: 1;
      visibility: visible;
      transition: none;
    }

    /* Subtle scale-up effect for panels during reveal */
    .velocity-dashboard.intro-state .velocity-side-panel {
      transform: scale(0.95);
    }

    .velocity-dashboard.intro-animating .velocity-side-panel {
      transform: scale(1);
      transition: opacity 1.05s ease-out 0.45s, visibility 0s 0.45s, transform 1.2s cubic-bezier(0.16, 1, 0.3, 1) 0.3s;
    }

    .velocity-dashboard.intro-complete .velocity-side-panel {
      transform: scale(1);
      transition: none;
    }

    .dashboard-text-glow {
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      animation: whiteGlow 3s ease-in-out infinite;
    }

    .dashboard-glow {
      color: #fff;
      animation: goldGlow 3s ease-in-out infinite;
    }

    .dashboard-glow-subtle {
      color: #fff;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.5);
    }

    .success-glow {
      color: #fff;
      animation: successGlow 3.5s ease-in-out infinite;
    }

    .caution-glow {
      color: #fff;
      animation: cautionGlow 3.5s ease-in-out infinite;
    }

    .text-success {
      color: #4ade80;
      text-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
    }

    /* Success and caution indicators */
    .success-indicator {
      border-left: 2px solid rgba(34, 197, 94, 0.5);
      padding-left: 8px;
      margin-left: 0;
    }

    .caution-indicator {
      border-left: 2px solid rgba(249, 115, 22, 0.5);
      padding-left: 8px;
      margin-left: 0;
    }

    .success-total {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, transparent 100%);
      border-color: rgba(34, 197, 94, 0.4);
      position: relative;
      top: -40px;
    }

    .caution-total {
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.15) 0%, transparent 100%);
      border-color: rgba(249, 115, 22, 0.4);
      position: relative;
      top: -40px;
    }

    /* Side Panels (Left: Pending, Right: Completed) */
    .velocity-side-panel {
      background: linear-gradient(180deg, #151515 0%, #0a0a0a 100%);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 12px;
      min-width: 218px;
      max-width: 266px;
      flex: 1;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    /* Subtle edge glow for side panels */
    .velocity-side-panel::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      pointer-events: none;
      animation: panelEdgeGlow 4s ease-in-out infinite;
    }

    @keyframes panelEdgeGlow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.7; }
    }

    .velocity-side-panel.left-panel {
      border-left: 3px solid #f97316;
      box-shadow:
        -5px 0 30px rgba(249, 115, 22, 0.25),
        inset 3px 0 20px rgba(249, 115, 22, 0.1);
      animation: leftPanelGlow 4s ease-in-out infinite;
    }

    @keyframes leftPanelGlow {
      0%, 100% { box-shadow: -5px 0 30px rgba(249, 115, 22, 0.25), inset 3px 0 20px rgba(249, 115, 22, 0.1); }
      50% { box-shadow: -8px 0 40px rgba(249, 115, 22, 0.4), inset 5px 0 30px rgba(249, 115, 22, 0.15); }
    }

    .velocity-side-panel.left-panel::after {
      left: 0;
      background: linear-gradient(180deg, transparent, #f97316, transparent);
    }

    .velocity-side-panel.right-panel {
      border-right: 3px solid #22c55e;
      box-shadow:
        5px 0 30px rgba(34, 197, 94, 0.25),
        inset -3px 0 20px rgba(34, 197, 94, 0.1);
      animation: rightPanelGlow 4s ease-in-out infinite;
    }

    @keyframes rightPanelGlow {
      0%, 100% { box-shadow: 5px 0 30px rgba(34, 197, 94, 0.25), inset -3px 0 20px rgba(34, 197, 94, 0.1); }
      50% { box-shadow: 8px 0 40px rgba(34, 197, 94, 0.4), inset -5px 0 30px rgba(34, 197, 94, 0.15); }
    }

    .velocity-side-panel.right-panel::after {
      right: 0;
      background: linear-gradient(180deg, transparent, #22c55e, transparent);
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #222;
    }

    .panel-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .panel-icon svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .left-panel .panel-icon {
      background: rgba(249, 115, 22, 0.15);
      color: #f97316;
    }

    .right-panel .panel-icon {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .panel-title {
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.6), 0 0 24px rgba(255, 255, 255, 0.3);
      animation: whiteGlow 4s ease-in-out infinite;
    }

    .panel-week-label {
      font-size: 9px;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      margin-left: auto;
    }

    .panel-stats {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    /* Compact stats for Progress Made panel */
    .panel-stats.compact-stats {
      gap: 5px;
    }

    .panel-stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      animation: borderGlow 5s ease-in-out infinite;
    }

    /* Compact stat items for Progress Made */
    .compact-stats .panel-stat-item {
      padding: 6px 10px;
    }

    .panel-stat-label {
      font-size: 11px;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
    }

    /* Reduced font size for compact stats */
    .compact-stats .panel-stat-label {
      font-size: 9px;
    }

    .panel-stat-value {
      font-size: 16px;
      font-weight: 700;
      font-family: 'Monaco', 'Menlo', monospace;
      color: #fff;
    }

    /* Reduced font size for compact stats */
    .compact-stats .panel-stat-value {
      font-size: 14px;
    }

    .left-panel .panel-stat-value {
      color: #fff;
      text-shadow: 0 0 12px rgba(249, 115, 22, 0.8), 0 0 24px rgba(249, 115, 22, 0.4);
      animation: cautionGlow 3s ease-in-out infinite;
    }

    .right-panel .panel-stat-value {
      color: #fff;
      text-shadow: 0 0 12px rgba(34, 197, 94, 0.8), 0 0 24px rgba(34, 197, 94, 0.4);
      animation: successGlow 3s ease-in-out infinite;
    }

    .panel-total {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid #333;
      text-align: center;
    }

    .panel-total-value {
      font-size: 32px;
      font-weight: 700;
      font-family: 'Monaco', 'Menlo', monospace;
      color: #fff;
    }

    .left-panel .panel-total-value {
      color: #fff;
      text-shadow: 0 0 20px rgba(249, 115, 22, 1), 0 0 40px rgba(249, 115, 22, 0.5), 0 0 60px rgba(249, 115, 22, 0.3);
      animation: cautionGlow 3s ease-in-out infinite;
    }

    .right-panel .panel-total-value {
      color: #fff;
      text-shadow: 0 0 20px rgba(34, 197, 94, 1), 0 0 40px rgba(34, 197, 94, 0.5), 0 0 60px rgba(34, 197, 94, 0.3);
      animation: successGlow 3s ease-in-out infinite;
    }

    .panel-total-label {
      font-size: 10px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: -3px;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
    }

    .panel-fuel-context {
      font-size: 12px;
      color: #f97316;
      font-weight: 600;
      margin-top: 4px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      text-shadow: 0 0 12px rgba(249, 115, 22, 0.8), 0 0 24px rgba(249, 115, 22, 0.4);
    }

    /* Value Delivered - reduced font and moved down 10px */
    .panel-value-delivered {
      font-size: 22px !important;
      margin-top: 10px;
    }

    /* Value Pending - match Value Delivered styling */
    .panel-value-pending {
      font-size: 22px !important;
      margin-top: 10px;
    }

    /* Actual Cost styling - bold green to emphasize real expenditure */
    .panel-actual-cost {
      font-size: 12px;
      color: #22c55e;
      font-weight: 600;
      margin-top: 4px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      text-shadow: 0 0 12px rgba(34, 197, 94, 0.8), 0 0 24px rgba(34, 197, 94, 0.4);
    }

    /* Center Speedometer Panel */
    .speedometer-panel {
      background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
      border: 1px solid #444;
      border-radius: 14px;
      padding: 14px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 360px;
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.6), 0 0 30px rgba(255, 189, 89, 0.1), inset 0 1px 0 rgba(255,255,255,0.1);
      animation: borderGlow 6s ease-in-out infinite;
    }

    .speedometer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 8px;
    }

    .speedometer-title {
      font-size: 10px;
      font-weight: 600;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.7), 0 0 24px rgba(255, 255, 255, 0.4);
      animation: whiteGlow 4s ease-in-out infinite;
    }

    .speedometer-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 189, 89, 0.15);
      border: 1px solid rgba(255, 189, 89, 0.4);
      border-radius: 12px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      font-family: 'Monaco', 'Menlo', monospace;
      text-shadow: 0 0 15px rgba(255, 189, 89, 0.8), 0 0 30px rgba(255, 189, 89, 0.4);
      animation: goldGlow 3s ease-in-out infinite;
      transition: all 0.2s ease;
    }

    .speedometer-badge.clickable {
      cursor: pointer;
    }

    .speedometer-badge.clickable:hover {
      background: rgba(255, 189, 89, 0.25);
      border-color: rgba(255, 189, 89, 0.6);
      transform: scale(1.02);
    }

    .speedometer-badge.refreshing {
      animation: pulseRefresh 0.8s ease-in-out infinite;
      color: #fbbf24;
    }

    /* Background Process Health Indicator */
    .health-indicator-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .health-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: relative;
      cursor: help;
      transition: background-color 0.3s ease;
    }

    .health-indicator.healthy {
      background-color: #ffd700;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
      animation: heartbeatColor 1.8s ease-in-out infinite;
    }

    .health-indicator.healthy::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: rgba(255, 165, 0, 0.3);
      animation: heartbeatGlow 1.8s ease-in-out infinite;
    }

    @keyframes heartbeatColor {
      0%, 100% {
        background-color: #ffd700;
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
        transform: scale(1);
      }
      15% {
        background-color: #ff8c00;
        box-shadow: 0 0 12px rgba(255, 140, 0, 0.9);
        transform: scale(1.15);
      }
      30% {
        background-color: #ffd700;
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        transform: scale(1);
      }
      45% {
        background-color: #ff8c00;
        box-shadow: 0 0 10px rgba(255, 140, 0, 0.7);
        transform: scale(1.1);
      }
      60%, 100% {
        background-color: #ffd700;
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
        transform: scale(1);
      }
    }

    @keyframes heartbeatGlow {
      0%, 100% {
        transform: scale(1);
        opacity: 0.3;
      }
      15% {
        transform: scale(1.5);
        opacity: 0.6;
      }
      30% {
        transform: scale(1);
        opacity: 0.3;
      }
      45% {
        transform: scale(1.3);
        opacity: 0.5;
      }
      60%, 100% {
        transform: scale(1);
        opacity: 0.3;
      }
    }

    .health-indicator.error {
      background-color: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    }

    .health-indicator.error::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.3);
      animation: none;
    }

    .health-indicator.unknown {
      background-color: #6b7280;
      box-shadow: 0 0 4px rgba(107, 114, 128, 0.4);
    }

    .health-indicator.unknown::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: rgba(107, 114, 128, 0.2);
      animation: healthPulse 3s ease-in-out infinite;
    }

    @keyframes healthPulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.8;
      }
      50% {
        transform: scale(1.4);
        opacity: 0.3;
      }
    }

    /* Health indicator tooltip */
    .health-indicator-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      margin-bottom: 8px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .health-indicator-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
    }

    .health-indicator-wrapper:hover .health-indicator-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .health-indicator-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    @keyframes pulseRefresh {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .speedometer-wrapper {
      position: relative;
      width: 340px;
      height: 260px;
      filter: drop-shadow(0 0 20px rgba(255, 189, 89, 0.3));
      animation: gaugeGlow 5s ease-in-out infinite;
      background: transparent;
    }

    @keyframes gaugeGlow {
      0%, 100% { filter: drop-shadow(0 0 20px rgba(255, 189, 89, 0.3)); }
      50% { filter: drop-shadow(0 0 35px rgba(255, 189, 89, 0.5)); }
    }

    .speedometer-canvas {
      display: block;
    }

    .speedometer-value-display {
      position: absolute;
      bottom: 27px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 10;
      background: transparent;
    }

    .speedometer-value {
      font-size: 40px;
      font-weight: 700;
      color: #fff;
      font-family: 'Monaco', 'Menlo', monospace;
      line-height: 1;
      text-shadow: 0 0 30px rgba(255, 189, 89, 1), 0 0 60px rgba(255, 189, 89, 0.6), 0 0 90px rgba(255, 189, 89, 0.3);
      animation: goldGlow 3s ease-in-out infinite;
      display: inline-block;
      position: relative;
      background: transparent;
    }

    .speedometer-wph-label {
      position: absolute;
      top: 12px;
      right: -27px;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(255, 189, 89, 0.8), 0 0 20px rgba(255, 189, 89, 0.4);
      animation: goldGlow 3s ease-in-out infinite;
    }

    .speedometer-unit {
      font-size: 11px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 4px;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.6), 0 0 24px rgba(255, 255, 255, 0.3);
      animation: whiteGlow 4s ease-in-out infinite;
    }

    .speedometer-description {
      text-align: center;
      margin-top: 18px;
      width: 100%;
      background: transparent;
    }

    .speedometer-desc-text {
      font-size: 10px;
      color: #fff;
      line-height: 1.4;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      background: transparent;
      text-transform: uppercase;
    }

    .speedometer-desc-text strong {
      color: #fff;
      text-shadow: 0 0 12px rgba(255, 189, 89, 0.8), 0 0 24px rgba(255, 189, 89, 0.4);
    }

    /* Mini Gauges Container - Row of 4 gauges */
    .mini-gauges-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 6px;
      margin: 10px auto 0;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(30, 30, 30, 0.6) 0%, rgba(20, 20, 20, 0.8) 100%);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* Individual Mini Gauge - 10% smaller (101x77 from 112x85) */
    .mini-gauge {
      position: relative;
      width: 101px;
      height: 77px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .mini-gauge-wrapper {
      position: relative;
      width: 68px;
      height: 68px;
    }

    .mini-gauge-canvas {
      display: block;
    }

    .mini-gauge-icon {
      position: absolute;
      top: calc(50% + 20px);
      left: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
    }

    .mini-gauge-icon svg {
      width: 100%;
      height: 100%;
      fill: #fff;
      filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
    }

    /* Gauge type-specific icon colors */
    .mini-gauge.fuel .mini-gauge-icon svg { fill: #ef4444; filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.6)); }
    .mini-gauge.temp .mini-gauge-icon svg { fill: #3b82f6; filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.6)); }
    .mini-gauge.oil .mini-gauge-icon svg { fill: #f59e0b; filter: drop-shadow(0 0 6px rgba(245, 158, 11, 0.6)); }
    .mini-gauge.rpm .mini-gauge-icon svg { fill: #ef4444; filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.6)); }

    .mini-gauge-labels {
      display: none;
    }

    .mini-gauge-label {
      font-size: 8px;
      font-weight: 700;
      font-family: 'Monaco', 'Menlo', monospace;
      color: rgba(255, 255, 255, 0.7);
    }

    .mini-gauge-label.low {
      text-shadow: 0 0 8px rgba(239, 68, 68, 0.7);
    }

    .mini-gauge-label.high {
      text-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .mini-gauge-title {
      font-size: 9px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 2px;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }

    .mini-gauge-value {
      font-size: 9px;
      font-weight: 600;
      color: #fff;
      font-family: 'Monaco', 'Menlo', monospace;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    /* Gauge glow animations by type */
    .mini-gauge.fuel .mini-gauge-wrapper { filter: drop-shadow(0 0 10px rgba(34, 197, 94, 0.2)); }
    .mini-gauge.temp .mini-gauge-wrapper { filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.2)); }
    .mini-gauge.oil .mini-gauge-wrapper { filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.2)); }
    .mini-gauge.rpm .mini-gauge-wrapper { filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.2)); }

    /* Gas Gauge Section (legacy bar gauge) */
    .gas-gauge-section {
      width: 100%;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #333;
    }

    .gas-gauge-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .gas-gauge-label {
      font-size: 9px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    .gas-gauge-value {
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      font-family: 'Monaco', 'Menlo', monospace;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
      animation: whiteGlow 4s ease-in-out infinite;
    }

    .gas-gauge-container {
      position: relative;
      height: 24px;
      background: #111;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #333;
    }

    .gas-gauge-fill {
      height: 100%;
      border-radius: 11px;
      transition: width 0.5s ease, background 0.3s ease;
      background: linear-gradient(90deg, #ef4444 0%, #f97316 30%, #22c55e 100%);
    }

    .gas-gauge-fill.low {
      background: linear-gradient(90deg, #ef4444 0%, #f97316 100%);
    }

    .gas-gauge-fill.empty {
      background: #ef4444;
    }

    .gas-gauge-markers {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 8px;
      align-items: center;
      pointer-events: none;
    }

    .gas-gauge-marker {
      font-size: 8px;
      color: rgba(255, 255, 255, 0.5);
      font-weight: 600;
    }

    .gas-gauge-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
    }

    /* Financial Summary Row */
    .financial-summary {
      display: flex;
      gap: 12px;
      width: 100%;
      margin-top: 12px;
    }

    .financial-item {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }

    .financial-value {
      font-size: 18px;
      font-weight: 700;
      font-family: 'Monaco', 'Menlo', monospace;
      color: #fff;
    }

    .financial-value.earned {
      color: #fff;
      text-shadow: 0 0 12px rgba(34, 197, 94, 0.9), 0 0 24px rgba(34, 197, 94, 0.5), 0 0 36px rgba(34, 197, 94, 0.3);
      animation: successGlow 3s ease-in-out infinite;
    }

    .financial-value.delivered {
      color: #fff;
      text-shadow: 0 0 12px rgba(255, 189, 89, 0.9), 0 0 24px rgba(255, 189, 89, 0.5), 0 0 36px rgba(255, 189, 89, 0.3);
      animation: goldGlow 3s ease-in-out infinite;
    }

    .financial-label {
      font-size: 9px;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 2px;
    }

    /* Panel earned value in Progress Made panel */
    .panel-earned-value {
      font-size: 12px;
      font-weight: 600;
      color: #22c55e;
      text-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Milestone dates container - single line layout */
    .milestone-dates-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      margin-top: 8px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }

    .milestone-date-label {
      font-size: 10px;
      color: #ffbd59;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    .milestone-date-separator {
      color: #666;
      font-size: 12px;
    }

    .milestone-date-input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 28px 4px 8px;
      color: #fff;
      font-size: 11px;
      font-family: 'Monaco', 'Menlo', monospace;
      cursor: pointer;
      transition: all 0.2s ease;
      /* Custom calendar icon */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffbd59'%3E%3Cpath d='M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 6px center;
      background-size: 16px 16px;
    }

    .milestone-date-input:hover {
      border-color: #ffbd59;
      background-color: rgba(255, 189, 89, 0.1);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffc566'%3E%3Cpath d='M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z'/%3E%3C/svg%3E");
    }

    .milestone-date-input:focus {
      outline: none;
      border-color: #ffbd59;
      box-shadow: 0 0 8px rgba(255, 189, 89, 0.3);
    }

    /* Hide native date picker - using custom calendar */
    .milestone-date-input::-webkit-calendar-picker-indicator {
      display: none;
    }

    /* Custom Calendar Popup Styling - Black & Yellow Theme */
    /* Note: Native date pickers have limited styling. Using custom approach. */
    .milestone-date-input::-webkit-datetime-edit {
      color: #fff;
      padding: 2px 4px;
    }

    .milestone-date-input::-webkit-datetime-edit-fields-wrapper {
      color: #fff;
    }

    .milestone-date-input::-webkit-datetime-edit-text {
      color: #ffbd59;
      padding: 0 2px;
    }

    .milestone-date-input::-webkit-datetime-edit-month-field,
    .milestone-date-input::-webkit-datetime-edit-day-field,
    .milestone-date-input::-webkit-datetime-edit-year-field {
      color: #fff;
    }

    .milestone-date-input::-webkit-datetime-edit-month-field:focus,
    .milestone-date-input::-webkit-datetime-edit-day-field:focus,
    .milestone-date-input::-webkit-datetime-edit-year-field:focus {
      background: rgba(255, 189, 89, 0.2);
      color: #ffbd59;
      outline: none;
    }

    /* Secondary stats row */
    .stats-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #151515 100%);
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 12px 16px;
      min-width: 100px;
      flex: 1;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.05);
      animation: borderGlow 5s ease-in-out infinite;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 2px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      animation: whiteGlow 4s ease-in-out infinite;
    }

    .stat-value.critical { color: #fff; text-shadow: 0 0 12px rgba(239, 68, 68, 0.9), 0 0 24px rgba(239, 68, 68, 0.5), 0 0 36px rgba(239, 68, 68, 0.3); }
    .stat-value.high { color: #fff; text-shadow: 0 0 12px rgba(249, 115, 22, 0.9), 0 0 24px rgba(249, 115, 22, 0.5), 0 0 36px rgba(249, 115, 22, 0.3); }
    .stat-value.in-progress { color: #fff; text-shadow: 0 0 12px rgba(59, 130, 246, 0.9), 0 0 24px rgba(59, 130, 246, 0.5), 0 0 36px rgba(59, 130, 246, 0.3); }
    .stat-value.completed { color: #fff; text-shadow: 0 0 12px rgba(34, 197, 94, 0.9), 0 0 24px rgba(34, 197, 94, 0.5), 0 0 36px rgba(34, 197, 94, 0.3); }
    .stat-value.bug { color: #fff; text-shadow: 0 0 12px rgba(244, 63, 94, 0.9), 0 0 24px rgba(244, 63, 94, 0.5), 0 0 36px rgba(244, 63, 94, 0.3); }

    .stat-label {
      font-size: 10px;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Toolbar */
    .tasks-toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar-filters {
      display: flex;
      gap: 8px;
      flex: 1;
      flex-wrap: wrap;
    }

    .filter-select {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      min-width: 120px;
    }

    .filter-select:focus {
      outline: none;
      border-color: #ffbd59;
    }

    .search-input {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      padding: 8px 12px;
      font-size: 13px;
      min-width: 200px;
    }

    .search-input:focus {
      outline: none;
      border-color: #ffbd59;
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .btn-create {
      background: linear-gradient(135deg, #ffbd59 0%, #e5a64d 100%);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .btn-create:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 189, 89, 0.3);
    }

    .btn-create svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* Tasks Table */
    .tasks-table-container {
      flex: 1;
      overflow: auto;
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
    }

    .tasks-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .tasks-table th {
      background: #1a1a1a;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      font-weight: 600;
      text-align: left;
      padding: 6px 10px;
      border-bottom: 1px solid #2a2a2a;
      position: sticky;
      top: 0;
      z-index: 1;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.5px;
    }

    .tasks-table td {
      padding: 4px 10px;
      border-bottom: 1px solid #1a1a1a;
      vertical-align: middle;
      line-height: 1.3;
    }

    .tasks-table tr {
      cursor: pointer;
      transition: background 0.1s ease;
    }

    .tasks-table tr:hover {
      background: rgba(255, 189, 89, 0.06);
    }

    .tasks-table tr.selected {
      background: rgba(255, 189, 89, 0.12);
    }

    .task-id {
      font-family: 'Monaco', 'Menlo', monospace;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 189, 89, 0.8), 0 0 20px rgba(255, 189, 89, 0.4);
      font-weight: 600;
      font-size: 11px;
      white-space: nowrap;
    }

    .task-title {
      color: #fff;
      font-weight: 500;
      font-size: 12px;
      max-width: 350px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .status-badge.submitted {
      background: rgba(156, 163, 175, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(156, 163, 175, 0.8);
      border: 1px solid rgba(156, 163, 175, 0.3);
      box-shadow: 0 0 8px rgba(156, 163, 175, 0.2);
    }

    .status-badge.in_review {
      background: rgba(147, 51, 234, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(167, 139, 250, 0.9);
      border: 1px solid rgba(147, 51, 234, 0.3);
      box-shadow: 0 0 8px rgba(147, 51, 234, 0.3);
    }

    .status-badge.in_progress {
      background: rgba(59, 130, 246, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(96, 165, 250, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
    }

    .status-badge.fixing {
      background: rgba(249, 115, 22, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(251, 146, 60, 0.9);
      border: 1px solid rgba(249, 115, 22, 0.3);
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
    }

    .status-badge.completed {
      background: rgba(34, 197, 94, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(74, 222, 128, 0.9);
      border: 1px solid rgba(34, 197, 94, 0.3);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
    }

    .status-badge.developing {
      background: rgba(59, 130, 246, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(96, 165, 250, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
    }

    .status-badge.reviewing {
      background: rgba(147, 51, 234, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(167, 139, 250, 0.9);
      border: 1px solid rgba(147, 51, 234, 0.3);
      box-shadow: 0 0 8px rgba(147, 51, 234, 0.3);
    }

    .status-badge.documenting {
      background: rgba(14, 165, 233, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(56, 189, 248, 0.9);
      border: 1px solid rgba(14, 165, 233, 0.3);
      box-shadow: 0 0 8px rgba(14, 165, 233, 0.3);
    }

    .status-badge.approving {
      background: rgba(251, 191, 36, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.9);
      border: 1px solid rgba(251, 191, 36, 0.3);
      box-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
    }

    /* Type Badge */
    .type-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .type-badge.bug {
      background: rgba(244, 63, 94, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(251, 113, 133, 0.9);
      box-shadow: 0 0 6px rgba(244, 63, 94, 0.3);
    }

    .type-badge.development {
      background: rgba(59, 130, 246, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(96, 165, 250, 0.9);
      box-shadow: 0 0 6px rgba(59, 130, 246, 0.3);
    }

    .type-badge.enhancement {
      background: rgba(34, 197, 94, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(74, 222, 128, 0.9);
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.3);
    }

    .type-badge.operational {
      background: rgba(255, 189, 89, 0.15);
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 189, 89, 0.9);
      box-shadow: 0 0 6px rgba(255, 189, 89, 0.3);
    }

    /* Priority Badge */
    .priority-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      font-weight: 500;
    }

    .priority-badge.critical {
      color: #fff;
      text-shadow: 0 0 10px rgba(239, 68, 68, 0.9), 0 0 20px rgba(239, 68, 68, 0.5);
    }

    .priority-badge.high {
      color: #fff;
      text-shadow: 0 0 10px rgba(249, 115, 22, 0.9), 0 0 20px rgba(249, 115, 22, 0.5);
    }

    .priority-badge.medium {
      color: #fff;
      text-shadow: 0 0 10px rgba(234, 179, 8, 0.9), 0 0 20px rgba(234, 179, 8, 0.5);
    }

    .priority-badge.low {
      color: #fff;
      text-shadow: 0 0 8px rgba(107, 114, 128, 0.7);
    }

    .priority-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .priority-badge.critical .priority-dot { background: #ef4444; }
    .priority-badge.high .priority-dot { background: #f97316; }
    .priority-badge.medium .priority-dot { background: #eab308; }
    .priority-badge.low .priority-dot { background: #6b7280; }

    .task-component {
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      font-size: 11px;
    }

    .task-date {
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      font-size: 10px;
      white-space: nowrap;
    }

    /* Action Buttons */
    .task-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      background: transparent;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .action-btn:hover {
      background: #1a1a1a;
      border-color: #444;
      color: #fff;
    }

    .action-btn.status-btn:hover {
      border-color: #ffbd59;
      color: #ffbd59;
    }

    .action-btn.edit-btn {
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn.edit-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .action-btn.edit-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      fill: #333;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 14px;
      margin-bottom: 16px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #2a2a2a;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: #fff;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.8);
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      padding: 12px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: #ffbd59;
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-row {
      display: flex;
      gap: 16px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid #2a2a2a;
    }

    .btn-cancel {
      background: transparent;
      border: 1px solid #333;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-cancel:hover {
      background: #222;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
    }

    .btn-submit {
      background: linear-gradient(135deg, #ffbd59 0%, #e5a64d 100%);
      border: none;
      color: #000;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-submit:hover {
      box-shadow: 0 4px 12px rgba(255, 189, 89, 0.3);
    }

    .btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Status Change Modal */
    .status-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .status-option:hover {
      background: #1a1a1a;
      border-color: #ffbd59;
    }

    .status-option.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .status-option.disabled:hover {
      background: #111;
      border-color: #333;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #333;
      border-top-color: #ffbd59;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ==================== RIGHT SLIDING EDIT PANEL ==================== */
    .tasks-layout-wrapper {
      display: flex;
      flex-direction: row;
      flex: 1;
      overflow: hidden;
    }

    .tasks-layout {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 8px 16px 0 16px;
      transition: margin-right 0.3s ease;
    }

    .tasks-layout.panel-open {
      margin-right: 0;
    }

    /* Right-side control panel */
    .tasks-control-panel {
      width: 72px;
      min-width: 72px;
      background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
      border-left: 1px solid #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 12px;
      gap: 16px;
      flex-shrink: 0;
      z-index: 100;
    }

    .control-btn {
      width: 48px;
      height: 48px;
      border: 2px solid #333;
      border-radius: 10px;
      background: #151515;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      position: relative;
    }

    .control-btn:hover {
      background: #1f1f1f;
      border-color: #555;
    }

    .control-btn.active {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.15) 0%, rgba(255, 189, 89, 0.05) 100%);
      border-color: #ffbd59;
    }

    .control-btn.active svg {
      fill: #ffbd59;
    }

    .control-btn svg {
      width: 24px;
      height: 24px;
      fill: #888;
      transition: fill 0.2s ease;
    }

    .control-btn:hover svg {
      fill: #bbb;
    }

    .control-btn-label {
      position: absolute;
      right: 60px;
      background: #222;
      color: #fff;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .control-btn:hover .control-btn-label {
      opacity: 1;
    }

    .control-divider {
      width: 32px;
      height: 1px;
      background: #333;
      margin: 8px 0;
    }

    /* Refresh Button - positioned at bottom of control panel */
    .control-panel-spacer {
      flex: 1;
    }

    .refresh-btn {
      width: 48px;
      height: 48px;
      border: 2px solid #333;
      border-radius: 10px;
      background: #151515;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      position: relative;
    }

    .refresh-btn:hover {
      background: #1f1f1f;
      border-color: #4caf50;
    }

    .refresh-btn:hover svg {
      fill: #4caf50;
    }

    .refresh-btn svg {
      width: 24px;
      height: 24px;
      fill: #888;
      transition: all 0.2s ease;
    }

    .refresh-btn.refreshing {
      pointer-events: none;
      border-color: #ffbd59;
    }

    .refresh-btn.refreshing svg {
      fill: #ffbd59;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .refresh-btn-label {
      position: absolute;
      right: 60px;
      background: #222;
      color: #fff;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .refresh-btn:hover .refresh-btn-label {
      opacity: 1;
    }

    /* Edit Panel Container */
    .edit-panel-container {
      position: fixed;
      top: 36px;
      right: 0;
      bottom: 0;
      width: 0;
      background: #111;
      border-left: 1px solid #2a2a2a;
      z-index: 100;
      display: flex;
      transition: width 0.3s ease;
      overflow: hidden;
    }

    .edit-panel-container.open {
      width: 480px;
    }

    /* Resize Handle */
    .edit-panel-resize-handle {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: ew-resize;
      background: transparent;
      z-index: 10;
      transition: background 0.15s ease;
    }

    .edit-panel-resize-handle:hover,
    .edit-panel-resize-handle.resizing {
      background: rgba(255, 189, 89, 0.4);
    }

    /* Panel Inner Content */
    .edit-panel {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .edit-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #2a2a2a;
      background: #151515;
      flex-shrink: 0;
    }

    .edit-panel-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .edit-panel-task-id {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 189, 89, 0.8), 0 0 20px rgba(255, 189, 89, 0.4);
      font-weight: 600;
    }

    .edit-panel-close {
      background: transparent;
      border: none;
      color: #fff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: all 0.15s;
    }

    .edit-panel-close:hover {
      color: #fff;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.8);
    }

    .edit-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Form Styles for Edit Panel */
    .edit-form-group {
      margin-bottom: 16px;
    }

    .edit-form-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .edit-form-input,
    .edit-form-textarea,
    .edit-form-select {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      padding: 10px 12px;
      font-size: 13px;
      font-family: inherit;
      transition: border-color 0.15s;
    }

    .edit-form-input:focus,
    .edit-form-textarea:focus,
    .edit-form-select:focus {
      outline: none;
      border-color: #ffbd59;
    }

    .edit-form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .edit-form-row {
      display: flex;
      gap: 12px;
    }

    .edit-form-row .edit-form-group {
      flex: 1;
    }

    /* Metadata Section */
    .edit-metadata-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #222;
    }

    .edit-metadata-title {
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .edit-metadata-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .edit-metadata-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .edit-metadata-label {
      font-size: 10px;
      color: #fff;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
    }

    .edit-metadata-value {
      font-size: 12px;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
    }

    /* Panel Footer */
    .edit-panel-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-top: 1px solid #2a2a2a;
      background: #151515;
      flex-shrink: 0;
    }

    .edit-panel-actions-left {
      display: flex;
      gap: 8px;
    }

    .edit-panel-actions-right {
      display: flex;
      gap: 8px;
    }

    .btn-panel-delete {
      background: transparent;
      border: 1px solid #444;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-panel-delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #fff;
      text-shadow: 0 0 10px rgba(239, 68, 68, 0.8);
    }

    .btn-panel-cancel {
      background: transparent;
      border: 1px solid #333;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-panel-cancel:hover {
      background: #222;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
    }

    .btn-panel-save {
      background: linear-gradient(135deg, #ffbd59 0%, #e5a64d 100%);
      border: none;
      color: #000;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-panel-save:hover {
      box-shadow: 0 4px 12px rgba(255, 189, 89, 0.3);
    }

    .btn-panel-save:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Status History in Panel */
    .status-history-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #222;
    }

    .status-history-title {
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .status-history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: #0a0a0a;
      border-radius: 6px;
      font-size: 11px;
    }

    .status-history-arrow {
      color: #fff;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
    }

    .status-history-meta {
      margin-left: auto;
      color: #fff;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
      font-size: 10px;
    }

    /* Panel overlay for mobile */
    .edit-panel-overlay {
      display: none;
      position: fixed;
      top: 36px;
      left: 52px;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }

    .edit-panel-overlay.visible {
      display: block;
    }

    /* ============================================
       THREE-COLUMN TASKS VIEW
       Left: Task Queue | Center: Task Details | Right: Task Context
       ============================================ */

    /* View Container - Switches between Dashboard and Tasks views */
    .view-analytics {
      display: none; /* Hidden by default */
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    /* Dashboard view shows analytics/velocity content */
    body.dashboard-view-active .view-analytics {
      display: flex !important;
    }

    body.settings-view-active .view-analytics { display: none; }
    body.settings-view-active .view-settings { display: block; }

    /* Tasks View Three-Column Layout */
    .tasks-view-container {
      display: none;
      flex: 1;
      min-height: 0;
      overflow: hidden;
      flex-direction: row;
    }

    body.tasks-view-active .tasks-view-container {
      display: flex !important;
    }

    /* When tasks view is active, hide dashboard content */
    body.tasks-view-active .view-analytics {
      display: none !important;
    }

    /* Ensure tasks-layout allows flex children to show properly */
    body.tasks-view-active .tasks-layout {
      padding: 0;
    }

    /* LEFT COLUMN: Task Queue (resizable) */
    .task-queue-column {
      flex: none;
      width: 60%;
      min-width: 350px;
      max-width: 80%;
      background: linear-gradient(180deg, #0d0d0d 0%, #0a0a0a 100%);
      border-right: none;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative; /* For sticky footer positioning */
    }

    /* Resizable divider between panels */
    .panel-resize-handle {
      width: 6px;
      background: #222;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s ease;
      position: relative;
    }

    .panel-resize-handle:hover,
    .panel-resize-handle.dragging {
      background: #fbbf24;
    }

    .panel-resize-handle::after {
      content: '';
      width: 2px;
      height: 40px;
      background: #444;
      border-radius: 1px;
      transition: background 0.15s ease;
    }

    .panel-resize-handle:hover::after,
    .panel-resize-handle.dragging::after {
      background: #000;
    }

    .task-queue-header {
      padding: 16px;
      border-bottom: none;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      height: 56px;
      box-sizing: border-box;
    }

    /* Yellow divider beneath task queue header */
    .task-queue-header-divider {
      height: 2px;
      background: #fbbf24;
      width: 100%;
      flex-shrink: 0;
    }

    .task-queue-title {
      font-size: 20px;
      font-weight: 700;
      color: #fbbf24;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .task-queue-title svg {
      width: 18px;
      height: 18px;
      fill: #ffbd59;
    }

    .task-queue-filter {
      flex-shrink: 0;
    }

    /* Archive/Open Toggle Switch */
    .task-view-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .task-view-toggle .toggle-label {
      font-size: 11px;
      font-weight: 700;
      color: #666;
      cursor: pointer;
      transition: color 0.2s ease;
      letter-spacing: 0.5px;
    }

    .task-view-toggle .toggle-label.active {
      color: #fbbf24;
    }

    .task-view-toggle .toggle-label:hover {
      color: #999;
    }

    .task-view-toggle .toggle-label.active:hover {
      color: #fbbf24;
    }

    .view-toggle-switch {
      width: 44px;
      height: 22px;
      background: #333;
      border-radius: 11px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s ease;
      border: 1px solid #fbbf24;
    }

    .view-toggle-switch .toggle-knob {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #fbbf24;
      border-radius: 50%;
      top: 2px;
      right: 3px;
      transition: transform 0.3s ease;
    }

    .view-toggle-switch.archive .toggle-knob {
      transform: translateX(-22px);
    }

    .task-queue-filter-select {
      padding: 6px 28px 6px 12px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #ccc;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%23888'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      transition: all 0.15s ease;
    }

    .task-queue-filter-select:hover {
      border-color: #555;
      color: #fff;
    }

    .task-queue-filter-select:focus {
      outline: none;
      border-color: #fbbf24;
    }

    .task-queue-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .queue-filter-btn {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 12px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .queue-filter-btn:hover {
      border-color: #555;
      color: #ccc;
    }

    .queue-filter-btn.active {
      background: rgba(255, 189, 89, 0.15);
      border-color: #ffbd59;
      color: #ffbd59;
    }

    .task-queue-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      padding-bottom: 50px; /* Space for sticky footer */
    }

    /* Sticky Footer with Totals */
    .task-queue-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(20, 20, 20, 0.95) 0%, #0f0f0f 100%);
      border-top: 1px solid rgba(255, 189, 89, 0.3);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      z-index: 10;
    }

    .footer-total {
      font-size: 11px;
      font-weight: 600;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      color: #ffbd59;
      letter-spacing: 0.5px;
    }

    /* Task Queue Item - Compact Single Row */
    .task-queue-item {
      padding: 8px 10px;
      margin-bottom: 1px;
      background: #151515;
      border: 1px solid #1a1a1a;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.1s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .task-queue-item:hover {
      background: #1a1a1a;
      border-color: #333;
    }

    .task-queue-item.selected {
      background: rgba(255, 189, 89, 0.08);
      border-color: #ffbd59;
    }

    .task-queue-item-header {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .task-queue-id {
      font-size: 10px;
      font-weight: 700;
      color: #ffbd59;
      font-family: 'SF Mono', monospace;
      min-width: 70px;
      flex-shrink: 0;
    }

    .task-queue-priority {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .task-queue-priority.critical { background: #ef4444; box-shadow: 0 0 4px rgba(239, 68, 68, 0.5); }
    .task-queue-priority.high { background: #f97316; }
    .task-queue-priority.medium { background: #eab308; }
    .task-queue-priority.low { background: #22c55e; }

    .task-queue-title {
      flex: 1;
      font-size: 12px;
      color: #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-queue-date {
      font-size: 10px;
      color: #555;
      font-family: 'SF Mono', monospace;
      min-width: 40px;
      flex-shrink: 0;
    }

    .task-queue-status {
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
      min-width: 72px;
      text-align: center;
      display: inline-block;
    }

    /* Gabriel-owned statuses: Yellow background, black text */
    .task-queue-status.owner-gabriel {
      background: #fbbf24;
      color: #000;
    }

    /* Jubilee-owned statuses: Sky blue background, bold black text */
    .task-queue-status.owner-jubilee {
      background: #38bdf8;
      color: #000;
      font-weight: 700;
    }

    /* Completed: Green with checkmark feel */
    .task-queue-status.owner-none,
    .task-queue-status.completed {
      background: rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    /* Legacy status styles for backwards compatibility */
    .task-queue-status.submitted { background: #9ca3af; color: #000; }
    .task-queue-status.developing { background: #3b82f6; color: #fff; }
    .task-queue-status.in_progress, .task-queue-status.in-progress { background: #3b82f6; color: #fff; }
    .task-queue-status.reviewing { background: #9333ea; color: #fff; }
    .task-queue-status.in_review, .task-queue-status.in-review { background: #9333ea; color: #fff; }
    .task-queue-status.documenting { background: #0ea5e9; color: #000; }
    .task-queue-status.approving { background: #fbbf24; color: #000; }
    .task-queue-status.fixing { background: #9333ea; color: #fff; }
    .task-queue-status.completed { background: #22c55e; color: #fff; }

    /* EHH (Est. Human Hours) badge */
    .task-ehh-badge {
      font-size: 9px;
      font-weight: 600;
      font-family: 'SF Mono', monospace;
      color: #a78bfa;
      padding: 2px 6px;
      background: rgba(167, 139, 250, 0.12);
      border: 1px solid rgba(167, 139, 250, 0.25);
      border-radius: 8px;
      flex-shrink: 0;
      white-space: nowrap;
      min-width: 55px;
      text-align: center;
    }

    /* CW+ (Completed Work Human+AI) badge - only for Archive/completed tasks */
    .task-cw-badge {
      font-size: 9px;
      font-weight: 600;
      font-family: 'SF Mono', monospace;
      color: #22c55e;
      padding: 2px 6px;
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.25);
      border-radius: 8px;
      flex-shrink: 0;
      white-space: nowrap;
      min-width: 55px;
      text-align: center;
    }

    /* Duration badge for completed tasks */
    .task-duration-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
      color: #4ade80;
      font-size: 9px;
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .task-duration-badge svg {
      width: 10px;
      height: 10px;
      fill: currentColor;
    }

    .task-queue-meta {
      display: none; /* Hidden in compact mode */
      align-items: center;
      gap: 12px;
      margin-top: 8px;
      font-size: 11px;
      color: #666;
    }

    .task-queue-type {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-queue-type svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    /* QA Test Button in Task Queue Item (for Reviewing status) */
    .qa-test-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 12px;
      color: #a78bfa;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      margin-left: auto;
    }

    .qa-test-btn:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.6);
      transform: scale(1.02);
    }

    .qa-test-btn:active {
      transform: scale(0.98);
    }

    .qa-test-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }

    .qa-test-btn.running {
      background: rgba(234, 179, 8, 0.2);
      border-color: rgba(234, 179, 8, 0.4);
      color: #fbbf24;
      cursor: wait;
    }

    .qa-test-btn.passed {
      background: rgba(34, 197, 94, 0.3);
      border-color: rgba(34, 197, 94, 0.5);
      color: #4ade80;
    }

    .qa-test-btn.failed {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.5);
      color: #f87171;
    }

    /* Spinning animation for loading states */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    /* CENTER COLUMN: Task Detail/Edit Panel */
    /* CENTER COLUMN: Hidden - using two-column layout */
    .task-detail-column {
      display: none;
    }

    .task-detail-header {
      padding: 16px 20px 14px 20px;
      border-bottom: none;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Divider beneath task detail header */
    .task-detail-divider {
      height: 1px;
      background: linear-gradient(90deg, rgba(255, 189, 89, 0.5) 0%, rgba(255, 189, 89, 0.2) 50%, transparent 100%);
      margin: 0;
    }

    .task-detail-title-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .task-detail-id {
      font-size: 14px;
      font-weight: 600;
      color: #ffbd59;
      font-family: 'SF Mono', monospace;
    }

    .task-detail-status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .task-detail-actions {
      display: flex;
      gap: 8px;
    }

    .task-detail-action-btn {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #ccc;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-detail-action-btn:hover {
      background: #252525;
      border-color: #444;
    }

    .task-detail-action-btn.primary {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.2) 0%, rgba(255, 189, 89, 0.1) 100%);
      border-color: #ffbd59;
      color: #ffbd59;
    }

    .task-detail-action-btn.primary:hover {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.3) 0%, rgba(255, 189, 89, 0.15) 100%);
    }

    .task-detail-action-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .task-detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .task-detail-section {
      margin-bottom: 24px;
    }

    .task-detail-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #222;
    }

    .task-detail-field {
      margin-bottom: 16px;
    }

    .task-detail-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 6px;
      display: block;
    }

    .task-detail-input {
      width: 100%;
      padding: 10px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      transition: border-color 0.15s ease;
    }

    .task-detail-input:focus {
      outline: none;
      border-color: #ffbd59;
    }

    .task-detail-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .task-detail-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .task-detail-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .task-detail-timestamps {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 12px;
      background: #0d0d0d;
      border-radius: 8px;
    }

    .task-detail-timestamp {
      font-size: 11px;
    }

    .task-detail-timestamp-label {
      color: #666;
      margin-bottom: 2px;
    }

    .task-detail-timestamp-value {
      color: #aaa;
      font-family: 'SF Mono', monospace;
    }

    /* Empty State for Center Panel */
    .task-detail-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #555;
      padding: 40px;
      text-align: center;
    }

    .task-detail-empty svg {
      width: 64px;
      height: 64px;
      fill: #333;
      margin-bottom: 16px;
    }

    .task-detail-empty-text {
      font-size: 14px;
      color: #666;
    }

    .task-detail-empty-hint {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
    }

    /* RIGHT COLUMN: Task Edit Panel (fills remaining space) */
    .task-context-column {
      flex: 1;
      min-width: 320px;
      background: linear-gradient(180deg, #0d0d0d 0%, #0a0a0a 100%);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Empty State */
    .task-edit-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #555;
      padding: 40px 20px;
      text-align: center;
    }

    .task-edit-empty .empty-icon {
      width: 48px;
      height: 48px;
      fill: #333;
      margin-bottom: 12px;
    }

    /* Edit Content */
    .task-edit-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .task-edit-header {
      padding: 16px;
      border-bottom: none;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      box-sizing: border-box;
    }

    .task-edit-id {
      font-size: 14px;
      font-weight: 700;
      color: #ffbd59;
      font-family: 'SF Mono', monospace;
      text-shadow: 0 0 8px rgba(255, 189, 89, 0.4);
    }

    .task-edit-status {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(234, 179, 8, 0.2);
      color: #fbbf24;
    }

    /* Owner-based status pill colors */
    .task-edit-status.owner-gabriel {
      background: #fbbf24;
      color: #000;
    }
    .task-edit-status.owner-jubilee {
      background: #38bdf8;
      color: #000;
      font-weight: 700;
    }
    .task-edit-status.owner-none,
    .task-edit-status.completed {
      background: rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    /* Yellow divider beneath edit panel header */
    .task-edit-header-divider {
      height: 2px;
      background: #fbbf24;
      width: 100%;
      flex-shrink: 0;
    }

    /* Back/Next Navigation Buttons */
    .task-edit-nav-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .task-nav-btn {
      padding: 4px 16px;
      font-size: 10px;
      font-weight: 700;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 60px;
      text-align: center;
    }

    .task-nav-btn.back {
      background: #000;
      border: 2px solid #fbbf24;
      color: #fbbf24;
    }

    .task-nav-btn.back:hover {
      background: rgba(251, 191, 36, 0.15);
    }

    .task-nav-btn.back:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Back button when clicking would return to Jubilee-owned state */
    .task-nav-btn.back.to-jubilee {
      background: #000;
      border: 2px solid #38bdf8;
      color: #38bdf8;
    }

    .task-nav-btn.back.to-jubilee:hover {
      background: rgba(56, 189, 248, 0.15);
    }

    .task-nav-btn.next {
      background: #fbbf24;
      border: 2px solid #fbbf24;
      color: #000;
    }

    /* Next button when clicking would advance to Jubilee-owned state */
    .task-nav-btn.next.to-jubilee {
      background: #38bdf8;
      border: 2px solid #38bdf8;
      color: #000;
      font-weight: 700;
    }

    .task-nav-btn.next.to-jubilee:hover {
      background: #0ea5e9;
      border-color: #0ea5e9;
    }

    .task-nav-btn.next:hover {
      background: #f59e0b;
      border-color: #f59e0b;
    }

    .task-nav-btn.next:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .review-actions-label {
      font-size: 10px;
      font-weight: 600;
      color: #fbbf24;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .review-radio-group {
      display: flex;
      gap: 10px;
    }

    .review-radio {
      cursor: pointer;
    }

    .review-radio input {
      display: none;
    }

    .radio-pill {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      background: #2a2a2a;
      color: #888;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .radio-pill.complete {
      border-color: #22c55e;
    }

    .radio-pill.rework {
      border-color: #f97316;
    }

    .review-radio input:checked + .radio-pill.complete {
      background: #22c55e;
      color: #000;
    }

    .review-radio input:checked + .radio-pill.rework {
      background: #f97316;
      color: #000;
    }

    /* Auto-save Indicator */
    .autosave-indicator {
      padding: 4px 16px;
      font-size: 10px;
      text-align: right;
      height: 20px;
    }

    .autosave-indicator .autosave-saving,
    .autosave-indicator .autosave-saved {
      display: none;
    }

    .autosave-indicator.saving .autosave-saving {
      display: inline;
      color: #fbbf24;
    }

    .autosave-indicator.saved .autosave-saved {
      display: inline;
      color: #22c55e;
    }

    /* Work History Section */
    .work-history-section {
      border-top: 1px solid #222;
      margin-top: auto;
      max-height: 300px;
      display: flex;
      flex-direction: column;
    }

    .work-history-header {
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid #222;
      flex-shrink: 0;
    }

    .work-history-header svg {
      width: 14px;
      height: 14px;
      fill: #888;
    }

    .work-history-total-duration {
      margin-left: auto;
      font-size: 10px;
      color: #4ade80;
      background: rgba(34, 197, 94, 0.2);
      padding: 2px 8px;
      border-radius: 10px;
      text-transform: none;
      letter-spacing: 0;
      font-weight: 600;
    }

    .work-history-total-duration:empty {
      display: none;
    }

    .work-history-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px;
    }

    .work-history-empty {
      font-size: 11px;
      color: #555;
      text-align: center;
      padding: 16px;
    }

    .work-history-item {
      display: flex;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #1a1a1a;
    }

    .work-history-item:last-child {
      border-bottom: none;
    }

    .work-history-actor {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .work-history-actor.gabriel {
      background: #fbbf24;
      color: #000;
    }

    .work-history-actor.jubilee {
      background: #38bdf8;
      color: #000;
      font-weight: 700;
    }

    .work-history-details {
      flex: 1;
      min-width: 0;
    }

    .work-history-action {
      font-size: 11px;
      color: #ccc;
      margin-bottom: 2px;
    }

    .work-history-meta {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .work-history-time {
      font-size: 9px;
      color: #555;
    }

    .work-history-duration {
      font-size: 8px;
      color: #4ade80;
      background: rgba(34, 197, 94, 0.15);
      padding: 1px 6px;
      border-radius: 8px;
    }

    /* Session Documentation Section - displays EHH and CW+ for current task */
    .session-documentation {
      border-top: 1px solid #222;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(0, 0, 0, 0) 100%);
    }

    .session-doc-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .session-doc-header svg {
      width: 14px;
      height: 14px;
      fill: #22c55e;
    }

    .session-doc-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .session-doc-metric {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .session-doc-metric.ehh {
      border-color: rgba(255, 189, 89, 0.3);
    }

    .session-doc-metric.cw {
      border-color: rgba(34, 197, 94, 0.3);
    }

    .session-doc-metric-label {
      font-size: 9px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .session-doc-metric.ehh .session-doc-metric-label {
      color: #ffbd59;
    }

    .session-doc-metric.cw .session-doc-metric-label {
      color: #22c55e;
    }

    .session-doc-metric-value {
      font-size: 20px;
      font-weight: 700;
      font-family: 'SF Mono', monospace;
      color: #fff;
    }

    .session-doc-metric.ehh .session-doc-metric-value {
      color: #ffbd59;
    }

    .session-doc-metric.cw .session-doc-metric-value {
      color: #22c55e;
    }

    .session-doc-metric-unit {
      font-size: 10px;
      font-weight: 600;
      color: #666;
      margin-left: 4px;
    }

    .session-doc-efficiency {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 6px;
    }

    .session-doc-efficiency-label {
      font-size: 10px;
      color: #888;
    }

    .session-doc-efficiency-value {
      font-size: 14px;
      font-weight: 700;
      color: #22c55e;
      font-family: 'SF Mono', monospace;
    }

    .session-doc-efficiency-mult {
      font-size: 11px;
      color: #4ade80;
      font-weight: 600;
    }

    .task-edit-form {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .edit-field {
      margin-bottom: 14px;
    }

    .edit-field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .edit-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .edit-input,
    .edit-select,
    .edit-textarea {
      width: 100%;
      padding: 10px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      transition: border-color 0.15s ease;
    }

    .edit-input:focus,
    .edit-select:focus,
    .edit-textarea:focus {
      outline: none;
      border-color: #ffbd59;
    }

    .edit-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .edit-textarea.small {
      min-height: 50px;
    }

    .edit-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
      cursor: pointer;
    }

    .task-edit-actions {
      padding: 16px;
      border-top: 1px solid #222;
      display: flex;
      gap: 10px;
    }

    .edit-action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .edit-action-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .edit-action-btn.save {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.2) 0%, rgba(255, 189, 89, 0.1) 100%);
      border-color: #ffbd59;
      color: #ffbd59;
    }

    .edit-action-btn.save:hover {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.3) 0%, rgba(255, 189, 89, 0.15) 100%);
    }

    .edit-action-btn.delete {
      background: #1a1a1a;
      border-color: #333;
      color: #888;
    }

    .edit-action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .task-context-header {
      padding: 16px;
      border-bottom: 1px solid #222;
      background: rgba(0, 0, 0, 0.3);
    }

    .task-context-title {
      font-size: 13px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .task-context-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .task-context-section {
      margin-bottom: 20px;
    }

    .task-context-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    /* Task Stats in Context */
    .task-context-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .task-context-stat {
      padding: 10px;
      background: #151515;
      border: 1px solid #222;
      border-radius: 6px;
      text-align: center;
    }

    .task-context-stat-value {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }

    .task-context-stat-label {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }

    /* Related Tasks */
    .task-context-related {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .task-context-related-item {
      padding: 8px 10px;
      background: #151515;
      border: 1px solid #222;
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .task-context-related-item:hover {
      background: #1a1a1a;
      border-color: #333;
    }

    .task-context-related-id {
      font-size: 10px;
      color: #666;
      font-family: 'SF Mono', monospace;
    }

    .task-context-related-title {
      font-size: 12px;
      color: #ccc;
      margin-top: 2px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Activity Timeline */
    .task-context-timeline {
      position: relative;
      padding-left: 20px;
    }

    .task-context-timeline::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #222;
    }

    .task-context-timeline-item {
      position: relative;
      padding-bottom: 16px;
    }

    .task-context-timeline-item::before {
      content: '';
      position: absolute;
      left: -17px;
      top: 4px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
      border: 2px solid #0d0d0d;
    }

    .task-context-timeline-item.status-change::before {
      background: #ffbd59;
    }

    .task-context-timeline-time {
      font-size: 10px;
      color: #555;
      margin-bottom: 2px;
    }

    .task-context-timeline-text {
      font-size: 12px;
      color: #aaa;
    }

    /* Task Queue Title */
    .task-queue-title {
      font-size: 13px;
      color: #e5e5e5;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Status badges with hyphenated class names */
    .task-queue-status.in-review { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .task-queue-status.in-progress { background: rgba(234, 179, 8, 0.2); color: #fbbf24; }
    .task-detail-status-badge.in-review { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .task-detail-status-badge.in-progress { background: rgba(234, 179, 8, 0.2); color: #fbbf24; }
    .task-detail-status-badge.submitted { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .task-detail-status-badge.fixing { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
    .task-detail-status-badge.completed { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

    /* Task Queue Loading and Error States */
    .task-queue-loading,
    .task-queue-empty,
    .task-queue-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: #666;
      text-align: center;
      font-size: 13px;
    }

    .task-queue-loading .loading-spinner {
      width: 24px;
      height: 24px;
      margin-bottom: 12px;
    }

    /* Task Queue Priority Badge (text version) */
    .task-queue-priority.critical,
    .task-queue-priority.high,
    .task-queue-priority.medium,
    .task-queue-priority.low {
      width: auto;
      height: auto;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .task-queue-priority.critical { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .task-queue-priority.high { background: rgba(249, 115, 22, 0.2); color: #f97316; }
    .task-queue-priority.medium { background: rgba(234, 179, 8, 0.2); color: #eab308; }
    .task-queue-priority.low { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

    /* Type icons in task queue */
    .type-icon {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }
    .type-icon.bug { color: #ef4444; }
    .type-icon.dev { color: #60a5fa; }
    .type-icon.enhance { color: #fbbf24; }
    .type-icon.ops { color: #8b5cf6; }

    /* Task Detail Form Styles */
    .task-detail-form {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .detail-form-group {
      margin-bottom: 16px;
    }

    .detail-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .detail-input,
    .detail-select,
    .detail-textarea {
      width: 100%;
      padding: 10px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      transition: border-color 0.15s ease;
    }

    .detail-input:focus,
    .detail-select:focus,
    .detail-textarea:focus {
      outline: none;
      border-color: #ffbd59;
    }

    .detail-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .detail-textarea.small {
      min-height: 60px;
    }

    .detail-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
      cursor: pointer;
    }

    .detail-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .detail-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #222;
    }

    .detail-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .detail-btn.save {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.2) 0%, rgba(255, 189, 89, 0.1) 100%);
      border-color: #ffbd59;
      color: #ffbd59;
    }

    .detail-btn.save:hover {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.3) 0%, rgba(255, 189, 89, 0.15) 100%);
    }

    .detail-btn.cancel {
      background: #222;
      color: #888;
      border-color: #333;
    }

    .detail-btn.cancel:hover {
      background: #2a2a2a;
      color: #aaa;
    }

    /* Task Detail ID Badge */
    .task-detail-id-badge {
      font-size: 14px;
      font-weight: 600;
      color: #ffbd59;
      font-family: 'SF Mono', monospace;
    }

    /* Task Context Empty State */
    .task-context-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      font-size: 13px;
      padding: 20px;
      text-align: center;
    }

    .task-context-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* Context Section Styles */
    .context-section {
      margin-bottom: 24px;
    }

    .context-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #222;
    }

    /* Context Metrics */
    .context-metrics {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .context-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #151515;
      border-radius: 6px;
    }

    .context-metric-label {
      font-size: 12px;
      color: #888;
    }

    .context-metric-value {
      font-size: 12px;
      color: #ffbd59;
      font-weight: 600;
      font-family: 'SF Mono', monospace;
    }

    /* Context Timeline */
    .context-timeline {
      position: relative;
      padding-left: 20px;
    }

    .context-timeline::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #222;
    }

    .timeline-item {
      position: relative;
      padding-bottom: 16px;
      display: flex;
      gap: 12px;
    }

    .timeline-dot {
      position: absolute;
      left: -17px;
      top: 4px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
      border: 2px solid #0d0d0d;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-time {
      font-size: 10px;
      color: #555;
      margin-bottom: 2px;
    }

    .timeline-text {
      font-size: 12px;
      color: #aaa;
    }

    /* Context Related Tasks */
    .context-related {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .context-empty-text {
      font-size: 12px;
      color: #555;
      font-style: italic;
    }

    .related-task-item {
      padding: 8px 10px;
      background: #151515;
      border: 1px solid #222;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .related-task-item:hover {
      background: #1a1a1a;
      border-color: #333;
    }

    .related-task-id {
      font-size: 10px;
      color: #666;
      font-family: 'SF Mono', monospace;
    }

    .related-task-title {
      font-size: 12px;
      color: #ccc;
      margin-top: 2px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Context Action Buttons */
    .context-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .context-action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #151515;
      border: 1px solid #222;
      border-radius: 6px;
      color: #aaa;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .context-action-btn:hover {
      background: #1a1a1a;
      border-color: #333;
      color: #fff;
    }

    .context-action-btn.delete {
      color: #888;
    }

    .context-action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .context-action-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* Responsive adjustments for Tasks View */
    @media (max-width: 900px) {
      .task-context-column {
        display: none;
      }
      .task-queue-column {
        flex: 1;
        min-width: 100%;
      }
    }

    /* ==================== QA TESTS VIEW STYLES ==================== */

    .qa-view-container {
      display: none;
      flex: 1;
      flex-direction: column;
      background: #0d0d0d;
      overflow: hidden;
    }

    body.qa-view-active .qa-view-container {
      display: flex !important;
    }

    body.qa-view-active .view-analytics,
    body.qa-view-active .tasks-view-container {
      display: none !important;
    }

    .qa-header {
      height: 32px;
      min-height: 32px;
      padding: 0 16px;
      padding-top: 2px;
      background: #111;
      border-bottom: 2px solid #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .qa-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .qa-title {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .qa-summary {
      display: flex;
      gap: 8px;
    }

    .qa-stat {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .qa-stat.passed {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .qa-stat.failed {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .qa-stat.pending {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }

    .qa-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qa-filter-select {
      padding: 8px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #ccc;
      font-size: 13px;
      cursor: pointer;
    }

    .qa-run-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .qa-run-btn:hover {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    }

    .qa-run-btn svg {
      width: 10px;
      height: 10px;
      fill: currentColor;
    }

    .qa-run-btn.running {
      background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
      pointer-events: none;
    }

    .qa-table-container {
      flex: 1;
      overflow: auto;
      padding: 16px 24px;
    }

    .qa-table {
      width: 100%;
      border-collapse: collapse;
    }

    .qa-table thead th {
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #222;
      background: #111;
      position: sticky;
      top: 0;
    }

    .qa-table tbody tr {
      border-bottom: 1px solid #1a1a1a;
      transition: background 0.1s ease;
    }

    .qa-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .qa-table tbody td {
      padding: 12px 16px;
      font-size: 13px;
      color: #ccc;
    }

    .qa-col-category {
      width: 120px;
    }

    .qa-col-status {
      width: 100px;
    }

    .qa-col-actions {
      width: 100px;
      text-align: center;
    }

    .qa-category-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.05);
      color: #888;
    }

    .qa-status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .qa-status-badge.passed {
      background: #22c55e;
      color: #000;
    }

    .qa-status-badge.failed {
      background: #ef4444;
      color: #fff;
    }

    .qa-status-badge.pending {
      background: #eab308;
      color: #000;
    }

    .qa-status-badge.running {
      background: #3b82f6;
      color: #fff;
    }

    .qa-status-badge.skipped {
      background: #6b7280;
      color: #fff;
    }

    .qa-run-single-btn {
      padding: 4px 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.1s ease;
    }

    .qa-run-single-btn:hover {
      background: #222;
      border-color: #555;
      color: #fff;
    }

    .qa-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 40px;
      color: #666;
    }

    /* QA Test Button in Task Queue (for Reviewing status) */
    .qa-test-btn {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      transition: all 0.15s ease;
      margin-right: 6px;
      flex-shrink: 0;
      min-width: 60px;
      text-align: center;
    }

    .qa-test-btn.pending {
      background: #fbbf24;
      color: #000;
    }

    .qa-test-btn.running {
      background: #3b82f6;
      color: #fff;
    }

    .qa-test-btn.passed {
      background: #22c55e;
      color: #000;
    }

    .qa-test-btn.failed {
      background: #ef4444;
      color: #fff;
    }

    .qa-test-btn:hover {
      transform: scale(1.05);
    }

    /* QA Categories Container */
    .qa-categories-container {
      flex: 1;
      overflow: auto;
      padding: 8px 0;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .qa-loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 60px 40px;
      color: #666;
      font-size: 14px;
    }

    .qa-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 40px;
      color: #666;
      text-align: center;
    }

    .qa-empty-state svg {
      width: 48px;
      height: 48px;
      fill: #444;
      margin-bottom: 16px;
    }

    .qa-stat.total {
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
    }

    .qa-execution-status {
      font-size: 10px;
      color: #888;
    }

    .qa-execution-status.running {
      color: #3b82f6;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Category Group */
    .qa-category-group {
      background: transparent;
      border: none;
      border-bottom: 1px solid #1a1a1a;
    }

    .qa-category-group:last-child {
      border-bottom: none;
    }

    .qa-category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: transparent;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease;
    }

    .qa-category-header:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .qa-category-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qa-category-toggle {
      width: 13px;
      height: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffbd59;
      font-size: 10px;
      font-weight: 700;
      font-family: monospace;
      border: 1px solid #ffbd59;
      border-radius: 2px;
      background: rgba(255, 189, 89, 0.1);
    }

    .qa-category-group.expanded .qa-category-toggle {
      color: #ffbd59;
      background: rgba(255, 189, 89, 0.2);
    }

    .qa-category-name {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      text-transform: capitalize;
    }

    .qa-category-icon {
      display: none;
    }

    .qa-category-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .qa-category-stats {
      display: flex;
      gap: 6px;
    }

    .qa-category-stat {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .qa-category-stat.passed-count {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .qa-category-stat.failed-count {
      background: rgba(239, 68, 68, 0.25);
      color: #ef4444;
      font-weight: 800;
    }

    .qa-category-stat.pending-indicator {
      background: rgba(255, 189, 89, 0.15);
      color: #ffbd59;
      font-style: italic;
    }

    .qa-category-run-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .qa-category-run-btn:hover {
      background: #222;
      border-color: #444;
      color: #fff;
    }

    .qa-category-run-btn svg {
      width: 10px;
      height: 10px;
      fill: currentColor;
    }

    .qa-category-run-btn.running {
      background: #1a3a5c;
      border-color: #3b82f6;
      color: #3b82f6;
      pointer-events: none;
    }

    .qa-category-run-btn.running svg {
      animation: spin 1s linear infinite;
    }

    /* Tests List */
    .qa-tests-list {
      display: none;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.2);
    }

    .qa-category-group.expanded .qa-tests-list {
      display: flex;
    }

    .qa-test-item {
      display: flex;
      align-items: center;
      padding: 5px 12px 5px 36px;
      border-top: 1px solid #151515;
      transition: background 0.1s ease;
      gap: 10px;
    }

    .qa-test-item:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Failed test items get a left border indicator */
    .qa-test-item.test-failed {
      border-left: 3px solid #ef4444;
      background: rgba(239, 68, 68, 0.05);
      padding-left: 33px;
      padding-top: 5px;
      padding-bottom: 5px;
    }

    /* Column layout for test items */
    .qa-test-number-col {
      width: 65px;
      flex-shrink: 0;
    }

    .qa-test-number {
      font-size: 10px;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      color: #ffbd59;
      font-weight: 600;
    }

    .qa-test-name-col {
      flex: 1;
      min-width: 0;
    }

    .qa-test-type-col {
      width: 60px;
      flex-shrink: 0;
    }

    .qa-test-time-col {
      width: 60px;
      flex-shrink: 0;
      text-align: right;
    }

    .qa-test-status-col {
      width: 70px;
      flex-shrink: 0;
    }

    .qa-test-action-col {
      width: 50px;
      flex-shrink: 0;
      display: flex;
      justify-content: flex-end;
      gap: 4px;
    }

    .qa-test-name {
      font-size: 11px;
      color: #ccc;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .qa-test-item.test-failed .qa-test-name {
      color: #ef4444;
    }

    .qa-test-type {
      text-transform: uppercase;
      font-weight: 600;
      padding: 1px 4px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 8px;
      color: #666;
    }

    .qa-test-last-run {
      font-size: 10px;
      color: #555;
    }

    .qa-test-info-btn {
      width: 18px;
      height: 18px;
      padding: 0;
      background: transparent;
      border: 1px solid #ffbd59;
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qa-test-info-btn svg {
      width: 12px;
      height: 12px;
      fill: #ffbd59;
    }

    .qa-test-info-btn:hover {
      background: rgba(255, 189, 89, 0.2);
    }

    /* ==================== QA INFO MODAL ==================== */
    .qa-info-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .qa-info-modal {
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      background: #0a0a0a;
      border: 3px solid #ffbd59;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 189, 89, 0.2);
    }

    .qa-info-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .qa-info-modal-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qa-info-modal-number {
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      font-size: 14px;
      font-weight: 700;
      color: #ffbd59;
    }

    .qa-info-modal-name {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .qa-info-modal-close {
      width: 28px;
      height: 28px;
      background: transparent;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qa-info-modal-close:hover {
      background: #222;
      border-color: #555;
    }

    .qa-info-modal-close svg {
      width: 14px;
      height: 14px;
      fill: #888;
    }

    .qa-info-modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .qa-info-summary {
      padding: 16px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-left: 4px solid #ef4444;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .qa-info-summary-title {
      font-size: 12px;
      font-weight: 700;
      color: #ef4444;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .qa-info-summary-text {
      font-size: 13px;
      color: #ccc;
      line-height: 1.5;
    }

    .qa-info-section {
      margin-bottom: 20px;
    }

    .qa-info-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #ffbd59;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qa-info-section-title svg {
      width: 14px;
      height: 14px;
      fill: #ffbd59;
    }

    .qa-info-section-content {
      font-size: 12px;
      color: #aaa;
      line-height: 1.6;
    }

    .qa-info-section-content ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .qa-info-section-content li {
      margin-bottom: 6px;
    }

    .qa-info-tag {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(255, 189, 89, 0.15);
      border: 1px solid rgba(255, 189, 89, 0.3);
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      color: #ffbd59;
      margin-right: 6px;
    }

    .qa-test-status-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .qa-test-status-indicator.passed {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .qa-test-status-indicator.failed {
      background: rgba(239, 68, 68, 0.25);
      color: #ef4444;
    }

    .qa-test-status-indicator.pending {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }

    .qa-test-status-indicator.running {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .qa-test-status-indicator.running svg {
      animation: spin 1s linear infinite;
    }

    .qa-test-status-indicator svg {
      width: 10px;
      height: 10px;
      fill: currentColor;
    }

    .qa-test-run-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .qa-test-run-btn:hover {
      background: #222;
      border-color: #22c55e;
      color: #22c55e;
    }

    .qa-test-run-btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .qa-test-run-btn.running {
      background: #3b82f6;
      border-color: #3b82f6;
      color: #fff;
      pointer-events: none;
    }

    .qa-test-run-btn.running svg {
      animation: spin 1s linear infinite;
    }

    /* Spin animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Category icons by type */
    .qa-category-group[data-category="login"] .qa-category-icon { background: rgba(59, 130, 246, 0.1); }
    .qa-category-group[data-category="login"] .qa-category-icon svg { fill: #3b82f6; }

    .qa-category-group[data-category="registration"] .qa-category-icon { background: rgba(168, 85, 247, 0.1); }
    .qa-category-group[data-category="registration"] .qa-category-icon svg { fill: #a855f7; }

    .qa-category-group[data-category="chat"] .qa-category-icon { background: rgba(34, 197, 94, 0.1); }
    .qa-category-group[data-category="chat"] .qa-category-icon svg { fill: #22c55e; }

    .qa-category-group[data-category="payment"] .qa-category-icon { background: rgba(239, 68, 68, 0.1); }
    .qa-category-group[data-category="payment"] .qa-category-icon svg { fill: #ef4444; }

    .qa-category-group[data-category="admin"] .qa-category-icon { background: rgba(249, 115, 22, 0.1); }
    .qa-category-group[data-category="admin"] .qa-category-icon svg { fill: #f97316; }

    .qa-category-group[data-category="api"] .qa-category-icon { background: rgba(6, 182, 212, 0.1); }
    .qa-category-group[data-category="api"] .qa-category-icon svg { fill: #06b6d4; }

    /* ==================== QA TESTING OVERLAY ==================== */
    .qa-testing-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .qa-testing-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #ffbd59;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    .qa-testing-status {
      font-size: 14px;
      font-weight: 600;
      color: #ffbd59;
      text-align: center;
      margin-bottom: 12px;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }

    .qa-testing-rule {
      font-size: 12px;
      color: #ccc;
      text-align: center;
      max-width: 70%;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .qa-testing-progress-container {
      width: 70%;
      margin-top: 8px;
    }

    .qa-testing-progress-bar {
      width: 100%;
      height: 6px;
      background: #222;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .qa-testing-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffbd59 0%, #f59e0b 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Progress bar wrapper with percentage */
    .qa-testing-progress-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .qa-testing-progress-bar-container {
      flex: 1;
    }

    .qa-testing-progress-percent {
      font-size: 14px;
      font-weight: 700;
      color: #ffbd59;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      min-width: 45px;
      text-align: right;
      text-shadow: 0 0 8px rgba(255, 189, 89, 0.5);
    }

    /* Manual Hours Display - beneath progress bar */
    .qa-testing-manual-hours {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
    }

    .manual-hours-label {
      font-size: 12px;
      color: #888;
      font-weight: 500;
    }

    .manual-hours-value {
      font-size: 14px;
      font-weight: 700;
      color: #22c55e;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
    }

    /* Fixing Indicator - shows when auto-remediation is in progress */
    .fixing-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%);
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 6px;
      animation: fixingPulse 1.5s ease-in-out infinite;
    }

    .fixing-indicator span {
      font-size: 12px;
      font-weight: 600;
      color: #60a5fa;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }

    .fixing-icon {
      width: 16px;
      height: 16px;
      animation: wrenchTurn 1s ease-in-out infinite;
    }

    .fixing-icon svg {
      width: 100%;
      height: 100%;
      fill: #60a5fa;
    }

    @keyframes fixingPulse {
      0%, 100% {
        border-color: rgba(59, 130, 246, 0.4);
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.1);
      }
      50% {
        border-color: rgba(59, 130, 246, 0.7);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }
    }

    @keyframes wrenchTurn {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-15deg); }
      75% { transform: rotate(15deg); }
    }

    /* Fixed status styling - distinct from passed (green) */
    .qa-status-indicator.fixed {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .qa-status-indicator.fixed svg {
      fill: #60a5fa;
    }

    .qa-status-indicator.fixed .qa-status-text {
      color: #60a5fa;
    }

    /* ==================== STICKY FOOTER BAR ==================== */
    .qa-footer-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: #0a0a0a;
      border-top: 1px solid #222;
      z-index: 50;
      transition: all 0.3s ease;
    }

    /* Collapsed state - single line */
    .qa-footer-collapsed {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      cursor: pointer;
      user-select: none;
    }

    .qa-footer-collapsed:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .qa-footer-summary {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qa-footer-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .qa-footer-icon svg {
      width: 100%;
      height: 100%;
    }

    .qa-footer-text {
      font-size: 11px;
      font-weight: 500;
      color: #888;
    }

    .qa-footer-bar.has-failures .qa-footer-icon svg {
      fill: #ef4444;
    }

    .qa-footer-bar.has-failures .qa-footer-text {
      color: #ef4444;
    }

    .qa-footer-bar.all-passed .qa-footer-icon svg {
      fill: #22c55e;
    }

    .qa-footer-bar.all-passed .qa-footer-text {
      color: #22c55e;
    }

    .qa-footer-cta {
      font-size: 10px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .qa-footer-cta svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
      transition: transform 0.2s ease;
    }

    .qa-footer-bar.expanded .qa-footer-cta svg {
      transform: rotate(180deg);
    }

    /* Expanded state */
    .qa-footer-expanded {
      display: none;
      padding: 16px;
      background: #0d0d0d;
      border-top: 1px solid #1a1a1a;
      max-height: 300px;
      overflow-y: auto;
    }

    .qa-footer-bar.expanded .qa-footer-expanded {
      display: block;
    }

    .qa-footer-expanded-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .qa-footer-expanded-title {
      font-size: 12px;
      font-weight: 600;
      color: #ccc;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qa-footer-expanded-title svg {
      width: 14px;
      height: 14px;
      fill: #ef4444;
    }

    .qa-footer-close-btn {
      width: 20px;
      height: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .qa-footer-close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .qa-footer-close-btn svg {
      width: 12px;
      height: 12px;
      fill: #666;
    }

    .qa-footer-failure-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .qa-footer-failure-item {
      padding: 10px 12px;
      background: rgba(239, 68, 68, 0.05);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-left: 3px solid #ef4444;
      border-radius: 4px;
    }

    .qa-footer-failure-name {
      font-size: 11px;
      font-weight: 600;
      color: #ef4444;
      margin-bottom: 4px;
    }

    .qa-footer-failure-reason {
      font-size: 10px;
      color: #888;
      line-height: 1.4;
    }

    .qa-footer-failure-action {
      font-size: 10px;
      color: #666;
      margin-top: 6px;
      font-style: italic;
    }

    .qa-footer-success-msg {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: rgba(34, 197, 94, 0.05);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 4px;
    }

    .qa-footer-success-msg svg {
      width: 16px;
      height: 16px;
      fill: #22c55e;
      flex-shrink: 0;
    }

    .qa-footer-success-msg span {
      font-size: 11px;
      color: #22c55e;
      fill: #22c55e;
    }

    /* ==================== CUSTOM CALENDAR POPUP - BLACK & YELLOW THEME ==================== */
    .custom-calendar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      display: none;
    }

    .custom-calendar-overlay.active {
      display: block;
    }

    .custom-calendar {
      position: fixed;
      z-index: 9999;
      background: #0a0a0a;
      border: 2px solid #ffbd59;
      border-radius: 12px;
      padding: 16px;
      box-shadow:
        0 0 30px rgba(255, 189, 89, 0.3),
        0 20px 60px rgba(0, 0, 0, 0.8);
      display: none;
      min-width: 280px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .custom-calendar.active {
      display: block;
      animation: calendarFadeIn 0.2s ease-out;
    }

    @keyframes calendarFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
    }

    .calendar-nav-btn {
      background: transparent;
      border: 1px solid #ffbd59;
      color: #ffbd59;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .calendar-nav-btn:hover {
      background: rgba(255, 189, 89, 0.15);
      transform: scale(1.05);
    }

    .calendar-nav-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .calendar-month-year {
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .calendar-weekday {
      text-align: center;
      color: #ffbd59;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 8px 0;
      letter-spacing: 0.5px;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      background: transparent;
    }

    .calendar-day:hover:not(.empty):not(.selected) {
      background: rgba(255, 189, 89, 0.15);
      border-color: rgba(255, 189, 89, 0.3);
    }

    .calendar-day.empty {
      cursor: default;
    }

    .calendar-day.today {
      border-color: #ffbd59;
      color: #ffbd59;
    }

    .calendar-day.selected {
      background: #ffbd59;
      color: #000;
      font-weight: 700;
      border-color: #ffbd59;
      box-shadow: 0 0 15px rgba(255, 189, 89, 0.4);
    }

    .calendar-day.other-month {
      color: #555;
    }

    .calendar-day.other-month:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #888;
    }

    .calendar-footer {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #333;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .calendar-footer-btn {
      flex: 1;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .calendar-footer-btn.cancel {
      background: transparent;
      border: 1px solid #555;
      color: #888;
    }

    .calendar-footer-btn.cancel:hover {
      border-color: #888;
      color: #fff;
    }

    .calendar-footer-btn.today-btn {
      background: transparent;
      border: 1px solid #ffbd59;
      color: #ffbd59;
    }

    .calendar-footer-btn.today-btn:hover {
      background: rgba(255, 189, 89, 0.15);
    }

    .calendar-footer-btn.confirm {
      background: #ffbd59;
      border: 1px solid #ffbd59;
      color: #000;
    }

    .calendar-footer-btn.confirm:hover {
      background: #ffc566;
      box-shadow: 0 0 15px rgba(255, 189, 89, 0.3);
    }
  </style>
</head>
<body>
  <!-- Custom Calendar Popup -->
  <div class="custom-calendar-overlay" id="calendarOverlay"></div>
  <div class="custom-calendar" id="customCalendar">
    <div class="calendar-header">
      <button class="calendar-nav-btn" id="calendarPrevMonth" type="button">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
      <span class="calendar-month-year" id="calendarMonthYear">December 2025</span>
      <button class="calendar-nav-btn" id="calendarNextMonth" type="button">
        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
      </button>
    </div>
    <div class="calendar-weekdays">
      <div class="calendar-weekday">Sun</div>
      <div class="calendar-weekday">Mon</div>
      <div class="calendar-weekday">Tue</div>
      <div class="calendar-weekday">Wed</div>
      <div class="calendar-weekday">Thu</div>
      <div class="calendar-weekday">Fri</div>
      <div class="calendar-weekday">Sat</div>
    </div>
    <div class="calendar-days" id="calendarDays"></div>
    <div class="calendar-footer">
      <button class="calendar-footer-btn cancel" id="calendarCancel" type="button">Cancel</button>
      <button class="calendar-footer-btn today-btn" id="calendarToday" type="button">Today</button>
      <button class="calendar-footer-btn confirm" id="calendarConfirm" type="button">Select</button>
    </div>
  </div>

  <div class="app-container">
    <!-- LEFT SIDEBAR -->
    <!-- Navigation Order: Dashboard, Search, Tasks, Hospitality -->
    <div id="admin-sidebar-container">
      <div class="admin-sidebar">
        <a href="/admin" class="admin-sidebar-icon" data-tooltip="Dashboard" data-nav="dashboard">
          <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
        </a>
        <a href="/search" class="admin-sidebar-icon" data-tooltip="Search" data-nav="search">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </a>
        <a href="/admin/tasks" class="admin-sidebar-icon is-active" data-tooltip="Tasks" data-nav="tasks">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        </a>
        <a href="/admin/hospitality" class="admin-sidebar-icon" data-tooltip="Hospitality" data-nav="hospitality">
          <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
        </a>
        <div class="admin-sidebar-spacer"></div>
        <div class="admin-sidebar-brand-section">
          <div class="admin-sidebar-brand-text">Jubilee<span class="verse">Verse</span><span class="dotcom">.com</span></div>
          <div class="admin-sidebar-brand-sub">ADMIN DASHBOARD</div>
        </div>
        <div class="admin-sidebar-avatar">
          <img src="/images/personas/jubilee.png" alt="Admin" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23666%22%3E%3Cpath d=%22M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z%22/%3E%3C/svg%3E'">
        </div>
      </div>
    </div>

    <!-- MAIN AREA -->
    <div class="main-area">
      <!-- ADMIN HEADER -->
      <div class="admin-header">
        <div class="admin-header-left">
          <a href="/search" class="admin-header-logo">
            <span class="logo-jubilee">Jubilee</span><span class="logo-intelligence">Intelligence</span>
          </a>
        </div>
        <div class="admin-header-right">
          <span class="admin-header-user-name" id="adminUserName"></span>
          <span class="admin-header-sep">|</span>
          <a href="/admin" class="admin-header-back-link">Dashboard</a>
          <span class="admin-header-sep">|</span>
          <a href="#" class="admin-sign-out-btn" id="adminAuthBtn">
            <span id="adminAuthBtnText">Sign Out</span>
            <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 4v8" stroke="currentColor" stroke-width="2.5"/>
              <path d="M6.5 7.5a8 8 0 1 0 11 0" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- TASKS CONTENT WITH RIGHT CONTROL PANEL -->
      <div class="tasks-layout-wrapper">
      <div class="tasks-layout">
        <!-- ANALYTICS VIEW: Velocity Dashboard - Three Panel Layout -->
        <div class="view-analytics">
        <div class="velocity-dashboard intro-state" id="velocityDashboard">
          <!-- Reveal animation lines -->
          <div class="reveal-line reveal-line-left"></div>
          <div class="reveal-line reveal-line-right"></div>
          <!-- LEFT PANEL: Work Remaining -->
          <div class="velocity-side-panel left-panel">
            <div class="panel-header">
              <div class="panel-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
              </div>
              <span class="panel-title">Work Remaining</span>
            </div>
            <div class="panel-stats remaining-stats compact-stats">
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Remaining Tasks</span>
                <span class="panel-stat-value caution-glow" id="panelPendingTasks">--</span>
              </div>
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Remaining EHH</span>
                <span class="panel-stat-value caution-glow" id="panelPendingHEH">--</span>
              </div>
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Required WPH</span>
                <span class="panel-stat-value caution-glow" id="panelRequiredWPH">--</span>
              </div>
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Current WPH</span>
                <span class="panel-stat-value caution-glow" id="panelCurrentWPH">--</span>
              </div>
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Execution Pressure</span>
                <span class="panel-stat-value caution-glow" id="panelExecPressure">--%</span>
              </div>
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Est. Completion</span>
                <span class="panel-stat-value caution-glow" id="panelEstCompletion">--</span>
              </div>
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Schedule Position</span>
                <span class="panel-stat-value caution-glow" id="panelSchedulePosition">--</span>
              </div>
              <div class="panel-stat-item caution-indicator">
                <span class="panel-stat-label">Milestone Confidence</span>
                <span class="panel-stat-value caution-glow" id="panelMilestoneConfidence">--</span>
              </div>
            </div>
            <div class="panel-total caution-total">
              <div class="panel-total-value caution-glow panel-value-pending" id="panelValuePending">$0</div>
              <div class="panel-total-label">Value Pending</div>
              <div class="panel-fuel-context" id="panelFuelContext">Estimated: -- EHH  $150.00/hr</div>
            </div>
          </div>

          <!-- CENTER PANEL: Speedometer -->
          <div class="speedometer-panel">
            <div class="speedometer-header">
              <span class="speedometer-title">Development Velocity</span>
              <div class="health-indicator-container">
                <div class="health-indicator-wrapper">
                  <div class="health-indicator unknown" id="bgProcessHealthIndicator" title="Timeline Burst (1FTE)"></div>
                  <div class="health-indicator-tooltip" id="bgProcessHealthTooltip">
                    Timeline Burst (1FTE): Checking...
                  </div>
                </div>
                <div class="speedometer-badge clickable" id="speedBadge" title="Click to recalculate velocity">WPH: --</div>
              </div>
            </div>
            <div class="speedometer-wrapper">
              <canvas id="velocityGaugeCanvas" class="speedometer-canvas" width="340" height="260"></canvas>
              <div class="speedometer-value-display">
                <div class="speedometer-value dashboard-glow" id="speedometerValue">0<span class="speedometer-wph-label">WPH</span></div>
              </div>
            </div>
            <div class="speedometer-description">
              <div class="speedometer-desc-text">
                MILESTONE: <strong id="milestoneStartDisplay">Dec 21</strong>  <strong id="milestoneEndDisplay">Dec 31, 2025</strong> |
                <strong id="milestoneHoursRemaining">32</strong> working hours remaining
              </div>
            </div>
            <!-- Mini Gauges Row -->
            <div class="mini-gauges-container">
              <!-- Fuel Gauge (Milestone Time Remaining) -->
              <div class="mini-gauge fuel" title="MILESTONE FUEL: Working hours remaining until deadline. Tracks time buffer as percentage of total milestone duration. RED ZONE (first 10%) = critical reserve, immediate action needed. E=Empty (deadline passed), F=Full (100% buffer). Value shows hours remaining.">
                <div class="mini-gauge-wrapper">
                  <canvas id="fuelGaugeCanvas" class="mini-gauge-canvas" width="68" height="68"></canvas>
                  <div class="mini-gauge-icon">
                    <svg viewBox="0 0 24 24"><path d="M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33 0 1.38 1.12 2.5 2.5 2.5.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v16h10v-7.5h1.5v5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V9c0-.69-.28-1.32-.73-1.77zM12 10H6V5h6v5z"/></svg>
                  </div>
                  <div class="mini-gauge-labels">
                    <span class="mini-gauge-label low">E</span>
                    <span class="mini-gauge-label high">F</span>
                  </div>
                </div>
                <div class="mini-gauge-title">Fuel</div>
                <div class="mini-gauge-value" id="fuelGaugeText">--h</div>
              </div>

              <!-- Execution Pressure Gauge -->
              <div class="mini-gauge temp" title="EXECUTION PRESSURE: How hard you need to push to meet the deadline. Formula: Required velocity  Current velocity. LOW (blue) = on track, HIGH (red) = falling behind. Over 100% means current pace won't meet the deadline. Colors: BLUE <70%, ORANGE 70-85%, RED >85%.">
                <div class="mini-gauge-wrapper">
                  <canvas id="tempGaugeCanvas" class="mini-gauge-canvas" width="68" height="68"></canvas>
                  <div class="mini-gauge-icon">
                    <svg viewBox="0 0 24 24"><path d="M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4zm-4-8c0-.55.45-1 1-1s1 .45 1 1h-1v1h1v2h-1v1h1v2h-2V5z"/></svg>
                  </div>
                  <div class="mini-gauge-labels">
                    <span class="mini-gauge-label low">L</span>
                    <span class="mini-gauge-label high">H</span>
                  </div>
                </div>
                <div class="mini-gauge-title">Pressure</div>
                <div class="mini-gauge-value" id="tempGaugeText">0%</div>
              </div>

              <!-- Delivery Confidence Gauge -->
              <div class="mini-gauge oil" title="DELIVERY CONFIDENCE: Likelihood of meeting the milestone on time. Capped at 99% (always residual risk). Aligns with Milestone Confidence label: HIGH (70-99%) = on track, MEDIUM (40-69%) = caution needed, LOW (0-39%) = at risk. Factors: velocity, schedule buffer, execution pressure.">
                <div class="mini-gauge-wrapper">
                  <canvas id="oilGaugeCanvas" class="mini-gauge-canvas" width="68" height="68"></canvas>
                  <div class="mini-gauge-icon">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                  </div>
                  <div class="mini-gauge-labels">
                    <span class="mini-gauge-label low">L</span>
                    <span class="mini-gauge-label high">H</span>
                  </div>
                </div>
                <div class="mini-gauge-title">Confidence</div>
                <div class="mini-gauge-value" id="oilGaugeText">--%</div>
              </div>

              <!-- Quality Control Gauge -->
              <div class="mini-gauge rpm" title="QUALITY CONTROL: Reliability of the development tracking process. Measures: progress tracking consistency, data freshness, background process health, metric calculation accuracy. HIGH (75-95%) = reliable tracking, FAIR (50-74%) = minor gaps, LOW (<50%) = tracking issues need attention. Capped at 95%.">
                <div class="mini-gauge-wrapper">
                  <canvas id="rpmGaugeCanvas" class="mini-gauge-canvas" width="68" height="68"></canvas>
                  <div class="mini-gauge-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                  </div>
                  <div class="mini-gauge-labels">
                    <span class="mini-gauge-label low">L</span>
                    <span class="mini-gauge-label high">H</span>
                  </div>
                </div>
                <div class="mini-gauge-title">Quality</div>
                <div class="mini-gauge-value" id="rpmGaugeText">--%</div>
              </div>
            </div>
            <div class="milestone-dates-container">
              <span class="milestone-date-label">Milestone Start / End</span>
              <input type="date" class="milestone-date-input" id="milestoneStartDate" value="2025-12-21" onchange="updateMilestoneDates()" title="Start Date">
              <span class="milestone-date-separator"></span>
              <input type="date" class="milestone-date-input" id="milestoneEndDate" value="2025-12-31" onchange="updateMilestoneDates()" title="End Date">
            </div>
          </div>

          <!-- RIGHT PANEL: Progress Made -->
          <div class="velocity-side-panel right-panel">
            <div class="panel-header">
              <div class="panel-icon circular-check">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
              </div>
              <span class="panel-title">Progress Made</span>
            </div>
            <div class="panel-stats progress-stats compact-stats">
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">Completed Tasks</span>
                <span class="panel-stat-value success-glow" id="panelCompletedTasks">0</span>
              </div>
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">Lines of Code</span>
                <span class="panel-stat-value success-glow" id="panelLOC">0</span>
              </div>
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">API Endpoints</span>
                <span class="panel-stat-value success-glow" id="panelAPIs">0</span>
              </div>
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">DB Tables</span>
                <span class="panel-stat-value success-glow" id="panelTables">0</span>
              </div>
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">Est. Human Hours (EHH)</span>
                <span class="panel-stat-value success-glow" id="panelEHH">0</span>
              </div>
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">Completed Work (CW+)</span>
                <span class="panel-stat-value success-glow" id="panelCompletedWork">0</span>
              </div>
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">Work Efficiency (%)</span>
                <span class="panel-stat-value success-glow" id="panelWorkEfficiency">0%</span>
              </div>
              <div class="panel-stat-item success-indicator">
                <span class="panel-stat-label">Timeline Burst</span>
                <span class="panel-stat-value success-glow" id="panelTimelineBurst">--/--/----</span>
              </div>
            </div>
            <div class="panel-total success-total">
              <div class="panel-total-value success-glow panel-value-delivered" id="panelValueDelivered">$0</div>
              <div class="panel-total-label">Value Delivered</div>
              <div class="panel-actual-cost" id="panelActualCost">Actual Cost: $0</div>
            </div>
          </div>
        </div><!-- END velocity-dashboard -->
        </div><!-- END view-analytics -->

        <!-- ==================== TASKS VIEW - THREE COLUMN LAYOUT ==================== -->
        <div class="tasks-view-container" id="tasksViewContainer">
          <!-- LEFT COLUMN: Task Queue -->
          <div class="task-queue-column">
            <div class="task-queue-header">
              <h3 class="task-queue-title">Jubilee: Project Manager</h3>
              <div class="task-view-toggle">
                <span class="toggle-label archive-label" id="archiveLabel">ARCHIVE</span>
                <div class="view-toggle-switch" id="viewToggleSwitch">
                  <div class="toggle-knob"></div>
                </div>
                <span class="toggle-label open-label active" id="openLabel">OPEN</span>
              </div>
              <!-- Hidden select for backwards compatibility -->
              <select id="taskQueueFilter" class="task-queue-filter-select" style="display: none;">
                <option value="open">Open Tasks</option>
                <option value="archive">Archive</option>
              </select>
            </div>
            <div class="task-queue-header-divider"></div>
            <div class="task-queue-list" id="taskQueueList">
              <!-- Task queue items will be populated by JavaScript -->
              <div class="task-queue-loading">
                <div class="loading-spinner"></div>
                <span>Loading tasks...</span>
              </div>
            </div>
            <!-- Sticky Footer with Totals -->
            <div class="task-queue-footer" id="taskQueueFooter">
              <span class="footer-total" id="footerTotal">TOTAL: 00.00 EHH (0 TASKS)</span>
            </div>
          </div>

          <!-- CENTER COLUMN: Task Detail/Edit Panel -->
          <div class="task-detail-column">
            <div class="task-detail-empty" id="taskDetailEmpty">
              <svg viewBox="0 0 24 24" class="empty-icon"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
              <span>Select a task to view details</span>
            </div>
            <div class="task-detail-content" id="taskDetailContent" style="display: none;">
              <div class="task-detail-header">
                <div class="task-detail-id-badge" id="detailTaskId">TASK-001</div>
                <div class="task-detail-status-badge" id="detailStatusBadge">In Progress</div>
              </div>
              <div class="task-detail-divider"></div>
              <div class="task-detail-form">
                <div class="detail-form-group">
                  <label class="detail-label">Title</label>
                  <input type="text" class="detail-input" id="detailTitle" placeholder="Task title">
                </div>
                <div class="detail-form-group">
                  <label class="detail-label">Description</label>
                  <textarea class="detail-textarea" id="detailDescription" placeholder="Task description"></textarea>
                </div>
                <div class="detail-form-row">
                  <div class="detail-form-group">
                    <label class="detail-label">Type</label>
                    <select class="detail-select" id="detailType">
                      <option value="development">Development</option>
                      <option value="bug">Bug</option>
                      <option value="enhancement">Enhancement</option>
                      <option value="operational">Operational</option>
                    </select>
                  </div>
                  <div class="detail-form-group">
                    <label class="detail-label">Priority</label>
                    <select class="detail-select" id="detailPriority">
                      <option value="low">Low</option>
                      <option value="medium">Medium</option>
                      <option value="high">High</option>
                      <option value="critical">Critical</option>
                    </select>
                  </div>
                </div>
                <div class="detail-form-row">
                  <div class="detail-form-group">
                    <label class="detail-label">Status</label>
                    <select class="detail-select" id="detailStatus">
                      <option value="submitted">Submitted</option>
                      <option value="in_review">In Review</option>
                      <option value="in_progress">In Progress</option>
                      <option value="fixing">Fixing</option>
                      <option value="completed">Completed</option>
                    </select>
                  </div>
                  <div class="detail-form-group">
                    <label class="detail-label">Component</label>
                    <input type="text" class="detail-input" id="detailComponent" placeholder="e.g., chat, billing">
                  </div>
                </div>
                <div class="detail-form-group">
                  <label class="detail-label">Effort (HEH)</label>
                  <input type="number" class="detail-input" id="detailEffort" placeholder="Estimated hours" step="0.5" min="0">
                </div>
                <div class="detail-form-group">
                  <label class="detail-label">Internal Notes</label>
                  <textarea class="detail-textarea small" id="detailNotes" placeholder="Admin-only notes"></textarea>
                </div>
                <div class="detail-actions">
                  <button class="detail-btn save" id="detailSaveBtn">Save Changes</button>
                  <button class="detail-btn cancel" id="detailCancelBtn">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Resizable divider between detail and context columns -->
          <div class="panel-resize-handle" id="panelResizeHandle"></div>

          <!-- RIGHT COLUMN: Task Edit Panel (1/3 width) -->
          <div class="task-context-column" id="taskContextColumn">
            <div class="task-edit-empty" id="taskEditEmpty">
              <svg viewBox="0 0 24 24" class="empty-icon"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
              <span>Select a task to edit</span>
            </div>
            <div class="task-edit-content" id="taskEditContent" style="display: none;">
              <!-- Task Header with Back/Next Navigation -->
              <div class="task-edit-header">
                <div class="task-edit-id" id="taskEditId">JTX000001</div>
                <div class="task-edit-nav-buttons">
                  <button class="task-nav-btn back" id="taskBackBtn">Back</button>
                  <button class="task-nav-btn next" id="taskNextBtn">Next</button>
                </div>
              </div>
              <div class="task-edit-header-divider"></div>

              <!-- Auto-save indicator -->
              <div class="autosave-indicator" id="autosaveIndicator">
                <span class="autosave-saving">Saving...</span>
                <span class="autosave-saved">Saved</span>
              </div>

              <!-- Task Edit Form -->
              <div class="task-edit-form">
                <div class="edit-field">
                  <label class="edit-label">Title</label>
                  <input type="text" class="edit-input" id="taskEditTitle" placeholder="Task title" data-autosave="true">
                </div>

                <div class="edit-field">
                  <label class="edit-label">Task Description</label>
                  <textarea class="edit-textarea" id="taskEditDescription" placeholder="Original instructions, requirements, and clarifications" data-autosave="true"></textarea>
                </div>

                <div class="edit-field-row">
                  <div class="edit-field">
                    <label class="edit-label">Type</label>
                    <select class="edit-select" id="taskEditType" data-autosave="true">
                      <option value="development">Development</option>
                      <option value="bug">Bug</option>
                      <option value="enhancement">Enhancement</option>
                      <option value="operational">Operational</option>
                    </select>
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Priority</label>
                    <select class="edit-select" id="taskEditPriority" data-autosave="true">
                      <option value="low">Low</option>
                      <option value="medium">Medium</option>
                      <option value="high">High</option>
                      <option value="critical">Critical</option>
                    </select>
                  </div>
                </div>

                <div class="edit-field-row">
                  <div class="edit-field">
                    <label class="edit-label">Status</label>
                    <select class="edit-select" id="taskEditStatus" data-autosave="true">
                      <option value="submitted">Submitted</option>
                      <option value="developing">Developing</option>
                      <option value="reviewing">Reviewing</option>
                      <option value="rework">Rework</option>
                      <option value="documenting">Documenting</option>
                      <option value="approving">Approving</option>
                      <option value="completed">Completed</option>
                    </select>
                  </div>
                  <div class="edit-field">
                    <label class="edit-label">Page/Component</label>
                    <input type="text" class="edit-input" id="taskEditComponent" placeholder="e.g., admin-tasks, chat" data-autosave="true">
                  </div>
                </div>

                <div class="edit-field">
                  <label class="edit-label">Est. Human-Only Hours (EHH)</label>
                  <input type="number" class="edit-input" id="taskEditEffort" placeholder="Estimated hours" step="0.5" min="0" data-autosave="true">
                </div>

                <div class="edit-field">
                  <label class="edit-label">Completed Work (Human+AI)</label>
                  <input type="number" class="edit-input" id="taskEditCompletedWork" placeholder="Actual hours with AI" step="0.1" min="0.1" data-autosave="true">
                </div>
              </div>

              <!-- Session Documentation Summary -->
              <div class="session-documentation" id="sessionDocumentation">
                <div class="session-doc-header">
                  <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                  <span>Task Documentation</span>
                </div>
                <div class="session-doc-metrics">
                  <div class="session-doc-metric ehh">
                    <div class="session-doc-metric-label">Est. Human Hours</div>
                    <div class="session-doc-metric-value" id="sessionDocEHH">--<span class="session-doc-metric-unit">hrs</span></div>
                  </div>
                  <div class="session-doc-metric cw">
                    <div class="session-doc-metric-label">Completed Work</div>
                    <div class="session-doc-metric-value" id="sessionDocCW">--<span class="session-doc-metric-unit">hrs</span></div>
                  </div>
                </div>
                <div class="session-doc-efficiency">
                  <span class="session-doc-efficiency-label">Efficiency:</span>
                  <span class="session-doc-efficiency-value" id="sessionDocEfficiency">--</span>
                  <span class="session-doc-efficiency-mult" id="sessionDocMultiplier">(--x faster)</span>
                </div>
              </div>

              <!-- Work History / Activity Log -->
              <div class="work-history-section">
                <div class="work-history-header">
                  <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                  <span>Work History</span>
                  <span class="work-history-total-duration" id="workHistoryDuration"></span>
                </div>
                <div class="work-history-list" id="workHistoryList">
                  <div class="work-history-empty">No activity yet</div>
                </div>
              </div>

              <!-- Delete Button (only visible for non-completed tasks) -->
              <div class="task-edit-actions" id="taskEditActions">
                <button class="edit-action-btn delete" id="taskEditDeleteBtn">
                  <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                  Delete Task
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- ==================== END TASKS VIEW ==================== -->

        <!-- ==================== QA TESTS VIEW ==================== -->
        <div class="qa-view-container">
          <!-- QA Tests Header -->
          <div class="qa-header">
            <div class="qa-header-left">
              <h2 class="qa-title">QA Tests</h2>
            </div>
            <div class="qa-header-right">
              <div class="qa-execution-status" id="qaExecutionStatus"></div>
              <button class="qa-run-btn" id="qaRunAllBtn">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                Run All
              </button>
            </div>
          </div>

          <!-- QA Tests Categories Container -->
          <div class="qa-categories-container" id="qaCategoriesContainer">
            <div class="qa-loading-state" id="qaLoadingState">
              <div class="loading-spinner"></div>
              <span>Loading QA tests...</span>
            </div>
          </div>

          <!-- AI Communication Section (rendered dynamically when there are failures) -->
          <div id="qaAiMessageContainer"></div>
        </div>
        <!-- ==================== END QA TESTS VIEW ==================== -->

      </div>

      <!-- Right Control Panel - Navigation for Views (Dashboard, Tasks, QA Tests) -->
      <div class="tasks-control-panel">
        <!-- Dashboard View (Primary - default view, shows velocity gauges and analytics) -->
        <button class="control-btn active" data-view="dashboard" title="Dashboard - Velocity & Analytics">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
          <span class="control-btn-label">Dashboard</span>
        </button>
        <!-- Tasks View (shows task queue with full operational controls) -->
        <button class="control-btn" data-view="tasks" title="Task Queue - Operational View">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
          <span class="control-btn-label">Tasks</span>
        </button>
        <!-- QA Tests View (Third - shows QA test management) -->
        <button class="control-btn" data-view="qa" title="QA Tests">
          <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM10 17l-3.5-3.5 1.41-1.41L10 14.17l4.59-4.59L16 11l-6 6z"/></svg>
          <span class="control-btn-label">QA Tests</span>
        </button>

        <!-- Spacer to push refresh button to bottom -->
        <div class="control-panel-spacer"></div>

        <!-- Refresh Button - Forces full recalculation of all metrics -->
        <button class="refresh-btn" id="refreshDashboardBtn" title="Refresh - Recalculate all metrics">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          <span class="refresh-btn-label">Refresh</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Create/Edit Task Modal -->
  <div class="modal-overlay" id="taskModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">New Task</div>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <form id="taskForm">
          <input type="hidden" id="taskId">
          <div class="form-group">
            <label class="form-label">Title *</label>
            <input type="text" class="form-input" id="taskTitle" required placeholder="Brief description of the task">
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="taskDescription" placeholder="Detailed description of the task"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Type</label>
              <select class="form-select" id="taskType">
                <option value="development">Development</option>
                <option value="bug">Bug</option>
                <option value="enhancement">Enhancement</option>
                <option value="operational">Operational</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Priority</label>
              <select class="form-select" id="taskPriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Component</label>
              <input type="text" class="form-input" id="taskComponent" placeholder="e.g., chat, personas, billing">
            </div>
            <div class="form-group">
              <label class="form-label">Assigned To</label>
              <select class="form-select" id="taskAssignee">
                <option value="">Unassigned</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Internal Notes</label>
            <textarea class="form-textarea" id="taskNotes" placeholder="Notes visible only to admins"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" id="btnCancelTask">Cancel</button>
        <button type="submit" class="btn-submit" id="btnSubmitTask">Create Task</button>
      </div>
    </div>
  </div>

  <!-- Status Change Modal -->
  <div class="modal-overlay" id="statusModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <div class="modal-title">Change Status</div>
        <button class="modal-close" id="statusModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="statusTaskId">
        <div class="status-options" id="statusOptions"></div>
        <div class="form-group" style="margin-top: 16px;">
          <label class="form-label">Comment (optional)</label>
          <textarea class="form-textarea" id="statusComment" placeholder="Add a comment for this status change" style="min-height: 60px;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" id="btnCancelStatus">Cancel</button>
        <button type="button" class="btn-submit" id="btnSubmitStatus">Update Status</button>
      </div>
    </div>
  </div>

  <!-- Right Sliding Edit Panel -->
  <div class="edit-panel-overlay" id="editPanelOverlay"></div>
  <div class="edit-panel-container" id="editPanelContainer">
    <div class="edit-panel-resize-handle" id="editPanelResizeHandle"></div>
    <div class="edit-panel">
      <div class="edit-panel-header">
        <div class="edit-panel-title">
          <span id="editPanelTitle">Edit Task</span>
          <span class="edit-panel-task-id" id="editPanelTaskId"></span>
        </div>
        <button class="edit-panel-close" id="editPanelClose">&times;</button>
      </div>
      <div class="edit-panel-body">
        <form id="editPanelForm">
          <input type="hidden" id="editTaskId">

          <div class="edit-form-group">
            <label class="edit-form-label">Title *</label>
            <input type="text" class="edit-form-input" id="editTaskTitle" required>
          </div>

          <div class="edit-form-group">
            <label class="edit-form-label">Description</label>
            <textarea class="edit-form-textarea" id="editTaskDescription" rows="3"></textarea>
          </div>

          <div class="edit-form-row">
            <div class="edit-form-group">
              <label class="edit-form-label">Type</label>
              <select class="edit-form-select" id="editTaskType">
                <option value="development">Development</option>
                <option value="bug">Bug</option>
                <option value="enhancement">Enhancement</option>
                <option value="operational">Operational</option>
              </select>
            </div>
            <div class="edit-form-group">
              <label class="edit-form-label">Priority</label>
              <select class="edit-form-select" id="editTaskPriority">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </div>
          </div>

          <div class="edit-form-row">
            <div class="edit-form-group">
              <label class="edit-form-label">Status</label>
              <select class="edit-form-select" id="editTaskStatus">
                <option value="submitted">Submitted</option>
                <option value="in_review">In Review</option>
                <option value="in_progress">In Progress</option>
                <option value="fixing">Fixing</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div class="edit-form-group">
              <label class="edit-form-label">Component</label>
              <input type="text" class="edit-form-input" id="editTaskComponent" placeholder="e.g., chat, admin">
            </div>
          </div>

          <div class="edit-form-group">
            <label class="edit-form-label">Assigned To</label>
            <select class="edit-form-select" id="editTaskAssignee">
              <option value="">Unassigned</option>
            </select>
          </div>

          <div class="edit-form-group">
            <label class="edit-form-label">Internal Notes</label>
            <textarea class="edit-form-textarea" id="editTaskNotes" rows="2" placeholder="Admin-only notes"></textarea>
          </div>

          <div class="edit-form-group">
            <label class="edit-form-label">Resolution</label>
            <textarea class="edit-form-textarea" id="editTaskResolution" rows="2" placeholder="How was this task resolved?"></textarea>
          </div>

          <!-- Metadata Section -->
          <div class="edit-metadata-section">
            <div class="edit-metadata-title">Task Metadata</div>
            <div class="edit-metadata-grid">
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Created By</span>
                <span class="edit-metadata-value" id="editMetaCreatedBy">-</span>
              </div>
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Created At</span>
                <span class="edit-metadata-value" id="editMetaCreatedAt">-</span>
              </div>
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Submitted At</span>
                <span class="edit-metadata-value" id="editMetaSubmittedAt">-</span>
              </div>
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Updated At</span>
                <span class="edit-metadata-value" id="editMetaUpdatedAt">-</span>
              </div>
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Reviewed At</span>
                <span class="edit-metadata-value" id="editMetaReviewedAt">-</span>
              </div>
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Started At</span>
                <span class="edit-metadata-value" id="editMetaStartedAt">-</span>
              </div>
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Fixing At</span>
                <span class="edit-metadata-value" id="editMetaFixingAt">-</span>
              </div>
              <div class="edit-metadata-item">
                <span class="edit-metadata-label">Completed At</span>
                <span class="edit-metadata-value" id="editMetaCompletedAt">-</span>
              </div>
            </div>
          </div>

          <!-- Status History Section -->
          <div class="status-history-section" id="statusHistorySection" style="display: none;">
            <div class="status-history-title">Status History</div>
            <div class="status-history-list" id="statusHistoryList"></div>
          </div>
        </form>
      </div>
      <div class="edit-panel-footer">
        <div class="edit-panel-actions-left">
          <button type="button" class="btn-panel-delete" id="btnPanelDelete">Delete</button>
        </div>
        <div class="edit-panel-actions-right">
          <button type="button" class="btn-panel-cancel" id="btnPanelCancel">Cancel</button>
          <button type="button" class="btn-panel-save" id="btnPanelSave">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      // ==================== PAGE LOAD REVEAL ANIMATION ====================
      // Animates the green and red vertical lines from center outward
      // with a coordinated "ta-da" style reveal of the dashboard panels
      const IntroAnimation = (function() {
        const INITIAL_DELAY = 1000;     // ms before animation starts (1 second wait)
        const COMPLETE_DELAY = 1800;    // ms before marking animation complete
        const FADE_OUT_DELAY = 600;     // ms for lines to fade out smoothly

        function init() {
          const dashboard = document.getElementById('velocityDashboard');
          if (!dashboard) {
            console.warn('[IntroAnimation] Dashboard element not found');
            return;
          }

          // Ensure intro-state class is set (should be in HTML)
          if (!dashboard.classList.contains('intro-state')) {
            dashboard.classList.add('intro-state');
          }

          // Start animation after initial delay
          setTimeout(function() {
            // Trigger the slide-out animation
            dashboard.classList.remove('intro-state');
            dashboard.classList.add('intro-animating');

            // Mark animation complete after slide-out finishes
            setTimeout(function() {
              // Add complete class while keeping animating to prevent flicker
              dashboard.classList.add('intro-complete');

              // Remove animating class after a frame to ensure smooth transition
              requestAnimationFrame(function() {
                dashboard.classList.remove('intro-animating');
              });

              // Clean up reveal lines after they've fully faded out
              setTimeout(function() {
                const lines = dashboard.querySelectorAll('.reveal-line');
                lines.forEach(function(line) {
                  line.style.display = 'none';
                });
              }, FADE_OUT_DELAY);
            }, COMPLETE_DELAY);
          }, INITIAL_DELAY);
        }

        // Run on DOM ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          // DOM already loaded
          init();
        }

        return { init: init };
      })();

      // ==================== AUTOMOTIVE SPEEDOMETER COMPONENT ====================
      const VelocityGauge = (function() {
        let canvas, ctx;
        let currentValue = 0;
        let targetValue = 0;
        let animationFrame = null;
        let wigglePhase = 0;
        let isWiggling = false;
        let isStabilized = false;  // After 10 seconds, needle becomes stable
        let stabilizationTimer = null;
        let currentVibrationOffset = 0;
        // FIXED scale of 0-120 for this version - no auto-scaling
        const maxScale = 120;
        const STABILIZATION_DELAY = 10000; // 10 seconds before needle stabilizes

        // Fixed tick label values for 0-120 scale
        const FIXED_TICK_LABELS = [0, 20, 40, 60, 80, 100, 120];

        // No auto-scaling - fixed at 120
        function getAppropriateScale(wphValue) {
          return maxScale; // Always return 120
        }

        // No-op since scale is fixed
        function setMaxScale(newMax) {
          // Scale is fixed at 120 - ignore requests to change
          console.log('[VelocityGauge] Scale is fixed at 120, ignoring request to change to', newMax);
        }

        // Speedometer configuration - Automotive style
        // 0 at lower-left, 120 at lower-right, sweeping arc
        // Updated for 340x260 canvas with full arc visibility
        const config = {
          centerX: 170,
          centerY: 155,  // Adjusted for 260px canvas height
          radius: 120,
          // Arc from lower-left to lower-right with full visibility
          startAngle: Math.PI * 0.80,   // Lower-left position
          endAngle: Math.PI * 0.20,     // Lower-right position
          sweepAngle: Math.PI * 1.40,   // 252 total sweep
          arcWidth: 14,
          needleLength: 85,
          baseline: 40
        };

        // Colors - Gold labels, white ticks/minor, red zone
        const colors = {
          arcBg: 'rgba(40, 40, 40, 0.8)',
          arcGlow: 'rgba(255, 189, 89, 0.15)',
          tickMajor: '#ffffff',
          tickMinor: 'rgba(255, 255, 255, 0.5)',
          labelMajor: '#ffbd59',  // Gold for major labels
          labelMinor: '#ffffff',   // White for minor
          needle: '#ffbd59',
          needleGlow: 'rgba(255, 189, 89, 0.6)',
          centerHub: '#222',
          centerRing: '#ffbd59',
          redZone: 'rgba(220, 38, 38, 0.4)',
          redZoneBorder: 'rgba(220, 38, 38, 0.8)'
        };

        function init(canvasId) {
          canvas = document.getElementById(canvasId);
          if (!canvas) return false;
          ctx = canvas.getContext('2d');
          drawGauge();
          return true;
        }

        // Convert value (0-120) to angle on the arc
        function valueToAngle(value) {
          const clampedValue = Math.max(0, Math.min(value, maxScale));
          const ratio = clampedValue / maxScale;
          // Sweep from startAngle (lower-left) clockwise through top to endAngle (lower-right)
          return config.startAngle + (ratio * config.sweepAngle);
        }

        function drawGauge() {
          const { centerX, centerY, radius, startAngle, sweepAngle, arcWidth } = config;
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Outer glow ring
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius + 4, startAngle, startAngle + sweepAngle, false);
          ctx.strokeStyle = colors.arcGlow;
          ctx.lineWidth = arcWidth + 12;
          ctx.lineCap = 'round';
          ctx.stroke();

          // Main arc background
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, startAngle, startAngle + sweepAngle, false);
          ctx.strokeStyle = colors.arcBg;
          ctx.lineWidth = arcWidth;
          ctx.lineCap = 'round';
          ctx.stroke();

          // Yellow glow around the dome arc (50% increased intensity)
          ctx.save();
          ctx.shadowColor = '#fbbf24';
          ctx.shadowBlur = 23;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 0;
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius + arcWidth/2 + 3, startAngle, startAngle + sweepAngle, false);
          ctx.strokeStyle = 'rgba(251, 191, 36, 0.9)';
          ctx.lineWidth = 12;
          ctx.lineCap = 'round';
          ctx.stroke();
          ctx.restore();

          // Yellow outer edge line around the arc (except bottom opening) - 5px thick
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius + arcWidth/2 + 3, startAngle, startAngle + sweepAngle, false);
          ctx.strokeStyle = '#fbbf24';
          ctx.lineWidth = 5;
          ctx.lineCap = 'round';
          ctx.stroke();

          // Black separator line (3px) outside the yellow line - increased by 2px for depth
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius + arcWidth/2 + 7, startAngle, startAngle + sweepAngle, false);
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 3;
          ctx.lineCap = 'round';
          ctx.stroke();

          // Second yellow accent line (1px) outside the black separator
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius + arcWidth/2 + 10, startAngle, startAngle + sweepAngle, false);
          ctx.strokeStyle = '#fbbf24';
          ctx.lineWidth = 1;
          ctx.lineCap = 'round';
          ctx.stroke();

          // Red zone from 100-120 (fixed warning zone)
          const redZoneStart = 100;  // Fixed at 100
          const redStartAngle = valueToAngle(redZoneStart);
          const redEndAngle = valueToAngle(maxScale);
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, redStartAngle, redEndAngle, false);
          ctx.strokeStyle = colors.redZone;
          ctx.lineWidth = arcWidth + 2;
          ctx.lineCap = 'butt';
          ctx.stroke();

          // Red zone border
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius + arcWidth/2 + 1, redStartAngle, redEndAngle, false);
          ctx.strokeStyle = colors.redZoneBorder;
          ctx.lineWidth = 2;
          ctx.stroke();

          // Draw ticks and labels
          drawTicks();

          // Draw needle with random vibration effect (+1.3 to -3.9 points, 30% increase)
          // BUT: After stabilization, needle holds steady at exact value
          if (isStabilized) {
            currentVibrationOffset = 0;
          } else {
            currentVibrationOffset = isWiggling ? (Math.random() * 5.2 - 3.9) : 0;
          }
          const displayValue = currentValue + currentVibrationOffset;
          drawNeedle(displayValue);

          // Update the displayed value to match needle movement (only if not stabilized)
          if (isWiggling && !isStabilized) {
            updateDisplayValue(displayValue);
          }

          // Draw center hub
          drawCenterHub();
        }

        function drawTicks() {
          const { centerX, centerY, radius, arcWidth } = config;

          // Fixed tick labels: 0, 20, 40, 60, 80, 100, 120
          const labelValues = FIXED_TICK_LABELS;
          const labelSet = new Set(labelValues);

          // Minor tick interval of 10
          const tickInterval = 10;

          // Draw major ticks and labels at fixed positions
          for (const value of labelValues) {
            const angle = valueToAngle(value);

            // Tick dimensions
            const tickOuterRadius = radius + arcWidth/2 + 2;
            const tickInnerRadius = radius - arcWidth/2 - 10;

            // Draw major tick
            ctx.beginPath();
            ctx.moveTo(
              centerX + Math.cos(angle) * tickInnerRadius,
              centerY + Math.sin(angle) * tickInnerRadius
            );
            ctx.lineTo(
              centerX + Math.cos(angle) * tickOuterRadius,
              centerY + Math.sin(angle) * tickOuterRadius
            );
            ctx.strokeStyle = colors.tickMajor;
            ctx.lineWidth = 2.5;
            ctx.lineCap = 'round';
            ctx.stroke();

            // Draw label
            const labelRadius = radius - arcWidth/2 - 22;
            const labelX = centerX + Math.cos(angle) * labelRadius;
            const labelY = centerY + Math.sin(angle) * labelRadius;

            ctx.font = 'bold 14px Monaco, Menlo, monospace';
            // Color coding: 100 and 120 are yellow
            ctx.fillStyle = (value === 120 || value === 100) ? '#fbbf24' : colors.labelMajor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(value.toString(), labelX, labelY);
          }

          // Draw minor ticks at 10-unit intervals
          for (let i = tickInterval; i < maxScale; i += tickInterval) {
            // Skip if this is already a labeled major tick
            if (labelSet.has(i)) continue;

            const angle = valueToAngle(i);
            const tickOuterRadius = radius + arcWidth/2;
            const tickInnerRadius = radius - arcWidth/2 - 4;

            ctx.beginPath();
            ctx.moveTo(
              centerX + Math.cos(angle) * tickInnerRadius,
              centerY + Math.sin(angle) * tickInnerRadius
            );
            ctx.lineTo(
              centerX + Math.cos(angle) * tickOuterRadius,
              centerY + Math.sin(angle) * tickOuterRadius
            );
            ctx.strokeStyle = colors.tickMinor;
            ctx.lineWidth = 1;
            ctx.lineCap = 'round';
            ctx.stroke();
          }
        }

        function drawNeedle(value) {
          const { centerX, centerY, needleLength } = config;
          const angle = valueToAngle(value);

          // Needle shadow/glow
          ctx.save();
          ctx.shadowColor = colors.needleGlow;
          ctx.shadowBlur = 15;

          // Needle body (tapered)
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);

          // Create tapered needle shape
          const tipX = centerX + Math.cos(angle) * needleLength;
          const tipY = centerY + Math.sin(angle) * needleLength;
          const baseWidth = 8;
          const perpAngle = angle + Math.PI / 2;

          ctx.moveTo(
            centerX + Math.cos(perpAngle) * baseWidth/2,
            centerY + Math.sin(perpAngle) * baseWidth/2
          );
          ctx.lineTo(tipX, tipY);
          ctx.lineTo(
            centerX - Math.cos(perpAngle) * baseWidth/2,
            centerY - Math.sin(perpAngle) * baseWidth/2
          );
          ctx.closePath();

          ctx.fillStyle = colors.needle;
          ctx.fill();
          ctx.restore();

          // Needle stroke
          ctx.strokeStyle = 'rgba(0,0,0,0.3)';
          ctx.lineWidth = 1;
          ctx.stroke();
        }

        function drawCenterHub() {
          const { centerX, centerY } = config;

          // Outer ring glow
          ctx.beginPath();
          ctx.arc(centerX, centerY, 18, 0, 2 * Math.PI);
          ctx.fillStyle = 'rgba(255, 189, 89, 0.2)';
          ctx.fill();

          // Center hub
          ctx.beginPath();
          ctx.arc(centerX, centerY, 14, 0, 2 * Math.PI);
          const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 14);
          gradient.addColorStop(0, '#444');
          gradient.addColorStop(1, '#1a1a1a');
          ctx.fillStyle = gradient;
          ctx.fill();

          // Gold ring
          ctx.beginPath();
          ctx.arc(centerX, centerY, 14, 0, 2 * Math.PI);
          ctx.strokeStyle = colors.centerRing;
          ctx.lineWidth = 2;
          ctx.stroke();

          // Inner highlight
          ctx.beginPath();
          ctx.arc(centerX, centerY, 6, 0, 2 * Math.PI);
          ctx.fillStyle = '#333';
          ctx.fill();
        }

        let wiggleFrameCount = 0;
        function startWiggle() {
          if (isWiggling) return;
          isWiggling = true;
          isStabilized = false;  // Reset stabilization when starting new animation
          wiggleFrameCount = 0;

          // Clear any existing stabilization timer
          if (stabilizationTimer) {
            clearTimeout(stabilizationTimer);
          }

          // Set up stabilization timer - after 10 seconds, needle becomes stable
          stabilizationTimer = setTimeout(() => {
            stabilize();
          }, STABILIZATION_DELAY);

          function wiggle() {
            if (!isWiggling) return;
            wiggleFrameCount++;
            // Only update every 20th frame (80% slower than previous)
            if (wiggleFrameCount % 20 === 0) {
              drawGauge();
            }
            requestAnimationFrame(wiggle);
          }
          wiggle();
        }

        function stopWiggle() {
          isWiggling = false;
          if (stabilizationTimer) {
            clearTimeout(stabilizationTimer);
            stabilizationTimer = null;
          }
          drawGauge();
        }

        // Stabilize the needle - stop oscillation and hold at exact value
        function stabilize() {
          isStabilized = true;
          isWiggling = false;
          currentVibrationOffset = 0;
          drawGauge();
          updateDisplayValue(currentValue);  // Show exact value
          console.log('Velocity gauge stabilized at', currentValue, 'WPH');
        }

        function animateTo(value) {
          targetValue = Math.min(value, maxScale);

          if (animationFrame) {
            cancelAnimationFrame(animationFrame);
          }

          // If already stabilized and receiving a new value, briefly animate then re-stabilize
          const wasStabilized = isStabilized;
          if (wasStabilized) {
            isStabilized = false;  // Temporarily un-stabilize for animation
          }

          // Start wiggle during animation
          startWiggle();

          function animate() {
            const diff = targetValue - currentValue;
            const step = diff * 0.06; // Smooth easing

            if (Math.abs(diff) < 0.3) {
              currentValue = targetValue;
              drawGauge();
              updateDisplayValue(currentValue);

              // If this was a value update after initial stabilization,
              // re-stabilize after a short easing period (2 seconds)
              if (wasStabilized) {
                setTimeout(() => {
                  stabilize();
                }, 2000);
              }
              return;
            }

            currentValue += step;
            drawGauge();
            updateDisplayValue(Math.round(currentValue));
            animationFrame = requestAnimationFrame(animate);
          }

          animate();
        }

        function updateDisplayValue(value) {
          const display = document.getElementById('speedometerValue');
          if (display) {
            // Format with no decimal places for WPH display
            const formattedValue = Math.round(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            display.innerHTML = formattedValue + '<span class="speedometer-wph-label">WPH</span>';
          }
        }

        function setValue(value) {
          // Log calculation inputs
          console.log('[VelocityGauge] setValue called with WPH:', value);
          console.log('[VelocityGauge] Current maxScale:', maxScale);

          // Check if we need to rescale
          const newScale = getAppropriateScale(value);
          if (newScale !== maxScale) {
            console.log('[VelocityGauge] Auto-rescaling required:', maxScale, '->', newScale);
            setMaxScale(newScale);
          }

          console.log('[VelocityGauge] Animating to:', value, '(max:', maxScale, ')');
          animateTo(value);
        }

        function setValueInstant(value) {
          console.log('[VelocityGauge] setValueInstant called with WPH:', value);

          // Check if we need to rescale
          const newScale = getAppropriateScale(value);
          if (newScale !== maxScale) {
            console.log('[VelocityGauge] Auto-rescaling required:', maxScale, '->', newScale);
            setMaxScale(newScale);
          }

          currentValue = Math.min(value, maxScale);
          targetValue = currentValue;
          drawGauge();
          updateDisplayValue(currentValue);
        }

        // ============================================
        // VELOCITY GAUGE STABILIZATION BEHAVIOR
        // ============================================
        // The velocity gauge intentionally stabilizes after 10 seconds from initial
        // page load. During the first 10 seconds, the needle oscillates for visual
        // interest (engine rev effect). After stabilization, the needle holds steady
        // at the exact calculated velocity value, reinforcing trust in the displayed
        // metric and preventing the appearance of jitter or uncertainty.
        //
        // If the underlying velocity value changes due to task updates, the needle
        // will animate smoothly from its current position to the new target value,
        // then re-stabilize after a 2-second easing period.
        // ============================================

        return {
          init,
          setValue,
          setValueInstant,
          setMaxScale,
          getAppropriateScale,
          drawGauge,
          startWiggle,
          stopWiggle,
          stabilize,  // Manually trigger stabilization
          getCurrentScale: () => maxScale  // Getter for current max scale
        };
      })();

      // ==================== MINI GAUGE CLASS ====================
      // Reusable gauge class for fuel, temp, oil, and RPM gauges
      class MiniGauge {
        constructor(canvasId, options = {}) {
          this.canvasId = canvasId;
          this.canvas = null;
          this.ctx = null;
          this.currentValue = options.initialValue || 50;
          this.targetValue = this.currentValue;
          this.animationFrame = null;

          // Configuration for 68x68 canvas with bottom opening (like main speedometer)
          this.config = {
            centerX: 34,
            centerY: 38,
            radius: 26,
            startAngle: Math.PI * 0.80,   // Start at lower-left (like main gauge)
            sweepAngle: Math.PI * 1.40,   // 252 degree sweep with bottom opening
            arcWidth: 5,
            needleLength: 20,
            tickCount: 6
          };

          // Gauge type-specific colors
          this.type = options.type || 'default';
          this.colors = this.getColors(this.type);

          // Value display settings
          this.valueElementId = options.valueElementId;
          this.formatValue = options.formatValue || ((v) => Math.round(v));
        }

        getColors(type) {
          const colorSchemes = {
            fuel: {
              arcBg: 'rgba(239, 68, 68, 0.2)',
              arcFull: '#ef4444',
              arcMid: '#f97316',
              arcLow: '#ef4444',
              accent: '#ef4444',
              dangerZone: 'rgba(239, 68, 68, 0.4)'
            },
            milestone: {
              // Milestone time remaining: gray fill, red zone at last 10%
              arcBg: 'rgba(100, 100, 100, 0.3)',     // Gray background
              arcFull: '#9ca3af',                    // Gray fill (neutral)
              arcMid: '#9ca3af',                     // Gray (no color change)
              arcLow: '#ef4444',                     // Red when in danger zone
              accent: '#9ca3af',                     // Gray accent
              dangerZone: 'rgba(239, 68, 68, 0.6)'   // Red danger zone (last 10%)
            },
            temp: {
              arcBg: 'rgba(59, 130, 246, 0.2)',
              arcFull: '#3b82f6',
              arcMid: '#f97316',
              arcLow: '#3b82f6',
              accent: '#3b82f6',
              dangerZone: 'rgba(239, 68, 68, 0.4)'
            },
            oil: {
              // Delivery Confidence: High=Green (good), Mid=Yellow, Low=Red (bad)
              arcBg: 'rgba(34, 197, 94, 0.2)',
              arcFull: '#22c55e',   // High confidence = green (good)
              arcMid: '#f97316',    // Medium confidence = orange/yellow
              arcLow: '#ef4444',    // Low confidence = red (bad)
              accent: '#22c55e',    // Accent green for high confidence state
              dangerZone: 'rgba(239, 68, 68, 0.4)'
            },
            rpm: {
              // Quality Control: High=Green (good), Mid=Yellow, Low=Red (bad)
              arcBg: 'rgba(34, 197, 94, 0.2)',
              arcFull: '#22c55e',   // High quality = green (good)
              arcMid: '#f97316',    // Medium quality = orange/yellow
              arcLow: '#ef4444',    // Low quality = red (bad)
              accent: '#22c55e',    // Accent green for high quality state
              dangerZone: 'rgba(239, 68, 68, 0.5)'
            }
          };
          return {
            ...colorSchemes[type] || colorSchemes.fuel,
            needle: '#ffffff',
            needleGlow: 'rgba(255, 255, 255, 0.5)',
            tickColor: 'rgba(255, 255, 255, 0.5)'
          };
        }

        init() {
          this.canvas = document.getElementById(this.canvasId);
          if (!this.canvas) return false;
          this.ctx = this.canvas.getContext('2d');
          this.draw();
          return true;
        }

        percentToAngle(percent) {
          const clampedPercent = Math.max(0, Math.min(percent, 100));
          const ratio = clampedPercent / 100;
          return this.config.startAngle + (ratio * this.config.sweepAngle);
        }

        draw() {
          const { centerX, centerY, radius, startAngle, sweepAngle, arcWidth, tickCount } = this.config;
          const ctx = this.ctx;
          ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

          // Background arc
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, startAngle, startAngle + sweepAngle, false);
          ctx.strokeStyle = this.colors.arcBg;
          ctx.lineWidth = arcWidth;
          ctx.lineCap = 'round';
          ctx.stroke();

          // Draw tick marks
          for (let i = 0; i <= tickCount; i++) {
            const tickPercent = (i / tickCount) * 100;
            const angle = this.percentToAngle(tickPercent);
            const tickInner = radius - arcWidth / 2 - 2;
            const tickOuter = radius + arcWidth / 2 + 2;

            ctx.beginPath();
            ctx.moveTo(centerX + Math.cos(angle) * tickInner, centerY + Math.sin(angle) * tickInner);
            ctx.lineTo(centerX + Math.cos(angle) * tickOuter, centerY + Math.sin(angle) * tickOuter);
            ctx.strokeStyle = this.colors.tickColor;
            ctx.lineWidth = i % 2 === 0 ? 1.5 : 1;
            ctx.lineCap = 'round';
            ctx.stroke();
          }

          // Danger zone (different position based on gauge type)
          // NOTE: Fuel gauge danger zone is drawn AFTER fill arc (below) to appear on top
          if (this.type === 'milestone') {
            // Milestone: Fixed 10% red zone at low end (last 10% of time remaining)
            const dangerEnd = this.percentToAngle(10);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, dangerEnd, false);
            ctx.strokeStyle = this.colors.dangerZone;
            ctx.lineWidth = arcWidth + 1;
            ctx.lineCap = 'butt';
            ctx.stroke();
          } else if (this.type === 'oil' || this.type === 'rpm') {
            // Delivery Confidence & Quality Control: Low is bad - danger at start (40% zone)
            const dangerEnd = this.percentToAngle(40);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, dangerEnd, false);
            ctx.strokeStyle = this.colors.dangerZone;
            ctx.lineWidth = arcWidth + 1;
            ctx.lineCap = 'butt';
            ctx.stroke();
          } else if (this.type === 'temp') {
            // Execution Pressure: High is bad - danger at end
            const dangerStart = this.percentToAngle(85);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, dangerStart, startAngle + sweepAngle, false);
            ctx.strokeStyle = this.colors.dangerZone;
            ctx.lineWidth = arcWidth + 1;
            ctx.lineCap = 'butt';
            ctx.stroke();
          }

          // Filled arc
          if (this.currentValue > 0) {
            const fillEndAngle = this.percentToAngle(this.currentValue);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, fillEndAngle, false);

            // Color based on value and type
            let fillColor;
            if (this.type === 'milestone') {
              // Milestone: gray fill, red only when in danger zone (10%)
              fillColor = this.currentValue <= 10 ? this.colors.arcLow : this.colors.arcFull;
            } else if (this.type === 'fuel') {
              // Fuel: red below 10%, green otherwise (no orange)
              // The stationary red zone covers first 10%, so fill shows red when in danger
              fillColor = this.currentValue <= 10 ? this.colors.arcLow : this.colors.arcFull;
            } else if (this.type === 'oil' || this.type === 'rpm') {
              // Delivery Confidence & Quality Control: High=Green, Mid=Yellow, Low=Red
              fillColor = this.currentValue >= 70 ? this.colors.arcFull :
                          this.currentValue >= 40 ? this.colors.arcMid : this.colors.arcLow;
            } else {
              // Temp (Execution Pressure): Low=Good, High=Bad
              fillColor = this.currentValue >= 85 ? '#ef4444' :
                          this.currentValue >= 70 ? this.colors.arcMid : this.colors.accent;
            }
            ctx.strokeStyle = fillColor;
            ctx.lineWidth = arcWidth - 1;
            ctx.lineCap = 'round';
            ctx.stroke();
          }

          // Fuel gauge: Draw stationary 10% red zone ON TOP of fill arc
          // This creates a permanent warning zone visible regardless of fill level
          if (this.type === 'fuel') {
            const dangerEnd = this.percentToAngle(10); // First 10% is danger zone
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, dangerEnd, false);
            ctx.strokeStyle = 'rgba(239, 68, 68, 0.85)'; // Solid red, slightly transparent
            ctx.lineWidth = arcWidth;
            ctx.lineCap = 'butt';
            ctx.stroke();
          }

          // Draw needle
          this.drawNeedle();
        }

        drawNeedle() {
          const { centerX, centerY, needleLength } = this.config;
          const ctx = this.ctx;
          const angle = this.percentToAngle(this.currentValue);

          ctx.save();
          ctx.shadowColor = this.colors.needleGlow;
          ctx.shadowBlur = 6;

          const tipX = centerX + Math.cos(angle) * needleLength;
          const tipY = centerY + Math.sin(angle) * needleLength;

          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(tipX, tipY);
          ctx.strokeStyle = this.colors.needle;
          ctx.lineWidth = 1.5;
          ctx.lineCap = 'round';
          ctx.stroke();
          ctx.restore();

          // Center hub (smaller for compact gauge)
          ctx.beginPath();
          ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
          ctx.fillStyle = '#333';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 0.5;
          ctx.stroke();
        }

        animateTo(percent) {
          this.targetValue = Math.max(0, Math.min(percent, 100));

          if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
          }

          const animate = () => {
            const diff = this.targetValue - this.currentValue;
            const step = diff * 0.1;

            if (Math.abs(diff) < 0.5) {
              this.currentValue = this.targetValue;
              this.draw();
              this.updateDisplay();
              return;
            }

            this.currentValue += step;
            this.draw();
            this.updateDisplay();
            this.animationFrame = requestAnimationFrame(animate);
          };

          animate();
        }

        updateDisplay() {
          if (this.valueElementId) {
            const el = document.getElementById(this.valueElementId);
            if (el) {
              el.textContent = this.formatValue(this.currentValue);
            }
          }
        }

        setValue(percent) {
          this.animateTo(percent);
        }

        setValueInstant(percent) {
          this.currentValue = Math.max(0, Math.min(percent, 100));
          this.targetValue = this.currentValue;
          this.draw();
          this.updateDisplay();
        }
      }

      // Milestone Configuration - Hours per workday (Mon-Fri only)
      const HOURS_PER_WORKDAY = 8;

      // Parse a YYYY-MM-DD date string as local time (avoids UTC timezone issues)
      // new Date('2025-12-21') parses as UTC midnight, which shows as Dec 20 in US timezones
      function parseLocalDate(dateString) {
        if (!dateString) return null;
        const parts = dateString.split('-');
        if (parts.length !== 3) return null;
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      }

      // Get current milestone dates from input fields (or defaults)
      function getMilestoneDates() {
        const startInput = document.getElementById('milestoneStartDate');
        const endInput = document.getElementById('milestoneEndDate');

        // Parse dates from inputs as local time, or use defaults
        const startDate = (startInput && startInput.value)
          ? parseLocalDate(startInput.value)
          : new Date(2024, 11, 2); // Dec 2, 2024 in local time
        const endDate = (endInput && endInput.value)
          ? parseLocalDate(endInput.value)
          : new Date(2025, 11, 31); // Dec 31, 2025 in local time

        return { startDate, endDate };
      }

      // Count workdays between two dates (Mon-Fri only)
      function countWorkdays(startDate, endDate) {
        let workdays = 0;
        let current = new Date(startDate);
        current.setHours(0, 0, 0, 0);

        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);

        while (current <= end) {
          const dayOfWeek = current.getDay();
          if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Mon-Fri only
            workdays++;
          }
          current.setDate(current.getDate() + 1);
        }
        return workdays;
      }

      // Calculate milestone time remaining based on start/end dates and current date
      // Uses only workdays (Mon-Fri) with 8 hours per day
      // ALWAYS reads from input fields to ensure real-time accuracy
      function calculateMilestoneTimeRemaining() {
        const now = new Date();
        const { startDate: MILESTONE_START, endDate: MILESTONE_END } = getMilestoneDates();

        // Total available milestone work hours
        const totalWorkdays = countWorkdays(MILESTONE_START, MILESTONE_END);
        const totalMilestoneHours = totalWorkdays * HOURS_PER_WORKDAY;

        // Calculate remaining workdays from TODAY to milestone end
        // (not from milestone start - we want time REMAINING)
        let remainingWorkdays = 0;
        if (now <= MILESTONE_END) {
          // Count workdays from today to end date
          const effectiveStart = now < MILESTONE_START ? MILESTONE_START : now;
          remainingWorkdays = countWorkdays(effectiveStart, MILESTONE_END);

          // If today is a workday and we're within milestone, account for partial day
          const dayOfWeek = now.getDay();
          if (dayOfWeek >= 1 && dayOfWeek <= 5 && now >= MILESTONE_START) {
            // Partial day calculation based on current hour (8-hour workday)
            const currentHour = now.getHours();
            const hoursRemainingToday = Math.max(0, 8 - Math.min(currentHour, 8));
            const partialDayFraction = hoursRemainingToday / 8;
            // Subtract today's full day and add back partial
            remainingWorkdays = remainingWorkdays - 1 + partialDayFraction;
          }
        }

        const hoursRemaining = Math.max(0, remainingWorkdays * HOURS_PER_WORKDAY);
        const hoursSpent = Math.max(0, totalMilestoneHours - hoursRemaining);

        // Fuel percentage = remaining / total  100
        const fuelPercent = totalMilestoneHours > 0
          ? Math.round((hoursRemaining / totalMilestoneHours) * 100)
          : 0;

        console.log('[FuelGauge] Milestone calculation:', {
          start: MILESTONE_START.toISOString().split('T')[0],
          end: MILESTONE_END.toISOString().split('T')[0],
          totalWorkdays,
          totalMilestoneHours,
          remainingWorkdays: Math.round(remainingWorkdays * 10) / 10,
          hoursRemaining: Math.round(hoursRemaining),
          hoursSpent: Math.round(hoursSpent),
          fuelPercent
        });

        return {
          totalMilestoneHours: Math.round(totalMilestoneHours),
          hoursSpent: Math.round(hoursSpent),
          hoursRemaining: Math.round(hoursRemaining),
          fuelPercent,
          totalWorkdays
        };
      }

      // Store milestone data globally for recalculation
      let milestoneData = calculateMilestoneTimeRemaining();

      // Create gauge instances
      // Fuel gauge now uses 'milestone' type with gray fill and 10% red warning zone
      const FuelGauge = new MiniGauge('fuelGaugeCanvas', {
        type: 'milestone',  // New type for milestone time remaining
        valueElementId: 'fuelGaugeText',
        initialValue: milestoneData.fuelPercent,
        formatValue: (v) => {
          // Recalculate to get accurate remaining hours
          const data = calculateMilestoneTimeRemaining();
          return `${data.hoursRemaining}h`;
        }
      });

      // ============================================
      // OPERATIONAL METRICS GAUGES (Refactored for Decision-Grade Instruments)
      // TEMP = Execution Pressure, OIL = Rework Drag, RPM = Throughput Load
      // All gauges now show percentages for clarity
      // ============================================

      // Execution Pressure (TEMP) - How much time pressure relative to milestone?
      // Formula: (Required WPH / Current WPH)  100
      // 0-200% scale: <80%=comfortable(green), 80-120%=moderate(yellow), >120%=at risk(red)
      const TempGauge = new MiniGauge('tempGaugeCanvas', {
        type: 'temp',
        valueElementId: 'tempGaugeText',
        initialValue: 0,
        formatValue: (v) => `${Math.round(v)}%`
      });

      // Rework Drag (OIL) - What percentage of effort lost to rework?
      // Formula: (Rework Hours / Total Completed Hours)  100
      // 0-100% scale: <10%=clean(green), 10-25%=moderate(yellow), >25%=inefficient(red)
      const OilGauge = new MiniGauge('oilGaugeCanvas', {
        type: 'oil',
        valueElementId: 'oilGaugeText',
        initialValue: 0,
        formatValue: (v) => `${Math.round(v)}%`
      });

      // Throughput Load (RPM) - How loaded is the system vs sustainable capacity?
      // Formula: (Active Work Events / Sustainable Baseline)  100
      // 0-150% scale: <30%=underutilized, 30-80%=optimal(green), 80-100%=high(yellow), >100%=overloaded(red)
      const RpmGauge = new MiniGauge('rpmGaugeCanvas', {
        type: 'rpm',
        valueElementId: 'rpmGaugeText',
        initialValue: 0,
        formatValue: (v) => `${Math.round(v)}%`
      });

      // Calculate new operational metrics based on live CW+ (AI-augmented) data
      function calculateOperationalHealth(tasks, stats) {
        // Get milestone data for time-based calculations
        const msData = calculateMilestoneTimeRemaining();
        const hoursRemaining = msData.hoursRemaining || 24;

        // ============================================
        // CW+ (Completed Work Plus) - AI-AUGMENTED DATA
        // ============================================
        // The "plus" in CW+ represents AI-assisted contribution
        // All metrics must use CW+ data, not human-only assumptions
        const totalCWPlus = velocity?.totalCWPlus || 0;  // Actual work hours (AI-augmented)
        const totalEHH = velocity?.totalEHH || 0;         // Est. Human Hours value delivered
        const currentWPH = velocity?.wph || 0;            // Work Per Hour efficiency

        // Calculate remaining work from tasks array or use stats fallback
        let pendingTasks = 0;
        let pendingHH = 0;

        if (tasks && tasks.length > 0) {
          // Calculate from actual task data
          pendingTasks = tasks.filter(t => t.workflow_status !== 'completed').length;
          pendingHH = tasks.reduce((sum, t) => {
            if (t.workflow_status !== 'completed') {
              return sum + (parseFloat(t.estimated_hours) || 4);
            }
            return sum;
          }, 0);
        } else {
          // Fallback: Calculate from stats if task array empty
          // Use non-completed status counts from stats
          const totalTasks = (stats.total || 0);
          const completedCount = (stats.completed || 0);
          pendingTasks = Math.max(0, totalTasks - completedCount);

          // If we have task counts but no hours, estimate from average
          // Avg task = 4 estimated hours (based on default)
          if (pendingTasks > 0) {
            pendingHH = pendingTasks * 4;
          }
        }

        // If still zero but we have unfinished work, use stats directly
        if (pendingTasks === 0 && stats) {
          const statusCounts = ['open', 'in_progress', 'in_review', 'submitted', 'fixing', 'rejected', 'blocked'];
          pendingTasks = statusCounts.reduce((sum, status) => sum + (stats[status] || 0), 0);
          if (pendingTasks > 0 && pendingHH === 0) {
            pendingHH = pendingTasks * 4; // Estimate 4 hours per remaining task
          }
        }

        // Calculate Required WPH to finish on time
        // Required WPH = Remaining Est. HH / Hours Remaining in Milestone
        const requiredWPH = hoursRemaining > 0 ? pendingHH / hoursRemaining : 0;

        // ============================================
        // EXECUTION PRESSURE (uses CW+ velocity)
        // ============================================
        // Formula: (Required WPH / Current WPH)  100
        // Current WPH is derived from CW+ data (EHH / CW+)
        // If required WPH > current WPH, pressure is high (>100%)
        const executionPressure = currentWPH > 0 ? (requiredWPH / currentWPH) * 100 : 0;

        let pressureZone = 'comfortable';
        if (executionPressure >= 120) pressureZone = 'at_risk';
        else if (executionPressure >= 80) pressureZone = 'moderate';

        // ============================================
        // DELIVERY CONFIDENCE (capped at 99% - always residual risk)
        // ============================================
        // Factors: velocity trend, schedule buffer, execution pressure
        // Must align with qualitative Milestone Confidence label (Low/Medium/High)
        // Never shows 100% - there is always delivery risk

        // Start with base confidence based on execution pressure
        let deliveryConfidence = 85; // Start at 85% - never assume perfect conditions

        // Significant penalty for high execution pressure
        if (executionPressure > 120) {
          deliveryConfidence -= Math.min(45, (executionPressure - 100) * 1.0);
        } else if (executionPressure > 100) {
          deliveryConfidence -= (executionPressure - 100) * 0.8;
        } else if (executionPressure > 80) {
          deliveryConfidence -= (executionPressure - 80) * 0.3;
        }

        // Penalty for low fuel remaining (schedule buffer)
        const fuelRemaining = milestoneData ? milestoneData.fuelPercent : 50;
        if (fuelRemaining < 15) {
          deliveryConfidence -= Math.min(35, (15 - fuelRemaining) * 2.5);
        } else if (fuelRemaining < 30) {
          deliveryConfidence -= (30 - fuelRemaining) * 0.8;
        } else if (fuelRemaining < 50) {
          deliveryConfidence -= (50 - fuelRemaining) * 0.2;
        }

        // Modest bonus for being ahead of schedule (capped)
        if (currentWPH > requiredWPH * 1.3 && fuelRemaining > 40) {
          deliveryConfidence = Math.min(90, deliveryConfidence + 8);
        } else if (currentWPH > requiredWPH * 1.1) {
          deliveryConfidence = Math.min(85, deliveryConfidence + 4);
        }

        // Cap at 99% - never show 100% confidence (always residual risk)
        deliveryConfidence = Math.max(0, Math.min(99, deliveryConfidence));

        // Confidence zones aligned with Milestone Confidence label
        let confidenceZone = 'high';      // 70-99%
        if (deliveryConfidence < 40) {
          confidenceZone = 'low';         // 0-39%
        } else if (deliveryConfidence < 70) {
          confidenceZone = 'medium';      // 40-69%
        }

        // ============================================
        // QUALITY CONTROL (renamed from System Stability)
        // ============================================
        // Measures reliability of the development tracking process:
        // - Progress tracking consistency
        // - Data freshness and accuracy
        // - Background process health
        // - Metric calculation reliability

        // Base QC starts at 90% (always some uncertainty in tracking)
        let qualityControl = 90;

        // Check background process health indicator
        const healthIndicator = document.getElementById('bgProcessHealthIndicator');
        if (healthIndicator) {
          if (healthIndicator.classList.contains('error')) {
            qualityControl -= 35; // Major penalty for unhealthy tracking processes
          } else if (healthIndicator.classList.contains('unknown')) {
            qualityControl -= 12; // Minor penalty for unknown state
          }
        }

        // Check for metric consistency (compare EHH to CW+ ratio)
        // Healthy ratio should be between 10x and 100x for AI-augmented work
        const efficiencyRatio = totalCWPlus > 0 ? totalEHH / totalCWPlus : 0;
        if (efficiencyRatio > 0) {
          if (efficiencyRatio < 5 || efficiencyRatio > 200) {
            qualityControl -= 25; // Unusual ratio suggests tracking issues
          } else if (efficiencyRatio < 10 || efficiencyRatio > 150) {
            qualityControl -= 10; // Slightly unusual ratio
          }
        }

        // Check for active work being tracked
        const completedTasks = stats.completed || 0;
        const inProgressTasks = stats.in_progress || 0;
        if (completedTasks === 0 && inProgressTasks === 0) {
          qualityControl -= 15; // No tracked activity may indicate gaps
        }

        // Penalty if no pending work defined (planning gaps)
        if (pendingTasks === 0 && pendingHH === 0) {
          qualityControl -= 8; // Work backlog not defined
        }

        // Cap at 95% - tracking always has some uncertainty
        qualityControl = Math.max(0, Math.min(95, qualityControl));

        let qualityZone = 'good';         // 75-95%
        if (qualityControl < 50) {
          qualityZone = 'poor';           // 0-49%
        } else if (qualityControl < 75) {
          qualityZone = 'fair';           // 50-74%
        }

        // ============================================
        // MILESTONE CONFIDENCE (derived label - MUST match Delivery Confidence gauge)
        // ============================================
        // The label must exactly reflect the Confidence gauge value, not be influenced by Quality Control
        // Quality Control affects tracking reliability, not delivery confidence
        let milestoneConfidence = 'High';      // 70-99%
        if (deliveryConfidence < 40) {
          milestoneConfidence = 'Low';         // 0-39%
        } else if (deliveryConfidence < 70) {
          milestoneConfidence = 'Medium';      // 40-69%
        }

        // ============================================
        // SCHEDULE POSITION
        // ============================================
        // Calculate estimated completion date at current CW+ pace
        const hoursNeededAtCurrentPace = currentWPH > 0 ? pendingHH / currentWPH : Infinity;
        const daysNeeded = Math.ceil(hoursNeededAtCurrentPace / 8); // 8-hour workday

        // Get milestone end date (parse as local time to avoid timezone issues)
        const endDateInput = document.getElementById('milestoneEndDate');
        const milestoneEndDate = (endDateInput && endDateInput.value)
          ? parseLocalDate(endDateInput.value)
          : new Date(2025, 11, 31); // Dec 31, 2025 in local time

        // Calculate schedule position
        const today = new Date();
        const daysUntilMilestone = Math.ceil((milestoneEndDate - today) / (1000 * 60 * 60 * 24));
        const scheduleDelta = daysUntilMilestone - daysNeeded;

        let schedulePosition = 'On Track';
        if (scheduleDelta > 2) schedulePosition = `Ahead (+${scheduleDelta}d)`;
        else if (scheduleDelta < -2) schedulePosition = `Behind (${scheduleDelta}d)`;

        // Calculate estimated completion date
        const estCompletionDate = addBusinessDays(today, daysNeeded);

        // Log CW+ metrics for debugging
        console.log('[calculateOperationalHealth] Metrics:', {
          totalCWPlus,
          totalEHH,
          currentWPH,
          pendingTasks,
          pendingHH,
          requiredWPH: requiredWPH.toFixed(2),
          executionPressure: executionPressure.toFixed(1) + '%',
          deliveryConfidence: deliveryConfidence.toFixed(1) + '%',
          qualityControl: qualityControl.toFixed(1) + '%'
        });

        return {
          // Gauge values (0-100 scale for gauge display)
          pressure: {
            value: executionPressure,
            zone: pressureZone,
            gaugePercent: Math.min(100, executionPressure * 0.5) // Scale 0-200% to 0-100 for gauge
          },
          confidence: {
            value: deliveryConfidence,
            zone: confidenceZone,
            gaugePercent: deliveryConfidence // Already 0-100 scale
          },
          quality: {
            value: qualityControl,
            zone: qualityZone,
            gaugePercent: qualityControl // Already 0-100 scale
          },
          // Additional derived metrics
          requiredWPH: requiredWPH,
          currentWPH: currentWPH,
          pendingTasks: pendingTasks,
          pendingHH: pendingHH,
          milestoneConfidence: milestoneConfidence,
          schedulePosition: schedulePosition,
          estCompletionDate: estCompletionDate,
          hoursRemaining: hoursRemaining,
          // CW+ metrics for panel display
          totalCWPlus: totalCWPlus,
          totalEHH: totalEHH
        };
      }

      // State
      let tasks = [];
      let stats = {};
      let velocity = null;
      let dashboardData = null;
      let assignees = [];
      let currentTaskId = null;
      let selectedStatus = null;
      let editPanelTaskId = null;
      let editPanelOriginalStatus = null;
      let isPanelResizing = false;
      let panelWidth = 480;

      // DOM Elements (some may not exist if filter UI was removed)
      const tasksTableBody = document.getElementById('tasksTableBody');
      const filterStatus = document.getElementById('filterStatus') || { value: '' };
      const filterType = document.getElementById('filterType') || { value: '' };
      const filterPriority = document.getElementById('filterPriority') || { value: '' };
      const searchInput = document.getElementById('searchInput') || { value: '' };

      // Initialize sidebar (navigation handled by anchor tags)
      function initSidebar() {
        // Sidebar navigation is now handled by direct anchor tags
        // No menu toggle or sliding panel functionality needed
      }

      // Workflow pipeline definition
      // Submitted  Developing  Reviewing  Documenting  Approving  Completed
      const WORKFLOW_PIPELINE = [
        { status: 'submitted', label: 'Submitted' },
        { status: 'developing', label: 'Developing' },
        { status: 'reviewing', label: 'Reviewing' },
        { status: 'documenting', label: 'Documenting' },
        { status: 'approving', label: 'Approving' },
        { status: 'completed', label: 'Completed' }
      ];

      // Get current workflow index
      function getWorkflowIndex(status) {
        const normalizedStatus = normalizeStatus(status);
        const idx = WORKFLOW_PIPELINE.findIndex(s => s.status === normalizedStatus);
        return idx >= 0 ? idx : 0;
      }

      // Normalize status to workflow pipeline values
      function normalizeStatus(status) {
        const statusMap = {
          'submitted': 'submitted',
          'task_submitted': 'submitted',
          'in_progress': 'developing',
          'developing': 'developing',
          'jubilee_developing': 'developing',
          'in_review': 'reviewing',
          'reviewing': 'reviewing',
          'gabriel_to_review': 'reviewing',
          'documenting': 'documenting',
          'approving': 'approving',
          'fixing': 'reviewing',
          'completed': 'completed'
        };
        return statusMap[status] || 'submitted';
      }

      // Handle Back button - move to previous workflow status
      async function handleTaskBack() {
        if (!selectedTaskId) return;

        const task = tasks.find(t => t.id === selectedTaskId);
        if (!task) return;

        const currentStatus = task.workflow_status || task.status || 'submitted';
        const currentIndex = getWorkflowIndex(currentStatus);

        if (currentIndex <= 0) {
          console.log('Already at first status, cannot go back');
          return;
        }

        const newStatus = WORKFLOW_PIPELINE[currentIndex - 1].status;
        await updateTaskStatus(selectedTaskId, newStatus, 'Moved back in workflow');
      }

      // Handle Next button - move to next workflow status
      async function handleTaskNext() {
        if (!selectedTaskId) return;

        const task = tasks.find(t => t.id === selectedTaskId);
        if (!task) return;

        const currentStatus = task.workflow_status || task.status || 'submitted';
        const currentIndex = getWorkflowIndex(currentStatus);

        if (currentIndex >= WORKFLOW_PIPELINE.length - 1) {
          console.log('Already at final status, cannot go next');
          return;
        }

        const newStatus = WORKFLOW_PIPELINE[currentIndex + 1].status;
        await updateTaskStatus(selectedTaskId, newStatus, 'Advanced in workflow');
      }

      // Update task status and create work history entry
      async function updateTaskStatus(taskId, newStatus, comment) {
        try {
          const task = tasks.find(t => t.id === taskId);
          if (!task) return;

          const previousStatus = task.workflow_status || task.status || 'submitted';

          // Update task status via dedicated status API (handles history logging automatically)
          const response = await fetch(`/api/admin/tasks/${taskId}/status`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              status: newStatus,
              comment: comment || `Status changed from ${previousStatus} to ${newStatus}`
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'Failed to update task status');
          }

          const result = await response.json();

          // Update local task data with server response
          if (result.task) {
            task.workflow_status = result.task.workflow_status || result.task.status;
            task.status = result.task.status;
            task.current_owner = result.task.current_owner;
          } else {
            task.workflow_status = newStatus;
            task.status = newStatus;
          }

          // Refresh task queue (will filter out completed tasks from Open Tasks view)
          await loadTaskQueue();

          // If task is completed and we're viewing Open Tasks, it will be removed from queue
          // Close the edit panel if the completed task was selected
          if (newStatus === 'completed') {
            const filterEl = document.getElementById('taskQueueFilter');
            if (filterEl && filterEl.value === 'open') {
              console.log('Completed task removed from Open Tasks queue');
              hideTaskEdit();
              return;
            }
          }

          // Refresh the edit panel to show updated status
          showTaskEdit(task);

          console.log(`Task ${taskId} status updated: ${previousStatus}  ${newStatus}`);
        } catch (error) {
          console.error('Error updating task status:', error);
          alert('Failed to update task status. Please try again.');
        }
      }

      // Update Back/Next button states based on current task status
      function updateWorkflowButtons(task) {
        const backBtn = document.getElementById('taskBackBtn');
        const nextBtn = document.getElementById('taskNextBtn');

        if (!backBtn || !nextBtn) return;

        const currentStatus = task.workflow_status || task.status || 'submitted';
        const currentIndex = getWorkflowIndex(currentStatus);

        // Disable Back if at first status
        backBtn.disabled = currentIndex <= 0;
        backBtn.style.opacity = currentIndex <= 0 ? '0.5' : '1';
        backBtn.style.cursor = currentIndex <= 0 ? 'not-allowed' : 'pointer';

        // Disable Next if at final status
        nextBtn.disabled = currentIndex >= WORKFLOW_PIPELINE.length - 1;
        nextBtn.style.opacity = currentIndex >= WORKFLOW_PIPELINE.length - 1 ? '0.5' : '1';
        nextBtn.style.cursor = currentIndex >= WORKFLOW_PIPELINE.length - 1 ? 'not-allowed' : 'pointer';

        // Update button labels to show what's next/previous
        if (currentIndex > 0) {
          backBtn.textContent = WORKFLOW_PIPELINE[currentIndex - 1].label;
        } else {
          backBtn.textContent = 'Back';
        }

        if (currentIndex < WORKFLOW_PIPELINE.length - 1) {
          nextBtn.textContent = WORKFLOW_PIPELINE[currentIndex + 1].label;
        } else {
          nextBtn.textContent = 'Next';
        }

        // Update button colors based on ownership transfer direction
        // Remove existing ownership classes
        backBtn.classList.remove('to-jubilee', 'to-gabriel');
        nextBtn.classList.remove('to-jubilee', 'to-gabriel');

        // Determine ownership of previous status (for Back button)
        if (currentIndex > 0) {
          const prevStatus = WORKFLOW_PIPELINE[currentIndex - 1].status;
          const prevOwner = getStatusOwner(prevStatus);
          if (prevOwner === 'jubilee') {
            backBtn.classList.add('to-jubilee');
          }
        }

        // Determine ownership of next status (for Next button)
        if (currentIndex < WORKFLOW_PIPELINE.length - 1) {
          const nextStatus = WORKFLOW_PIPELINE[currentIndex + 1].status;
          const nextOwner = getStatusOwner(nextStatus);
          if (nextOwner === 'jubilee') {
            nextBtn.classList.add('to-jubilee');
          }
        }
      }

      // Add event listeners for workflow navigation buttons (CSP blocks inline onclick)
      const taskBackBtnEl = document.getElementById('taskBackBtn');
      const taskNextBtnEl = document.getElementById('taskNextBtn');
      if (taskBackBtnEl) {
        taskBackBtnEl.addEventListener('click', handleTaskBack);
      }
      if (taskNextBtnEl) {
        taskNextBtnEl.addEventListener('click', handleTaskNext);
      }

      // Initialize panel resize functionality
      function initPanelResize() {
        const resizeHandle = document.getElementById('panelResizeHandle');
        const detailColumn = document.querySelector('.task-detail-column');
        const contextColumn = document.getElementById('taskContextColumn');
        const container = document.querySelector('.tasks-view-container');

        if (!resizeHandle || !detailColumn || !contextColumn || !container) return;

        let isResizing = false;
        let startX = 0;
        let startDetailWidth = 0;
        let startContextWidth = 0;

        resizeHandle.addEventListener('mousedown', (e) => {
          isResizing = true;
          startX = e.clientX;
          startDetailWidth = detailColumn.offsetWidth;
          startContextWidth = contextColumn.offsetWidth;
          resizeHandle.classList.add('dragging');
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;

          const deltaX = e.clientX - startX;
          const newDetailWidth = startDetailWidth + deltaX;
          const newContextWidth = startContextWidth - deltaX;

          // Set min/max constraints
          const minWidth = 250;
          const maxDetailWidth = container.offsetWidth - 350 - 6; // Leave room for context column and handle

          if (newDetailWidth >= minWidth && newDetailWidth <= maxDetailWidth && newContextWidth >= minWidth) {
            detailColumn.style.flex = 'none';
            detailColumn.style.width = newDetailWidth + 'px';
            contextColumn.style.flex = 'none';
            contextColumn.style.width = newContextWidth + 'px';
          }
        });

        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            resizeHandle.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
          }
        });
      }

      // Format task number
      function formatTaskNumber(num) {
        return 'JV-' + String(num).padStart(3, '0');
      }

      // Format date
      function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      // Format status for display
      function formatStatus(status) {
        const map = {
          'submitted': 'Submitted',
          'developing': 'Developing',
          'in_progress': 'Developing',
          'in_review': 'Reviewing',
          'reviewing': 'Reviewing',
          'documenting': 'Documenting',
          'approving': 'Approving',
          'fixing': 'Reviewing',
          'completed': 'Completed'
        };
        return map[status] || status;
      }

      // Update stats display
      function updateStats() {
        // Left panel - Work Remaining
        const submitted = stats.byStatus?.submitted || 0;
        const inReview = stats.byStatus?.inReview || 0;
        const inProgress = stats.byStatus?.inProgress || 0;
        const fixing = stats.byStatus?.fixing || 0;
        const totalPending = submitted + inReview + inProgress + fixing;

        const panelSubmitted = document.getElementById('panelSubmitted');
        const panelInReview = document.getElementById('panelInReview');
        const panelInProgress = document.getElementById('panelInProgress');
        const panelFixing = document.getElementById('panelFixing');
        const panelTotalPending = document.getElementById('panelTotalPending');

        if (panelSubmitted) panelSubmitted.textContent = submitted;
        if (panelInReview) panelInReview.textContent = inReview;
        if (panelInProgress) panelInProgress.textContent = inProgress;
        if (panelFixing) panelFixing.textContent = fixing;
        if (panelTotalPending) panelTotalPending.textContent = totalPending;

        // Right panel - Progress Made
        const completed = stats.byStatus?.completed || 0;
        const panelCompleted = document.getElementById('panelCompleted');
        const panelTotalCompleted = document.getElementById('panelTotalCompleted');
        if (panelCompleted) panelCompleted.textContent = completed;
        if (panelTotalCompleted) panelTotalCompleted.textContent = completed;

        // Calculate bugs fixed (completed bugs)
        // This would ideally come from the API, using estimate for now
        const bugsFixed = Math.floor(completed * 0.3); // Estimate 30% of completed are bug fixes
        const panelBugsFixed = document.getElementById('panelBugsFixed');
        if (panelBugsFixed) panelBugsFixed.textContent = bugsFixed;
      }

      // Load comprehensive dashboard metrics from PostgreSQL
      async function loadDashboardMetrics() {
        try {
          const response = await fetch('/api/admin/dashboard/metrics', {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) {
            console.warn('Failed to load dashboard metrics, status:', response.status, response.statusText);
            const errorText = await response.text();
            console.warn('Error response:', errorText.substring(0, 500));
            loadDefaultDashboardData();
            return;
          }

          const data = await response.json();
          console.log('[loadDashboardMetrics] API response:', {
            success: data.success,
            hasProgressMade: !!data.progressMade,
            completedTasks: data.progressMade?.completedTasks,
            totalEHH: data.progressMade?.totalEHH,
            totalCWPlus: data.progressMade?.totalCWPlus
          });
          if (data.success) {
            dashboardData = data;

            // Calculate WPH from progress-made data (completed work only)
            // WPH = Est. Human Hours (EHH) / Completed Work (CW+)
            // This measures how fast work is being completed based on actual execution
            const pm = data.progressMade || {};
            const ehh = pm.totalEHH || pm.totalHEH || 0;  // Est. Human Hours completed
            const cwPlus = pm.totalCWPlus || pm.actualHoursWorked || 1;  // Completed Work hours
            const wph = cwPlus > 0 ? ehh / cwPlus : 0;

            // Log detailed WPH calculation for verification
            console.log('[loadDashboardMetrics] WPH Calculation (Progress-Made):', {
              formula: 'WPH = EHH / CW+',
              estHumanHours: ehh,
              completedWork: cwPlus,
              calculatedWPH: wph.toFixed(2),
              gaugeScale: '0-120 (fixed)'
            });

            // Set the gauge with WPH (fixed 0-120 scale)
            VelocityGauge.setValue(wph);

            // Update speedometer display with precise WPH
            const speedometerEl = document.getElementById('speedometerValue');
            if (speedometerEl) {
              speedometerEl.innerHTML = formatPreciseNumber(wph) + '<span class="speedometer-wph-label">WPH</span>';
            }

            // Update speed badge with WPH
            const speedBadgeEl = document.getElementById('speedBadge');
            if (speedBadgeEl) speedBadgeEl.textContent = 'WPH: ' + formatPreciseNumber(wph);

            // Store velocity data for other functions
            velocity = {
              ...(data.velocity || {}),
              wph: wph,
              totalEHH: ehh,
              totalCWPlus: cwPlus
            };

            // Update milestone information - use values from calendar inputs
            if (data.milestone) {
              // Milestone display is now updated by updateMilestoneDates()
              // which reads from the calendar inputs for consistency
              const milestoneHours = document.getElementById('milestoneHoursRemaining');
              if (milestoneHours) milestoneHours.textContent = data.milestone.hoursRemaining || 0;
            }

            // Update fuel gauge with milestone time remaining
            // Recalculate from milestone dates, not from API fuel data
            milestoneData = calculateMilestoneTimeRemaining();
            FuelGauge.setValue(milestoneData.fuelPercent);
            const fuelTextEl = document.getElementById('fuelGaugeText');
            if (fuelTextEl) fuelTextEl.textContent = `${milestoneData.hoursRemaining}h`;

            // Update all panels
            updateDashboardPanels(data);
          }
        } catch (error) {
          console.error('Error loading dashboard metrics:', error);
          loadDefaultDashboardData();
        }
      }

      // Load/refresh velocity data - wrapper for loadDashboardMetrics
      // This function is called after task changes to recalculate velocity
      async function loadVelocity() {
        console.log('Refreshing velocity calculations...');
        const speedBadge = document.getElementById('speedBadge');
        if (speedBadge) {
          speedBadge.textContent = 'Calculating...';
          speedBadge.classList.add('refreshing');
        }

        try {
          await loadDashboardMetrics();
          console.log('Velocity refresh complete');
        } finally {
          if (speedBadge) {
            speedBadge.classList.remove('refreshing');
          }
        }
      }
      window.loadVelocity = loadVelocity;

      // Add click listener for speed badge (CSP blocks inline onclick)
      const speedBadgeEl = document.getElementById('speedBadge');
      if (speedBadgeEl) {
        speedBadgeEl.addEventListener('click', loadVelocity);
      }

      // Load fallback data when API unavailable - shows zeros, not fake demo data
      function loadDefaultDashboardData() {
        console.warn('[loadDefaultDashboardData] API unavailable - showing zeros until data loads');

        // Set gauges to zero when no data available
        VelocityGauge.setValue(0);
        const speedometerEl = document.getElementById('speedometerValue');
        if (speedometerEl) {
          speedometerEl.innerHTML = '0<span class="speedometer-wph-label">WPH</span>';
        }
        const speedBadgeDefault = document.getElementById('speedBadge');
        if (speedBadgeDefault) speedBadgeDefault.textContent = 'WPH: 0';

        // Set milestone info from calculation (this is real data, not demo)
        const milestoneHoursEl = document.getElementById('milestoneHoursRemaining');
        if (milestoneHoursEl) milestoneHoursEl.textContent = milestoneData.hoursRemaining;

        // Set fuel gauge based on milestone time remaining
        milestoneData = calculateMilestoneTimeRemaining();
        FuelGauge.setValue(milestoneData.fuelPercent);
        const fuelTextEl = document.getElementById('fuelGaugeText');
        if (fuelTextEl) fuelTextEl.textContent = `${milestoneData.hoursRemaining}h`;

        // Set global velocity to zeros
        velocity = {
          wph: 0,
          totalEHH: 0,
          totalCWPlus: 0
        };

        // Update panels with zeros - no fake demo data
        updateDashboardPanels({
          milestone: {
            date: '2025-12-31',
            hoursRemaining: milestoneData.hoursRemaining,
            workdaysRemaining: milestoneData.workdaysRemaining,
            weeksRemaining: milestoneData.weeksRemaining
          },
          velocity: velocity,
          progressMade: {
            completedTasks: 0,
            linesOfCode: 0,
            linesOfCodeFormatted: '0',
            apiEndpoints: 0,
            databaseTables: 0,
            totalEHH: 0,
            totalHEH: 0,
            totalCWPlus: 0,
            valueDeliveredHours: 0,
            actualHoursWorked: 0
          },
          workRemaining: {
            pendingTasks: 0,
            pendingHEH: 0,
            projectedCompletionHEH: 0,
            workDeficit: 0,
            onTrack: false,
            estimatedDaysRemaining: 0,
            hoursRemaining: milestoneData.hoursRemaining,
            hoursUsed: 0,
            milestoneHoursRemaining: milestoneData.hoursRemaining
          },
          fuel: {
            hoursRemaining: milestoneData.hoursRemaining,
            tankCapacity: 40,
            fuelPercent: milestoneData.fuelPercent
          }
        });
      }

      // Update side panels with PostgreSQL data
      function updateDashboardPanels(data) {
        // Right panel - Progress Made (green success indicators)
        if (data.progressMade) {
          const pm = data.progressMade;

          // Completed Tasks count
          const completedTasksEl = document.getElementById('panelCompletedTasks');
          if (completedTasksEl) completedTasksEl.textContent = pm.completedTasks || 0;

          // Lines of code - use ~X,XXX format
          const locEl = document.getElementById('panelLOC');
          if (locEl) {
            const loc = pm.linesOfCode || 56000;
            locEl.textContent = '~' + loc.toLocaleString();
          }

          // API endpoints
          const apiEl = document.getElementById('panelAPIs');
          if (apiEl) apiEl.textContent = pm.apiEndpoints || 0;

          // Database tables
          const tablesEl = document.getElementById('panelTables');
          if (tablesEl) tablesEl.textContent = pm.databaseTables || 0;

          // Est. Human Hours (EHH) - from database, display as integer
          const ehhEl = document.getElementById('panelEHH');
          if (ehhEl) {
            const ehh = Math.round(pm.totalEHH || pm.totalHEH || 0);
            ehhEl.textContent = ehh.toLocaleString('en-US');
          }

          // Completed Work (CW+) - from database, display as integer
          const cwPlusEl = document.getElementById('panelCompletedWork');
          if (cwPlusEl) {
            const cwPlus = Math.round(pm.totalCWPlus || 0);
            cwPlusEl.textContent = cwPlus.toLocaleString('en-US');
          }

          // Work Efficiency (%) = (EHH / CW+)  100
          // This shows the multiplier of work value delivered vs actual time spent
          // 100% = 1 hour of value per 1 hour worked (baseline human)
          // 5000% = 50 hours of value per 1 hour worked (AI-assisted)
          const workEffEl = document.getElementById('panelWorkEfficiency');
          if (workEffEl) {
            const ehh = pm.totalEHH || pm.totalHEH || 0;
            const cwPlus = pm.totalCWPlus || 1; // prevent div by zero
            // Work Efficiency = (EHH / CW+)  100
            const workEffPct = cwPlus > 0 ? (ehh / cwPlus) * 100 : 0;
            workEffEl.textContent = Math.round(workEffPct).toLocaleString('en-US') + '%';
          }

          // Timeline Burst - projected future date if work was done at human pace
          // Formula: EHH / (40 hours/week  70% efficiency) = effective human weeks
          // Then convert to business days
          const timelineBurstEl = document.getElementById('panelTimelineBurst');
          if (timelineBurstEl) {
            const totalEHH = pm.totalEHH || pm.totalHEH || 0;
            // 40 hours/week at 70% efficiency = 28 effective hours/week
            const effectiveHoursPerWeek = 40 * 0.70;
            const humanWeeks = totalEHH / effectiveHoursPerWeek;
            const businessDays = Math.floor(humanWeeks * 5);  // Convert to business days

            // Calculate Timeline Burst date by adding business days (skip weekends)
            const burstDate = addBusinessDays(new Date(), businessDays);
            const month = String(burstDate.getMonth() + 1).padStart(2, '0');
            const day = String(burstDate.getDate()).padStart(2, '0');
            const year = String(burstDate.getFullYear()).slice(-2);
            timelineBurstEl.textContent = `${month}/${day}/${year}`;

            // Log Timeline Burst calculation for verification
            console.log('[TimelineBurst] Calculation:', {
              totalEHH,
              effectiveHoursPerWeek,
              humanWeeks: humanWeeks.toFixed(2),
              businessDays,
              burstDate: `${month}/${day}/${year}`
            });
          }

          // Value Delivered ($) = EHH  $150/hr
          const valueEl = document.getElementById('panelValueDelivered');
          if (valueEl) {
            const ehh = pm.totalEHH || pm.totalHEH || 0;
            const valueDeliveredDollars = ehh * 150; // $150/hr rate
            valueEl.textContent = formatPreciseCurrency(valueDeliveredDollars);
          }

          // Actual Cost ($) = CW+  $150/hr
          const actualCostEl = document.getElementById('panelActualCost');
          if (actualCostEl) {
            const cwPlus = pm.totalCWPlus || 0;
            const actualCostDollars = cwPlus * 150; // $150/hr rate
            actualCostEl.textContent = 'Actual Cost: ' + formatPreciseCurrency(actualCostDollars);
          }

          // Update center panel financial values
          const earnedEl = document.getElementById('hoursEarned');
          if (earnedEl) {
            const cwPlus = pm.totalCWPlus || 0;
            earnedEl.textContent = formatPreciseCurrency(cwPlus * 120); // $120/hr earned rate
          }

          const deliveredEl = document.getElementById('valueDelivered');
          if (deliveredEl) {
            const ehh = pm.totalEHH || pm.totalHEH || 0;
            deliveredEl.textContent = formatPreciseCurrency(ehh * 150);
          }
        }

        // Left panel - Work Remaining (orange caution indicators)
        if (data.workRemaining) {
          const wr = data.workRemaining;

          // Pending tasks
          const pendingEl = document.getElementById('panelPendingTasks');
          if (pendingEl) pendingEl.textContent = wr.pendingTasks || 0;

          // Pending HEH
          const pendingHehEl = document.getElementById('panelPendingHEH');
          if (pendingHehEl) pendingHehEl.textContent = (wr.pendingHEH || 0).toFixed(1);

          // Estimated days (use milestone-aware calculation)
          const estDaysEl = document.getElementById('panelEstDays');
          if (estDaysEl) estDaysEl.textContent = wr.estimatedDaysRemaining || wr.estimatedDays || 0;

          // Projected completion HEH
          const projectedEl = document.getElementById('panelProjectedHEH');
          if (projectedEl) projectedEl.textContent = formatNumber(wr.projectedCompletionHEH || 0);

          // Work deficit (if behind)
          const deficitEl = document.getElementById('panelWorkDeficit');
          if (deficitEl) {
            const deficit = wr.workDeficit || 0;
            deficitEl.textContent = deficit > 0 ? '-' + formatNumber(deficit) : '0';
            deficitEl.style.color = deficit > 0 ? '#f44336' : '#4caf50';
          }

          // On-track status indicator
          const statusEl = document.getElementById('panelOnTrackStatus');
          if (statusEl) {
            const onTrack = wr.onTrack;
            statusEl.textContent = onTrack ? 'On Track' : 'Behind';
            statusEl.style.color = onTrack ? '#4caf50' : '#f44336';
          }

          // Legacy status counts (if available from legacy metrics)
          if (data.metrics && data.metrics.workRemaining) {
            const legacy = data.metrics.workRemaining;
            const subEl = document.getElementById('panelSubmitted');
            if (subEl) subEl.textContent = legacy.submitted || 0;
            const revEl = document.getElementById('panelInReview');
            if (revEl) revEl.textContent = legacy.inReview || 0;
            const progEl = document.getElementById('panelInProgress');
            if (progEl) progEl.textContent = legacy.inProgress || 0;
          }

          // Value Pending is now calculated in updateWorkRemainingPanel
        }

        // Update milestone information
        if (data.milestone) {
          const milestoneHoursEl = document.getElementById('milestoneHoursRemaining');
          if (milestoneHoursEl) milestoneHoursEl.textContent = Math.round(data.milestone.hoursRemaining) || 0;

          const milestoneDaysEl = document.getElementById('milestoneWorkdaysRemaining');
          if (milestoneDaysEl) milestoneDaysEl.textContent = data.milestone.workdaysRemaining || 0;

          const milestoneWeeksEl = document.getElementById('milestoneWeeksRemaining');
          if (milestoneWeeksEl) milestoneWeeksEl.textContent = (data.milestone.weeksRemaining || 0).toFixed(1);
        }

        // Update velocity zone indicator
        if (data.velocity) {
          const zoneEl = document.getElementById('velocityZone');
          if (zoneEl) {
            const zone = data.velocity.zone || 'normal';
            const zoneLabels = { peak: 'Peak', accelerating: 'Accelerating', normal: 'Normal', warming_up: 'Warming Up' };
            zoneEl.textContent = zoneLabels[zone] || zone;
          }

          const paceEl = document.getElementById('velocityPaceStatus');
          if (paceEl) {
            const pace = data.velocity.paceStatus || 'on_pace';
            const paceLabels = { ahead: 'Ahead of Pace', on_pace: 'On Pace', behind: 'Behind Pace' };
            paceEl.textContent = paceLabels[pace] || pace;
            paceEl.style.color = pace === 'ahead' ? '#4caf50' : pace === 'behind' ? '#f44336' : '#ffc107';
          }
        }

        // Update fuel gauge with milestone time remaining (not API fuel data)
        milestoneData = calculateMilestoneTimeRemaining();
        FuelGauge.setValue(milestoneData.fuelPercent);
        const fuelTextEl2 = document.getElementById('fuelGaugeText');
        if (fuelTextEl2) {
          fuelTextEl2.textContent = `${milestoneData.hoursRemaining}h`;
        }
      }

      // Format number with K/M suffix
      function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
        return num.toString();
      }

      // Format currency with K suffix
      function formatCurrency(num) {
        if (num >= 1000000) return '$' + (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return '$' + (num / 1000).toFixed(0) + 'K';
        return '$' + num.toFixed(0);
      }

      // Format precise number (no shorthand, with thousands separator, no decimals)
      // Used for metrics that require auditability
      function formatPreciseNumber(num) {
        const value = parseFloat(num) || 0;
        return Math.round(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      }

      // Format precise currency (no shorthand, with thousands separator and 2 decimals)
      // Used for financial metrics that require auditability
      function formatPreciseCurrency(num) {
        const value = parseFloat(num) || 0;
        return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      // Add business days to a date (skips weekends)
      // Timeline Burst: Projects where the project would be if work had been done at human speed
      function addBusinessDays(startDate, businessDays) {
        const result = new Date(startDate);
        let daysAdded = 0;

        while (daysAdded < businessDays) {
          result.setDate(result.getDate() + 1);
          const dayOfWeek = result.getDay();
          // Skip Saturday (6) and Sunday (0)
          if (dayOfWeek !== 0 && dayOfWeek !== 6) {
            daysAdded++;
          }
        }

        return result;
      }

      // Hourly rate for calculations
      const HOURLY_RATE = 120; // $120/hour

      // Update milestone dates and recalculate Fuel gauge
      // Called when: date inputs change, Refresh button clicked, or page loads
      function updateMilestoneDates() {
        const startInput = document.getElementById('milestoneStartDate');
        const endInput = document.getElementById('milestoneEndDate');

        if (!startInput || !endInput) return;

        // Force recalculation of milestone data using current input values
        // calculateMilestoneTimeRemaining() reads directly from input fields
        milestoneData = calculateMilestoneTimeRemaining();

        // Parse date strings as local dates to avoid timezone off-by-one errors
        // Uses parseLocalDate() helper to ensure consistent date parsing throughout the app
        const startDate = parseLocalDate(startInput.value);
        const endDate = parseLocalDate(endInput.value);
        const today = new Date();

        // Use the shared countWorkdays function for consistency
        const totalWorkingDays = countWorkdays(startDate, endDate);
        const remainingWorkingDays = today <= endDate ? countWorkdays(today, endDate) : 0;

        // Working hours (8 hours per day)
        const totalHours = totalWorkingDays * HOURS_PER_WORKDAY;
        const remainingHours = milestoneData.hoursRemaining;  // Use precise calculation
        const workedHours = milestoneData.hoursSpent;         // Use precise calculation

        // Calculate earned amount based on worked hours
        const earnedAmount = workedHours * HOURLY_RATE;

        // Update milestone display in speedometer area (both start and end dates)
        const milestoneStartDisplayEl = document.getElementById('milestoneStartDisplay');
        const milestoneEndDisplayEl = document.getElementById('milestoneEndDisplay');

        if (milestoneStartDisplayEl) {
          // Show start date (short format: "Dec 21")
          milestoneStartDisplayEl.textContent = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        if (milestoneEndDisplayEl) {
          // Show end date with year (full format: "Dec 31, 2025")
          milestoneEndDisplayEl.textContent = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        const milestoneHoursEl = document.getElementById('milestoneHoursRemaining');
        if (milestoneHoursEl) {
          milestoneHoursEl.textContent = remainingHours;
        }

        // Value Pending is now calculated in updateWorkRemainingPanel

        // Update estimated days remaining
        const estDaysEl = document.getElementById('panelEstDays');
        if (estDaysEl) {
          estDaysEl.textContent = remainingWorkingDays;
        }

        // Update earned value in Progress Made panel
        const panelEarnedEl = document.getElementById('panelEarnedValue');
        if (panelEarnedEl) {
          panelEarnedEl.textContent = '$' + earnedAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' EARNED (' + workedHours + 'HRS)';
        }

        // Update Fuel gauge needle and text - CRITICAL for real-time updates
        if (typeof FuelGauge !== 'undefined' && FuelGauge.setValue) {
          FuelGauge.setValue(milestoneData.fuelPercent);
          console.log('[FuelGauge] Updated to', milestoneData.fuelPercent + '%', 'remaining:', milestoneData.hoursRemaining + 'h');
        }

        const fuelTextEl = document.getElementById('fuelGaugeText');
        if (fuelTextEl) {
          fuelTextEl.textContent = `${milestoneData.hoursRemaining}h`;
        }

        // Save milestone dates to localStorage for persistence
        localStorage.setItem('milestoneStartDate', startInput.value);
        localStorage.setItem('milestoneEndDate', endInput.value);

        console.log('[updateMilestoneDates] Milestone recalculated:', {
          startDate: startInput.value,
          endDate: endInput.value,
          totalWorkingDays,
          remainingWorkingDays,
          totalHours,
          remainingHours,
          workedHours,
          earnedAmount
        });
      }

      // Load saved milestone dates on page load
      function loadSavedMilestoneDates() {
        const savedStart = localStorage.getItem('milestoneStartDate');
        const savedEnd = localStorage.getItem('milestoneEndDate');

        if (savedStart) {
          const startInput = document.getElementById('milestoneStartDate');
          if (startInput) startInput.value = savedStart;
        }
        if (savedEnd) {
          const endInput = document.getElementById('milestoneEndDate');
          if (endInput) endInput.value = savedEnd;
        }

        // Recalculate with loaded values
        updateMilestoneDates();
      }

      // Initialize milestone dates when DOM is ready
      setTimeout(loadSavedMilestoneDates, 100);

      // Expose function globally
      window.updateMilestoneDates = updateMilestoneDates;

      // ==================== CUSTOM CALENDAR POPUP ====================
      const customCalendar = {
        element: document.getElementById('customCalendar'),
        overlay: document.getElementById('calendarOverlay'),
        daysContainer: document.getElementById('calendarDays'),
        monthYearLabel: document.getElementById('calendarMonthYear'),
        currentDate: new Date(),
        selectedDate: null,
        targetInput: null,
        months: ['January', 'February', 'March', 'April', 'May', 'June',
                 'July', 'August', 'September', 'October', 'November', 'December'],

        init() {
          // Bind navigation buttons
          document.getElementById('calendarPrevMonth').addEventListener('click', () => this.navigate(-1));
          document.getElementById('calendarNextMonth').addEventListener('click', () => this.navigate(1));
          document.getElementById('calendarCancel').addEventListener('click', () => this.close());
          document.getElementById('calendarToday').addEventListener('click', () => this.goToToday());
          document.getElementById('calendarConfirm').addEventListener('click', () => this.confirm());
          this.overlay.addEventListener('click', () => this.close());

          // Replace native date pickers with custom calendar
          const startInput = document.getElementById('milestoneStartDate');
          const endInput = document.getElementById('milestoneEndDate');

          if (startInput) {
            startInput.addEventListener('click', (e) => {
              e.preventDefault();
              this.open(startInput);
            });
            // Prevent native picker
            startInput.addEventListener('mousedown', (e) => e.preventDefault());
          }

          if (endInput) {
            endInput.addEventListener('click', (e) => {
              e.preventDefault();
              this.open(endInput);
            });
            // Prevent native picker
            endInput.addEventListener('mousedown', (e) => e.preventDefault());
          }
        },

        open(inputElement) {
          this.targetInput = inputElement;

          // Parse current value
          const currentValue = inputElement.value;
          if (currentValue) {
            const parts = currentValue.split('-');
            this.currentDate = new Date(parts[0], parts[1] - 1, parts[2]);
            this.selectedDate = new Date(this.currentDate);
          } else {
            this.currentDate = new Date();
            this.selectedDate = null;
          }

          // Position calendar near the input
          const rect = inputElement.getBoundingClientRect();
          const calendarHeight = 380;
          const calendarWidth = 300;

          let top = rect.bottom + 8;
          let left = rect.left;

          // Adjust if it would go off screen
          if (top + calendarHeight > window.innerHeight) {
            top = rect.top - calendarHeight - 8;
          }
          if (left + calendarWidth > window.innerWidth) {
            left = window.innerWidth - calendarWidth - 16;
          }

          this.element.style.top = `${top}px`;
          this.element.style.left = `${left}px`;

          this.render();
          this.element.classList.add('active');
          this.overlay.classList.add('active');
        },

        close() {
          this.element.classList.remove('active');
          this.overlay.classList.remove('active');
          this.targetInput = null;
        },

        navigate(direction) {
          this.currentDate.setMonth(this.currentDate.getMonth() + direction);
          this.render();
        },

        goToToday() {
          const today = new Date();
          this.currentDate = new Date(today);
          this.selectedDate = new Date(today);
          this.render();
        },

        confirm() {
          if (this.selectedDate && this.targetInput) {
            const year = this.selectedDate.getFullYear();
            const month = String(this.selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(this.selectedDate.getDate()).padStart(2, '0');
            this.targetInput.value = `${year}-${month}-${day}`;

            // Trigger change event
            const event = new Event('change', { bubbles: true });
            this.targetInput.dispatchEvent(event);

            // Directly call updateMilestoneDates to ensure Fuel gauge updates
            // This is necessary because synthetic events may not trigger inline onchange handlers
            if (typeof updateMilestoneDates === 'function') {
              updateMilestoneDates();
              console.log('[CustomCalendar] Date confirmed, updateMilestoneDates called directly');
            }
          }
          this.close();
        },

        selectDate(year, month, day) {
          this.selectedDate = new Date(year, month, day);
          this.render();
        },

        render() {
          const year = this.currentDate.getFullYear();
          const month = this.currentDate.getMonth();

          // Update header
          this.monthYearLabel.textContent = `${this.months[month]} ${year}`;

          // Calculate days
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const daysInPrevMonth = new Date(year, month, 0).getDate();

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          let html = '';

          // Previous month days
          for (let i = firstDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const prevMonth = month - 1;
            const prevYear = prevMonth < 0 ? year - 1 : year;
            const actualMonth = prevMonth < 0 ? 11 : prevMonth;
            html += `<div class="calendar-day other-month" data-year="${prevYear}" data-month="${actualMonth}" data-day="${day}">${day}</div>`;
          }

          // Current month days
          for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(year, month, day);
            dateObj.setHours(0, 0, 0, 0);

            let classes = 'calendar-day';
            if (dateObj.getTime() === today.getTime()) {
              classes += ' today';
            }
            if (this.selectedDate &&
                this.selectedDate.getFullYear() === year &&
                this.selectedDate.getMonth() === month &&
                this.selectedDate.getDate() === day) {
              classes += ' selected';
            }

            html += `<div class="${classes}" data-year="${year}" data-month="${month}" data-day="${day}">${day}</div>`;
          }

          // Next month days
          const totalCells = firstDay + daysInMonth;
          const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
          for (let day = 1; day <= remainingCells; day++) {
            const nextMonth = month + 1;
            const nextYear = nextMonth > 11 ? year + 1 : year;
            const actualMonth = nextMonth > 11 ? 0 : nextMonth;
            html += `<div class="calendar-day other-month" data-year="${nextYear}" data-month="${actualMonth}" data-day="${day}">${day}</div>`;
          }

          this.daysContainer.innerHTML = html;

          // Bind click events
          this.daysContainer.querySelectorAll('.calendar-day').forEach(cell => {
            cell.addEventListener('click', () => {
              const y = parseInt(cell.dataset.year);
              const m = parseInt(cell.dataset.month);
              const d = parseInt(cell.dataset.day);
              this.selectDate(y, m, d);
            });
          });
        }
      };

      // Initialize custom calendar
      setTimeout(() => customCalendar.init(), 150);

      // Render tasks table (only if tasksTableBody exists)
      function renderTasks() {
        if (!tasksTableBody) return;  // Table was removed from Analytics view
        if (tasks.length === 0) {
          tasksTableBody.innerHTML = `
            <tr>
              <td colspan="8">
                <div class="empty-state">
                  <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                  <div class="empty-state-text">No tasks found</div>
                  <button class="btn-create" data-action="create-task">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Create First Task
                  </button>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        // Render tasks in batches to prevent page unresponsiveness
        const BATCH_SIZE = 25;
        let currentIndex = 0;

        // Clear table first
        tasksTableBody.innerHTML = '';

        function renderBatch() {
          const fragment = document.createDocumentFragment();
          const endIndex = Math.min(currentIndex + BATCH_SIZE, tasks.length);

          for (let i = currentIndex; i < endIndex; i++) {
            const task = tasks[i];
            const tr = document.createElement('tr');
            tr.setAttribute('data-task-id', task.id);
            if (editPanelTaskId === task.id) tr.classList.add('selected');
            tr.innerHTML = `
              <td><span class="task-id">${formatTaskNumber(task.taskNumber)}</span></td>
              <td><span class="task-title">${escapeHtml(task.title)}</span></td>
              <td><span class="type-badge ${task.taskType}">${task.taskType}</span></td>
              <td>
                <span class="priority-badge ${task.priority}">
                  <span class="priority-dot"></span>
                  ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                </span>
              </td>
              <td><span class="status-badge ${task.status}">${formatStatus(task.status)}</span></td>
              <td><span class="task-component">${task.component || '-'}</span></td>
              <td><span class="task-date">${formatDate(task.createdAt)}</span></td>
              <td>
                <div class="task-actions">
                  <button class="action-btn edit-btn" data-action="edit-task" title="Edit Task">
                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                  </button>
                  <button class="action-btn status-btn" data-action="status-modal" data-status="${task.status}">Status</button>
                </div>
              </td>
            `;
            fragment.appendChild(tr);
          }

          tasksTableBody.appendChild(fragment);
          currentIndex = endIndex;

          // Continue rendering remaining batches in next animation frame
          if (currentIndex < tasks.length) {
            requestAnimationFrame(renderBatch);
          }
        }

        // Start batch rendering
        requestAnimationFrame(renderBatch);
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Load tasks from API
      async function loadTasks() {
        try {
          const params = new URLSearchParams();
          if (filterStatus.value) params.set('status', filterStatus.value);
          if (filterType.value) params.set('taskType', filterType.value);
          if (filterPriority.value) params.set('priority', filterPriority.value);
          if (searchInput.value) params.set('search', searchInput.value);

          const response = await fetch('/api/admin/tasks?' + params.toString(), {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              window.location.href = '/login?redirect=/admin/tasks';
              return;
            }
            throw new Error('Failed to load tasks');
          }

          const data = await response.json();
          tasks = data.tasks || [];
          stats = data.stats || {};

          updateStats();
          renderTasks();
          updateOperationalHealthGauges();  // Update operational health based on new task data
        } catch (error) {
          console.error('Error loading tasks:', error);
          if (tasksTableBody) {
            tasksTableBody.innerHTML = `
              <tr>
                <td colspan="8">
                  <div class="empty-state">
                    <div class="empty-state-text">Failed to load tasks. Please try again.</div>
                  </div>
                </td>
              </tr>
            `;
          }
        }
      }

      // Load assignees
      async function loadAssignees() {
        try {
          const response = await fetch('/api/admin/tasks/assignees', {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (response.ok) {
            const data = await response.json();
            assignees = data.users || [];
            updateAssigneeDropdown();
          }
        } catch (error) {
          console.error('Error loading assignees:', error);
        }
      }

      // Update assignee dropdown
      function updateAssigneeDropdown() {
        const select = document.getElementById('taskAssignee');
        select.innerHTML = '<option value="">Unassigned</option>' +
          assignees.map(u => `<option value="${u.id}">${escapeHtml(u.displayName)}</option>`).join('');
      }

      // Open create modal
      function openCreateModal() {
        currentTaskId = null;
        document.getElementById('modalTitle').textContent = 'New Task';
        document.getElementById('btnSubmitTask').textContent = 'Create Task';
        document.getElementById('taskForm').reset();
        document.getElementById('taskModal').classList.add('active');
      }

      // Edit task
      window.editTask = async function(taskId) {
        try {
          const response = await fetch('/api/admin/tasks/' + taskId, {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) throw new Error('Failed to load task');

          const data = await response.json();
          const task = data.task;

          currentTaskId = task.id;
          document.getElementById('modalTitle').textContent = 'Edit Task ' + formatTaskNumber(task.taskNumber);
          document.getElementById('btnSubmitTask').textContent = 'Save Changes';
          document.getElementById('taskTitle').value = task.title || '';
          document.getElementById('taskDescription').value = task.description || '';
          document.getElementById('taskType').value = task.taskType || 'development';
          document.getElementById('taskPriority').value = task.priority || 'medium';
          document.getElementById('taskComponent').value = task.component || '';
          document.getElementById('taskAssignee').value = task.assignedToId || '';
          document.getElementById('taskNotes').value = task.notes || '';
          document.getElementById('taskModal').classList.add('active');
        } catch (error) {
          console.error('Error loading task:', error);
          alert('Failed to load task details');
        }
      };

      // View task (same as edit for now)
      window.viewTask = function(taskId) {
        editTask(taskId);
      };

      // Submit task form
      async function submitTask() {
        const title = document.getElementById('taskTitle').value.trim();
        if (!title) {
          alert('Task title is required');
          return;
        }

        const taskData = {
          title,
          description: document.getElementById('taskDescription').value.trim() || null,
          taskType: document.getElementById('taskType').value,
          priority: document.getElementById('taskPriority').value,
          component: document.getElementById('taskComponent').value.trim() || null,
          assignedToId: document.getElementById('taskAssignee').value || null,
          notes: document.getElementById('taskNotes').value.trim() || null
        };

        try {
          const url = currentTaskId ? '/api/admin/tasks/' + currentTaskId : '/api/admin/tasks';
          const method = currentTaskId ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method,
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(taskData)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save task');
          }

          document.getElementById('taskModal').classList.remove('active');
          loadTasks();
          loadVelocity(); // Refresh velocity after creating task
        } catch (error) {
          console.error('Error saving task:', error);
          alert(error.message);
        }
      }

      // Open status modal
      window.openStatusModal = function(taskId, currentStatus) {
        document.getElementById('statusTaskId').value = taskId;
        document.getElementById('statusComment').value = '';
        selectedStatus = null;

        // Define all statuses and valid transitions
        const allStatuses = ['submitted', 'in_review', 'in_progress', 'fixing', 'completed'];
        const validTransitions = {
          'submitted': ['in_review', 'completed'],
          'in_review': ['in_progress', 'submitted', 'completed'],
          'in_progress': ['fixing', 'in_review', 'completed'],
          'fixing': ['completed', 'in_progress'],
          'completed': ['in_progress']
        };

        const valid = validTransitions[currentStatus] || [];

        const optionsHtml = allStatuses.map(status => {
          const isValid = valid.includes(status);
          const isCurrent = status === currentStatus;
          return `
            <div class="status-option ${!isValid && !isCurrent ? 'disabled' : ''} ${isCurrent ? 'current' : ''}"
                 data-status="${status}"
                 data-valid="${isValid}">
              <span class="status-badge ${status}">${formatStatus(status)}</span>
              ${isCurrent ? '<span style="color: #fff; text-shadow: 0 0 6px rgba(255,255,255,0.3); font-size: 11px;">(current)</span>' : ''}
            </div>
          `;
        }).join('');

        const statusOptionsEl = document.getElementById('statusOptions');
        statusOptionsEl.innerHTML = optionsHtml;
        // Add event delegation for status options (CSP blocks inline onclick)
        statusOptionsEl.onclick = function(e) {
          const option = e.target.closest('.status-option');
          if (option && option.dataset.valid === 'true') {
            selectStatus(option.dataset.status);
          }
        };
        document.getElementById('statusModal').classList.add('active');
      };

      // Select status
      window.selectStatus = function(status) {
        selectedStatus = status;
        document.querySelectorAll('.status-option').forEach(el => {
          el.style.borderColor = el.dataset.status === status ? '#ffbd59' : '#333';
        });
      };

      // Submit status change
      async function submitStatusChange() {
        if (!selectedStatus) {
          alert('Please select a status');
          return;
        }

        const taskId = document.getElementById('statusTaskId').value;
        const comment = document.getElementById('statusComment').value.trim() || null;

        try {
          const response = await fetch('/api/admin/tasks/' + taskId + '/status', {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ status: selectedStatus, comment })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update status');
          }

          document.getElementById('statusModal').classList.remove('active');
          loadTasks();
          loadVelocity(); // Refresh velocity after status change
        } catch (error) {
          console.error('Error updating status:', error);
          alert(error.message);
        }
      }

      // Event listeners
      document.getElementById('btnCreate')?.addEventListener('click', openCreateModal);
      document.getElementById('modalClose').addEventListener('click', () => {
        document.getElementById('taskModal').classList.remove('active');
      });
      document.getElementById('btnCancelTask').addEventListener('click', () => {
        document.getElementById('taskModal').classList.remove('active');
      });
      document.getElementById('btnSubmitTask').addEventListener('click', submitTask);
      document.getElementById('statusModalClose').addEventListener('click', () => {
        document.getElementById('statusModal').classList.remove('active');
      });
      document.getElementById('btnCancelStatus').addEventListener('click', () => {
        document.getElementById('statusModal').classList.remove('active');
      });
      document.getElementById('btnSubmitStatus').addEventListener('click', submitStatusChange);

      // Filter listeners (only if elements exist in DOM)
      let searchTimeout;
      if (document.getElementById('filterStatus')) {
        filterStatus.addEventListener('change', loadTasks);
      }
      if (document.getElementById('filterType')) {
        filterType.addEventListener('change', loadTasks);
      }
      if (document.getElementById('filterPriority')) {
        filterPriority.addEventListener('change', loadTasks);
      }
      if (document.getElementById('searchInput')) {
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(loadTasks, 300);
        });
      }

      // Close modals on overlay click
      document.getElementById('taskModal').addEventListener('click', (e) => {
        if (e.target.id === 'taskModal') {
          document.getElementById('taskModal').classList.remove('active');
        }
      });
      document.getElementById('statusModal').addEventListener('click', (e) => {
        if (e.target.id === 'statusModal') {
          document.getElementById('statusModal').classList.remove('active');
        }
      });

      // ==================== EDIT PANEL FUNCTIONS ====================

      // Open edit panel with task data
      window.openEditPanel = async function(taskId) {
        try {
          const response = await fetch('/api/admin/tasks/' + taskId, {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) throw new Error('Failed to load task');

          const data = await response.json();
          const task = data.task;

          // Store current task info
          editPanelTaskId = task.id;
          editPanelOriginalStatus = task.status;

          // Populate form fields
          document.getElementById('editTaskId').value = task.id;
          document.getElementById('editPanelTaskId').textContent = formatTaskNumber(task.taskNumber);
          document.getElementById('editTaskTitle').value = task.title || '';
          document.getElementById('editTaskDescription').value = task.description || '';
          document.getElementById('editTaskType').value = task.taskType || 'development';
          document.getElementById('editTaskPriority').value = task.priority || 'medium';
          document.getElementById('editTaskStatus').value = task.status || 'submitted';
          document.getElementById('editTaskComponent').value = task.component || '';
          document.getElementById('editTaskNotes').value = task.notes || '';
          document.getElementById('editTaskResolution').value = task.resolution || '';

          // Update assignee dropdown
          updateEditPanelAssigneeDropdown();
          document.getElementById('editTaskAssignee').value = task.assignedToId || '';

          // Populate metadata
          document.getElementById('editMetaCreatedBy').textContent = task.createdByName || '-';
          document.getElementById('editMetaCreatedAt').textContent = formatDateTime(task.createdAt);
          document.getElementById('editMetaSubmittedAt').textContent = formatDateTime(task.submittedAt);
          document.getElementById('editMetaUpdatedAt').textContent = formatDateTime(task.updatedAt);
          document.getElementById('editMetaReviewedAt').textContent = formatDateTime(task.reviewedAt);
          document.getElementById('editMetaStartedAt').textContent = formatDateTime(task.startedAt);
          document.getElementById('editMetaFixingAt').textContent = formatDateTime(task.fixingAt);
          document.getElementById('editMetaCompletedAt').textContent = formatDateTime(task.completedAt);

          // Load status history
          loadStatusHistory(taskId);

          // Open panel
          document.getElementById('editPanelContainer').classList.add('open');
          document.getElementById('editPanelOverlay').classList.add('visible');

          // Update table row selection
          renderTasks();
        } catch (error) {
          console.error('Error loading task for edit panel:', error);
          alert('Failed to load task details');
        }
      };

      // Close edit panel
      function closeEditPanel() {
        document.getElementById('editPanelContainer').classList.remove('open');
        document.getElementById('editPanelOverlay').classList.remove('visible');
        editPanelTaskId = null;
        editPanelOriginalStatus = null;
        renderTasks();
      }

      // Update edit panel assignee dropdown
      function updateEditPanelAssigneeDropdown() {
        const select = document.getElementById('editTaskAssignee');
        select.innerHTML = '<option value="">Unassigned</option>' +
          assignees.map(u => `<option value="${u.id}">${escapeHtml(u.displayName)}</option>`).join('');
      }

      // Format datetime
      function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Load status history
      async function loadStatusHistory(taskId) {
        try {
          const response = await fetch('/api/admin/tasks/' + taskId + '/history', {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) {
            document.getElementById('statusHistorySection').style.display = 'none';
            return;
          }

          const data = await response.json();
          const history = data.history || [];

          if (history.length === 0) {
            document.getElementById('statusHistorySection').style.display = 'none';
            return;
          }

          const historyHtml = history.map(h => `
            <div class="status-history-item">
              <span class="status-badge ${h.previousStatus || 'submitted'}">${formatStatus(h.previousStatus || 'new')}</span>
              <span class="status-history-arrow"></span>
              <span class="status-badge ${h.newStatus}">${formatStatus(h.newStatus)}</span>
              <span class="status-history-meta">${formatDateTime(h.changedAt)}</span>
            </div>
          `).join('');

          document.getElementById('statusHistoryList').innerHTML = historyHtml;
          document.getElementById('statusHistorySection').style.display = 'block';
        } catch (error) {
          console.error('Error loading status history:', error);
          document.getElementById('statusHistorySection').style.display = 'none';
        }
      }

      // Save task from edit panel
      async function saveTaskFromPanel() {
        const taskId = document.getElementById('editTaskId').value;
        const title = document.getElementById('editTaskTitle').value.trim();

        if (!title) {
          alert('Task title is required');
          return;
        }

        const newStatus = document.getElementById('editTaskStatus').value;
        const statusChanged = newStatus !== editPanelOriginalStatus;

        const taskData = {
          title,
          description: document.getElementById('editTaskDescription').value.trim() || null,
          taskType: document.getElementById('editTaskType').value,
          priority: document.getElementById('editTaskPriority').value,
          component: document.getElementById('editTaskComponent').value.trim() || null,
          assignedToId: document.getElementById('editTaskAssignee').value || null,
          notes: document.getElementById('editTaskNotes').value.trim() || null,
          resolution: document.getElementById('editTaskResolution').value.trim() || null
        };

        try {
          // Update task data
          const response = await fetch('/api/admin/tasks/' + taskId, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(taskData)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save task');
          }

          // Update status if changed
          if (statusChanged) {
            const statusResponse = await fetch('/api/admin/tasks/' + taskId + '/status', {
              method: 'PUT',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({ status: newStatus })
            });

            if (!statusResponse.ok) {
              const error = await statusResponse.json();
              throw new Error(error.error || 'Failed to update status');
            }
          }

          // Reload tasks and velocity, then close panel
          await loadTasks();
          loadVelocity(); // Refresh velocity after task update
          closeEditPanel();
        } catch (error) {
          console.error('Error saving task:', error);
          alert(error.message);
        }
      }

      // Delete task from edit panel
      async function deleteTaskFromPanel() {
        const taskId = document.getElementById('editTaskId').value;
        const taskNumber = document.getElementById('editPanelTaskId').textContent;

        if (!confirm(`Are you sure you want to delete task ${taskNumber}? This cannot be undone.`)) {
          return;
        }

        try {
          const response = await fetch('/api/admin/tasks/' + taskId, {
            method: 'DELETE',
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete task');
          }

          await loadTasks();
          loadVelocity(); // Refresh velocity after task delete
          closeEditPanel();
        } catch (error) {
          console.error('Error deleting task:', error);
          alert(error.message);
        }
      }

      // ==================== PANEL RESIZE FUNCTIONALITY ====================

      const editPanelContainer = document.getElementById('editPanelContainer');
      const editPanelResizeHandle = document.getElementById('editPanelResizeHandle');

      editPanelResizeHandle.addEventListener('mousedown', (e) => {
        isPanelResizing = true;
        editPanelResizeHandle.classList.add('resizing');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isPanelResizing) return;

        const newWidth = window.innerWidth - e.clientX;
        const minWidth = 360;
        const maxWidth = 800;

        panelWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
        editPanelContainer.style.width = panelWidth + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isPanelResizing) {
          isPanelResizing = false;
          editPanelResizeHandle.classList.remove('resizing');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // ==================== EDIT PANEL EVENT LISTENERS ====================

      document.getElementById('editPanelClose').addEventListener('click', closeEditPanel);
      document.getElementById('btnPanelCancel').addEventListener('click', closeEditPanel);
      document.getElementById('btnPanelSave').addEventListener('click', saveTaskFromPanel);
      document.getElementById('btnPanelDelete').addEventListener('click', deleteTaskFromPanel);
      document.getElementById('editPanelOverlay').addEventListener('click', closeEditPanel);

      // Close panel on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && editPanelTaskId) {
          closeEditPanel();
        }
      });

      // Initialize
      initSidebar();
      initPanelResize();

      // Initialize velocity gauge (speedometer) - start at 0, animate to value
      VelocityGauge.init('velocityGaugeCanvas');
      VelocityGauge.setValueInstant(0);

      // Note: Main gauge value is set dynamically by loadDashboardMetrics()
      // which calculates WPH from database data. No hardcoded value here.

      // Initialize all 4 mini gauges - start at max, then animate to target
      FuelGauge.init();
      FuelGauge.setValueInstant(100);  // Start at max (full fuel = 100% time remaining)

      TempGauge.init();
      TempGauge.setValueInstant(100);  // Start at max

      OilGauge.init();
      OilGauge.setValueInstant(100);  // Start at max

      RpmGauge.init();
      RpmGauge.setValueInstant(100);  // Start at max

      // After a short delay, animate gauges to their actual values
      setTimeout(() => {
        // Calculate milestone time remaining and set Fuel gauge
        milestoneData = calculateMilestoneTimeRemaining();
        FuelGauge.setValue(milestoneData.fuelPercent);
        const fuelTextEl = document.getElementById('fuelGaugeText');
        if (fuelTextEl) fuelTextEl.textContent = `${milestoneData.hoursRemaining}h`;

        // Initialize operational metrics gauges with calculated values
        // These will be properly updated once tasks are loaded
        TempGauge.setValue(0);   // Execution Pressure: starts at 0%
        OilGauge.setValue(100);  // Delivery Confidence: starts at 100% (high is good)
        RpmGauge.setValue(100);  // Quality Control: starts at 100% (high is good)
      }, 500);

      // Update operational health gauges when tasks change
      function updateOperationalHealthGauges() {
        const metrics = calculateOperationalHealth(tasks, stats);

        // Update TEMP (Execution Pressure) gauge
        TempGauge.setValue(metrics.pressure.gaugePercent);
        const tempText = document.getElementById('tempGaugeText');
        if (tempText) tempText.textContent = `${Math.round(metrics.pressure.value)}%`;

        // Update OIL (Delivery Confidence) gauge
        OilGauge.setValue(metrics.confidence.gaugePercent);
        const oilText = document.getElementById('oilGaugeText');
        if (oilText) oilText.textContent = `${Math.round(metrics.confidence.value)}%`;

        // Update RPM (Quality Control) gauge
        RpmGauge.setValue(metrics.quality.gaugePercent);
        const rpmText = document.getElementById('rpmGaugeText');
        if (rpmText) rpmText.textContent = `${Math.round(metrics.quality.value)}%`;

        // Update Work Remaining panel with new metrics
        updateWorkRemainingPanel(metrics);

        console.log('Operational Metrics Updated:', {
          pressure: `${metrics.pressure.value.toFixed(1)}% (${metrics.pressure.zone})`,
          confidence: `${metrics.confidence.value.toFixed(1)}% (${metrics.confidence.zone})`,
          quality: `${metrics.quality.value.toFixed(1)}% (${metrics.quality.zone})`,
          milestoneConfidence: metrics.milestoneConfidence,
          schedule: metrics.schedulePosition
        });
      }

      // Update Work Remaining panel with calculated metrics
      function updateWorkRemainingPanel(metrics) {
        // Remaining Tasks
        const pendingTasksEl = document.getElementById('panelPendingTasks');
        if (pendingTasksEl) pendingTasksEl.textContent = metrics.pendingTasks || 0;

        // Remaining Est. HH
        const pendingHHEl = document.getElementById('panelPendingHEH');
        if (pendingHHEl) pendingHHEl.textContent = Math.round(metrics.pendingHH || 0);

        // Required WPH
        const requiredWPHEl = document.getElementById('panelRequiredWPH');
        if (requiredWPHEl) requiredWPHEl.textContent = Math.round(metrics.requiredWPH || 0);

        // Current WPH
        const currentWPHEl = document.getElementById('panelCurrentWPH');
        if (currentWPHEl) currentWPHEl.textContent = Math.round(metrics.currentWPH || 0);

        // Execution Pressure
        const execPressureEl = document.getElementById('panelExecPressure');
        if (execPressureEl) {
          execPressureEl.textContent = `${Math.round(metrics.pressure.value)}%`;
          // Color code based on zone
          if (metrics.pressure.zone === 'at_risk') {
            execPressureEl.style.color = '#ef4444'; // Red
          } else if (metrics.pressure.zone === 'moderate') {
            execPressureEl.style.color = '#f59e0b'; // Yellow/Orange
          } else {
            execPressureEl.style.color = '#22c55e'; // Green
          }
        }

        // Estimated Completion Date
        const estCompletionEl = document.getElementById('panelEstCompletion');
        if (estCompletionEl && metrics.estCompletionDate) {
          const date = metrics.estCompletionDate;
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          estCompletionEl.textContent = `${month}/${day}/${date.getFullYear()}`;
        }

        // Schedule Position
        const scheduleEl = document.getElementById('panelSchedulePosition');
        if (scheduleEl) {
          scheduleEl.textContent = metrics.schedulePosition;
          // Color code based on position
          if (metrics.schedulePosition.includes('Behind')) {
            scheduleEl.style.color = '#ef4444'; // Red
          } else if (metrics.schedulePosition.includes('Ahead')) {
            scheduleEl.style.color = '#22c55e'; // Green
          } else {
            scheduleEl.style.color = '#f59e0b'; // Yellow for On Track
          }
        }

        // Milestone Confidence
        const confidenceEl = document.getElementById('panelMilestoneConfidence');
        if (confidenceEl) {
          confidenceEl.textContent = metrics.milestoneConfidence;
          // Color code based on confidence
          if (metrics.milestoneConfidence === 'Low') {
            confidenceEl.style.color = '#ef4444'; // Red
          } else if (metrics.milestoneConfidence === 'Medium') {
            confidenceEl.style.color = '#f59e0b'; // Yellow/Orange
          } else {
            confidenceEl.style.color = '#22c55e'; // Green
          }
        }

        // Value Pending = Remaining Est. HH  $150/hr
        const valuePendingEl = document.getElementById('panelValuePending');
        if (valuePendingEl) {
          const pendingHH = metrics.pendingHH || 0;
          const valuePending = pendingHH * 150;
          valuePendingEl.textContent = '$' + valuePending.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Fuel Context - show calculation basis
        const fuelContextEl = document.getElementById('panelFuelContext');
        if (fuelContextEl) {
          const pendingHH = metrics.pendingHH || 0;
          fuelContextEl.textContent = `Estimated: ${Math.round(pendingHH).toLocaleString()} EHH  $150.00/hr`;
          // Calculate total milestone hours (kept for future use)
          const startDateInput = document.getElementById('milestoneStartDate');
          const endDateInput = document.getElementById('milestoneEndDate');
          if (false && startDateInput && endDateInput) {  // Disabled for now
            // Parse dates as local time using shared helper
            const startDate = parseLocalDate(startDateInput.value);
            const endDate = parseLocalDate(endDateInput.value);
            const totalMilestoneHours = calculateWorkingHours(startDate, endDate);
            const fuelPercent = totalMilestoneHours > 0 ? Math.round((metrics.hoursRemaining / totalMilestoneHours) * 100) : 0;
            fuelContextEl.textContent = `${fuelPercent}% of milestone window`;
          }
        }
      }

      // Helper: Calculate working hours between two dates (Mon-Fri, 8hrs/day)
      function calculateWorkingHours(startDate, endDate) {
        let hours = 0;
        const current = new Date(startDate);
        while (current <= endDate) {
          const dayOfWeek = current.getDay();
          if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not weekend
            hours += 8;
          }
          current.setDate(current.getDate() + 1);
        }
        return hours;
      }

      // ==================== VIEW SWITCHING FUNCTIONALITY ====================

      let currentView = 'dashboard';  // Default to Dashboard/Analytics view for this page
      let selectedTaskId = null;
      let taskQueueData = [];

      // QA tests state - must be declared before switchToView which references loadQATests
      let qaTestsData = [];
      let qaTestsLoading = false;
      let qaTestsRunning = false;
      let expandedCategories = new Set();

      // Set default view class on body (Dashboard/Analytics view for this page)
      document.body.classList.add('dashboard-view-active');

      // Switch between Analytics, Tasks, and QA Tests views
      function switchToView(viewName) {
        console.log('switchToView called with:', viewName);
        currentView = viewName;

        // Update body class for CSS view switching
        document.body.classList.remove('dashboard-view-active', 'tasks-view-active', 'qa-view-active');
        document.body.classList.add(viewName + '-view-active');

        // Update control panel button states
        document.querySelectorAll('.control-btn[data-view]').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === viewName);
        });

        // Load view-specific data
        if (viewName === 'tasks') {
          loadTaskQueue();
        } else if (viewName === 'dashboard') {
          loadDashboardMetrics();
        } else if (viewName === 'qa') {
          loadQATests();
        }

        // Save view state
        saveViewState();
      }
      // Expose globally for onclick handlers
      window.switchToView = switchToView;

      // Also attach event listeners directly to buttons
      document.querySelectorAll('.control-btn[data-view]').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const view = this.dataset.view;
          console.log('Button clicked, view:', view);
          switchToView(view);
        });
      });

      // Refresh current view data
      window.refreshCurrentView = function() {
        if (currentView === 'tasks') {
          loadTaskQueue();
        } else if (currentView === 'dashboard') {
          loadDashboardMetrics();
        } else if (currentView === 'qa') {
          loadQATests();
        }
        console.log('Refreshed view:', currentView);
      };

      // ==================== TASK QUEUE FUNCTIONALITY ====================

      // Event delegation for task queue clicks - attached once, works for dynamically rendered items
      (function() {
        const queueList = document.getElementById('taskQueueList');
        if (queueList) {
          queueList.addEventListener('click', (e) => {
            // Handle QA test button click (CSP blocks inline onclick)
            const qaBtn = e.target.closest('.qa-test-btn');
            if (qaBtn) {
              e.stopPropagation();
              const taskId = qaBtn.dataset.taskId;
              if (taskId) {
                runTaskQATests(taskId);
              }
              return;
            }
            // Find the clicked task-queue-item
            const taskItem = e.target.closest('.task-queue-item');
            if (taskItem) {
              e.stopPropagation(); // Prevent any bubbling issues
              const taskId = taskItem.dataset.taskId; // Keep as string (UUID)
              if (taskId) {
                selectTask(taskId);
              }
            }
          });
        }
      })();

      // Load tasks into the task queue column
      async function loadTaskQueue() {
        const queueList = document.getElementById('taskQueueList');
        const filterEl = document.getElementById('taskQueueFilter');
        const filterValue = filterEl ? filterEl.value : 'open';

        // Preserve current selection to avoid panel flicker
        const preservedTaskId = selectedTaskId;

        // Show loading state
        queueList.innerHTML = '<div class="task-queue-loading"><div class="loading-spinner"></div><span>Loading tasks...</span></div>';

        try {
          const response = await fetch('/api/admin/tasks', {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) {
            console.error('Tasks API error:', response.status, response.statusText);
            // Check for authentication redirect
            if (response.status === 401 || response.redirected) {
              queueList.innerHTML = '<div class="task-queue-error">Session expired. Please <a href="/login" style="color: #ffbd59;">log in</a> again.</div>';
              return;
            }
            throw new Error('Failed to load tasks');
          }

          const data = await response.json();
          taskQueueData = data.tasks || [];

          // Filter tasks based on Open/Archive selection with 24-hour completion window
          let filteredTasks = taskQueueData;
          const getTaskStatus = (t) => t.workflow_status || t.status || 'submitted';
          const now = Date.now();
          const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);

          // Helper to check if task was completed within 24 hours
          const isRecentlyCompleted = (task) => {
            const status = getTaskStatus(task);
            if (status !== 'completed') return false;
            const completedAt = task.completed_at ? new Date(task.completed_at).getTime() : 0;
            return completedAt > twentyFourHoursAgo;
          };

          if (filterValue === 'open') {
            // Open Tasks: All non-completed + completed within last 24 hours
            filteredTasks = taskQueueData.filter(t => {
              const status = getTaskStatus(t);
              if (status !== 'completed') return true;
              return isRecentlyCompleted(t);
            });
          } else if (filterValue === 'archive') {
            // Archive: Only tasks completed more than 24 hours ago
            filteredTasks = taskQueueData.filter(t => {
              const status = getTaskStatus(t);
              if (status !== 'completed') return false;
              return !isRecentlyCompleted(t);
            });
          }

          // Sort by priority (critical first) then by created date
          const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
          filteredTasks.sort((a, b) => {
            const pDiff = (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3);
            if (pDiff !== 0) return pDiff;
            return new Date(b.created_at) - new Date(a.created_at);
          });

          // Render task queue items
          if (filteredTasks.length === 0) {
            queueList.innerHTML = `<div class="task-queue-empty">No ${filterValue === 'archive' ? 'archived' : 'open'} tasks</div>`;
            updateQueueFooter([], filterValue);
            hideTaskEdit();
            return;
          }

          // Render in batches to prevent page unresponsiveness
          const BATCH_SIZE = 20;
          let currentIndex = 0;
          queueList.innerHTML = '';

          function renderQueueBatch() {
            const fragment = document.createDocumentFragment();
            const endIndex = Math.min(currentIndex + BATCH_SIZE, filteredTasks.length);

            for (let i = currentIndex; i < endIndex; i++) {
              const task = filteredTasks[i];
              const div = document.createElement('div');
              div.innerHTML = renderTaskQueueItem(task);
              fragment.appendChild(div.firstElementChild);
            }

            queueList.appendChild(fragment);
            currentIndex = endIndex;

            if (currentIndex < filteredTasks.length) {
              requestAnimationFrame(renderQueueBatch);
            }
          }

          requestAnimationFrame(renderQueueBatch);

          // Update footer with totals for current view
          updateQueueFooter(filteredTasks, filterValue);

          // Restore selection if task still exists in filtered list
          const taskStillVisible = preservedTaskId && filteredTasks.find(t => String(t.id) === String(preservedTaskId));
          if (taskStillVisible) {
            // Re-apply selection and ensure edit panel is visible
            selectedTaskId = String(preservedTaskId);
            document.querySelectorAll('.task-queue-item').forEach(item => {
              item.classList.toggle('selected', String(item.dataset.taskId) === String(preservedTaskId));
            });
            // Ensure edit panel shows the preserved task
            showTaskEdit(taskStillVisible);
          } else if (filteredTasks.length > 0) {
            // Select first task if previous selection not in current view
            selectTask(filteredTasks[0].id);
          }

        } catch (error) {
          console.error('Error loading task queue:', error);
          queueList.innerHTML = `<div class="task-queue-error">Error loading tasks: ${error.message || 'Unknown error'}</div>`;
        }
      }

      // Render a single task queue item
      function renderTaskQueueItem(task) {
        const isSelected = task.id == selectedTaskId;
        // Format Task ID as JTX + 6 digits using task_code from database, fallback to task_number
        const displayId = task.taskCode || task.task_code || ('JTX' + String(task.taskNumber || task.task_number || task.id).padStart(6, '0'));
        // Format created date as MM/DD
        const createdDate = task.created_at ? new Date(task.created_at).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' }) : '-';

        // Get workflow status and owner
        const workflowStatus = task.workflow_status || task.status || 'task_submitted';
        const owner = getStatusOwner(workflowStatus);
        const statusDisplay = formatWorkflowStatus(workflowStatus);

        // Check if task is in reviewing status (shows QA Test button)
        const isReviewing = workflowStatus === 'reviewing' || workflowStatus === 'gabriel_to_review' || workflowStatus === 'in_review';
        const qaTestButton = isReviewing ? `
          <button class="qa-test-btn" data-task-id="${task.id}" data-action="run-qa-tests" title="Run QA Tests">
            <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM10 17l-3.5-3.5 1.41-1.41L10 14.17l4.59-4.59L16 11l-6 6z"/></svg>
            <span>QA Test</span>
          </button>
        ` : '';

        // Show duration for completed tasks
        const isCompleted = workflowStatus === 'completed';
        const durationBadge = isCompleted && task.duration_minutes ? `
          <span class="task-duration-badge" title="Total task duration">
            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            ${formatDuration(task.duration_minutes)}
          </span>
        ` : '';

        // Format EHH (Est. Human Hours) as HH.MM format
        const effortHours = task.effort_hours || 0;
        const ehhDisplay = effortHours > 0 ? formatEHH(effortHours) : '';
        const ehhBadge = ehhDisplay ? `<span class="task-ehh-badge" title="Est. Human-Only Hours">${ehhDisplay}</span>` : '';

        // Format CW+ (Completed Work Human+AI) - only for completed tasks
        const completedWork = task.completed_work || 0;
        const cwDisplay = (isCompleted && completedWork > 0) ? formatCWPlus(completedWork) : '';
        const cwBadge = cwDisplay ? `<span class="task-cw-badge" title="Completed Work (Human+AI)">${cwDisplay}</span>` : '';

        // Compact single-row format: Task ID | Title | Created Date | QA Button (if reviewing) | EHH | CW+ (if completed) | Status | Duration (if completed)
        // QA Button appears LEFT of status pill as requested
        return `
          <div class="task-queue-item ${isSelected ? 'selected' : ''}" data-task-id="${task.id}">
            <span class="task-queue-id">${displayId}</span>
            <span class="task-queue-title">${escapeHtml(task.title || 'Untitled')}</span>
            <span class="task-queue-date">${createdDate}</span>
            ${qaTestButton}
            ${ehhBadge}
            ${cwBadge}
            <span class="task-queue-status owner-${owner}">${statusDisplay}</span>
            ${durationBadge}
          </div>
        `;
      }

      // Format duration for display
      function formatDuration(minutes) {
        if (!minutes) return '';
        if (minutes < 60) return Math.round(minutes) + 'm';
        const hours = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return hours + 'h' + (mins > 0 ? ' ' + mins + 'm' : '');
      }

      // Format EHH (Est. Human Hours) as "00.00 EHH" format
      // e.g., 1.5 hours = "01.30 EHH" (1 hour 30 minutes)
      function formatEHH(hours) {
        if (!hours || hours <= 0) return '';
        const wholeHours = Math.floor(hours);
        const fractionalPart = hours - wholeHours;
        const minutes = Math.round(fractionalPart * 60);
        const hh = String(wholeHours).padStart(2, '0');
        const mm = String(minutes).padStart(2, '0');
        return `${hh}.${mm} EHH`;
      }

      // Format CW+ (Completed Work Human+AI) as "00.00 CW+" format
      // e.g., 2.5 hours = "02.30 CW+" (2 hours 30 minutes)
      function formatCWPlus(hours) {
        if (!hours || hours <= 0) return '';
        const wholeHours = Math.floor(hours);
        const fractionalPart = hours - wholeHours;
        const minutes = Math.round(fractionalPart * 60);
        const hh = String(wholeHours).padStart(2, '0');
        const mm = String(minutes).padStart(2, '0');
        return `${hh}.${mm} CW+`;
      }

      // Update Session Documentation display with EHH and CW+ values
      // Shows efficiency metrics for the current task
      function updateSessionDocumentation(effortHours, completedWork) {
        const ehhEl = document.getElementById('sessionDocEHH');
        const cwEl = document.getElementById('sessionDocCW');
        const efficiencyEl = document.getElementById('sessionDocEfficiency');
        const multiplierEl = document.getElementById('sessionDocMultiplier');

        const ehh = parseFloat(effortHours) || 0;
        const cw = parseFloat(completedWork) || 0;

        // Update EHH display
        if (ehhEl) {
          if (ehh > 0) {
            ehhEl.innerHTML = `${ehh.toFixed(1)}<span class="session-doc-metric-unit">hrs</span>`;
          } else {
            ehhEl.innerHTML = `--<span class="session-doc-metric-unit">hrs</span>`;
          }
        }

        // Update CW+ display
        if (cwEl) {
          if (cw > 0) {
            cwEl.innerHTML = `${cw.toFixed(1)}<span class="session-doc-metric-unit">hrs</span>`;
          } else {
            cwEl.innerHTML = `--<span class="session-doc-metric-unit">hrs</span>`;
          }
        }

        // Calculate and update efficiency
        if (efficiencyEl && multiplierEl) {
          if (ehh > 0 && cw > 0) {
            // Efficiency = (EHH / CW+)  100
            const efficiency = (ehh / cw) * 100;
            const multiplier = ehh / cw;

            efficiencyEl.textContent = Math.round(efficiency).toLocaleString() + '%';
            multiplierEl.textContent = `(${multiplier.toFixed(1)}x faster)`;
          } else {
            efficiencyEl.textContent = '--';
            multiplierEl.textContent = '(--x faster)';
          }
        }
      }

      // Update the queue footer with totals for the current view
      function updateQueueFooter(tasks, filterValue) {
        const footerEl = document.getElementById('footerTotal');
        if (!footerEl) return;

        const taskCount = tasks.length;
        const isArchive = filterValue === 'archive';

        // Calculate totals
        const totalEHH = tasks.reduce((sum, t) => sum + (parseFloat(t.effort_hours) || 0), 0);
        const totalCW = tasks.reduce((sum, t) => sum + (parseFloat(t.completed_work) || 0), 0);

        // Format EHH as HH.MM
        const ehhHours = Math.floor(totalEHH);
        const ehhMins = Math.round((totalEHH - ehhHours) * 60);
        const ehhFormatted = String(ehhHours).padStart(2, '0') + '.' + String(ehhMins).padStart(2, '0');

        if (isArchive && totalCW > 0) {
          // Archive view: show both EHH and CW+
          const cwHours = Math.floor(totalCW);
          const cwMins = Math.round((totalCW - cwHours) * 60);
          const cwFormatted = String(cwHours).padStart(2, '0') + '.' + String(cwMins).padStart(2, '0');
          footerEl.textContent = `TOTAL: ${ehhFormatted} EHH | ${cwFormatted} CW+ (${taskCount} ARCHIVED)`;
        } else {
          // Open tasks view: show EHH only
          const label = isArchive ? 'ARCHIVED' : 'OPEN TASKS';
          footerEl.textContent = `TOTAL: ${ehhFormatted} EHH (${taskCount} ${label})`;
        }
      }

      // Get owner based on workflow status
      // Human (Gabriel): submitted, reviewing, approving - Yellow
      // AI (Jubilee): developing, rework, documenting - Sky Blue
      // None: completed - Green
      function getStatusOwner(status) {
        const ownerMap = {
          'submitted': 'gabriel',
          'developing': 'jubilee',
          'reviewing': 'gabriel',
          'rework': 'jubilee',
          'documenting': 'jubilee',
          'approving': 'gabriel',
          'completed': 'none',
          // Legacy status mappings
          'task_submitted': 'gabriel',
          'jubilee_to_develop': 'jubilee',
          'gabriel_to_review': 'gabriel',
          'jubilee_to_rework': 'jubilee',
          'jubilee_to_document': 'jubilee',
          'gabriel_to_approve': 'gabriel',
          'in_review': 'gabriel',
          'in_progress': 'jubilee',
          'fixing': 'jubilee'
        };
        return ownerMap[status] || 'gabriel';
      }

      // Format workflow status for display (capitalized)
      function formatWorkflowStatus(status) {
        const statusMap = {
          'submitted': 'Submitted',
          'developing': 'Developing',
          'reviewing': 'Reviewing',
          'rework': 'Rework',
          'documenting': 'Documenting',
          'approving': 'Approving',
          'completed': 'Completed',
          // Legacy status mappings
          'task_submitted': 'Submitted',
          'jubilee_to_develop': 'Developing',
          'gabriel_to_review': 'Reviewing',
          'jubilee_to_rework': 'Rework',
          'jubilee_to_document': 'Documenting',
          'gabriel_to_approve': 'Approving',
          'in_review': 'Reviewing',
          'in_progress': 'Developing',
          'fixing': 'Rework'
        };
        return statusMap[status] || status;
      }

      // Get icon for task type
      function getTaskTypeIcon(type) {
        const icons = {
          bug: '<svg viewBox="0 0 24 24" class="type-icon bug"><path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/></svg>',
          development: '<svg viewBox="0 0 24 24" class="type-icon dev"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>',
          enhancement: '<svg viewBox="0 0 24 24" class="type-icon enhance"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>',
          operational: '<svg viewBox="0 0 24 24" class="type-icon ops"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>'
        };
        return icons[type] || icons.development;
      }

      // Select a task and show edit panel
      function selectTask(taskId) {
        // Prevent duplicate calls
        if (taskId === null || taskId === undefined || taskId === '') return;

        // Keep taskId as string (UUID format)
        const stringId = String(taskId);

        // Find the task in our data (compare as strings)
        const task = taskQueueData.find(t => String(t.id) === stringId);

        // Update selection state
        selectedTaskId = stringId;

        // Update visual selection in queue list
        document.querySelectorAll('.task-queue-item').forEach(item => {
          const itemId = String(item.dataset.taskId);
          item.classList.toggle('selected', itemId === stringId);
        });

        // Show or hide edit panel based on task existence
        if (!task) {
          console.log('Task not found in data:', stringId);
          hideTaskEdit();
          return;
        }

        // Ensure the edit panel is shown and populated
        showTaskEdit(task);
      }

      // Show task edit form in right panel
      function showTaskEdit(task) {
        const emptyState = document.getElementById('taskEditEmpty');
        const content = document.getElementById('taskEditContent');

        // Null check - elements might not exist in all views
        if (!emptyState || !content) return;

        emptyState.style.display = 'none';
        content.style.display = 'flex';

        // Get workflow status and owner
        const workflowStatus = task.workflow_status || task.status || 'task_submitted';
        const owner = getStatusOwner(workflowStatus);
        const statusDisplay = formatWorkflowStatus(workflowStatus);

        // Populate edit fields - use JTX + 6 digit format from task_code
        const taskId = task.taskCode || task.task_code || ('JTX' + String(task.taskNumber || task.task_number || task.id).padStart(6, '0'));

        const taskEditId = document.getElementById('taskEditId');
        const taskEditStatusBadge = document.getElementById('taskEditStatusBadge');
        const taskEditTitle = document.getElementById('taskEditTitle');
        const taskEditDescription = document.getElementById('taskEditDescription');
        const taskEditType = document.getElementById('taskEditType');
        const taskEditPriority = document.getElementById('taskEditPriority');
        const taskEditStatus = document.getElementById('taskEditStatus');
        const taskEditComponent = document.getElementById('taskEditComponent');
        const taskEditEffort = document.getElementById('taskEditEffort');
        const taskEditCompletedWork = document.getElementById('taskEditCompletedWork');

        if (taskEditId) taskEditId.textContent = taskId;
        if (taskEditStatusBadge) {
          taskEditStatusBadge.textContent = statusDisplay;
          taskEditStatusBadge.className = 'task-edit-status owner-' + owner;
        }
        if (taskEditTitle) taskEditTitle.value = task.title || '';
        if (taskEditDescription) taskEditDescription.value = task.task_description || task.description || '';
        if (taskEditType) taskEditType.value = task.task_type || 'development';
        if (taskEditPriority) taskEditPriority.value = task.priority || 'medium';
        if (taskEditStatus) taskEditStatus.value = workflowStatus;
        if (taskEditComponent) taskEditComponent.value = task.page_component || task.component || '';
        if (taskEditEffort) taskEditEffort.value = task.effort_hours || '';
        if (taskEditCompletedWork) taskEditCompletedWork.value = task.completed_work || '';

        // Update Session Documentation display
        updateSessionDocumentation(task.effort_hours, task.completed_work);

        // Show/hide review actions based on status (visible when in Reviewing state)
        const reviewActions = document.getElementById('reviewActions');
        const isInReview = workflowStatus === 'reviewing';
        if (reviewActions) reviewActions.style.display = isInReview ? 'block' : 'none';

        // Reset radio buttons
        const reviewComplete = document.getElementById('reviewComplete');
        const reviewRework = document.getElementById('reviewRework');
        if (reviewComplete) reviewComplete.checked = false;
        if (reviewRework) reviewRework.checked = false;

        // Show/hide delete button (hide for completed tasks)
        const taskEditActions = document.getElementById('taskEditActions');
        if (taskEditActions) taskEditActions.style.display = workflowStatus === 'completed' ? 'none' : 'block';

        // Load work history
        loadWorkHistory(task.id);

        // Store current task for auto-save
        currentEditingTask = task;

        // Reset autosave indicator
        const autosaveIndicator = document.getElementById('autosaveIndicator');
        if (autosaveIndicator) autosaveIndicator.className = 'autosave-indicator';

        // Update workflow Back/Next buttons
        updateWorkflowButtons(task);
      }

      // Current task being edited (for auto-save)
      let currentEditingTask = null;
      let autosaveTimeout = null;

      // Load work history for a task
      async function loadWorkHistory(taskId) {
        const historyList = document.getElementById('workHistoryList');
        const durationEl = document.getElementById('workHistoryDuration');

        // Clear the duration display initially
        if (durationEl) durationEl.textContent = '';

        try {
          // Try the new work-history endpoint first, fall back to activity endpoint
          let response = await fetch(`/api/admin/tasks/${taskId}/work-history`);
          let data;
          let entries = [];

          if (response.ok) {
            data = await response.json();
            entries = data.history || [];
          } else {
            // Fall back to activity endpoint
            response = await fetch(`/api/admin/tasks/${taskId}/activity`);
            if (response.ok) {
              data = await response.json();
              entries = data.activities || [];
            }
          }

          if (entries.length === 0) {
            historyList.innerHTML = '<div class="work-history-empty">No activity yet</div>';
            return;
          }

          // Sort entries chronologically (oldest first)
          entries.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

          // Calculate total duration from first to last entry
          const firstEntry = entries[0];
          const lastEntry = entries[entries.length - 1];
          if (firstEntry && lastEntry && durationEl) {
            const startTime = new Date(firstEntry.created_at);
            const endTime = new Date(lastEntry.created_at);
            const totalSeconds = Math.floor((endTime - startTime) / 1000);
            if (totalSeconds > 0) {
              durationEl.textContent = 'Total: ' + formatDurationSeconds(totalSeconds);
            }
          }

          historyList.innerHTML = entries.map(entry => {
            const actorInitial = entry.actor === 'jubilee' ? 'J' : 'G';
            const actorName = entry.actor === 'jubilee' ? 'Jubilee' : 'Gabriel';
            const timeAgo = formatTimeAgo(new Date(entry.created_at));
            const timestamp = new Date(entry.created_at).toLocaleString('en-US', {
              month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
            });

            // Format action type for display
            const actionType = formatActionType(entry.action);
            const description = entry.description || actionType;

            // Duration indicator if available
            const durationInfo = entry.duration_seconds ?
              `<span class="work-history-duration">${formatDurationSeconds(entry.duration_seconds)}</span>` : '';

            return `
              <div class="work-history-item">
                <div class="work-history-actor ${entry.actor}" title="${actorName}">${actorInitial}</div>
                <div class="work-history-details">
                  <div class="work-history-action">${escapeHtml(description)}</div>
                  <div class="work-history-meta">
                    <span class="work-history-time" title="${timestamp}">${timeAgo}</span>
                    ${durationInfo}
                  </div>
                </div>
              </div>
            `;
          }).join('');

        } catch (error) {
          console.error('Error loading work history:', error);
          historyList.innerHTML = '<div class="work-history-empty">Error loading history</div>';
        }
      }

      // Format action type for display
      function formatActionType(action) {
        const actionMap = {
          'created': 'Task created',
          'assigned': 'Task assigned',
          'status_changed': 'Status updated',
          'developed': 'Development completed',
          'submitted_for_review': 'Submitted for review',
          'reviewed': 'Review completed',
          'approved': 'Approved',
          'rejected': 'Rejected',
          'rework_requested': 'Rework requested',
          'rework_completed': 'Rework completed',
          'documented': 'Documentation added',
          'qa_tested': 'QA testing completed',
          'qa_passed': 'QA tests passed',
          'qa_failed': 'QA tests failed',
          'completed': 'Task completed',
          'reopened': 'Task reopened',
          'comment_added': 'Comment added',
          'field_updated': 'Field updated'
        };
        return actionMap[action] || action;
      }

      // Format duration in seconds to readable string
      function formatDurationSeconds(seconds) {
        if (!seconds) return '';
        if (seconds < 60) return seconds + 's';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return hours + 'h' + (mins > 0 ? ' ' + mins + 'm' : '');
      }

      // Format time ago
      function formatTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      // Hide task edit panel (no selection)
      function hideTaskEdit() {
        const emptyState = document.getElementById('taskEditEmpty');
        const content = document.getElementById('taskEditContent');
        if (emptyState) emptyState.style.display = 'flex';
        if (content) content.style.display = 'none';
      }

      // Save task changes from edit panel (with auto-save support)
      async function saveTaskFromEditPanel(showIndicator = true) {
        if (!selectedTaskId) return;

        const taskData = {
          title: document.getElementById('taskEditTitle').value,
          task_description: document.getElementById('taskEditDescription').value,
          task_type: document.getElementById('taskEditType').value,
          priority: document.getElementById('taskEditPriority').value,
          workflow_status: document.getElementById('taskEditStatus').value,
          page_component: document.getElementById('taskEditComponent').value,
          effort_hours: parseFloat(document.getElementById('taskEditEffort').value) || null,
          completed_work: parseFloat(document.getElementById('taskEditCompletedWork').value) || null
        };

        // Show saving indicator
        if (showIndicator) {
          const indicator = document.getElementById('autosaveIndicator');
          indicator.className = 'autosave-indicator saving';
        }

        try {
          const response = await fetch(`/api/admin/tasks/${selectedTaskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
          });

          if (!response.ok) throw new Error('Failed to save task');

          // Show saved indicator
          if (showIndicator) {
            const indicator = document.getElementById('autosaveIndicator');
            indicator.className = 'autosave-indicator saved';
            setTimeout(() => {
              indicator.className = 'autosave-indicator';
            }, 2000);
          }

          // Refresh task queue without losing selection
          await loadTaskQueue();

          console.log('Task auto-saved successfully');
        } catch (error) {
          console.error('Error saving task:', error);
          const indicator = document.getElementById('autosaveIndicator');
          indicator.className = 'autosave-indicator';
        }
      }

      // Auto-save with debounce
      function triggerAutosave() {
        if (autosaveTimeout) {
          clearTimeout(autosaveTimeout);
        }
        autosaveTimeout = setTimeout(() => {
          saveTaskFromEditPanel(true);
        }, 1000); // Save after 1 second of no changes
      }

      // Handle review decision (Complete or Rework)
      async function handleReviewDecision(decision) {
        if (!selectedTaskId) return;

        // Complete -> completed, Rework -> rework (assigns ownership back to Jubilee)
        const newStatus = decision === 'complete' ? 'completed' : 'rework';

        try {
          const response = await fetch(`/api/admin/tasks/${selectedTaskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ workflow_status: newStatus })
          });

          if (!response.ok) throw new Error('Failed to update status');

          // Refresh and update UI
          await loadTaskQueue();
          const updatedTask = taskQueueData.find(t => t.id == selectedTaskId);
          if (updatedTask) {
            showTaskEdit(updatedTask);
          }

          console.log(`Task ${decision === 'complete' ? 'marked as completed' : 'sent back to Jubilee for rework'}`);
        } catch (error) {
          console.error('Error updating task status:', error);
          alert('Failed to update status: ' + error.message);
        }
      }

      // Delete task from edit panel
      async function deleteTaskFromEditPanel() {
        if (!selectedTaskId) return;
        if (!confirm('Are you sure you want to delete this task?')) return;

        try {
          const response = await fetch(`/api/admin/tasks/${selectedTaskId}`, {
            method: 'DELETE'
          });

          if (!response.ok) throw new Error('Failed to delete task');

          selectedTaskId = null;
          hideTaskEdit();
          await loadTaskQueue();
          console.log('Task deleted successfully');
        } catch (error) {
          console.error('Error deleting task:', error);
          alert('Failed to delete task: ' + error.message);
        }
      }

      // Event listeners for task queue and edit panel
      document.getElementById('taskQueueFilter').addEventListener('change', loadTaskQueue);
      document.getElementById('taskEditDeleteBtn').addEventListener('click', deleteTaskFromEditPanel);

      // View toggle switch functionality (ARCHIVE - OPEN)
      (function initViewToggle() {
        const toggleSwitch = document.getElementById('viewToggleSwitch');
        const archiveLabel = document.getElementById('archiveLabel');
        const openLabel = document.getElementById('openLabel');
        const filterSelect = document.getElementById('taskQueueFilter');

        function setView(view) {
          if (view === 'archive') {
            toggleSwitch.classList.add('archive');
            archiveLabel.classList.add('active');
            openLabel.classList.remove('active');
            filterSelect.value = 'archive';
          } else {
            toggleSwitch.classList.remove('archive');
            archiveLabel.classList.remove('active');
            openLabel.classList.add('active');
            filterSelect.value = 'open';
          }
          // Trigger the change event to reload tasks
          filterSelect.dispatchEvent(new Event('change'));
        }

        // Click handlers
        if (toggleSwitch) {
          toggleSwitch.addEventListener('click', () => {
            const isArchive = toggleSwitch.classList.contains('archive');
            setView(isArchive ? 'open' : 'archive');
          });
        }

        if (archiveLabel) {
          archiveLabel.addEventListener('click', () => setView('archive'));
        }

        if (openLabel) {
          openLabel.addEventListener('click', () => setView('open'));
        }
      })();

      // Auto-save event listeners for all editable fields (except status which has special handling)
      document.querySelectorAll('[data-autosave="true"]').forEach(element => {
        // Skip status dropdown - it has special handling below
        if (element.id === 'taskEditStatus') return;

        if (element.tagName === 'SELECT') {
          element.addEventListener('change', triggerAutosave);
        } else {
          element.addEventListener('input', triggerAutosave);
        }
      });

      // Update Session Documentation when EHH or CW+ fields change
      const taskEditEffortEl = document.getElementById('taskEditEffort');
      const taskEditCompletedWorkEl = document.getElementById('taskEditCompletedWork');

      function updateSessionDocFromInputs() {
        const ehh = taskEditEffortEl ? parseFloat(taskEditEffortEl.value) || 0 : 0;
        const cw = taskEditCompletedWorkEl ? parseFloat(taskEditCompletedWorkEl.value) || 0 : 0;
        updateSessionDocumentation(ehh, cw);
      }

      if (taskEditEffortEl) {
        taskEditEffortEl.addEventListener('input', updateSessionDocFromInputs);
      }
      if (taskEditCompletedWorkEl) {
        taskEditCompletedWorkEl.addEventListener('input', updateSessionDocFromInputs);
      }

      // Special handler for status dropdown - uses workflow logic with history logging
      const statusDropdown = document.getElementById('taskEditStatus');
      if (statusDropdown) {
        statusDropdown.addEventListener('change', async function() {
          if (!selectedTaskId) return;

          const newStatus = this.value;
          const task = tasks.find(t => t.id === selectedTaskId);
          if (!task) return;

          const previousStatus = task.workflow_status || task.status || 'submitted';

          // Don't update if status hasn't changed
          if (normalizeStatus(previousStatus) === newStatus) return;

          console.log(`Status dropdown changed: ${previousStatus}  ${newStatus}`);

          // Use the same updateTaskStatus function as Back/Next buttons
          await updateTaskStatus(selectedTaskId, newStatus, 'Status changed via dropdown');

          // If completed, task should be removed from active queue
          if (newStatus === 'completed') {
            console.log('Task marked as completed - will be archived after 24 hours');
          }
        });
      }

      // Review decision radio button handlers (elements may not exist on all views)
      const reviewReworkEl = document.getElementById('reviewRework');
      const reviewDocumentEl = document.getElementById('reviewDocument');
      if (reviewReworkEl) {
        reviewReworkEl.addEventListener('change', function() {
          if (this.checked) handleReviewDecision('rework');
        });
      }
      if (reviewDocumentEl) {
        reviewDocumentEl.addEventListener('change', function() {
          if (this.checked) handleReviewDecision('document');
        });
      }

      // ==================== COOKIE-BASED STATE PERSISTENCE ====================

      // Save current view state to cookie
      function saveViewState() {
        const state = {
          view: currentView,
          selectedTaskId: selectedTaskId,
          filter: document.getElementById('taskQueueFilter')?.value || 'open'
        };
        document.cookie = `adminTasksState=${encodeURIComponent(JSON.stringify(state))};path=/;max-age=86400`;
      }

      // Load view state from cookie
      function loadViewState() {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'adminTasksState') {
            try {
              return JSON.parse(decodeURIComponent(value));
            } catch (e) {
              return null;
            }
          }
        }
        return null;
      }

      // Restore saved state on page load
      function restoreViewState() {
        const state = loadViewState();
        if (state) {
          // Restore view (map old 'analytics' to 'dashboard')
          let viewToRestore = state.view;
          if (viewToRestore === 'analytics') viewToRestore = 'dashboard';
          // Default is now 'tasks', so only switch if different
          if (viewToRestore && viewToRestore !== 'tasks') {
            switchToView(viewToRestore);
          }

          // Restore filter (validate against new options)
          if (state.filter) {
            const filterEl = document.getElementById('taskQueueFilter');
            if (filterEl) {
              // Map old filter values to new ones
              if (state.filter === 'all' || state.filter === 'open') {
                filterEl.value = 'open';
              } else if (state.filter === 'archive' || state.filter === 'completed') {
                filterEl.value = 'archive';
              } else {
                filterEl.value = 'open'; // Default to open for any old filter value
              }
            }
          }

          // Restore selected task (after queue loads)
          if (state.selectedTaskId && state.view === 'tasks') {
            setTimeout(() => {
              if (taskQueueData.find(t => t.id === state.selectedTaskId)) {
                selectTask(state.selectedTaskId);
              }
            }, 500);
          }
        }
      }

      // Save state when view changes
      const originalSwitchToView = switchToView;
      switchToView = function(viewName) {
        originalSwitchToView(viewName);
        saveViewState();
      };
      window.switchToView = switchToView;

      // Save state when task is selected
      const originalSelectTask = selectTask;
      selectTask = function(taskId) {
        originalSelectTask(taskId);
        saveViewState();
      };

      // ========================================
      // QA Tests Functionality - Category-Based View
      // ========================================
      // Note: qaTestsData, qaTestsLoading, qaTestsRunning, expandedCategories
      // are declared earlier in the file before switchToView

      // Category display names and icons
      const QA_CATEGORY_CONFIG = {
        'login': { name: 'Login', icon: '<svg viewBox="0 0 24 24"><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></svg>' },
        'registration': { name: 'Registration', icon: '<svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' },
        'chat': { name: 'Chat', icon: '<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>' },
        'personas': { name: 'Personas', icon: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>' },
        'hospitality': { name: 'Hospitality', icon: '<svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>' },
        'payment': { name: 'Payment', icon: '<svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>' },
        'billing': { name: 'Billing', icon: '<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>' },
        'admin': { name: 'Admin', icon: '<svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>' },
        'translation': { name: 'Translation', icon: '<svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>' },
        'community': { name: 'Community', icon: '<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>' },
        'api': { name: 'API', icon: '<svg viewBox="0 0 24 24"><path d="M14 12l-2 2-2-2 2-2 2 2zm-2-6l2.12 2.12 2.5-2.5L12 1 7.38 5.62l2.5 2.5L12 6zm-6 6l2.12-2.12-2.5-2.5L1 12l4.62 4.62 2.5-2.5L6 12zm12 0l-2.12 2.12 2.5 2.5L23 12l-4.62-4.62-2.5 2.5L18 12zm-6 6l-2.12-2.12-2.5 2.5L12 23l4.62-4.62-2.5-2.5L12 18z"/></svg>' },
        'ui': { name: 'UI', icon: '<svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM5 15h14v3H5z"/></svg>' },
        'performance': { name: 'Performance', icon: '<svg viewBox="0 0 24 24"><path d="M19.03 7.39l1.42-1.42c-.45-.51-.9-.97-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM13 14h-2V8h2v6z"/></svg>' },
        'security': { name: 'Security', icon: '<svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>' },
        'integration': { name: 'Integration', icon: '<svg viewBox="0 0 24 24"><path d="M17 7h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.43-.98 2.63-2.31 2.98l1.46 1.46C20.88 15.61 22 13.95 22 12c0-2.76-2.24-5-5-5zm-1 4h-2.19l2 2H16v-2zM2 4.27l3.11 3.11C3.29 8.12 2 9.91 2 12c0 2.76 2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1 0-1.59 1.21-2.9 2.76-3.07L8.73 11H8v2h2.73L13 15.27V17h1.73l4.01 4L20 19.74 3.27 3 2 4.27z"/></svg>' },
        'other': { name: 'Other', icon: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' }
      };

      // QA Test Documentation Data - maps QA numbers to their documentation
      const QA_TEST_DOCS = {
        'QA-0800': { validates: 'Homepage renders without errors', systems: 'Frontend, Server', causes: ['Server error', 'Asset loading failure', 'JavaScript exception'], remediation: 'Check server logs, verify asset loading, review console errors' },
        'QA-0801': { validates: 'All registration form fields are present', systems: 'Frontend, Form Renderer', causes: ['Template error', 'JavaScript not loaded', 'Conditional rendering issue'], remediation: 'Check template, verify JavaScript loading' },
        'QA-0802': { validates: 'System rejects forgot password requests for non-existent emails', systems: 'Authentication Service, Email Validator', causes: ['Email validation bypassed', 'Error handling missing'], remediation: 'Verify email validation logic, check error handling' },
        'QA-0803': { validates: 'Spanish locale loads correctly in UI', systems: 'Translation Service, UI Renderer', causes: ['Translation file missing', 'Locale not recognized'], remediation: 'Check translation files, verify locale configuration' },
        'QA-0804': { validates: 'AI service gracefully handles errors', systems: 'AI Service, Error Handler', causes: ['AI service timeout', 'Missing error boundary', 'API key issue'], remediation: 'Check AI service logs, verify API keys, ensure error boundaries' },
        'QA-0805': { validates: 'Sessions are created, validated, and expired correctly', systems: 'Authentication Service, Session Store', causes: ['Session not invalidated', 'Token not rotating', 'Expiry not enforced'], remediation: 'Review session lifecycle, verify token rotation' },
        'QA-0806': { validates: 'French to English translation works correctly', systems: 'Translation Service', causes: ['Translation API error', 'Language code incorrect'], remediation: 'Check translation API, verify language codes' },
        'QA-0807': { validates: 'Email field validates format correctly', systems: 'Frontend, Validation Service', causes: ['Regex pattern incorrect', 'Validation disabled'], remediation: 'Update validation pattern, enable all validations' },
        'QA-0808': { validates: 'AI service properly enforces rate limits', systems: 'AI Service, Rate Limiter', causes: ['Rate limiter configuration incorrect', 'Redis connection issue'], remediation: 'Check rate limiter configuration, verify Redis connectivity' },
        'QA-0809': { validates: 'Password meets strength requirements', systems: 'Frontend, Validation Service', causes: ['Password requirements not enforced', 'Validation logic error'], remediation: 'Enforce password requirements, verify server validation' },
        'QA-0810': { validates: 'Homepage displays correctly on mobile devices', systems: 'Frontend, CSS Framework', causes: ['CSS media queries incorrect', 'Viewport not set'], remediation: 'Test on mobile devices, fix responsive issues' },
        'QA-0811': { validates: 'German to English translation works correctly', systems: 'Translation Service', causes: ['Translation API error', 'API configuration issue'], remediation: 'Check translation API, verify configuration' },
        'QA-0812': { validates: 'Community board pages load correctly', systems: 'Community Service, Board Renderer', causes: ['Database connection issue', 'Missing board data'], remediation: 'Check database connectivity, verify board data exists' },
        'QA-0813': { validates: 'Users can post and view comments', systems: 'Community Service, Comment Handler', causes: ['Comment API endpoint error', 'Authorization issue'], remediation: 'Check comment API logs, verify user permissions' },
        'QA-0814': { validates: 'All navigation elements are visible', systems: 'Frontend, Navigation Component', causes: ['Navigation component not rendering', 'CSS hiding elements'], remediation: 'Check navigation component, verify visibility' },
        'QA-0815': { validates: 'Complete registration flow works', systems: 'Registration Service, Email Service, Database', causes: ['Database write failure', 'Email not sent'], remediation: 'Check full registration pipeline, verify database writes' },
        'QA-0816': { validates: 'Homepage displays correctly on tablet', systems: 'Frontend, CSS Framework', causes: ['CSS breakpoints incorrect', 'Layout not adapting'], remediation: 'Test on tablets, adjust breakpoints' },
        'QA-0817': { validates: 'System rejects incorrect credentials', systems: 'Authentication Service, Password Validator', causes: ['Password comparison error', 'Authentication bypass'], remediation: 'Immediately investigate authentication logic' },
        'QA-0818': { validates: 'System sends reset email for valid accounts', systems: 'Authentication Service, Email Service', causes: ['Email service down', 'Token generation failure'], remediation: 'Check email service, verify token generation' },
        'QA-0819': { validates: 'CSRF protection is enabled and working', systems: 'Authentication Service, CSRF Middleware', causes: ['CSRF middleware disabled', 'Token validation bypassed'], remediation: 'Enable CSRF protection immediately' },
        'QA-0820': { validates: 'Translation API responds quickly', systems: 'Translation Service', causes: ['API latency high', 'Network issues'], remediation: 'Monitor API performance, consider caching' },
        'QA-0821': { validates: 'Language switcher changes UI language', systems: 'Frontend, Translation Service', causes: ['Switcher event not firing', 'Locale not persisting'], remediation: 'Check switcher functionality, verify locale storage' },
        'QA-0822': { validates: 'Features section renders with all content', systems: 'Frontend, Content Renderer', causes: ['Content not loading', 'Template error'], remediation: 'Check content source, verify template' },
        'QA-0823': { validates: 'Hero section displays correctly', systems: 'Frontend, Hero Component', causes: ['Image not loading', 'Text overflow'], remediation: 'Verify image paths, check text sizing' },
        'QA-0824': { validates: 'AI service responds to health checks', systems: 'AI Service, Health Monitor', causes: ['AI service crashed', 'Network connectivity issue'], remediation: 'Restart AI service, check network configuration' },
        'QA-0825': { validates: 'French locale loads correctly', systems: 'Translation Service, UI Renderer', causes: ['Translation file missing', 'Character encoding issue'], remediation: 'Check translation files, verify encoding' },
        'QA-0826': { validates: 'Homepage loads within time threshold', systems: 'Frontend, CDN, Server', causes: ['Large unoptimized assets', 'Server response slow'], remediation: 'Optimize assets, check server performance' },
        'QA-0827': { validates: 'Users can log in with correct credentials', systems: 'Authentication Service, Session Manager', causes: ['Database connection issue', 'Password hashing mismatch'], remediation: 'Check database, verify password hashing' },
        'QA-0828': { validates: 'Homepage meets accessibility standards', systems: 'Frontend', causes: ['Missing alt text', 'Insufficient color contrast'], remediation: 'Run accessibility audit, fix reported issues' },
        'QA-0829': { validates: 'Login page renders correctly', systems: 'Frontend, Authentication UI', causes: ['JavaScript error', 'CSS loading failure'], remediation: 'Check browser console, verify asset loading' },
        'QA-0830': { validates: 'Romanian to English translation works', systems: 'Translation Service', causes: ['Language pair not supported', 'Rate limiting'], remediation: 'Verify language support, check API configuration' },
        'QA-0831': { validates: 'Spanish to English translation works', systems: 'Translation Service', causes: ['Translation API error', 'Network timeout'], remediation: 'Check API logs, verify response handling' },
        'QA-0832': { validates: 'Chinese to English translation works', systems: 'Translation Service', causes: ['Character encoding issue', 'Language code mismatch'], remediation: 'Check encoding, verify language codes' },
        'QA-0833': { validates: 'Translation service handles errors', systems: 'Translation Service, Error Handler', causes: ['Missing error handling', 'Fallback not working'], remediation: 'Add error handling, implement fallbacks' },
        'QA-0834': { validates: 'AI chat completion returns valid responses', systems: 'AI Service, Chat Engine', causes: ['AI model unavailable', 'Token limit exceeded'], remediation: 'Check AI model status, verify request formatting' },
        'QA-0835': { validates: 'All login form elements present', systems: 'Frontend, Form Renderer', causes: ['Template error', 'DOM manipulation failure'], remediation: 'Verify template integrity, check DOM structure' },
        'QA-0836': { validates: 'Registration page loads correctly', systems: 'Frontend, Registration UI', causes: ['Route not configured', 'Template error'], remediation: 'Check routing, verify assets load' },
        'QA-0837': { validates: 'System rejects duplicate email registrations', systems: 'Registration Service, Database', causes: ['Unique constraint not enforced', 'Race condition'], remediation: 'Verify database constraints, check validation order' },
        'QA-0838': { validates: 'Forgot password page loads correctly', systems: 'Frontend, Authentication UI', causes: ['Route configuration error', 'Template missing'], remediation: 'Check routing, verify template exists' },
        'QA-0839': { validates: 'Remember me persists session', systems: 'Authentication Service, Session Manager', causes: ['Cookie not set correctly', 'Session expiry too short'], remediation: 'Check cookie settings, verify session configuration' },
        'QA-0840': { validates: 'Forgot password link navigates correctly', systems: 'Frontend, Navigation', causes: ['Link href incorrect', 'Route misconfigured'], remediation: 'Verify link destination, check routing' },
        'QA-0841': { validates: 'Users can create new board posts', systems: 'Community Service, Post Handler', causes: ['Post creation API error', 'Permission denied'], remediation: 'Check post creation endpoint, verify authorization' },
        'QA-0842': { validates: 'Password reset requests are rate limited', systems: 'Authentication Service, Rate Limiter', causes: ['Rate limiter disabled', 'Threshold too high'], remediation: 'Enable rate limiting, adjust thresholds' },
        'QA-0843': { validates: 'Authentication tokens generated securely', systems: 'Authentication Service, Token Generator', causes: ['Weak random generator', 'Insufficient token length'], remediation: 'Use cryptographically secure random, increase token length' },
        'QA-0844': { validates: 'Required SEO meta tags are present', systems: 'Frontend, SEO', causes: ['Meta tags missing', 'Canonical URL incorrect'], remediation: 'Add missing meta tags, verify canonical URLs' },
        'QA-0845': { validates: 'Token validation correctly accepts/rejects', systems: 'Authentication Service, Token Validator', causes: ['Validation logic error', 'Signature verification disabled'], remediation: 'Review validation logic, ensure all checks are active' },

        // ============================================
        // MULTI-USER PLAN INFRASTRUCTURE TESTS (QA-0846 to QA-0880)
        // ============================================
        'QA-0846': { validates: 'Shared token pool table structure correct', systems: 'Database, Plan Service', causes: ['Migration not run', 'Column missing', 'Constraint not applied'], remediation: 'Run migration 058_multi_user_plans.sql, verify schema' },
        'QA-0847': { validates: 'Plan memberships table has age verification fields', systems: 'Database, Plan Service', causes: ['Migration incomplete', 'Column type mismatch'], remediation: 'Verify age_verified, age_verified_at columns exist with correct types' },
        'QA-0848': { validates: 'Plan invitations table tracks expiration and attestation', systems: 'Database, Invitation Service', causes: ['Migration not run', 'Default value incorrect'], remediation: 'Verify expires_at defaults to NOW() + 7 days' },
        'QA-0849': { validates: 'Plan type limits configured for all tiers', systems: 'Database, Billing Service', causes: ['Seed data missing', 'Values incorrect'], remediation: 'Check plan_type_limits table has visitor, standard, ministry, business, enterprise entries' },
        'QA-0850': { validates: 'Token pool foreign keys reference users correctly', systems: 'Database, Referential Integrity', causes: ['Foreign key missing', 'ON DELETE behavior wrong'], remediation: 'Verify foreign key with ON DELETE CASCADE' },
        'QA-0851': { validates: 'Pool balance cannot go negative', systems: 'Database, Token Service', causes: ['CHECK constraint missing', 'Constraint not enforced'], remediation: 'Verify CHECK (current_balance >= 0) constraint exists' },
        'QA-0852': { validates: 'Sensitive data audit log is immutable', systems: 'Database, Audit Service', causes: ['DELETE allowed', 'UPDATE trigger missing'], remediation: 'Verify audit log has no UPDATE/DELETE permissions at application level' },
        'QA-0853': { validates: 'Terms acceptance log captures compliance data', systems: 'Database, Legal Compliance', causes: ['Columns missing', 'IP not captured'], remediation: 'Verify ip_address, user_agent, age_attestation_text columns exist' },
        'QA-0854': { validates: 'Plan info API returns correct data structure', systems: 'Plan API, Backend', causes: ['Endpoint error', 'Response schema wrong', 'Pool not found'], remediation: 'Check /api/plan endpoint, verify response includes plan_type, current_balance' },
        'QA-0855': { validates: 'Token balance API returns complete breakdown', systems: 'Plan API, Token Service', causes: ['Calculation error', 'Field missing'], remediation: 'Verify current_balance, tokens_used_this_period, additional_tokens_purchased returned' },
        'QA-0856': { validates: 'Members API returns list with roles', systems: 'Plan API, Membership Service', causes: ['Authorization error', 'Query incorrect', 'Role not included'], remediation: 'Check /api/plan/members returns user_id, role, status, age_verified' },
        'QA-0857': { validates: 'Invitation creation requires age attestation', systems: 'Plan API, Invitation Service', causes: ['Validation missing', 'Attestation not checked'], remediation: 'Verify POST /api/plan/invite requires inviter_age_attestation=true' },
        'QA-0858': { validates: 'Invitation acceptance creates membership', systems: 'Plan API, Membership Service', causes: ['Transaction failed', 'Terms not validated'], remediation: 'Check membership record created with status=active' },
        'QA-0859': { validates: 'Usage history API returns per-user data', systems: 'Plan API, Usage Service', causes: ['Query error', 'User filter wrong'], remediation: 'Verify token_usage_log data returned with user attribution' },
        'QA-0860': { validates: 'Token purchase updates pool balance', systems: 'Plan API, Payment Service', causes: ['Transaction failed', 'Balance not updated'], remediation: 'Check add_purchased_tokens function, verify token_purchases record' },
        'QA-0861': { validates: 'Member removal changes status correctly', systems: 'Plan API, Membership Service', causes: ['Status not updated', 'Cascade issue'], remediation: 'Verify status changes to removed, access revoked' },
        'QA-0862': { validates: 'Associated users blocked from viewing members', systems: 'Authorization, RBAC', causes: ['Role check missing', 'Middleware bypassed'], remediation: 'Verify role check in /api/plan/members endpoint' },
        'QA-0863': { validates: 'Associated users blocked from inviting', systems: 'Authorization, RBAC', causes: ['Permission check missing'], remediation: 'Verify only primary/admin can POST /api/plan/invite' },
        'QA-0864': { validates: 'Only primary can purchase tokens', systems: 'Authorization, Payment Service', causes: ['Role check missing', 'Primary check wrong'], remediation: 'Verify is_plan_primary check in purchase endpoint' },
        'QA-0865': { validates: 'Primary user cannot be removed', systems: 'Plan Service, Validation', causes: ['Protection missing', 'Wrong user checked'], remediation: 'Add check preventing primary removal, return 400 error' },
        'QA-0866': { validates: 'Age attestation required before invitation', systems: 'Plan Service, Compliance', causes: ['Validation bypassed', 'Field not checked'], remediation: 'Verify inviter_age_attestation is validated before creating invitation' },
        'QA-0867': { validates: 'Terms acceptance required for membership', systems: 'Plan Service, Compliance', causes: ['Validation missing', 'Terms field ignored'], remediation: 'Verify terms_accepted checked in invitation acceptance' },
        'QA-0868': { validates: 'Database trigger enforces age verification', systems: 'Database, Trigger Service', causes: ['Trigger disabled', 'Condition wrong'], remediation: 'Verify trg_enforce_age_verification raises exception for unverified associated users' },
        'QA-0869': { validates: 'Expired invitations rejected', systems: 'Invitation Service, Validation', causes: ['Expiry not checked', 'Timezone issue'], remediation: 'Verify expires_at compared to current time, return 400 for expired' },
        'QA-0870': { validates: 'Duplicate invitations prevented', systems: 'Invitation Service, Validation', causes: ['Unique check missing', 'Status not checked'], remediation: 'Check for pending invitation before creating new one' },
        'QA-0871': { validates: 'Member list access creates audit entry', systems: 'Audit Service, Logging', causes: ['Logging missing', 'Transaction not committed'], remediation: 'Verify sensitive_data_audit_log entry created on /api/plan/members access' },
        'QA-0872': { validates: 'Pool capacity checked on invitation', systems: 'Plan Service, Capacity Check', causes: ['Capacity not checked', 'Count wrong'], remediation: 'Verify check_pool_capacity called and returns false when at limit' },
        'QA-0873': { validates: 'Token deduction is atomic', systems: 'Token Service, Database', causes: ['Race condition', 'Lock not held'], remediation: 'Verify FOR UPDATE lock in deduct_pool_tokens, no partial deduction' },
        'QA-0874': { validates: 'Token purchase adds to balance correctly', systems: 'Token Service, Database', causes: ['Addition wrong', 'Record not created'], remediation: 'Verify current_balance increases and token_purchases record exists' },
        'QA-0875': { validates: 'Usage tracking logs user attribution', systems: 'Token Service, Logging', causes: ['User ID missing', 'Log not created'], remediation: 'Verify token_usage_log has correct pool_id and user_id' },
        'QA-0876': { validates: 'Period reset function works correctly', systems: 'Token Service, Scheduled Job', causes: ['Reset incomplete', 'Dates wrong'], remediation: 'Verify reset_pool_period resets balance and updates period dates' },
        'QA-0877': { validates: 'Member usage counter updates on deduction', systems: 'Token Service, Membership', causes: ['Counter not updated', 'Wrong member'], remediation: 'Verify tokens_used_this_period in plan_memberships increases' },
        'QA-0878': { validates: 'Pool summary view returns accurate counts', systems: 'Database, Views', causes: ['View outdated', 'JOIN wrong'], remediation: 'Verify v_pool_summary aggregates correctly' },
        'QA-0879': { validates: 'Pending invitations view excludes expired', systems: 'Database, Views', causes: ['Filter missing', 'Timezone issue'], remediation: 'Verify v_pending_invitations has expires_at > NOW() filter' },
        'QA-0880': { validates: 'Terms acceptance includes IP and user agent', systems: 'Audit Service, Compliance', causes: ['Headers not captured', 'Field null'], remediation: 'Verify req.ip and user-agent header logged in terms_acceptance_log' },

        // ============================================
        // USER ANALYTICS INTELLIGENCE TESTS (QA-0881 to QA-0905)
        // ============================================
        'QA-0881': { validates: 'Conversation analysis table has all metrics', systems: 'Database, Analytics Service', causes: ['Migration incomplete', 'Columns missing'], remediation: 'Verify sentiment_score, emotion_* (10), fivefold_* (5) columns exist' },
        'QA-0882': { validates: 'Analytics consent column exists on users', systems: 'Database, User Service', causes: ['Migration not run', 'Default wrong'], remediation: 'Verify analytics_consent boolean column with DEFAULT FALSE' },
        'QA-0883': { validates: 'Monthly analytics table has aggregation columns', systems: 'Database, Analytics Service', causes: ['Migration incomplete'], remediation: 'Verify year_month, is_finalized, avg_* columns exist' },
        'QA-0884': { validates: 'Emotion scores have valid range constraints', systems: 'Database, Validation', causes: ['CHECK constraint missing'], remediation: 'Verify all emotion_* columns have CHECK (>= 0 AND <= 100)' },
        'QA-0885': { validates: 'Five-Fold ministry columns present', systems: 'Database, Analytics', causes: ['Columns missing', 'Names wrong'], remediation: 'Check fivefold_apostle, fivefold_prophet, fivefold_evangelist, fivefold_pastor, fivefold_teacher' },
        'QA-0886': { validates: 'MBTI columns have correct defaults', systems: 'Database, Analytics', causes: ['Default value wrong'], remediation: 'Verify mbti_e_i, mbti_s_n, mbti_t_f, mbti_j_p default to 50' },
        'QA-0887': { validates: 'Analysis unique per message', systems: 'Database, Integrity', causes: ['Constraint missing', 'Duplicate allowed'], remediation: 'Verify UNIQUE constraint on message_id' },
        'QA-0888': { validates: 'Analysis endpoint creates records', systems: 'Analytics API, AI Service', causes: ['API error', 'AI analysis failed', 'Record not saved'], remediation: 'Check /api/conversation/analyze creates conversation_analysis record' },
        'QA-0889': { validates: 'Current month analytics returned', systems: 'Analytics API', causes: ['Query error', 'No data aggregated'], remediation: 'Verify /api/user/analytics returns current year_month data' },
        'QA-0890': { validates: 'Historical analytics accessible', systems: 'Analytics API', causes: ['Year-month parsing error', 'Record not found'], remediation: 'Verify /api/user/analytics/:yearMonth returns historical data' },
        'QA-0891': { validates: 'Consent toggle updates user record', systems: 'Analytics API, User Service', causes: ['Update failed', 'Timestamp not set'], remediation: 'Verify analytics_consent and analytics_consent_at updated' },
        'QA-0892': { validates: 'Analytics purge deletes all records', systems: 'Analytics API, Data Service', causes: ['Delete failed', 'Records orphaned'], remediation: 'Verify DELETE /api/user/analytics removes conversation_analysis and monthly records' },
        'QA-0893': { validates: 'Analysis respects consent setting', systems: 'Analytics Service, Consent', causes: ['Consent not checked', 'Analysis runs anyway'], remediation: 'Verify analytics_consent=FALSE blocks analysis' },
        'QA-0894': { validates: 'Monthly aggregation calculates correctly', systems: 'Analytics Service, Math', causes: ['AVG calculation wrong', 'NULL handling error'], remediation: 'Verify avg_sentiment matches AVG(sentiment_score) from raw records' },
        'QA-0895': { validates: 'Consent required for analysis', systems: 'Analytics Service, Privacy', causes: ['Consent check bypassed'], remediation: 'Verify no records created when analytics_consent=FALSE' },
        'QA-0896': { validates: 'Consent revocation triggers data purge', systems: 'Analytics Service, Privacy', causes: ['Job not running', 'Purge incomplete'], remediation: 'Verify MonthlyAnalyticsAggregationJob purges data for revoked users' },
        'QA-0897': { validates: 'Private conversations excluded from analytics', systems: 'Analytics Service, Privacy', causes: ['Privacy flag not checked', 'JOIN wrong'], remediation: 'Verify is_private=TRUE conversations have no analysis records' },
        'QA-0898': { validates: 'Finalized analytics are immutable', systems: 'Analytics Service, Data Integrity', causes: ['Update not blocked', 'Check missing'], remediation: 'Verify is_finalized=TRUE records cannot be updated' },
        'QA-0899': { validates: 'Analytics access logged', systems: 'Audit Service, Logging', causes: ['Logging not implemented'], remediation: 'Verify analytics_access_log entry created on admin access' },

        // ============================================
        // SAFEGUARD INFRASTRUCTURE TESTS (QA-0900 to QA-0930)
        // ============================================
        'QA-0900': { validates: 'Safety flags table has required columns', systems: 'Database, Safeguard Service', causes: ['Migration incomplete'], remediation: 'Verify category, severity, confidence, evidence_tokens columns exist' },
        'QA-0901': { validates: 'Admin alerts table has redacted summary', systems: 'Database, Alert Service', causes: ['Column missing'], remediation: 'Verify redacted_summary column exists (no raw conversation text)' },
        'QA-0902': { validates: 'Alert access log tracks viewers', systems: 'Database, Audit', causes: ['Table missing'], remediation: 'Verify admin_alert_access_log has alert_id, accessed_by, access_type' },
        'QA-0903': { validates: 'Persona performance tracks behavior metrics', systems: 'Database, Persona Service', causes: ['Columns missing'], remediation: 'Verify relatability, friendliness, boundary_clarity, overall_score columns' },
        'QA-0904': { validates: 'Safeguard thresholds configured', systems: 'Database, Configuration', causes: ['Seed data missing'], remediation: 'Check safeguard_thresholds has entries for self_harm, harm_to_others, etc.' },
        'QA-0905': { validates: 'Safety flag trigger enforces privacy', systems: 'Database, Trigger', causes: ['Trigger disabled', 'Check wrong'], remediation: 'Verify trg_safety_flags_privacy blocks private conversations' },
        'QA-0906': { validates: 'Severity values are valid', systems: 'Database, Validation', causes: ['Invalid value accepted'], remediation: 'Verify only low, moderate, elevated, high, critical accepted' },
        'QA-0907': { validates: 'Dashboard returns alert counts', systems: 'Safeguard API', causes: ['Query error', 'Count wrong'], remediation: 'Check /api/admin/safeguard/dashboard returns new_alerts_count, severity breakdown' },
        'QA-0908': { validates: 'Alerts endpoint supports pagination', systems: 'Safeguard API', causes: ['Pagination not implemented'], remediation: 'Verify offset/limit parameters work correctly' },
        'QA-0909': { validates: 'Urgent alerts filtered correctly', systems: 'Safeguard API', causes: ['Filter wrong'], remediation: 'Verify /api/admin/safeguard/alerts/urgent returns only critical/high' },
        'QA-0910': { validates: 'Acknowledge updates alert status', systems: 'Safeguard API', causes: ['Update failed'], remediation: 'Verify status=acknowledged, acknowledged_at, acknowledged_by set' },
        'QA-0911': { validates: 'Resolve updates with notes', systems: 'Safeguard API', causes: ['Notes not saved'], remediation: 'Verify status=resolved, resolution_notes saved' },
        'QA-0912': { validates: 'Escalate increases severity', systems: 'Safeguard API', causes: ['Severity not changed'], remediation: 'Verify severity level increases on escalation' },
        'QA-0913': { validates: 'User safety history accessible', systems: 'Safeguard API', causes: ['Query error'], remediation: 'Verify /api/admin/safeguard/flags/user/:userId returns past flags' },
        'QA-0914': { validates: 'Persona metrics endpoint works', systems: 'Safeguard API', causes: ['Data not aggregated'], remediation: 'Verify avg_relatability, boundary_handling_success_rate returned' },
        'QA-0915': { validates: 'Safeguard endpoints require admin', systems: 'Authorization, RBAC', causes: ['Middleware missing'], remediation: 'Verify requireSafeguardAccess middleware applied' },
        'QA-0916': { validates: 'Alert detail access logged', systems: 'Audit Service', causes: ['Logging missing'], remediation: 'Verify admin_alert_access_log entry with access_type=view_detail' },
        'QA-0917': { validates: 'Authorized roles can access', systems: 'Authorization', causes: ['Role list incomplete'], remediation: 'Verify safety_reviewer, counselor, admin, superadmin allowed' },
        'QA-0918': { validates: 'Unauthorized roles blocked', systems: 'Authorization', causes: ['Check bypassed'], remediation: 'Verify role=user gets 403 Forbidden' },
        'QA-0919': { validates: 'Access denial logged', systems: 'Audit Service', causes: ['Logging missing'], remediation: 'Verify access_granted=FALSE entries created' },
        'QA-0920': { validates: 'Authorization controls detail access', systems: 'Authorization', causes: ['Flag not checked'], remediation: 'Verify requires_authorization flag enforced' },
        'QA-0921': { validates: 'Persona metrics aggregated monthly', systems: 'Persona Service, Aggregation', causes: ['Job not running'], remediation: 'Verify persona_engagement_metrics populated monthly' },
        'QA-0922': { validates: 'Boundary testing ratio calculated', systems: 'Persona Service, Analytics', causes: ['Function error'], remediation: 'Verify calculate_persona_boundary_ratio returns correct ratio' },
        'QA-0923': { validates: 'High boundary testing flagged', systems: 'Persona Service, Alerts', causes: ['Threshold wrong'], remediation: 'Verify flagged_for_review=TRUE when ratio > 2.0' },
        'QA-0924': { validates: 'Persona performance privacy trigger', systems: 'Database, Trigger', causes: ['Trigger disabled'], remediation: 'Verify trg_persona_performance_privacy blocks private conversations' },
        'QA-0925': { validates: 'Crisis response tracked', systems: 'Persona Service', causes: ['Field not populated'], remediation: 'Verify crisis_response_appropriate set when crisis detected' },

        // ============================================
        // PRIVACY CONTROLS & DEMOGRAPHICS TESTS (QA-0926 to QA-0945)
        // ============================================
        'QA-0926': { validates: 'Conversation privacy flag exists', systems: 'Database, Privacy', causes: ['Column missing'], remediation: 'Verify conversations.is_private column with DEFAULT FALSE' },
        'QA-0927': { validates: 'Privacy status endpoint works', systems: 'Privacy API', causes: ['Endpoint error'], remediation: 'Verify GET /api/conversation/:id/privacy returns is_private' },
        'QA-0928': { validates: 'Privacy toggle updates correctly', systems: 'Privacy API', causes: ['Update failed'], remediation: 'Verify PUT sets is_private, marked_private_at timestamp' },
        'QA-0929': { validates: 'Private conversations listed', systems: 'Privacy API', causes: ['Query error'], remediation: 'Verify GET /api/user/private-conversations returns filtered list' },
        'QA-0930': { validates: 'Private flag excludes from analytics', systems: 'Privacy, Analytics', causes: ['Filter missing'], remediation: 'Verify no conversation_analysis for is_private=TRUE' },
        'QA-0931': { validates: 'Private flag excludes from safeguards', systems: 'Privacy, Safeguards', causes: ['Filter missing'], remediation: 'Verify no safety_flags for is_private=TRUE' },
        'QA-0932': { validates: 'Privacy verification function works', systems: 'Database, Function', causes: ['Function error'], remediation: 'Verify verify_conversation_not_private returns correct boolean' },
        'QA-0933': { validates: 'Demographics columns exist', systems: 'Database, User Profile', causes: ['Migration incomplete'], remediation: 'Verify declared_sex, declared_primary_language, declared_age_range exist' },
        'QA-0934': { validates: 'Demographics GET returns all fields', systems: 'Demographics API', causes: ['Response incomplete'], remediation: 'Verify /api/user/demographics returns all declared_* fields' },
        'QA-0935': { validates: 'Demographics PUT updates fields', systems: 'Demographics API', causes: ['Update failed'], remediation: 'Verify declared fields saved, demographics_updated_at set' },
        'QA-0936': { validates: 'Demographics field can be cleared', systems: 'Demographics API', causes: ['Delete logic wrong'], remediation: 'Verify DELETE sets specified field to NULL' },
        'QA-0937': { validates: 'Demographics never inferred', systems: 'Privacy, AI Ethics', causes: ['Inference logic exists'], remediation: 'Verify declared_* ONLY from user input, never conversation_analysis' },
        'QA-0938': { validates: 'Language accepts ISO codes', systems: 'Demographics API, Validation', causes: ['Validation missing'], remediation: 'Verify ISO 639-1 codes accepted (en, es, fr)' },
        'QA-0939': { validates: 'Age range accepts valid values', systems: 'Demographics API, Validation', causes: ['Enum not enforced'], remediation: 'Verify only teen, young_adult, adult, senior accepted' },
        'QA-0940': { validates: 'Marital status accepts valid values', systems: 'Demographics API, Validation', causes: ['Enum not enforced'], remediation: 'Verify only valid marital statuses accepted' },

        // ============================================
        // INTEGRATION & PERFORMANCE TESTS (QA-0941 to QA-0955)
        // ============================================
        'QA-0941': { validates: 'Chat tokens deduct from pool', systems: 'Token Service, Chat', causes: ['Legacy path used'], remediation: 'Verify deduct_pool_tokens called, not legacy user balance' },
        'QA-0942': { validates: 'Privacy respected for pool users', systems: 'Privacy, Multi-User', causes: ['User check wrong'], remediation: 'Verify is_private checked regardless of pool membership' },
        'QA-0943': { validates: 'Safeguards check privacy first', systems: 'Safeguards, Privacy', causes: ['Order wrong'], remediation: 'Verify verify_conversation_not_private called before safety flag creation' },
        'QA-0944': { validates: 'Audit log tracks all access', systems: 'Audit Service', causes: ['Logging incomplete'], remediation: 'Verify audit entries for plan, analytics, safeguard access' },
        'QA-0945': { validates: 'Consent revocation cascades', systems: 'Analytics, Data Retention', causes: ['Cascade incomplete'], remediation: 'Verify all analytics data deleted on consent=FALSE' },
        'QA-0946': { validates: 'Plan downgrade handles capacity', systems: 'Billing, Plan Service', causes: ['Validation missing'], remediation: 'Verify error or member handling when new plan has lower max_users' },
        'QA-0947': { validates: 'Monthly jobs complete successfully', systems: 'Jobs, Scheduler', causes: ['Job failure', 'Error unhandled'], remediation: 'Verify MonthlyAnalyticsAggregationJob runs without errors' },
        'QA-0948': { validates: 'Token period resets monthly', systems: 'Token Service, Scheduler', causes: ['Reset not triggered'], remediation: 'Verify pools reset on schedule' },
        'QA-0949': { validates: 'Audit log queries perform well', systems: 'Database, Performance', causes: ['Index missing', 'Query slow'], remediation: 'Verify queries with accessor_user_id filter complete < 500ms' },
        'QA-0950': { validates: 'Analytics aggregation performs well', systems: 'Analytics, Performance', causes: ['Aggregation slow'], remediation: 'Verify monthly aggregation completes in reasonable time' },
        'QA-0951': { validates: 'Alert pagination maintains performance', systems: 'Safeguards, Performance', causes: ['OFFSET slow'], remediation: 'Verify paginated queries complete < 200ms' },
        'QA-0952': { validates: 'Token deduction handles concurrency', systems: 'Token Service, Concurrency', causes: ['Race condition'], remediation: 'Verify FOR UPDATE lock prevents race conditions' },
        'QA-0953': { validates: 'Pool capacity check is efficient', systems: 'Plan Service, Performance', causes: ['Query slow'], remediation: 'Verify check_pool_capacity completes < 10ms' },

        // ============================================
        // EDGE CASE & FAILURE CONDITION TESTS (QA-0954+)
        // Race Conditions, NULL Handling, Boundary Values
        // ============================================

        // Race Condition Tests
        'QA-0954': { validates: 'Token deduction prevents overdraw under concurrent access', systems: 'Token Service, Database Locking', causes: ['Missing FOR UPDATE', 'Transaction isolation wrong', 'Lock timeout'], remediation: 'Verify deduct_pool_tokens uses row-level locking, test concurrent requests' },
        'QA-0955': { validates: 'Pool capacity race prevents exceeding max users', systems: 'Plan Service, Concurrency', causes: ['Check-then-act gap', 'Missing transaction wrap'], remediation: 'Add serializable isolation or advisory locks for capacity checks' },
        'QA-0956': { validates: 'Month finalization handles concurrent calls', systems: 'Analytics Service, Database', causes: ['Double finalization', 'Missing idempotency'], remediation: 'Add unique constraint or check before update' },
        'QA-0957': { validates: 'Alert acknowledgment preserves first responder', systems: 'Alert Service, Audit', causes: ['Last-write-wins', 'No version check'], remediation: 'Check acknowledged_at before updating, log all attempts' },
        'QA-0958': { validates: 'Duplicate analysis INSERT handled gracefully', systems: 'Analytics Service, Database', causes: ['UNIQUE violation crash', 'Error not caught'], remediation: 'ON CONFLICT DO NOTHING or catch constraint error' },
        'QA-0959': { validates: 'Purchase during deduction maintains balance integrity', systems: 'Token Service, Transactions', causes: ['Non-atomic operations', 'Missing transaction'], remediation: 'Wrap purchase and deduction in same transaction scope' },
        'QA-0960': { validates: 'Period reset during usage does not corrupt data', systems: 'Token Service, Scheduler', causes: ['Partial update', 'Race with active deduction'], remediation: 'Use exclusive lock during reset, queue active requests' },
        'QA-0961': { validates: 'Threshold updates apply consistently during analysis', systems: 'Safeguard Service, Configuration', causes: ['Mid-analysis config change', 'Inconsistent snapshot'], remediation: 'Snapshot thresholds at analysis start, not per-check' },

        // NULL and Empty Data Tests
        'QA-0962': { validates: 'User with no messages returns valid stats', systems: 'Analytics Service, Query', causes: ['AVG on empty set', 'NULL handling wrong'], remediation: 'COALESCE or handle NULL averages explicitly' },
        'QA-0963': { validates: 'Empty JSONB arrays aggregated as arrays not NULL', systems: 'Analytics Service, JSONB', causes: ['Array vs NULL confusion', 'Merge logic wrong'], remediation: 'Use COALESCE(field, []::jsonb) in aggregations' },
        'QA-0964': { validates: 'NULL confidence scores handled in averages', systems: 'Analytics Service, Math', causes: ['NaN result', 'Division by zero'], remediation: 'AVG() ignores NULL - document and test behavior' },
        'QA-0965': { validates: 'Token purchase without payment method logged', systems: 'Billing Service, Audit', causes: ['Missing audit trail', 'Silent failure'], remediation: 'Require payment_id OR stripe_intent, log warning if both NULL' },
        'QA-0966': { validates: 'Invitation without attestation text rejected', systems: 'Plan Service, Validation', causes: ['Partial attestation', 'Text field skipped'], remediation: 'Require inviter_age_attestation_text when inviter_age_attestation=TRUE' },
        'QA-0967': { validates: 'Empty evidence tokens array is valid', systems: 'Safeguard Service, Schema', causes: ['NULL vs [] confusion'], remediation: 'Allow empty array, store as [] not NULL' },
        'QA-0968': { validates: 'NULL persona in performance rejected', systems: 'Persona Service, Foreign Key', causes: ['Missing FK check'], remediation: 'persona_id NOT NULL constraint enforced' },
        'QA-0969': { validates: 'User without default persona can chat', systems: 'Chat Service, Fallback', causes: ['NULL dereference', 'No fallback logic'], remediation: 'Assign default persona or return selection prompt' },

        // Boundary Value Tests
        'QA-0970': { validates: 'Zero token deduction is no-op or rejected', systems: 'Token Service, Validation', causes: ['Meaningless operation logged', 'Wasted resources'], remediation: 'Reject tokens=0 in function parameter validation' },
        'QA-0971': { validates: 'Negative token deduction rejected', systems: 'Token Service, Validation', causes: ['Balance increases illegally', 'No sign check'], remediation: 'CHECK constraint or function validation for positive values' },
        'QA-0972': { validates: 'Negative token purchase rejected by constraint', systems: 'Billing Service, Database', causes: ['CHECK constraint missing'], remediation: 'Verify CHECK (tokens_purchased > 0) exists and works' },
        'QA-0973': { validates: 'Sentiment score >100 rejected', systems: 'Analytics Service, Validation', causes: ['AI returned invalid value', 'No clamping'], remediation: 'CHECK constraint + application-level clamping to 0-100' },
        'QA-0974': { validates: 'Negative emotion scores rejected', systems: 'Analytics Service, Validation', causes: ['Negative value from AI', 'Sign not checked'], remediation: 'CHECK (>= 0) on all emotion columns' },
        'QA-0975': { validates: 'Confidence >100 rejected', systems: 'Analytics Service, Validation', causes: ['Over-confident AI', 'No upper bound'], remediation: 'CHECK (<= 100) on all confidence columns' },
        'QA-0976': { validates: 'Integer overflow on token totals prevented', systems: 'Token Service, Types', causes: ['INT overflow', 'Sum exceeds 2^31'], remediation: 'Use BIGINT for cumulative fields or add overflow check' },
        'QA-0977': { validates: 'Threshold confidence >100 rejected', systems: 'Safeguard Config, Validation', causes: ['Admin misconfiguration', 'No constraint'], remediation: 'Add CHECK constraint to safeguard_thresholds' },
        'QA-0978': { validates: 'Max users zero prevents all memberships', systems: 'Plan Service, Edge Case', causes: ['Division by zero', 'Undefined behavior'], remediation: 'Reject max_users=0 in plan_type_limits' },
        'QA-0979': { validates: 'Past expiration date rejected on invite creation', systems: 'Plan Service, Validation', causes: ['Invalid invitation created', 'No date check'], remediation: 'Validate expires_at > NOW() before INSERT' },

        // Age Verification Critical Tests
        'QA-0980': { validates: 'Associated INSERT with active status blocked', systems: 'Plan Service, Trigger', causes: ['Trigger only on UPDATE', 'INSERT bypasses'], remediation: 'Add BEFORE INSERT trigger for age verification' },
        'QA-0981': { validates: 'Primary user must verify age', systems: 'Plan Service, Compliance', causes: ['Default parameter wrong', 'No validation'], remediation: 'Reject initializePlan with ageVerified=FALSE' },
        'QA-0982': { validates: 'Direct UPDATE to active blocked without age', systems: 'Plan Service, Database', causes: ['Trigger condition wrong'], remediation: 'Verify trigger fires on status change to active' },
        'QA-0983': { validates: 'Minimum age 13 enforced in attestation', systems: 'Compliance, Validation', causes: ['Wrong min_age allowed'], remediation: 'Reject min_age_requirement < 13' },
        'QA-0984': { validates: 'Terms version current required', systems: 'Compliance, Validation', causes: ['Outdated terms accepted', 'No version check'], remediation: 'Compare terms_version to current system version' },
        'QA-0985': { validates: 'Age verification requires timestamp', systems: 'Compliance, Audit', causes: ['Verification without record', 'Timestamp NULL'], remediation: 'Require age_verified_at when age_verified=TRUE' },

        // Privacy Critical Tests
        'QA-0986': { validates: 'Analysis blocked without consent', systems: 'Privacy, Analytics', causes: ['Consent not checked', 'Wrong user queried'], remediation: 'Check analytics_consent=TRUE before analysis' },
        'QA-0987': { validates: 'Consent revocation triggers purge', systems: 'Privacy, Data Retention', causes: ['Purge job not running', 'Old data remains'], remediation: 'Schedule purge within 24 hours of consent=FALSE' },
        'QA-0988': { validates: 'Private marking triggers cleanup', systems: 'Privacy, Cascade', causes: ['No cascade logic', 'Orphaned records'], remediation: 'Delete conversation_analysis when is_private set TRUE' },
        'QA-0989': { validates: 'Safety flag blocked for private conversation', systems: 'Privacy, Trigger', causes: ['Trigger bypassed', 'Wrong condition'], remediation: 'Verify prevent_private_safety_records trigger works' },
        'QA-0990': { validates: 'Persona performance blocked for private', systems: 'Privacy, Trigger', causes: ['Missing trigger', 'Wrong table'], remediation: 'Verify trg_persona_performance_privacy trigger works' },
        'QA-0991': { validates: 'Privacy change cascades to all records', systems: 'Privacy, Cascade', causes: ['Cascade incomplete', 'Some records remain'], remediation: 'Trigger cascade deletes on is_private=TRUE' },
        'QA-0992': { validates: 'Mixed consent plan excludes opted-out users', systems: 'Privacy, Aggregation', causes: ['Plan-level consent assumed', 'Individual ignored'], remediation: 'Filter by individual analytics_consent in aggregation' },
        'QA-0993': { validates: 'Finalized analytics updated after privacy change', systems: 'Privacy, Consistency', causes: ['Finalized data immutable', 'No recalculation'], remediation: 'Recalculate or flag finalized records when source marked private' },

        // Alert Lifecycle Tests
        'QA-0994': { validates: 'Invalid status transition rejected', systems: 'Alert Service, State Machine', causes: ['Any transition allowed', 'No state validation'], remediation: 'Implement allowed transitions map, reject invalid changes' },
        'QA-0995': { validates: 'Expired alert shows expiration notice', systems: 'Alert Service, UX', causes: ['Expiry not checked on access', 'Stale data shown'], remediation: 'Check expires_at before displaying alert details' },
        'QA-0996': { validates: 'Escalate critical severity is no-op', systems: 'Alert Service, Logic', causes: ['Severity exceeds max', 'Error on escalate'], remediation: 'Return success but do not change critical severity' },
        'QA-0997': { validates: 'Resolution without notes flagged incomplete', systems: 'Alert Service, Audit', causes: ['Empty resolution accepted', 'No warning'], remediation: 'Log warning or require notes for complete resolution' },
        'QA-0998': { validates: 'Second acknowledgment logs attempt', systems: 'Alert Service, Audit', causes: ['Overwrite first ack', 'No audit trail'], remediation: 'Keep original, log duplicate attempt in access_log' },
        'QA-0999': { validates: 'Insufficient auth level blocked', systems: 'Alert Service, RBAC', causes: ['Authorization not checked', 'Wrong role comparison'], remediation: 'Compare user role to authorization_level required' },
        'QA-1000': { validates: 'Detail access creates audit with IP', systems: 'Alert Service, Audit', causes: ['Logging missing', 'IP not captured'], remediation: 'Log IP and user agent in admin_alert_access_log' },
        'QA-1001': { validates: 'Alert access log delete blocked', systems: 'Alert Service, Immutability', causes: ['DELETE permitted', 'No protection'], remediation: 'Revoke DELETE permission on admin_alert_access_log' },

        // Scheduled Job Failure Tests
        'QA-1002': { validates: 'Aggregation crash does not corrupt data', systems: 'Jobs, Transactions', causes: ['Partial commit', 'No transaction'], remediation: 'Wrap aggregation in transaction, rollback on error' },
        'QA-1003': { validates: 'Period reset failure leaves consistent state', systems: 'Jobs, Atomicity', causes: ['Partial reset', 'Some fields updated'], remediation: 'Single transaction for all reset operations' },
        'QA-1004': { validates: 'Cleanup with zero days rejected', systems: 'Jobs, Validation', causes: ['All data deleted', 'No safeguard'], remediation: 'Require days_to_keep >= 30' },
        'QA-1005': { validates: 'Re-finalize already final month is no-op', systems: 'Jobs, Idempotency', causes: ['Double processing', 'Data corrupted'], remediation: 'Check is_finalized before update' },
        'QA-1006': { validates: 'Purge job recovers from partial failure', systems: 'Jobs, Recovery', causes: ['Failed user skipped forever', 'No retry'], remediation: 'Track failed users for next run retry' },
        'QA-1007': { validates: 'Reset missing pool handled gracefully', systems: 'Jobs, Error Handling', causes: ['Exception on missing ID', 'Job crashes'], remediation: 'Check pool exists before reset' },
        'QA-1008': { validates: 'Aggregation handles DST correctly', systems: 'Jobs, Time', causes: ['Wrong period boundary', 'Missing hour'], remediation: 'Use UTC or explicit timezone handling' },
        'QA-1009': { validates: 'Concurrent jobs serialized', systems: 'Jobs, Locking', causes: ['Duplicate execution', 'Data races'], remediation: 'Use advisory locks or job queue with single consumer' },

        // Cross-Feature Integration Tests
        'QA-1010': { validates: 'Plan analytics excludes no-consent members', systems: 'Privacy, Multi-User', causes: ['Plan-level aggregation wrong', 'Individual consent ignored'], remediation: 'Join on analytics_consent in all plan queries' },
        'QA-1011': { validates: 'Private conversation updates related alerts', systems: 'Privacy, Alerts', causes: ['Alert orphaned', 'Data inconsistent'], remediation: 'Update alert status when source conversation marked private' },
        'QA-1012': { validates: 'Token reset and analytics do not conflict', systems: 'Scheduler, Transactions', causes: ['Deadlock', 'Inconsistent data'], remediation: 'Order lock acquisition or use separate transactions' },
        'QA-1013': { validates: 'Age verification failure blocks all access', systems: 'Compliance, Access Control', causes: ['Partial access remains', 'Some features work'], remediation: 'Check age_verified on all authenticated endpoints for associated users' },
        'QA-1014': { validates: 'Plan downgrade handles excess members', systems: 'Billing, Plan Service', causes: ['Over-capacity allowed', 'Silent failure'], remediation: 'Block downgrade or suspend excess members' },
        'QA-1015': { validates: 'Flagged persona shows warning in analytics', systems: 'Persona, Analytics', causes: ['No visual indicator', 'Flagged status hidden'], remediation: 'Include flagged_for_review in persona analytics response' },
        'QA-1016': { validates: 'User deletion cascades to pool membership', systems: 'Users, ON DELETE', causes: ['Orphaned membership', 'Token allocation wrong'], remediation: 'Verify ON DELETE CASCADE on plan_memberships.user_id' },
        'QA-1017': { validates: 'Plan community access respects membership status', systems: 'Community, Access Control', causes: ['Inactive members access', 'Status not checked'], remediation: 'Check membership status=active for community access' },

        // JSONB Validation Tests
        'QA-1018': { validates: 'Malformed JSONB rejected on insert', systems: 'Database, Validation', causes: ['Invalid JSON stored', 'Query fails later'], remediation: 'PostgreSQL rejects invalid JSONB, verify error handling' },
        'QA-1019': { validates: 'Incomplete struggle objects rejected', systems: 'Analytics, Schema', causes: ['Missing required fields', 'Aggregation fails'], remediation: 'Application validates struggle object schema before insert' },
        'QA-1020': { validates: 'Score overflow in JSONB clamped to 100', systems: 'Analytics, Validation', causes: ['Unclamped values', 'Comparison fails'], remediation: 'Clamp all numeric JSONB values to valid range' },
        'QA-1021': { validates: 'Huge JSONB array truncated or rejected', systems: 'Database, Performance', causes: ['Memory exhaustion', 'Slow queries'], remediation: 'Limit array size to 100 elements or reject' },
        'QA-1022': { validates: 'Empty domain relevance handled', systems: 'Analytics, Edge Case', causes: ['NULL pointer', 'Undefined access'], remediation: 'Treat empty object {} as valid, no analysis fields set' },
        'QA-1023': { validates: 'JSONB type mismatch rejected', systems: 'Database, Schema', causes: ['Wrong type stored', 'Query fails'], remediation: 'Validate structure before insert' },
        'QA-1024': { validates: 'JSONB unicode preserved', systems: 'Database, Encoding', causes: ['Encoding corruption', 'Special chars lost'], remediation: 'UTF-8 encoding verified on storage and retrieval' },
        'QA-1025': { validates: 'NULL vs empty array distinguished', systems: 'Analytics, Query', causes: ['Wrong query result', 'NULL treated as empty'], remediation: 'Use IS NULL vs = [] in queries appropriately' }
      };

      // Show QA Info Modal
      function showQAInfoModal(test) {
        const qaNumber = test.qa_number || '';
        const doc = QA_TEST_DOCS[qaNumber] || {};
        const failureReason = test.last_result || test.last_error || 'Test assertion failed. The expected outcome did not match actual results.';

        const causesHtml = (doc.causes || ['Unknown cause']).map(c => `<li>${escapeHtml(c)}</li>`).join('');

        const modalHtml = `
          <div class="qa-info-modal-overlay" id="qaInfoModalOverlay">
            <div class="qa-info-modal">
              <div class="qa-info-modal-header">
                <div class="qa-info-modal-title">
                  <span class="qa-info-modal-number">${qaNumber}</span>
                  <span class="qa-info-modal-name">${escapeHtml(test.test_name)}</span>
                </div>
                <button class="qa-info-modal-close" id="qaInfoModalClose">
                  <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
              </div>
              <div class="qa-info-modal-body">
                <div class="qa-info-summary">
                  <div class="qa-info-summary-title">Failure Summary</div>
                  <div class="qa-info-summary-text">${escapeHtml(failureReason)}</div>
                </div>

                <div class="qa-info-section">
                  <div class="qa-info-section-title">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    What This Test Validates
                  </div>
                  <div class="qa-info-section-content">
                    ${escapeHtml(doc.validates || 'Validates expected system behavior')}
                  </div>
                </div>

                <div class="qa-info-section">
                  <div class="qa-info-section-title">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    Systems Affected
                  </div>
                  <div class="qa-info-section-content">
                    <span class="qa-info-tag">${test.category || 'other'}</span>
                    <span class="qa-info-tag">${test.test_type || 'manual'}</span>
                    ${doc.systems ? `<br><br>${escapeHtml(doc.systems)}` : ''}
                  </div>
                </div>

                <div class="qa-info-section">
                  <div class="qa-info-section-title">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                    Common Causes
                  </div>
                  <div class="qa-info-section-content">
                    <ul>${causesHtml}</ul>
                  </div>
                </div>

                <div class="qa-info-section">
                  <div class="qa-info-section-title">
                    <svg viewBox="0 0 24 24"><path d="M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33 0 1.38 1.12 2.5 2.5 2.5.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v16h10v-7.5h1.5v5a2.5 2.5 0 005 0V9c0-.69-.28-1.32-.73-1.77zM12 10H6V5h6v5zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
                    Recommended Remediation
                  </div>
                  <div class="qa-info-section-content">
                    ${escapeHtml(doc.remediation || 'Review test logs for specific error details and consult the QA documentation.')}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Add close handlers
        const overlay = document.getElementById('qaInfoModalOverlay');
        const closeBtn = document.getElementById('qaInfoModalClose');

        closeBtn.addEventListener('click', () => overlay.remove());
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) overlay.remove();
        });

        // ESC key to close
        const escHandler = (e) => {
          if (e.key === 'Escape') {
            overlay.remove();
            document.removeEventListener('keydown', escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);
      }

      // Load QA tests from the API
      async function loadQATests() {
        if (qaTestsLoading) return;
        qaTestsLoading = true;

        const container = document.getElementById('qaCategoriesContainer');

        // Show loading state
        if (container) {
          container.innerHTML = `
            <div class="qa-loading-state" style="display: flex;">
              <div class="loading-spinner"></div>
              <span>Loading QA tests...</span>
            </div>
          `;
        }

        try {
          const response = await fetch('/api/admin/qa-tests', {
            credentials: 'same-origin',
            headers: {
              'Accept': 'application/json'
            }
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
          }

          const data = await response.json();
          qaTestsData = data.tests || data || [];

          // Ensure it's an array
          if (!Array.isArray(qaTestsData)) {
            qaTestsData = [];
          }

          renderQACategoryView();
          updateQAStats();
        } catch (error) {
          console.error('Error loading QA tests:', error);
          if (container) {
            container.innerHTML = `
              <div class="qa-empty-state">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                <p>Failed to load QA tests</p>
                <p style="font-size: 12px; color: #888;">${escapeHtml(error.message)}</p>
                <button class="qa-retry-btn" style="margin-top: 16px; padding: 8px 16px; background: #333; border: 1px solid #555; border-radius: 6px; color: #fff; cursor: pointer;">Retry</button>
              </div>
            `;
            // Add event listener for retry button
            const retryBtn = container.querySelector('.qa-retry-btn');
            if (retryBtn) {
              retryBtn.addEventListener('click', () => {
                qaTestsLoading = false; // Reset loading state before retry
                loadQATests();
              });
            }
          }
        } finally {
          qaTestsLoading = false;
        }
      }
      window.loadQATests = loadQATests;

      // Group tests by category
      function groupTestsByCategory(tests) {
        const groups = {};
        tests.forEach(test => {
          const category = test.category || 'other';
          if (!groups[category]) {
            groups[category] = [];
          }
          groups[category].push(test);
        });
        return groups;
      }

      // Render category-based QA view
      function renderQACategoryView() {
        const container = document.getElementById('qaCategoriesContainer');
        if (!container) return;

        if (qaTestsData.length === 0) {
          container.innerHTML = `
            <div class="qa-empty-state">
              <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
              <p>No QA tests found</p>
              <p style="font-size: 12px; color: #888;">Tests will appear here once created</p>
            </div>
          `;
          return;
        }

        const grouped = groupTestsByCategory(qaTestsData);

        // Sort categories alphabetically A-Z
        const sortedCategories = Object.keys(grouped).sort((a, b) => a.localeCompare(b));

        // Sort tests within each category by qa_number
        Object.keys(grouped).forEach(category => {
          grouped[category].sort((a, b) => {
            const numA = a.qa_number || 'ZZ-9999';
            const numB = b.qa_number || 'ZZ-9999';
            return numA.localeCompare(numB);
          });
        });

        container.innerHTML = sortedCategories.map(category => {
          const tests = grouped[category];
          const config = QA_CATEGORY_CONFIG[category] || QA_CATEGORY_CONFIG['other'];
          const isExpanded = expandedCategories.has(category);

          const passedCount = tests.filter(t => t.status === 'passed').length;
          const failedCount = tests.filter(t => t.status === 'failed').length;
          const totalCount = tests.length;

          // Helper for zero-padded two-digit format
          const pad2 = (n) => String(n).padStart(2, '0');

          // Build stats string: "01 FAIL, 05 PASS" (FAIL on left, hide 0 failed)
          let statsHtml = '';
          if (passedCount > 0 || failedCount > 0) {
            if (failedCount > 0) {
              statsHtml += `<span class="qa-category-stat failed-count">${pad2(failedCount)} FAIL</span>`;
            }
            statsHtml += `<span class="qa-category-stat passed-count">${pad2(passedCount)} PASS</span>`;
          }

          return `
            <div class="qa-category-group ${isExpanded ? 'expanded' : ''}" data-category="${category}">
              <div class="qa-category-header">
                <div class="qa-category-header-left">
                  <div class="qa-category-toggle">${isExpanded ? '' : '+'}</div>
                  <span class="qa-category-name">${config.name}</span>
                </div>
                <div class="qa-category-header-right">
                  <div class="qa-category-stats">
                    ${statsHtml}
                    <span class="qa-category-stat total-count">${pad2(totalCount)}</span>
                  </div>
                </div>
              </div>
              <div class="qa-tests-list">
                ${tests.map(test => renderQATestItem(test)).join('')}
              </div>
            </div>
          `;
        }).join('');

        // Update AI message section based on failures
        updateAIMessageSection();
      }

      // Render a single test item - compact row layout with QA number
      function renderQATestItem(test) {
        const status = test.status || 'pending';
        const statusIcon = getStatusIcon(status);
        const lastRun = test.last_run_at ? formatTimeAgo(new Date(test.last_run_at)) : '';
        const isFailed = status === 'failed';
        const qaNumber = test.qa_number || '';

        return `
          <div class="qa-test-item ${isFailed ? 'test-failed' : ''}" data-test-id="${test.id}" data-qa-number="${qaNumber}">
            <div class="qa-test-number-col">
              <span class="qa-test-number">${qaNumber}</span>
            </div>
            <div class="qa-test-name-col">
              <span class="qa-test-name">${escapeHtml(test.test_name)}</span>
            </div>
            <div class="qa-test-type-col">
              <span class="qa-test-type">${test.test_type || 'manual'}</span>
            </div>
            <div class="qa-test-time-col">
              <span class="qa-test-last-run">${lastRun}</span>
            </div>
            <div class="qa-test-status-col">
              <div class="qa-test-status-indicator ${status}">
                ${statusIcon}
                <span>${formatQAStatus(status)}</span>
              </div>
            </div>
            <div class="qa-test-action-col">
              <button class="qa-test-run-btn" title="Run this test">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </button>
              ${isFailed ? `<button class="qa-test-info-btn" title="More Information"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></button>` : ''}
            </div>
          </div>
        `;
      }

      // Get status icon
      function getStatusIcon(status) {
        const icons = {
          'passed': '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
          'failed': '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',
          'fixed': '<svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>',
          'running': '<svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>',
          'fixing': '<svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>',
          'pending': '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
          'skipped': '<svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>'
        };
        return icons[status] || icons['pending'];
      }

      // Format manual hours as human-readable string
      function formatManualHours(hours) {
        if (!hours || hours <= 0) return '0.0 hours';

        let result = '';
        let remaining = hours;

        // Calculate weeks (40 hours = 1 week)
        if (remaining >= 40) {
          const weeks = Math.floor(remaining / 40);
          remaining = remaining - (weeks * 40);
          result = weeks === 1 ? '1 week' : `${weeks} weeks`;
        }

        // Calculate days (8 hours = 1 day)
        if (remaining >= 8) {
          const days = Math.floor(remaining / 8);
          remaining = remaining - (days * 8);
          if (result) result += ' ';
          result += days === 1 ? '1 day' : `${days} days`;
        }

        // Remaining hours (only show if < 8) - always show 1 decimal place
        if (remaining > 0 && remaining < 8) {
          if (result) result += ' ';
          const hrs = remaining.toFixed(1);
          result += hrs === '1.0' ? '1.0 hour' : `${hrs} hours`;
        }

        return result || '0 hours';
      }

      // Format time ago
      function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      }

      // Toggle category expansion
      function toggleQACategory(category) {
        if (expandedCategories.has(category)) {
          expandedCategories.delete(category);
        } else {
          expandedCategories.add(category);
        }
        renderQACategoryView();
      }
      window.toggleQACategory = toggleQACategory;

      // Format QA test status for display
      function formatQAStatus(status) {
        const statusMap = {
          'pending': 'Pending',
          'running': 'Running',
          'passed': 'Passed',
          'failed': 'Failed',
          'fixed': 'Fixed',
          'fixing': 'Fixing...',
          'skipped': 'Skipped'
        };
        return statusMap[status] || status || 'Pending';
      }

      // Update QA stats in the header
      function updateQAStats() {
        const total = qaTestsData.length;
        const passed = qaTestsData.filter(t => t.status === 'passed').length;
        const fixed = qaTestsData.filter(t => t.status === 'fixed').length;
        const failed = qaTestsData.filter(t => t.status === 'failed').length;

        const totalEl = document.getElementById('qaStatTotal');
        const passedEl = document.getElementById('qaStatPassed');
        const failedEl = document.getElementById('qaStatFailed');

        if (totalEl) totalEl.textContent = `${total}`;
        // Include fixed tests in passed count for display
        const passedDisplay = passed + fixed;
        if (passedEl) {
          passedEl.textContent = fixed > 0
            ? `${passedDisplay} passed (${fixed} fixed)`
            : `${passedDisplay} passed`;
        }
        if (failedEl) failedEl.textContent = `${failed} failed`;

        // Also update AI message section
        updateAIMessageSection();
      }

      // Update execution status display
      function updateExecutionStatus(message, isRunning = false) {
        const statusEl = document.getElementById('qaExecutionStatus');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.className = `qa-execution-status ${isRunning ? 'running' : ''}`;
        }
      }

      // Show or update the testing overlay with progress bar and manual hours
      function showTestingOverlay(testName, current, total, manualHours = 0, isFixing = false) {
        let overlay = document.querySelector('.qa-testing-overlay');
        const qaContent = document.querySelector('.qa-categories-container');

        // Helper for zero-padded two-digit format
        const pad2 = (n) => String(n).padStart(2, '0');

        if (!overlay && qaContent) {
          // Create overlay if it doesn't exist
          const initialPercent = total > 0 ? Math.round((current / total) * 100) : 0;
          overlay = document.createElement('div');
          overlay.className = 'qa-testing-overlay';
          overlay.innerHTML = `
            <div class="qa-testing-spinner"></div>
            <div class="qa-testing-status">Jubilee QA Tests Running (${pad2(current)} of ${pad2(total)})...</div>
            <div class="qa-testing-rule"></div>
            <div class="qa-testing-progress-container">
              <div class="qa-testing-progress-wrapper">
                <div class="qa-testing-progress-bar-container">
                  <div class="qa-testing-progress-bar">
                    <div class="qa-testing-progress-fill"></div>
                  </div>
                </div>
                <div class="qa-testing-progress-percent">${initialPercent}%</div>
              </div>
              <div class="qa-testing-manual-hours">
                <span class="manual-hours-label">Manual Testing Time Saved:</span>
                <span class="manual-hours-value">0 hours</span>
              </div>
            </div>
          `;
          qaContent.style.position = 'relative';
          qaContent.appendChild(overlay);
        }

        if (overlay) {
          const statusEl = overlay.querySelector('.qa-testing-status');
          const ruleEl = overlay.querySelector('.qa-testing-rule');
          const progressFill = overlay.querySelector('.qa-testing-progress-fill');
          const progressPercent = overlay.querySelector('.qa-testing-progress-percent');
          const manualHoursEl = overlay.querySelector('.manual-hours-value');

          if (statusEl) {
            statusEl.textContent = `Jubilee QA Tests Running (${pad2(current)} of ${pad2(total)})...`;
          }
          if (ruleEl) {
            if (isFixing) {
              ruleEl.innerHTML = `<span class="fixing-indicator">Fixing known issue:</span> ${testName}`;
            } else {
              ruleEl.textContent = testName || 'Initializing...';
            }
          }
          if (total > 0) {
            const percentage = (current / total) * 100;
            if (progressFill) {
              progressFill.style.width = `${percentage}%`;
            }
            if (progressPercent) {
              progressPercent.textContent = `${Math.round(percentage)}%`;
            }
          }
          if (manualHoursEl && manualHours > 0) {
            manualHoursEl.textContent = formatManualHours(manualHours);
          }
        }
      }

      // Hide the testing overlay
      function hideTestingOverlay() {
        const overlay = document.querySelector('.qa-testing-overlay');
        if (overlay) {
          overlay.remove();
        }
      }

      // Clear all category stats (before running tests)
      function clearCategoryStats() {
        // Reset all test statuses to pending visually
        document.querySelectorAll('.qa-category-stats').forEach(stats => {
          stats.innerHTML = '<span class="qa-category-stat pending-indicator">Pending...</span>';
        });
        // Clear AI message section
        const aiContainer = document.getElementById('qaAiMessageContainer');
        if (aiContainer) aiContainer.innerHTML = '';
      }

      // Run all QA tests sequentially with real-time progress and manual hours tracking
      async function runAllQATests() {
        if (qaTestsRunning) return;
        qaTestsRunning = true;

        const runBtn = document.getElementById('qaRunAllBtn');
        if (runBtn) {
          runBtn.disabled = true;
          runBtn.classList.add('running');
          runBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg> Running...';
        }

        // Step 1: Immediately clear all existing stats
        clearCategoryStats();

        const totalTests = qaTestsData.length;
        let passedCount = 0;
        let failedCount = 0;
        let fixedCount = 0;
        let accumulatedManualHours = 0;

        // Step 2: Show centered testing overlay
        showTestingOverlay('Initializing tests...', 0, totalTests, 0);
        updateExecutionStatus(`Running ${totalTests} tests...`, true);

        try {
          // Run tests sequentially for real-time progress updates
          for (let i = 0; i < qaTestsData.length; i++) {
            const test = qaTestsData[i];
            const qaNumber = test.qa_number || `Test ${i + 1}`;

            // Update overlay with current test info BEFORE running
            showTestingOverlay(`${qaNumber}: ${test.test_name}`, i, totalTests, accumulatedManualHours);

            try {
              // Run individual test
              const response = await fetch(`/api/admin/qa-tests/${test.id}/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });

              if (response.ok) {
                const result = await response.json();
                // Update local data with result
                test.status = result.status;
                test.last_result = result.result_summary;
                test.last_run_at = new Date().toISOString();
                test.run_count = (test.run_count || 0) + 1;
                test.auto_fixed = result.auto_fixed;
                test.fix_description = result.fix_description;

                // Accumulate manual hours for this test
                const testManualHours = parseFloat(result.manual_hours) || parseFloat(test.manual_hours) || 0.25;
                accumulatedManualHours += testManualHours;

                if (result.status === 'passed') {
                  test.pass_count = (test.pass_count || 0) + 1;
                  passedCount++;
                } else if (result.status === 'fixed') {
                  // Fixed counts as passed but track separately
                  test.pass_count = (test.pass_count || 0) + 1;
                  fixedCount++;
                  passedCount++;
                  // Show fixing indicator
                  showTestingOverlay(`${qaNumber}: ${test.test_name}`, i, totalTests, accumulatedManualHours, true);
                  await new Promise(r => setTimeout(r, 200)); // Brief pause to show fixing state
                } else if (result.status === 'failed') {
                  test.fail_count = (test.fail_count || 0) + 1;
                  failedCount++;
                }
              } else {
                // API error - count as failed
                test.status = 'failed';
                test.last_result = 'API error';
                failedCount++;
                accumulatedManualHours += parseFloat(test.manual_hours) || 0.25;
              }
            } catch (err) {
              // Network/parse error - count as failed
              test.status = 'failed';
              test.last_result = err.message;
              failedCount++;
              accumulatedManualHours += parseFloat(test.manual_hours) || 0.25;
            }

            // Update overlay progress AFTER test completes (i+1 completed)
            showTestingOverlay(`${qaNumber}: ${test.test_name}`, i + 1, totalTests, accumulatedManualHours);
          }

          // Step 3: Hide overlay and show results
          hideTestingOverlay();
          renderQACategoryView();
          updateQAStats();

          // Format completion message with fixed count
          let completionMsg = `${passedCount} Pass`;
          if (fixedCount > 0) {
            completionMsg += ` (${fixedCount} auto-fixed)`;
          }
          if (failedCount > 0) {
            completionMsg += `, ${failedCount} Failed`;
          }
          completionMsg += ` | Manual time saved: ${formatManualHours(accumulatedManualHours)}`;

          showQANotification(passedCount, failedCount, fixedCount);
          updateExecutionStatus(`Completed: ${completionMsg}`);

        } catch (error) {
          console.error('Error running QA tests:', error);
          hideTestingOverlay();
          updateExecutionStatus('Error running tests');
          showQANotification(0, 1, 0, error.message);
        } finally {
          qaTestsRunning = false;
          if (runBtn) {
            runBtn.disabled = false;
            runBtn.classList.remove('running');
            runBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> Run All Tests';
          }
        }
      }
      window.runAllQATests = runAllQATests;

      // Attach event listener for Run All Tests button (CSP blocks inline onclick)
      const qaRunAllBtnEl = document.getElementById('qaRunAllBtn');
      if (qaRunAllBtnEl) {
        qaRunAllBtnEl.addEventListener('click', runAllQATests);
      }

      // Run tests for a specific category (sequential with progress)
      async function runCategoryTests(category) {
        const categoryBtn = document.querySelector(`.qa-category-group[data-category="${category}"] .qa-category-run-btn`);
        if (categoryBtn) {
          categoryBtn.classList.add('running');
          categoryBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>';
        }

        const categoryTests = qaTestsData.filter(t => (t.category || 'other') === category);
        const totalTests = categoryTests.length;
        let passedCount = 0;
        let failedCount = 0;

        updateExecutionStatus(`Running ${totalTests} ${QA_CATEGORY_CONFIG[category]?.name || category} tests...`, true);

        try {
          // Run tests sequentially
          for (let i = 0; i < categoryTests.length; i++) {
            const test = categoryTests[i];
            const qaNumber = test.qa_number || `Test ${i + 1}`;

            try {
              const response = await fetch(`/api/admin/qa-tests/${test.id}/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });

              if (response.ok) {
                const result = await response.json();
                test.status = result.status;
                test.last_result = result.result_summary;
                test.last_run_at = new Date().toISOString();
                test.run_count = (test.run_count || 0) + 1;

                if (result.status === 'passed') {
                  test.pass_count = (test.pass_count || 0) + 1;
                  passedCount++;
                } else if (result.status === 'failed') {
                  test.fail_count = (test.fail_count || 0) + 1;
                  failedCount++;
                }
              } else {
                test.status = 'failed';
                test.last_result = 'API error';
                failedCount++;
              }
            } catch (err) {
              test.status = 'failed';
              test.last_result = err.message;
              failedCount++;
            }
          }

          renderQACategoryView();
          updateQAStats();
          showQANotification(passedCount, failedCount);
          updateExecutionStatus(`${QA_CATEGORY_CONFIG[category]?.name || category}: ${passedCount} passed, ${failedCount} failed`);

        } catch (error) {
          console.error('Error running category tests:', error);
          updateExecutionStatus('Error running tests');
        } finally {
          if (categoryBtn) {
            categoryBtn.classList.remove('running');
            categoryBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> Run';
          }
        }
      }
      window.runCategoryTests = runCategoryTests;

      // Run a single QA test
      async function runSingleQATest(testId) {
        const testItem = document.querySelector(`.qa-test-item[data-test-id="${testId}"]`);
        const statusIndicator = testItem?.querySelector('.qa-test-status-indicator');
        const runBtn = testItem?.querySelector('.qa-test-run-btn');

        if (statusIndicator) {
          statusIndicator.className = 'qa-test-status-indicator running';
          statusIndicator.innerHTML = `${getStatusIcon('running')}<span>Running</span>`;
        }
        if (runBtn) {
          runBtn.classList.add('running');
        }

        try {
          const response = await fetch(`/api/admin/qa-tests/${testId}/run`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) throw new Error('Failed to run test');

          const result = await response.json();

          // Update local data
          const test = qaTestsData.find(t => t.id === testId);
          if (test) {
            test.status = result.status;
            test.last_result = result.result_summary;
            test.last_run_at = new Date().toISOString();
            test.run_count = (test.run_count || 0) + 1;
            if (result.status === 'passed') test.pass_count = (test.pass_count || 0) + 1;
            if (result.status === 'failed') test.fail_count = (test.fail_count || 0) + 1;
          }

          // Update UI
          if (statusIndicator) {
            statusIndicator.className = `qa-test-status-indicator ${result.status}`;
            statusIndicator.innerHTML = `${getStatusIcon(result.status)}<span>${formatQAStatus(result.status)}</span>`;
          }

          updateQAStats();
          // Re-render to update category stats
          renderQACategoryView();

        } catch (error) {
          console.error('Error running QA test:', error);
          if (statusIndicator) {
            statusIndicator.className = 'qa-test-status-indicator failed';
            statusIndicator.innerHTML = `${getStatusIcon('failed')}<span>Error</span>`;
          }
        } finally {
          if (runBtn) {
            runBtn.classList.remove('running');
          }
        }
      }
      window.runSingleQATest = runSingleQATest;

      // Event delegation for QA container (CSP blocks inline onclick handlers)
      const qaCategoriesContainer = document.getElementById('qaCategoriesContainer');
      if (qaCategoriesContainer) {
        qaCategoriesContainer.addEventListener('click', function(e) {
          // Handle category header click (toggle)
          const categoryHeader = e.target.closest('.qa-category-header');
          if (categoryHeader && !e.target.closest('.qa-category-run-btn')) {
            const categoryGroup = categoryHeader.closest('.qa-category-group');
            if (categoryGroup) {
              const category = categoryGroup.dataset.category;
              toggleQACategory(category);
            }
            return;
          }

          // Handle category run button click
          const categoryRunBtn = e.target.closest('.qa-category-run-btn');
          if (categoryRunBtn) {
            e.stopPropagation();
            const categoryGroup = categoryRunBtn.closest('.qa-category-group');
            if (categoryGroup) {
              const category = categoryGroup.dataset.category;
              runCategoryTests(category);
            }
            return;
          }

          // Handle individual test run button click
          const testRunBtn = e.target.closest('.qa-test-run-btn');
          if (testRunBtn) {
            const testItem = testRunBtn.closest('.qa-test-item');
            if (testItem) {
              const testId = testItem.dataset.testId;
              runSingleQATest(testId);
            }
            return;
          }

          // Handle info button click for failed tests
          const testInfoBtn = e.target.closest('.qa-test-info-btn');
          if (testInfoBtn) {
            const testItem = testInfoBtn.closest('.qa-test-item');
            if (testItem) {
              const testId = testItem.dataset.testId;
              const test = qaTestsData.find(t => t.id === testId);
              if (test) showQAInfoModal(test);
            }
            return;
          }
        });
      }

      // Event delegation for tasks table (CSP blocks inline onclick handlers)
      if (tasksTableBody) {
        tasksTableBody.addEventListener('click', function(e) {
          const row = e.target.closest('tr[data-task-id]');
          if (!row) return;
          const taskId = row.dataset.taskId;

          // Handle create task button in empty state
          const createBtn = e.target.closest('[data-action="create-task"]');
          if (createBtn) {
            e.stopPropagation();
            openCreateModal();
            return;
          }

          // Handle status button click
          const statusBtn = e.target.closest('[data-action="status-modal"]');
          if (statusBtn) {
            e.stopPropagation();
            const status = statusBtn.dataset.status;
            openStatusModal(taskId, status);
            return;
          }

          // Handle edit button click
          const editBtn = e.target.closest('[data-action="edit-task"]');
          if (editBtn) {
            e.stopPropagation();
            openEditPanel(taskId);
            return;
          }

          // Handle task-actions container (prevent row click)
          const taskActions = e.target.closest('.task-actions');
          if (taskActions) {
            return;
          }

          // Row click opens edit panel
          openEditPanel(taskId);
        });
      }

      // Helper for zero-padded two-digit format (global)
      function pad2Global(n) {
        return String(n).padStart(2, '0');
      }

      // Update sticky footer bar based on test results
      function updateAIMessageSection() {
        const container = document.getElementById('qaAiMessageContainer');
        if (!container) return;

        const failedTests = qaTestsData.filter(t => t.status === 'failed');
        const passedTests = qaTestsData.filter(t => t.status === 'passed');
        const totalRan = passedTests.length + failedTests.length;

        // No tests run yet - hide footer
        if (totalRan === 0) {
          container.innerHTML = '';
          return;
        }

        // All tests passing
        if (failedTests.length === 0 && passedTests.length > 0) {
          container.innerHTML = `
            <div class="qa-footer-bar all-passed">
              <div class="qa-footer-collapsed">
                <div class="qa-footer-summary">
                  <div class="qa-footer-icon">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                  </div>
                  <span class="qa-footer-text">${pad2Global(passedTests.length)} PASS  All tests completed successfully</span>
                </div>
                <div class="qa-footer-cta">
                  <span>Click for details</span>
                  <svg viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                </div>
              </div>
              <div class="qa-footer-expanded">
                <div class="qa-footer-expanded-header">
                  <div class="qa-footer-expanded-title">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Test Results
                  </div>
                  <button class="qa-footer-close-btn">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                  </button>
                </div>
                <div class="qa-footer-success-msg">
                  <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                  <span>All ${passedTests.length} tests passed. System is stable and ready for deployment.</span>
                </div>
              </div>
            </div>
          `;
          attachFooterListeners();
          return;
        }

        // Has failures - build failure details
        const failureItems = failedTests.map(test => {
          const reason = test.last_result || 'Test assertion failed. The expected outcome did not match actual results.';
          const action = getFailureAction(test);
          return `
            <div class="qa-footer-failure-item">
              <div class="qa-footer-failure-name">${escapeHtml(test.test_name)}</div>
              <div class="qa-footer-failure-reason">${escapeHtml(reason)}</div>
              <div class="qa-footer-failure-action">${action}</div>
            </div>
          `;
        }).join('');

        container.innerHTML = `
          <div class="qa-footer-bar has-failures">
            <div class="qa-footer-collapsed">
              <div class="qa-footer-summary">
                <div class="qa-footer-icon">
                  <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                </div>
                <span class="qa-footer-text">${pad2Global(failedTests.length)} FAIL  Requires Attention!</span>
              </div>
              <div class="qa-footer-cta">
                <span>Click for details</span>
                <svg viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
              </div>
            </div>
            <div class="qa-footer-expanded">
              <div class="qa-footer-expanded-header">
                <div class="qa-footer-expanded-title">
                  <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                  Failed Tests (${failedTests.length})
                </div>
                <button class="qa-footer-close-btn">
                  <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
              </div>
              <div class="qa-footer-failure-list">
                ${failureItems}
              </div>
            </div>
          </div>
        `;
        attachFooterListeners();
      }

      // Attach event listeners to footer bar (CSP-compliant)
      function attachFooterListeners() {
        const container = document.getElementById('qaAiMessageContainer');
        if (!container) return;

        // Handle collapsed bar click to toggle
        const collapsed = container.querySelector('.qa-footer-collapsed');
        if (collapsed) {
          collapsed.addEventListener('click', function() {
            const footerBar = this.closest('.qa-footer-bar');
            if (footerBar) footerBar.classList.toggle('expanded');
          });
        }

        // Handle close button click
        const closeBtn = container.querySelector('.qa-footer-close-btn');
        if (closeBtn) {
          closeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const footerBar = this.closest('.qa-footer-bar');
            if (footerBar) footerBar.classList.remove('expanded');
          });
        }
      }

      // Get suggested action for a failed test
      function getFailureAction(test) {
        const category = test.category || 'other';
        const actions = {
          'login': 'Check authentication service and user credentials configuration.',
          'registration': 'Verify registration flow and email validation settings.',
          'chat': 'Review WebSocket connections and message handling logic.',
          'payment': 'Confirm payment gateway integration and API keys.',
          'admin': 'Check admin permissions and role-based access controls.',
          'api': 'Verify API endpoints and response schemas.',
          'security': 'Review security headers and authentication tokens.',
          'performance': 'Check database queries and server response times.',
          'other': 'Review test logs for specific error details.'
        };
        return actions[category] || actions['other'];
      }

      // Show QA notification
      function showQANotification(passed, failed, fixed = 0, errorMsg = null) {
        const total = passed + failed;
        let message;
        if (errorMsg) {
          message = `Error: ${errorMsg}`;
        } else if (failed === 0) {
          message = fixed > 0
            ? `All ${total} tests passed (${fixed} auto-fixed)!`
            : `All ${total} tests passed!`;
        } else {
          message = fixed > 0
            ? `${passed} passed (${fixed} auto-fixed), ${failed} failed`
            : `${passed} passed, ${failed} failed`;
        }

        const notification = document.createElement('div');
        notification.className = `qa-notification ${errorMsg ? 'error' : (failed === 0 ? 'success' : 'warning')}`;
        notification.innerHTML = `
          <span>${message}</span>
          <button class="qa-notification-close"></button>
        `;
        // Add close button handler (CSP blocks inline onclick)
        notification.querySelector('.qa-notification-close').addEventListener('click', function() {
          notification.remove();
        });
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 8px;
          background: ${errorMsg ? '#ef4444' : (failed === 0 ? '#22c55e' : '#f59e0b')};
          color: ${errorMsg ? '#fff' : '#000'};
          font-weight: 600;
          z-index: 10000;
          display: flex;
          align-items: center;
          gap: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;

        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
      }

      // Run QA tests for a specific task (for the QA Test button in task queue)
      async function runTaskQATests(taskId) {
        const btn = document.querySelector(`.qa-test-btn[data-task-id="${taskId}"]`);
        if (!btn) return;

        btn.disabled = true;
        btn.classList.remove('passed', 'failed');
        btn.classList.add('running');
        btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>';

        try {
          const response = await fetch(`/api/admin/tasks/${taskId}/qa-tests/run`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) throw new Error('Failed to run task QA tests');

          const result = await response.json();

          btn.classList.remove('running');
          if (result.failed === 0 && result.passed > 0) {
            btn.classList.add('passed');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Passed';
          } else if (result.failed > 0) {
            btn.classList.add('failed');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> Failed';
          } else {
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM10 17l-3.5-3.5 1.41-1.41L10 14.17l4.59-4.59L16 11l-6 6z"/></svg> QA Test';
          }

          // Refresh QA tests data to keep it in sync
          if (qaTestsData.length > 0) {
            loadQATests();
          }

        } catch (error) {
          console.error('Error running task QA tests:', error);
          btn.classList.remove('running');
          btn.classList.add('failed');
          btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> Error';
        } finally {
          btn.disabled = false;
        }
      }
      window.runTaskQATests = runTaskQATests;

      // Set up review decision radio button listeners
      document.querySelectorAll('input[name="reviewDecision"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.checked) {
            handleReviewDecision(this.value);
          }
        });
      });

      // ============================================
      // COMPREHENSIVE DASHBOARD REFRESH
      // Forces full recalculation of all metrics, gauges, and panels
      // Used for QA validation and verification workflows
      // ============================================
      async function refreshDashboard() {
        const refreshBtn = document.getElementById('refreshDashboardBtn');
        if (!refreshBtn) return;

        // Visual feedback - start loading state
        refreshBtn.classList.add('refreshing');
        console.log('Dashboard refresh initiated - recalculating all metrics...');

        try {
          // Run all refresh operations in parallel for optimal performance
          const refreshOperations = [
            // 1. Re-query dashboard metrics (HEH, velocity, Timeline Burst, etc.)
            loadDashboardMetrics().catch(e => console.error('Dashboard metrics refresh error:', e)),

            // 2. Re-load task queue from database
            loadTaskQueue().catch(e => console.error('Task queue refresh error:', e)),

            // 3. Re-load QA tests
            loadQATests().catch(e => console.error('QA tests refresh error:', e)),

            // 4. Re-load tasks list (if in tasks view)
            loadTasks().catch(e => console.error('Tasks list refresh error:', e))
          ];

          // Wait for all operations to complete
          await Promise.all(refreshOperations);

          // Note: WPH gauge and display are updated by loadDashboardMetrics()
          // which uses the authoritative formula: WPH = EHH / CW+
          // No redundant recalculation needed here.

          // Update Fuel gauge with milestone time remaining
          // Use updateMilestoneDates() for full recalculation from current input values
          if (typeof updateMilestoneDates === 'function') {
            updateMilestoneDates();
            console.log('[refreshDashboard] Fuel gauge recalculated from milestone dates');
          } else if (typeof FuelGauge !== 'undefined') {
            // Fallback if updateMilestoneDates not available
            milestoneData = calculateMilestoneTimeRemaining();
            FuelGauge.setValue(milestoneData.fuelPercent);
            const fuelTextEl = document.getElementById('fuelGaugeText');
            if (fuelTextEl) fuelTextEl.textContent = `${milestoneData.hoursRemaining}h`;
          }

          // Update operational health gauges (Execution Pressure, Rework Drag, Throughput Load)
          if (typeof updateOperationalHealthGauges === 'function') {
            updateOperationalHealthGauges();
            console.log('[refreshDashboard] Operational health gauges updated');
          }

          console.log('Dashboard refresh complete - all metrics updated');
        } catch (error) {
          console.error('Dashboard refresh failed:', error);
        } finally {
          // Remove loading state after a minimum display time for visual feedback
          setTimeout(() => {
            refreshBtn.classList.remove('refreshing');
          }, 500);
        }
      }

      // Expose refresh function globally for external access
      window.refreshDashboard = refreshDashboard;

      // ============================================
      // BACKGROUND PROCESS HEALTH INDICATOR
      // ============================================
      // Yellow = healthy/active, Red = error/inactive
      // Polls the health check endpoint every 30 seconds

      let healthCheckInterval = null;
      let lastHealthStatus = 'unknown';

      async function checkBackgroundProcessHealth() {
        const indicator = document.getElementById('bgProcessHealthIndicator');
        const tooltip = document.getElementById('bgProcessHealthTooltip');

        if (!indicator) return;

        try {
          const response = await fetch('/api/admin/health/background-processes', {
            credentials: 'include',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          if (data.healthy) {
            indicator.className = 'health-indicator healthy';
            lastHealthStatus = 'healthy';

            // Build detailed tooltip
            const services = data.services || {};
            const activeCount = Object.values(services).filter(s => s.active).length;
            const totalCount = Object.keys(services).length;

            let tooltipText = `Timeline Burst (1FTE)\n Tracking Active\n`;
            tooltipText += `${activeCount}/${totalCount} services running\n`;

            if (data.lastActivity) {
              const lastActivityTime = new Date(data.lastActivity);
              const now = new Date();
              const diffMs = now - lastActivityTime;
              const diffMins = Math.floor(diffMs / 60000);

              if (diffMins < 1) {
                tooltipText += `Last activity: just now`;
              } else if (diffMins < 60) {
                tooltipText += `Last activity: ${diffMins}m ago`;
              } else {
                tooltipText += `Last activity: ${Math.floor(diffMins / 60)}h ${diffMins % 60}m ago`;
              }
            }

            if (tooltip) tooltip.textContent = tooltipText;
          } else {
            indicator.className = 'health-indicator error';
            lastHealthStatus = 'error';

            let tooltipText = `Timeline Burst (1FTE)\n Tracking Inactive\n`;
            if (data.error) {
              tooltipText += data.error;
            } else if (data.issues && data.issues.length > 0) {
              tooltipText += data.issues.join('\n');
            } else {
              tooltipText += 'Services not responding';
            }

            if (tooltip) tooltip.textContent = tooltipText;
          }
        } catch (error) {
          console.warn('[HealthCheck] Failed to check background process health:', error.message);

          // Show error state
          indicator.className = 'health-indicator error';
          lastHealthStatus = 'error';

          if (tooltip) {
            tooltip.textContent = `Timeline Burst (1FTE)\n Check Failed\n${error.message}`;
          }
        }
      }

      function startHealthMonitoring() {
        // Initial check after a short delay
        setTimeout(() => {
          checkBackgroundProcessHealth();
        }, 2000);

        // Poll every 30 seconds
        healthCheckInterval = setInterval(() => {
          checkBackgroundProcessHealth();
        }, 30000);

        console.log('[HealthCheck] Background process health monitoring started');
      }

      function stopHealthMonitoring() {
        if (healthCheckInterval) {
          clearInterval(healthCheckInterval);
          healthCheckInterval = null;
          console.log('[HealthCheck] Background process health monitoring stopped');
        }
      }

      // Start health monitoring
      startHealthMonitoring();

      // Expose for debugging
      window.checkBackgroundProcessHealth = checkBackgroundProcessHealth;

      // Add click listener for refresh button
      const refreshDashboardBtn = document.getElementById('refreshDashboardBtn');
      if (refreshDashboardBtn) {
        refreshDashboardBtn.addEventListener('click', refreshDashboard);
        console.log('Refresh button event listener registered successfully');
      } else {
        console.error('Refresh button not found in DOM');
      }

      // Defer ALL data loading until after page renders
      // This prevents the "Page Unresponsive" error on initial load
      setTimeout(() => {
        // Load data sequentially to reduce browser strain
        loadDashboardMetrics()
          .catch(e => console.error('loadDashboardMetrics error:', e))
          .finally(() => {
            // Load tasks after dashboard metrics
            setTimeout(() => {
              loadTasks()
                .catch(e => console.error('loadTasks error:', e))
                .finally(() => {
                  // Load task queue after tasks
                  setTimeout(() => {
                    loadTaskQueue().catch(e => console.error('loadTaskQueue error:', e));
                    loadAssignees().catch(e => console.error('loadAssignees error:', e));
                    restoreViewState();

                    // Update operational health gauges after data loads
                    if (typeof updateOperationalHealthGauges === 'function') {
                      setTimeout(() => updateOperationalHealthGauges(), 200);
                    }

                    // Defer QA tests loading (271 tests)
                    setTimeout(() => {
                      loadQATests().catch(e => console.error('loadQATests error:', e));
                    }, 1000);
                  }, 100);
                });
            }, 100);
          });
      }, 50);  // Small delay to let page render first
    })();
  </script>
</body>
</html>
