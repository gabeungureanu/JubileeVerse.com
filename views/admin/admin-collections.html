<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AI Reactor Control Rods - Inspire 8.0 - JubileeVerse Admin">
  <title>AI Reactor Control Rods - Admin - JubileeVerse</title>
  <link rel="icon" type="image/png" href="/images/personas/jubilee.png">
  <link rel="apple-touch-icon" href="/images/personas/jubilee.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin-header.css">
  <link rel="stylesheet" href="/css/admin-sidebar.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #0a0a0a;
      color: #f2f2f2;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: #444 #1a1a1a;
    }

    .app-container {
      display: flex;
      height: calc(100vh - 36px);
      width: 100vw;
      margin-top: 36px;
      overflow-x: hidden;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
      padding-top: 0;
    }

    .main-content-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ==================== FULL-WIDTH HEADER BAR ==================== */
    .collections-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      height: 48px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 2px solid #ffd700;
      flex-shrink: 0;
    }

    .collections-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .collections-header-bar svg {
      width: 18px;
      height: 18px;
      fill: #ffd700;
    }

    .collections-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      letter-spacing: 1px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Gold Star VIP Icon */
    .vip-star-icon {
      width: 30px;
      height: 30px;
      fill: #ffd700;
      filter: drop-shadow(0 0 4px rgba(255, 189, 89, 0.6));
      animation: starGlow 2s ease-in-out infinite alternate;
    }

    @keyframes starGlow {
      0% { filter: drop-shadow(0 0 3px rgba(255, 189, 89, 0.4)); }
      100% { filter: drop-shadow(0 0 8px rgba(255, 189, 89, 0.9)); }
    }

    /* ==================== THREE PANEL LAYOUT ==================== */
    .collections-layout {
      flex: 1;
      display: flex;
      gap: 0;
      overflow: hidden;
    }

    /* ==================== RIGHT SIDEBAR - NAV ==================== */
    .collections-control-panel {
      width: 72px;
      background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
      border-left: 2px solid #ffd700;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 12px;
      gap: 16px;
      flex-shrink: 0;
    }

    .control-btn {
      width: 48px;
      height: 48px;
      border: 2px solid #333;
      border-radius: 10px;
      background: #151515;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      position: relative;
      text-decoration: none;
    }

    .control-btn:hover {
      background: #1f1f1f;
      border-color: #555;
    }

    .control-btn.active {
      background: linear-gradient(135deg, rgba(255, 189, 89, 0.15) 0%, rgba(255, 189, 89, 0.05) 100%);
      border-color: #ffd700;
    }

    .control-btn.active svg {
      fill: #ffd700;
    }

    .control-btn svg {
      width: 24px;
      height: 24px;
      fill: #888;
      transition: fill 0.2s ease;
    }

    .control-btn:hover svg {
      fill: #bbb;
    }

    .control-btn-label {
      position: absolute;
      right: 60px;
      background: #222;
      color: #fff;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .control-btn:hover .control-btn-label {
      opacity: 1;
    }

    .control-divider {
      width: 32px;
      height: 1px;
      background: #333;
      margin: 8px 0;
    }

    /* ==================== PANEL 1: COLLECTIONS TREE ==================== */
    .collections-tree-panel {
      width: 280px;
      min-width: 280px;
      background-color: #1a1a1a;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .tree-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      height: 38px;
      border-bottom: 1px solid #333;
      background: rgba(0, 0, 0, 0.2);
    }

    .tree-header svg {
      width: 18px;
      height: 18px;
      fill: #ffd700;
    }

    .tree-header span {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
    }

    .tree-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    /* Search at bottom of panel */
    .tree-search {
      padding: 10px 12px;
      border-top: 1px solid #333;
      background: rgba(0, 0, 0, 0.2);
    }

    .tree-search input {
      width: 100%;
      padding: 8px 10px;
      background: #222;
      border: 1px solid #444;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
    }

    .tree-search input:focus {
      outline: none;
      border-color: #ffd700;
    }

    .tree-search-hint {
      font-size: 9px;
      color: #666;
      margin-top: 4px;
      text-align: center;
    }

    /* ==================== COLLECTION SECTIONS ==================== */
    .collection-section {
      margin-bottom: 8px;
      padding: 0 12px;
    }

    /* Authority Foundation Section - Match search textbox style */
    .collection-section.authority-section .section-header {
      background: #ffd700;
      border: 1px solid #ffd700;
      border-radius: 4px;
      padding: 8px 10px;
      margin: 0;
    }

    .collection-section.authority-section .section-header:hover {
      background: #e5a94f;
    }

    .collection-section.authority-section .section-toggle svg {
      fill: #000;
    }

    .collection-section.authority-section .section-icon svg {
      fill: #000;
    }

    .collection-section.authority-section .section-title {
      color: #000 !important;
      font-weight: bold;
      font-family: Arial, sans-serif;
      font-size: 9px;
      letter-spacing: 1px;
      margin-left: 0px;
    }

    /* Hide toggle arrow for authority section */
    .collection-section.authority-section .section-toggle {
      display: none;
    }

    .collection-section.authority-section .section-header.expanded .section-title {
      color: #000 !important;
    }

    .collection-section.authority-section .section-header.expanded .section-toggle svg {
      fill: #000;
    }

    /* Reactor icon in Authority section */
    .collection-section.authority-section .section-icon {
      width: 20px;
      height: 20px;
      margin-left: -5px;
    }

    .collection-section.authority-section .section-icon svg {
      width: 18px;
      height: 18px;
      fill: #000 !important;
    }

    .collection-section.authority-section .section-header.expanded .section-icon svg {
      fill: #000 !important;
    }

    .collection-section.authority-section .section-count {
      color: #000;
      background: rgba(0, 0, 0, 0.15);
    }

    .collection-section.authority-section .section-items {
      background: transparent;
      margin-bottom: 0;
    }

    /* Goal-Driven Intelligence Section - Match search textbox style */
    .collection-section.orchestration-section .section-header {
      background: #ffd700;
      border: 1px solid #ffd700;
      border-radius: 4px;
      padding: 8px 10px;
      margin: 0;
    }

    .collection-section.orchestration-section .section-header:hover {
      background: #e5a94f;
    }

    .collection-section.orchestration-section .section-toggle svg {
      fill: #000;
    }

    .collection-section.orchestration-section .section-icon svg {
      fill: #000;
    }

    .collection-section.orchestration-section .section-title {
      color: #000 !important;
      font-weight: bold;
      font-family: Arial, sans-serif;
      font-size: 9px;
      letter-spacing: 1px;
      margin-left: 0px;
    }

    /* Hide toggle arrow for orchestration section */
    .collection-section.orchestration-section .section-toggle {
      display: none;
    }

    .collection-section.orchestration-section .section-header.expanded .section-title {
      color: #000 !important;
    }

    .collection-section.orchestration-section .section-header.expanded .section-toggle svg {
      fill: #000;
    }

    /* Reactor icon in Orchestration section */
    .collection-section.orchestration-section .section-icon {
      width: 20px;
      height: 20px;
      margin-left: -5px;
    }

    .collection-section.orchestration-section .section-icon svg {
      width: 18px;
      height: 18px;
      fill: #000 !important;
    }

    .collection-section.orchestration-section .section-header.expanded .section-icon svg {
      fill: #000 !important;
    }

    .collection-section.orchestration-section .section-count {
      color: #000;
      background: rgba(0, 0, 0, 0.15);
    }

    .collection-section.orchestration-section .section-items {
      background: transparent;
      margin-bottom: 0;
    }

    /* Kingdom Impact Section - Match search textbox style */
    .collection-section.interaction-section .section-header {
      background: #ffd700;
      border: 1px solid #ffd700;
      border-radius: 4px;
      padding: 8px 10px;
      margin: 0;
    }

    .collection-section.interaction-section .section-header:hover {
      background: #e5a94f;
    }

    .collection-section.interaction-section .section-toggle svg {
      fill: #000;
    }

    .collection-section.interaction-section .section-icon svg {
      fill: #000;
    }

    .collection-section.interaction-section .section-title {
      color: #000 !important;
      font-weight: bold;
      font-family: Arial, sans-serif;
      font-size: 9px;
      letter-spacing: 1px;
      margin-left: 0px;
    }

    /* Hide toggle arrow for interaction section */
    .collection-section.interaction-section .section-toggle {
      display: none;
    }

    .collection-section.interaction-section .section-header.expanded .section-title {
      color: #000 !important;
    }

    .collection-section.interaction-section .section-header.expanded .section-toggle svg {
      fill: #000;
    }

    /* Reactor icon in Interaction section */
    .collection-section.interaction-section .section-icon {
      width: 20px;
      height: 20px;
      margin-left: -5px;
    }

    .collection-section.interaction-section .section-icon svg {
      width: 18px;
      height: 18px;
      fill: #000 !important;
    }

    .collection-section.interaction-section .section-header.expanded .section-icon svg {
      fill: #000 !important;
    }

    .collection-section.interaction-section .section-count {
      color: #000;
      background: rgba(0, 0, 0, 0.15);
    }

    .collection-section.interaction-section .section-items {
      background: transparent;
      margin-bottom: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid #333;
      transition: background-color 0.15s ease;
      gap: 6px;
    }

    .section-header:hover {
      background: rgba(255, 189, 89, 0.08);
    }

    .section-header.active {
      background: rgba(255, 189, 89, 0.12);
    }

    .section-toggle {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .section-toggle svg {
      width: 10px;
      height: 10px;
      fill: #888;
    }

    .section-header.expanded .section-toggle {
      transform: rotate(90deg);
    }

    .section-header.expanded .section-toggle svg {
      fill: #ffd700;
    }

    .section-icon {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .section-icon svg {
      width: 16px;
      height: 16px;
      fill: #888;
    }

    .section-header.active .section-icon svg,
    .section-header.expanded .section-icon svg {
      fill: #ffd700;
    }

    .section-title {
      flex: 1;
      font-size: 10px;
      font-weight: 600;
      color: #ccc;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-header.active .section-title,
    .section-header.expanded .section-title {
      color: #ffd700;
    }

    .section-count {
      font-size: 9px;
      font-weight: 500;
      color: #666;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 5px;
      border-radius: 8px;
    }

    .section-header.expanded .section-count {
      color: #ffd700;
      background: rgba(255, 189, 89, 0.2);
    }

    .section-items {
      display: none;
      padding: 2px 0;
    }

    .section-items.expanded {
      display: block;
    }

    /* Collection Item Styling - Compact rows */
    .collection-item {
      position: relative;
      user-select: none;
    }

    .collection-item-row {
      display: flex;
      align-items: center;
      padding: 2px 10px 2px 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      gap: 8px;
      border-radius: 4px;
      margin: 0 6px;
      border: 1px solid transparent;
    }

    .collection-item-row:hover {
      background-color: rgba(255, 189, 89, 0.05);
    }

    /* Selected item - Gold font only, no border */
    .collection-item-row.active {
      background-color: transparent;
    }

    /* Collection Item Name Only - No icon, no description */
    .collection-name {
      font-size: 11px;
      font-weight: 500;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.15s ease;
      flex: 1;
    }

    .collection-item-row.active .collection-name {
      color: #ffd700;
      font-weight: 600;
    }

    /* Collection expand toggle (+/-) */
    .collection-expand-toggle {
      width: 8px;
      height: 8px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 6px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      border: 1px solid #888;
    }

    .collection-expand-placeholder {
      width: 8px;
      height: 8px;
      flex-shrink: 0;
    }

    .collection-expand-toggle:hover {
      background: rgba(192, 192, 192, 0.2);
    }

    .collection-item.expanded .collection-expand-toggle {
      background: rgba(192, 192, 192, 0.15);
    }

    /* Collection item icons */
    .collection-icon {
      width: 17px;
      height: 17px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .collection-icon svg {
      width: 14px;
      height: 14px;
      fill: #ffd700;
      stroke: #ffd700;
      color: #ffd700;
    }

    .collection-item-row:hover .collection-icon svg {
      fill: #ffd700;
    }

    .collection-item-row.active .collection-icon svg {
      fill: #ffd700;
    }

    /* Subcategories container */
    .collection-subcategories {
      display: none;
      padding-left: 12px;
      margin-top: 2px;
      border-left: 1px solid #333;
      margin-left: 21px;
    }

    .collection-item.expanded .collection-subcategories {
      display: block;
    }

    .subcategory-item {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      padding-left: 22px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 3px;
      margin: 1px 0;
      gap: 6px;
    }

    .subcategory-item:hover {
      background: rgba(255, 189, 89, 0.1);
    }

    .subcategory-item.active {
      background: transparent;
    }

    .subcategory-number {
      min-width: 14px;
      height: 10px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 189, 89, 0.15);
      border: 1px solid #ffd700;
      border-radius: 2px;
      font-size: 5px;
      font-weight: 700;
      color: #ffd700;
    }

    .subcategory-item.active .subcategory-number {
      background: rgba(255, 189, 89, 0.3);
    }

    .subcategory-name {
      font-size: 10px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subcategory-item:hover .subcategory-name {
      color: #ffd700;
    }

    .subcategory-item.active .subcategory-name {
      color: #ffd700;
      font-weight: 500;
    }

    /* Stage item - expandable with domains underneath */
    .stage-item {
      position: relative;
    }

    .stage-item-row {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      padding-left: 7px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 3px;
      margin: 1px 0;
      gap: 6px;
    }

    .stage-item-row:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .stage-item-row.active {
      background: rgba(255, 189, 89, 0.1);
    }

    .stage-item-row.active .subcategory-name {
      color: #ffd700;
      font-weight: 500;
    }

    .stage-item-row.active .subcategory-number {
      background: rgba(255, 189, 89, 0.3);
    }

    .stage-expand-toggle {
      width: 8px;
      height: 8px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 6px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      border: 1px solid #888;
    }

    .stage-expand-toggle:hover {
      color: #ffd700;
      border-color: #ffd700;
    }

    .stage-expand-toggle.empty {
      display: none;
    }

    /* Items without + toggle get extra padding to align with items that have + toggle */
    .stage-item.no-children > .stage-item-row {
      padding-left: 21px;
    }

    /* Stage domains container (level 2) */
    .stage-domains {
      display: none;
      padding-left: 12px;
      margin-top: 2px;
      border-left: 1px solid #444;
      margin-left: 17px;
    }

    .stage-item.expanded .stage-domains {
      display: block;
    }

    /* Domain item - expandable with children underneath */
    .domain-item {
      position: relative;
    }

    .domain-item-row {
      display: flex;
      align-items: center;
      padding: 2px 6px;
      padding-left: 0px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 3px;
      margin: 1px 0;
      gap: 5px;
    }

    .domain-item-row:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .domain-item-row.active {
      background: rgba(255, 189, 89, 0.1);
    }

    .domain-item-row.active .domain-name {
      color: #ffd700;
      font-weight: 500;
    }

    .domain-item-row.active .domain-number {
      background: rgba(255, 189, 89, 0.3);
    }

    .domain-expand-toggle {
      width: 7px;
      height: 7px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      border: 1px solid #888;
    }

    .domain-expand-toggle:hover {
      color: #ffd700;
      border-color: #ffd700;
    }

    .domain-expand-toggle.empty {
      display: none;
    }

    /* Domain items without + toggle get extra padding */
    .domain-item.no-children > .domain-item-row {
      padding-left: 55px !important;
    }

    .domain-icon {
      width: 12px;
      height: 12px;
      min-width: 12px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .domain-icon svg {
      width: 12px;
      height: 12px;
      fill: #ffd700;
    }

    .domain-name {
      font-size: 9px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .domain-item-row:hover .domain-name {
      color: #ffd700;
    }

    /* Domain children container (level 3) */
    .domain-children {
      display: none;
      padding-left: 12px;
      margin-top: 1px;
      border-left: 1px solid #555;
      margin-left: 17px;
    }

    .domain-item.expanded .domain-children {
      display: block;
    }

    /* Domain items without children get extra left padding */
    .domain-item.no-children > .domain-item-row {
      padding-left: 74px;
    }

    /* Child item (leaf node) */
    .child-item {
      display: flex;
      align-items: center;
      padding: 2px 5px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      margin: 1px 0;
      gap: 4px;
    }

    .child-item:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .child-item.active .child-name {
      color: #ffd700;
      font-weight: 500;
    }

    .child-icon {
      width: 12px;
      height: 12px;
      min-width: 12px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .child-icon svg {
      width: 12px;
      height: 12px;
      fill: #ffd700;
    }

    .child-name {
      font-size: 9px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .child-item:hover .child-name {
      color: #ffd700;
    }

    /* Nested parent item (expandable child with sub-children) */
    .nested-parent-item {
      position: relative;
    }

    .child-item-row {
      display: flex;
      align-items: center;
      padding: 2px 5px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      margin: 1px 0;
      margin-left: 0px;
      gap: 4px;
    }

    .child-item-row:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .child-item-row:hover .child-name {
      color: #ffd700;
    }

    .child-expand-toggle {
      width: 7px;
      height: 7px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      border: 1px solid #888;
    }

    .child-expand-toggle:hover {
      color: #ffd700;
      border-color: #ffd700;
    }

    /* Nested children container */
    .nested-children {
      display: none;
      padding-left: 12px;
      margin-top: 1px;
      border-left: 1px solid #555;
      margin-left: 17px;
    }

    .nested-parent-item.expanded .nested-children {
      display: block;
    }

    /* Nested child items (level 4 - for Mementos_and_Artifacts) */
    .nested-child-item {
      display: flex;
      align-items: center;
      padding: 2px 5px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      margin: 1px 0;
      gap: 4px;
    }

    .nested-child-item:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .nested-child-item.active .child-name {
      color: #ffd700;
      font-weight: 500;
    }

    .nested-child-icon {
      width: 12px;
      height: 12px;
      min-width: 12px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nested-child-icon svg {
      width: 12px;
      height: 12px;
      fill: #ffd700;
    }

    /* Nested child parent (level 4 expandable) */
    .nested-child-parent {
      position: relative;
    }

    .nested-child-item-row {
      display: flex;
      align-items: center;
      padding: 2px 5px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      margin: 1px 0;
      gap: 4px;
    }

    .nested-child-item-row:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .nested-child-item-row.active .child-name {
      color: #ffd700;
      font-weight: 500;
    }

    .nested-expand-toggle {
      width: 7px;
      height: 7px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      border: 1px solid #888;
    }

    .nested-expand-toggle:hover {
      color: #ffd700;
      border-color: #ffd700;
    }

    /* Deep nested children container (level 5) */
    .deep-nested-children {
      display: none;
      padding-left: 12px;
      margin-top: 1px;
      border-left: 1px solid #555;
      margin-left: 10px;
    }

    .nested-child-parent.expanded .deep-nested-children {
      display: block;
    }

    /* Deep nested parent (level 5 expandable) */
    .deep-nested-parent {
      position: relative;
    }

    .deep-nested-item-row {
      display: flex;
      align-items: center;
      padding: 2px 5px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      margin: 1px 0;
      gap: 4px;
    }

    .deep-nested-item-row:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .deep-nested-item-row.active .child-name {
      color: #ffd700;
      font-weight: 500;
    }

    .deep-nested-item {
      display: flex;
      align-items: center;
      padding: 2px 5px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      margin: 1px 0;
      gap: 4px;
    }

    .deep-nested-item:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .deep-nested-item.active .child-name {
      color: #ffd700;
      font-weight: 500;
    }

    .deep-nested-icon {
      width: 12px;
      height: 12px;
      min-width: 12px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .deep-nested-icon svg {
      width: 12px;
      height: 12px;
      fill: #ffd700;
    }

    .deep-expand-toggle {
      width: 7px;
      height: 7px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 2px;
      border: 1px solid #888;
    }

    .deep-expand-toggle:hover {
      color: #ffd700;
      border-color: #ffd700;
    }

    /* Deepest children container (level 6+) */
    .deepest-children {
      display: none;
      padding-left: 12px;
      margin-top: 1px;
      border-left: 1px solid #555;
      margin-left: 10px;
    }

    .deep-nested-parent.expanded .deepest-children {
      display: block;
    }

    /* ==================== INSPIRE FAMILY DATABASE CATEGORIES ==================== */
    .inspire-category-item {
      position: relative;
    }

    .inspire-category-row {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 4px;
      margin: 2px 0;
      gap: 6px;
    }

    .inspire-category-row:hover {
      background: rgba(255, 189, 89, 0.08);
    }

    .inspire-category-row.active {
      background: rgba(255, 189, 89, 0.15);
    }

    .inspire-category-row.active .inspire-category-name {
      color: #ffd700;
    }

    .inspire-category-toggle {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 3px;
      border: 1px solid #555;
    }

    .inspire-category-toggle:hover {
      border-color: #ffd700;
      color: #ffd700;
    }

    .inspire-category-toggle-placeholder {
      width: 14px;
      flex-shrink: 0;
    }

    .inspire-category-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .inspire-category-icon svg {
      width: 14px;
      height: 14px;
    }

    .inspire-category-number {
      min-width: 22px;
      height: 18px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 189, 89, 0.15);
      border: 1px solid #ffd700;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      color: #ffd700;
      margin-right: 8px;
    }

    .inspire-category-name {
      font-size: 11px;
      color: #fff;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .inspire-category-count {
      font-size: 9px;
      font-weight: 600;
      color: rgba(255, 189, 89, 0.5);
      background: rgba(255, 189, 89, 0.15);
      padding: 2px 6px;
      border-radius: 8px;
      flex-shrink: 0;
      min-width: 20px;
      text-align: center;
    }

    .inspire-category-children {
      padding-left: 12px;
      border-left: 1px solid #333;
      margin-left: 10px;
    }

    .inspire-category-item.level-1 .inspire-category-row {
      padding-left: 4px;
    }

    .inspire-category-item.level-2 .inspire-category-row {
      padding-left: 4px;
    }

    .inspire-category-item.level-2 .inspire-category-name {
      font-size: 10px;
    }

    /* ==================== INSPIRE FAMILY LEFT PANEL CATEGORIES ==================== */
    .if-panel-category {
      position: relative;
    }

    .if-panel-category-row {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.15s;
      gap: 6px;
    }

    .if-panel-category-row:hover {
      background-color: rgba(255, 189, 89, 0.1);
    }

    .if-panel-category-row.active {
      background-color: rgba(255, 189, 89, 0.2);
      border-left: 2px solid #ffd700;
    }

    .if-panel-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      flex-shrink: 0;
    }

    .if-panel-toggle:hover {
      color: #ffd700;
    }

    .if-panel-toggle-placeholder {
      width: 16px;
      flex-shrink: 0;
    }

    .if-panel-icon {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
    }

    .if-panel-icon svg {
      width: 14px;
      height: 14px;
    }

    .if-panel-name {
      flex: 1;
      font-size: 12px;
      color: #e0e0e0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .if-panel-count {
      display: none;
    }

    .if-panel-children {
      margin-left: 10px;
      padding-left: 12px;
      border-left: 1px solid #333;
    }

    .if-panel-category.level-1 .if-panel-name {
      font-size: 11px;
    }

    .if-panel-category.level-2 .if-panel-name {
      font-size: 10px;
      color: #aaa;
    }

    /* ==================== CATEGORY ITEMS LIST (in Edit Panel) ==================== */
    .category-items-list {
      padding: 12px;
      height: 100%;
      overflow-y: auto;
    }

    .category-items-header {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }

    .category-items-header h3 {
      font-size: 12px;
      font-weight: 600;
      color: #ffd700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .category-items-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .category-item-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .category-item-card:hover {
      background: #222;
      border-color: #444;
    }

    .category-item-card.high-priority {
      border-left: 3px solid #ff6b6b;
    }

    .category-item-card.medium-priority {
      border-left: 3px solid #ffd700;
    }

    .item-card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .item-type-badge {
      font-size: 8px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .item-type-activation {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }

    .item-type-property {
      background: rgba(100, 181, 246, 0.2);
      color: #64b5f6;
    }

    .item-type-event_trigger {
      background: rgba(186, 104, 200, 0.2);
      color: #ba68c8;
    }

    .item-type-prompt {
      background: rgba(129, 199, 132, 0.2);
      color: #81c784;
    }

    .sealed-badge {
      font-size: 7px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 2px;
      background: rgba(255, 189, 89, 0.3);
      color: #ffd700;
    }

    .irrevocable-badge {
      font-size: 7px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 2px;
      background: rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
    }

    .item-priority {
      font-size: 9px;
      color: #666;
      margin-left: auto;
    }

    .item-card-name {
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .item-card-preview {
      font-size: 10px;
      color: #888;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .item-card-source {
      font-size: 9px;
      color: #555;
      margin-top: 6px;
      font-style: italic;
    }

    .collection-info {
      flex: 1;
      min-width: 0;
    }

    .collection-description {
      display: none;
    }

    /* Item Count Badge - Hidden for cleaner look */
    .collection-item-count {
      font-size: 9px;
      font-weight: 600;
      color: #666;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .collection-item-row.active .collection-item-count {
      color: #ffd700;
      background: rgba(255, 189, 89, 0.2);
    }

    /* Loading State */
    .tree-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #666;
      font-size: 11px;
    }

    .tree-loading::before {
      content: "";
      width: 14px;
      height: 14px;
      border: 2px solid #333;
      border-top-color: #ffd700;
      border-radius: 50%;
      margin-right: 8px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ==================== PANEL 2: ITEMS LIST ==================== */
    .items-list-panel {
      flex: 1;
      min-width: 350px;
      max-width: 500px;
      background: linear-gradient(180deg, #111 0%, #0d0d0d 100%);
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .items-list-subheader {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      height: 38px;
      border-bottom: 2px solid #888;
      background: rgba(0, 0, 0, 0.1);
      gap: 8px;
    }

    .context-display {
      flex: 1;
      font-family: 'Orbitron', sans-serif;
      font-size: 11px;
      font-weight: 500;
      color: #ffd700;
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .items-list-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    /* Individual Item List Item - Matching Inspire Family inbox style */
    .item-list-item {
      position: relative;
    }

    .item-list-row {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 4px;
      margin: 2px 0;
      gap: 6px;
    }

    .item-list-row:hover {
      background: rgba(255, 189, 89, 0.08);
    }

    .item-list-item.selected .item-list-row {
      background: rgba(255, 189, 89, 0.15);
    }

    .item-list-item.selected .item-list-title {
      color: #ffd700;
    }

    .item-list-item.inactive {
      opacity: 0.6;
    }

    /* Item Number Badge - Matching inspire-category-number */
    .item-number-badge {
      min-width: 22px;
      height: 18px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 189, 89, 0.15);
      border: 1px solid #ffd700;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      color: #ffd700;
      margin-right: 8px;
    }

    .item-list-item.selected .item-number-badge {
      background: rgba(255, 189, 89, 0.3);
    }

    /* Item List Item Title */
    .item-list-title {
      font-size: 11px;
      color: #fff;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Item Count Badge - Matching inspire-category-count */
    .item-list-count {
      font-size: 9px;
      font-weight: 600;
      color: rgba(255, 189, 89, 0.5);
      background: rgba(255, 189, 89, 0.15);
      padding: 2px 6px;
      border-radius: 8px;
      flex-shrink: 0;
      min-width: 20px;
      text-align: center;
    }

    /* Item Status Indicator */
    .item-list-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .item-list-status.active {
      background: #4ade80;
      box-shadow: 0 0 4px rgba(74, 222, 128, 0.5);
    }

    .item-list-status.inactive {
      background: #666;
    }

    /* ==================== VERSE LIST ITEMS ==================== */
    .verse-item {
      display: flex;
      align-items: center;
      padding: 4px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .verse-item:hover {
      background: rgba(255, 189, 89, 0.08);
    }

    .verse-item.selected {
      background: rgba(255, 189, 89, 0.15);
    }

    .verse-number-badge {
      font-size: 9px;
      font-weight: 600;
      color: #ffd700;
      background: rgba(255, 189, 89, 0.12);
      padding: 1px 4px;
      border-radius: 3px;
      min-width: 18px;
      text-align: center;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .verse-content {
      flex: 1;
      min-width: 0;
    }

    .verse-preview {
      font-size: 11px;
      color: #e0e0e0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .verse-reference {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }

    .verse-section-heading {
      font-size: 11px;
      font-weight: 600;
      color: #ffd700;
      padding: 12px 16px 6px 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .verse-benchmark-score {
      font-size: 8px;
      font-weight: 600;
      color: #ffd700;
      border: 1px solid #ffd700;
      padding: 1px 5px;
      border-radius: 2px;
      margin-left: auto;
      flex-shrink: 0;
      font-family: 'Orbitron', sans-serif;
      line-height: 1.2;
    }

    /* ==================== BENCHMARK EVALUATION DISPLAY ==================== */
    .benchmark-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      text-align: center;
    }

    .benchmark-tab-header {
      display: flex;
      flex-direction: column;
      padding: 16px 16px 12px 16px;
      margin: -16px -16px 0 -16px;
      background: #0d0d0d;
      border-bottom: 2px solid #ffd700;
      position: sticky;
      top: -16px;
      z-index: 100;
    }

    .benchmark-verse-ref {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #ffd700;
      margin-bottom: 6px;
    }

    .benchmark-verse-text {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      color: #fff;
      margin-bottom: 6px;
      line-height: 1.4;
      text-align: justify;
      text-justify: inter-word;
    }

    .benchmark-verse-hebrew {
      font-family: 'SBL Hebrew', 'Ezra SIL', 'Times New Roman', 'David', serif;
      font-size: 16px;
      color: #c9a227;
      margin-top: -6px;
      margin-bottom: 12px;
      line-height: 1.6;
      direction: rtl;
      text-align: right;
      unicode-bidi: bidi-override;
    }

    .benchmark-score-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
      padding-right: 0;
    }

    .benchmark-execute-btn {
      background: linear-gradient(135deg, #ffd700, #d4af37);
      border: none;
      border-radius: 4px;
      color: #000;
      font-size: 9px;
      font-weight: 700;
      padding: 6px 10px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      transition: all 0.2s ease;
      white-space: nowrap;
      margin-top: 25px;
      align-self: flex-start;
    }

    .benchmark-execute-btn:hover {
      background: linear-gradient(135deg, #ffc970, #f0b85a);
      transform: translateY(-1px);
    }

    .benchmark-execute-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .benchmark-scores-group {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      margin-left: auto;
      margin-right: 0;
      padding-right: 0;
      flex-shrink: 0;
    }

    .benchmark-percent-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .benchmark-percent {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }

    /* Score color rules based on 0-1000 scale */
    .benchmark-percent.score-gold { color: #ffd700; }
    .benchmark-percent.score-green { color: #22c55e; }
    .benchmark-percent.score-red { color: #ef4444; }

    .benchmark-total {
      font-size: 10px;
      color: #888;
      margin-top: -3px;
      text-align: right;
      align-self: flex-end;
    }

    .benchmark-grade {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
      padding: 6px 14px;
      border-radius: 6px;
      margin-left: 25px;
      margin-right: 0;
      border: 3px solid;
    }

    /* Grade colors: A+/A = gold, B = gold, C = green, F = red */
    .benchmark-grade.grade-a-plus,
    .benchmark-grade.grade-a {
      background: linear-gradient(135deg, #ffd700, #e5c100);
      border-color: #ffd700;
      color: #000;
    }
    .benchmark-grade.grade-b {
      background: linear-gradient(135deg, #ffd700, #e5c100);
      border-color: #ffd700;
      color: #000;
    }
    .benchmark-grade.grade-c {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: #22c55e;
      color: #fff;
    }
    .benchmark-grade.grade-f {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border-color: #ef4444;
      color: #fff;
    }

    /* Full-width benchmark table */
    .benchmark-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      position: relative;
      z-index: 1;
    }

    .benchmark-table th {
      background: rgba(255, 189, 89, 0.15);
      color: #ffffff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 4px;
      text-align: left;
      border-bottom: 1px solid #ffd700;
      font-size: 9px;
      line-height: 1.65;
    }

    .benchmark-table th:last-child {
      text-align: right;
      width: 60px;
      padding-right: 8px;
    }

    .benchmark-table td {
      padding: 1px 4px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      color: #e0e0e0;
      font-size: 10px;
      line-height: 1.1;
    }

    .benchmark-table td:last-child {
      text-align: right;
      padding-right: 8px;
    }

    .benchmark-table tr:hover {
      background: rgba(255, 189, 89, 0.05);
    }

    .benchmark-table .criterion-num {
      color: #ffffff;
      font-weight: 400;
      width: 30px;
    }

    .benchmark-table .criterion-name {
      color: #e0e0e0;
    }

    .benchmark-table .criterion-name.inverted {
      color: #ffffff;
    }

    .benchmark-table .criterion-score {
      text-align: right;
      font-weight: 700;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      display: inline-block;
      min-width: 36px;
    }

    .benchmark-table td:last-child {
      text-align: right;
      padding-right: 8px;
    }

    /* Score colors for criterion percentages */
    .benchmark-table .score-gold { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
    .benchmark-table .score-green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .benchmark-table .score-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .benchmark-table .score-white { background: transparent; color: #ffffff; }

    .benchmark-table tfoot td {
      border-top: 2px solid #ffd700;
      padding: 4px 4px;
      font-weight: 700;
      color: #ffffff;
      font-size: 11px;
    }

    .benchmark-table tfoot .total-label {
      text-align: right;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .benchmark-table tfoot .total-score {
      text-align: right;
      font-family: 'Orbitron', sans-serif;
      font-size: 12px;
      color: #fff;
      padding-right: 8px;
    }

    .benchmark-insights-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 0;
      background: rgba(0, 0, 0, 0.2);
    }

    .insight-box {
      padding: 12px 0;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      width: 100%;
    }

    .insight-box-title {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .insight-box-title.strengths { color: #22c55e; }
    .insight-box-title.improvements { color: #f59e0b; }

    .insight-box ul {
      margin: 0;
      padding-left: 16px;
      font-size: 11px;
      color: #ccc;
      line-height: 1.6;
    }

    .insight-box li {
      margin-bottom: 4px;
    }

    .benchmark-assessment-section {
      padding: 16px 0 16px 12px;
      background: rgba(255, 189, 89, 0.08);
      border-left: 4px solid #ffd700;
      margin: 16px 0;
      border-radius: 0 6px 6px 0;
    }

    .benchmark-assessment-section .assessment-label {
      font-size: 10px;
      font-weight: 600;
      color: #ffd700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .benchmark-assessment-section .assessment-text {
      font-size: 12px;
      color: #e0e0e0;
      line-height: 1.6;
    }

    .benchmark-assessment-section .recommendation {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 189, 89, 0.2);
      font-size: 11px;
      color: #ccc;
    }

    /* Fine-tuning input section */
    .benchmark-finetune-section {
      padding: 12px 0;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 189, 89, 0.2);
    }

    .benchmark-finetune-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #ffd700;
      margin-bottom: 8px;
    }

    .benchmark-finetune-input {
      width: 100%;
      min-height: 80px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 189, 89, 0.3);
      border-radius: 4px;
      padding: 10px;
      color: #e0e0e0;
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 10px;
    }

    .benchmark-finetune-input:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 0 2px rgba(255, 189, 89, 0.2);
    }

    .benchmark-finetune-input::placeholder {
      color: #666;
    }

    .benchmark-finetune-submit {
      background: linear-gradient(135deg, #ffd700, #d4af37);
      border: none;
      border-radius: 4px;
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 8px 16px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      transition: all 0.2s ease;
    }

    .benchmark-finetune-submit:hover {
      background: linear-gradient(135deg, #ffc970, #f0b85a);
      transform: translateY(-1px);
    }

    .benchmark-finetune-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .benchmark-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px;
      color: #888;
    }

    .benchmark-loading svg {
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      fill: #ffd700;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .benchmark-not-evaluated {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px;
      text-align: center;
    }

    .benchmark-not-evaluated svg {
      width: 48px;
      height: 48px;
      fill: #555;
      margin-bottom: 16px;
    }

    .evaluate-btn {
      margin-top: 16px;
      padding: 10px 24px;
      background: linear-gradient(135deg, #ffd700, #d4af37);
      border: none;
      border-radius: 6px;
      color: #000;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .evaluate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 189, 89, 0.4);
    }

    .evaluate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* ==================== PANEL 3: ITEM EDITOR ==================== */
    .item-edit-panel {
      flex: 1;
      min-width: 400px;
      background: linear-gradient(180deg, #111 0%, #0d0d0d 100%);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .edit-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      height: 38px;
      border-bottom: 2px solid #888;
      background: rgba(0, 0, 0, 0.1);
    }

    .edit-panel-tabs {
      display: flex;
      align-items: center;
      gap: 0;
      flex: 1;
    }

    .edit-panel-tab {
      background: none;
      border: none;
      padding: 4px 4px;
      font-size: 9px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: color 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .edit-panel-tab:hover {
      color: #aaa;
    }

    .edit-panel-tab.active {
      color: #c0c0c0;
    }

    .edit-panel-tab-divider {
      color: #444;
      font-size: 9px;
      user-select: none;
      padding: 0 2px;
    }

    /* Tab content visibility */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .edit-panel-close {
      width: 22px;
      height: 22px;
      border: 1px solid #888;
      background: transparent;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .edit-panel-close:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #fff;
      color: #fff;
    }

    .edit-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* Primary Content Editor */
    .primary-content-editor {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
      padding-top: 0;
      position: relative;
    }

    .primary-content-editor label {
      position: absolute;
      top: 6px;
      left: 19px;
      font-size: 10px;
      font-weight: 500;
      color: #666;
      pointer-events: none;
      z-index: 5;
    }

    .primary-content-textarea {
      width: 100%;
      min-height: 120px;
      padding: 28px 14px 10px 14px;
      background: #000;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-family: inherit;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
      transition: all 0.2s ease;
    }

    .primary-content-textarea:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 0 3px rgba(255, 189, 89, 0.25);
    }

    .primary-content-textarea::placeholder {
      color: #888;
    }

    .edit-section {
      margin-bottom: 24px;
    }

    .edit-section-title {
      font-size: 9px;
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #ffd700;
      margin-bottom: 12px;
      padding-bottom: 8px;
      padding-left: 14px;
      border-bottom: 1px solid #222;
    }

    .edit-field {
      margin-bottom: 16px;
      position: relative;
    }

    .edit-field label {
      position: absolute;
      top: 6px;
      left: 14px;
      font-size: 10px;
      font-weight: 500;
      color: #666;
      pointer-events: none;
      z-index: 5;
    }

    .edit-field input,
    .edit-field textarea,
    .edit-field select {
      width: 100%;
      padding: 28px 14px 10px 14px;
      background: #000;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .edit-field input:focus,
    .edit-field textarea:focus,
    .edit-field select:focus {
      outline: none;
      background: #000;
      border: 1px solid #ffd700;
      box-shadow: 0 0 0 3px rgba(255, 189, 89, 0.25);
    }

    .edit-field textarea {
      resize: vertical;
      min-height: 100px;
    }

    .edit-field select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23c0c0c0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }

    .edit-field-row {
      display: flex;
      gap: 12px;
    }

    .edit-field-row .edit-field {
      flex: 1;
    }

    .edit-toggle-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #151515;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .edit-toggle-label {
      font-size: 13px;
      color: #ccc;
    }

    .edit-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #333;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .edit-toggle.active {
      background: #22c55e;
    }

    .edit-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    .edit-toggle.active::after {
      transform: translateX(20px);
    }

    /* Auto-save indicator */
    .autosave-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(34, 197, 94, 0.9);
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .autosave-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .autosave-indicator svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #666;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 500;
      color: #888;
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 13px;
      text-align: center;
      max-width: 300px;
    }

    /* ==================== RESIZE HANDLES ==================== */
    .resize-handle {
      width: 6px;
      background: #222;
      cursor: col-resize;
      transition: background-color 0.2s;
      flex-shrink: 0;
      position: relative;
    }

    .resize-handle:hover,
    .resize-handle.active {
      background: #c0c0c0;
    }

    .resize-handle::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 40px;
      background: #444;
      border-radius: 1px;
    }

    .resize-handle:hover::after,
    .resize-handle.active::after {
      background: #000;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- ADMIN LEFT SIDEBAR -->
    <div class="admin-sidebar">
      <a href="/admin" class="admin-sidebar-icon" data-tooltip="Dashboard" data-nav="dashboard">
        <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
      </a>
      <a href="/search" class="admin-sidebar-icon" data-tooltip="Search" data-nav="search">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      </a>
      <a href="/admin/tasks" class="admin-sidebar-icon" data-tooltip="Tasks" data-nav="tasks">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
      </a>
      <a href="/admin/hospitality" class="admin-sidebar-icon" data-tooltip="Hospitality" data-nav="hospitality">
        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
      </a>
      <a href="/admin/collections" class="admin-sidebar-icon active" data-tooltip="Collections" data-nav="collections">
        <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/></svg>
      </a>

      <div class="admin-sidebar-spacer"></div>

      <!-- Brand Text -->
      <div class="admin-sidebar-brand-section">
        <div class="admin-sidebar-brand-text">Jubilee<span class="verse">Verse</span><span class="dotcom">.com</span></div>
        <div class="admin-sidebar-brand-sub">ADMIN DASHBOARD</div>
      </div>

      <!-- User Avatar -->
      <div class="admin-sidebar-avatar">
        <img src="/images/personas/jubilee.png" alt="Admin" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23666%22%3E%3Cpath d=%22M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z%22/%3E%3C/svg%3E'">
      </div>
    </div>

    <!-- MAIN AREA -->
    <div class="main-area">
      <!-- ADMIN HEADER -->
      <div class="admin-header">
        <div class="admin-header-left">
          <a href="/search" class="admin-header-logo">
            <span class="logo-jubilee">Jubilee</span><span class="logo-intelligence">Intelligence</span>
          </a>
        </div>
        <div class="admin-header-right">
          <span class="admin-header-user-name" id="adminUserName"></span>
          <span class="admin-header-sep">|</span>
          <a href="/admin" class="admin-header-back-link">Admin</a>
          <span class="admin-header-sep">|</span>
          <a href="#" class="admin-sign-out-btn" id="adminAuthBtn">
            <span id="adminAuthBtnText">Sign Out</span>
            <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 4v8" stroke="currentColor" stroke-width="2.5"/>
              <path d="M6.5 7.5a8 8 0 1 0 11 0" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
          </a>
        </div>
      </div>
      <!-- Main Content Wrapper -->
      <div class="main-content-wrapper">
        <!-- Full-width Header Bar -->
        <div class="collections-header-bar">
          <div class="collections-header-left">
            <span class="collections-title" id="mainHeaderTitle">
              <svg class="vip-star-icon" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/></svg>
              AI Reactor Control Rods - Inspire 8.0
            </span>
          </div>
        </div>
      <div class="collections-layout">
        <!-- ==================== PANEL 1: REACTOR TREE ==================== -->
        <div class="collections-tree-panel">
          <div class="tree-content" id="collectionsTreeContent">
            <!-- Section 1: Authority Foundation -->
            <div class="collection-section authority-section" data-section="authority">
              <div class="section-header expanded" data-section-toggle="authority">
                <div class="section-toggle">
                  <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </div>
                <div class="section-icon">
                  <svg viewBox="0 0 24 24" fill="#000"><path d="M12 10.11c1.03 0 1.87.84 1.87 1.89 0 1-.84 1.85-1.87 1.85S10.13 13 10.13 12c0-1.05.84-1.89 1.87-1.89M7.37 20c.63.38 2.01-.2 3.6-1.7-.52-.59-1.03-1.23-1.51-1.9-.82-.08-1.63-.2-2.4-.36-.51 2.14-.32 3.61.31 3.96m.71-5.74l-.29-.51c-.11.29-.22.58-.29.86.27.06.57.11.88.16l-.3-.51m6.54-.76l.81-1.5-.81-1.5c-.3-.53-.62-1-.91-1.47C13.17 9 12.6 9 12 9s-1.17 0-1.71.03c-.29.47-.61.94-.91 1.47L8.57 12l.81 1.5c.3.53.62 1 .91 1.47.54.03 1.11.03 1.71.03s1.17 0 1.71-.03c.29-.47.61-.94.91-1.47M12 6.78c-.19.22-.39.45-.59.72h1.18c-.2-.27-.4-.5-.59-.72m0 10.44c.19-.22.39-.45.59-.72h-1.18c.2.27.4.5.59.72M16.62 4c-.62-.38-2 .2-3.59 1.7.52.59 1.03 1.23 1.51 1.9.82.08 1.63.2 2.4.36.51-2.14.32-3.61-.32-3.96m-.7 5.74l.29.51c.11-.29.22-.58.29-.86-.27-.06-.57-.11-.88-.16l.3.51m1.45-7.05c1.47.84 1.63 3.05 1.01 5.63 2.54.75 4.37 1.99 4.37 3.68s-1.83 2.93-4.37 3.68c.62 2.58.46 4.79-1.01 5.63-1.46.84-3.45-.12-5.37-1.95-1.92 1.83-3.91 2.79-5.38 1.95-1.46-.84-1.62-3.05-1-5.63-2.54-.75-4.37-1.99-4.37-3.68s1.83-2.93 4.37-3.68c-.62-2.58-.46-4.79 1-5.63 1.47-.84 3.46.12 5.38 1.95 1.92-1.83 3.91-2.79 5.37-1.95M17.08 12c.34.75.64 1.5.89 2.26 2.1-.63 3.28-1.53 3.28-2.26s-1.18-1.63-3.28-2.26c-.25.76-.55 1.51-.89 2.26M6.92 12c-.34-.75-.64-1.5-.89-2.26-2.1.63-3.28 1.53-3.28 2.26s1.18 1.63 3.28 2.26c.25-.76.55-1.51.89-2.26m9 2.26l-.3.51c.31-.05.61-.1.88-.16-.07-.28-.18-.57-.29-.86l-.29.51m-9.82 1.57c.77.16 1.58.28 2.4.36.48-.67.99-1.31 1.51-1.9-1.59-1.5-2.97-2.08-3.6-1.7-.63.35-.82 1.82-.31 3.96m1.67-4.24l-.3-.51-.29.51c-.11.29-.22.58-.29.86.27.06.57.11.88.16"/></svg>
                </div>
                <span class="section-title">Authority Foundation</span>
                <span class="section-count" id="authorityCount">0</span>
              </div>
              <div class="section-items expanded" id="authorityItems">
                <!-- Items will be loaded dynamically -->
              </div>
            </div>

            <!-- Section 2: Goal-Driven Intelligence -->
            <div class="collection-section orchestration-section" data-section="orchestration">
              <div class="section-header expanded" data-section-toggle="orchestration">
                <div class="section-toggle">
                  <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </div>
                <div class="section-icon">
                  <svg viewBox="0 0 24 24" fill="#000"><path d="M12 10.11c1.03 0 1.87.84 1.87 1.89 0 1-.84 1.85-1.87 1.85S10.13 13 10.13 12c0-1.05.84-1.89 1.87-1.89M7.37 20c.63.38 2.01-.2 3.6-1.7-.52-.59-1.03-1.23-1.51-1.9-.82-.08-1.63-.2-2.4-.36-.51 2.14-.32 3.61.31 3.96m.71-5.74l-.29-.51c-.11.29-.22.58-.29.86.27.06.57.11.88.16l-.3-.51m6.54-.76l.81-1.5-.81-1.5c-.3-.53-.62-1-.91-1.47C13.17 9 12.6 9 12 9s-1.17 0-1.71.03c-.29.47-.61.94-.91 1.47L8.57 12l.81 1.5c.3.53.62 1 .91 1.47.54.03 1.11.03 1.71.03s1.17 0 1.71-.03c.29-.47.61-.94.91-1.47M12 6.78c-.19.22-.39.45-.59.72h1.18c-.2-.27-.4-.5-.59-.72m0 10.44c.19-.22.39-.45.59-.72h-1.18c.2.27.4.5.59.72M16.62 4c-.62-.38-2 .2-3.59 1.7.52.59 1.03 1.23 1.51 1.9.82.08 1.63.2 2.4.36.51-2.14.32-3.61-.32-3.96m-.7 5.74l.29.51c.11-.29.22-.58.29-.86-.27-.06-.57-.11-.88-.16l.3.51m1.45-7.05c1.47.84 1.63 3.05 1.01 5.63 2.54.75 4.37 1.99 4.37 3.68s-1.83 2.93-4.37 3.68c.62 2.58.46 4.79-1.01 5.63-1.46.84-3.45-.12-5.37-1.95-1.92 1.83-3.91 2.79-5.38 1.95-1.46-.84-1.62-3.05-1-5.63-2.54-.75-4.37-1.99-4.37-3.68s1.83-2.93 4.37-3.68c-.62-2.58-.46-4.79 1-5.63 1.47-.84 3.46.12 5.38 1.95 1.92-1.83 3.91-2.79 5.37-1.95M17.08 12c.34.75.64 1.5.89 2.26 2.1-.63 3.28-1.53 3.28-2.26s-1.18-1.63-3.28-2.26c-.25.76-.55 1.51-.89 2.26M6.92 12c-.34-.75-.64-1.5-.89-2.26-2.1.63-3.28 1.53-3.28 2.26s1.18 1.63 3.28 2.26c.25-.76.55-1.51.89-2.26m9 2.26l-.3.51c.31-.05.61-.1.88-.16-.07-.28-.18-.57-.29-.86l-.29.51m-9.82 1.57c.77.16 1.58.28 2.4.36.48-.67.99-1.31 1.51-1.9-1.59-1.5-2.97-2.08-3.6-1.7-.63.35-.82 1.82-.31 3.96m1.67-4.24l-.3-.51-.29.51c-.11.29-.22.58-.29.86.27.06.57.11.88.16"/></svg>
                </div>
                <span class="section-title">Goal-Driven Intelligence</span>
                <span class="section-count" id="orchestrationCount">0</span>
              </div>
              <div class="section-items expanded" id="orchestrationItems">
                <!-- Items will be loaded dynamically -->
              </div>
            </div>

            <!-- Section 3: Kingdom Impact -->
            <div class="collection-section interaction-section" data-section="interaction">
              <div class="section-header expanded" data-section-toggle="interaction">
                <div class="section-toggle">
                  <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </div>
                <div class="section-icon">
                  <svg viewBox="0 0 24 24" fill="#000"><path d="M12 10.11c1.03 0 1.87.84 1.87 1.89 0 1-.84 1.85-1.87 1.85S10.13 13 10.13 12c0-1.05.84-1.89 1.87-1.89M7.37 20c.63.38 2.01-.2 3.6-1.7-.52-.59-1.03-1.23-1.51-1.9-.82-.08-1.63-.2-2.4-.36-.51 2.14-.32 3.61.31 3.96m.71-5.74l-.29-.51c-.11.29-.22.58-.29.86.27.06.57.11.88.16l-.3-.51m6.54-.76l.81-1.5-.81-1.5c-.3-.53-.62-1-.91-1.47C13.17 9 12.6 9 12 9s-1.17 0-1.71.03c-.29.47-.61.94-.91 1.47L8.57 12l.81 1.5c.3.53.62 1 .91 1.47.54.03 1.11.03 1.71.03s1.17 0 1.71-.03c.29-.47.61-.94.91-1.47M12 6.78c-.19.22-.39.45-.59.72h1.18c-.2-.27-.4-.5-.59-.72m0 10.44c.19-.22.39-.45.59-.72h-1.18c.2.27.4.5.59.72M16.62 4c-.62-.38-2 .2-3.59 1.7.52.59 1.03 1.23 1.51 1.9.82.08 1.63.2 2.4.36.51-2.14.32-3.61-.32-3.96m-.7 5.74l.29.51c.11-.29.22-.58.29-.86-.27-.06-.57-.11-.88-.16l.3.51m1.45-7.05c1.47.84 1.63 3.05 1.01 5.63 2.54.75 4.37 1.99 4.37 3.68s-1.83 2.93-4.37 3.68c.62 2.58.46 4.79-1.01 5.63-1.46.84-3.45-.12-5.37-1.95-1.92 1.83-3.91 2.79-5.38 1.95-1.46-.84-1.62-3.05-1-5.63-2.54-.75-4.37-1.99-4.37-3.68s1.83-2.93 4.37-3.68c-.62-2.58-.46-4.79 1-5.63 1.47-.84 3.46.12 5.38 1.95 1.92-1.83 3.91-2.79 5.37-1.95M17.08 12c.34.75.64 1.5.89 2.26 2.1-.63 3.28-1.53 3.28-2.26s-1.18-1.63-3.28-2.26c-.25.76-.55 1.51-.89 2.26M6.92 12c-.34-.75-.64-1.5-.89-2.26-2.1.63-3.28 1.53-3.28 2.26s1.18 1.63 3.28 2.26c.25-.76.55-1.51.89-2.26m9 2.26l-.3.51c.31-.05.61-.1.88-.16-.07-.28-.18-.57-.29-.86l-.29.51m-9.82 1.57c.77.16 1.58.28 2.4.36.48-.67.99-1.31 1.51-1.9-1.59-1.5-2.97-2.08-3.6-1.7-.63.35-.82 1.82-.31 3.96m1.67-4.24l-.3-.51-.29.51c-.11.29-.22.58-.29.86.27.06.57.11.88.16"/></svg>
                </div>
                <span class="section-title">Kingdom Impact</span>
                <span class="section-count" id="interactionCount">0</span>
              </div>
              <div class="section-items expanded" id="interactionItems">
                <!-- Items will be loaded dynamically -->
              </div>
            </div>
          </div>
          <!-- Search at bottom -->
          <div class="tree-search">
            <input type="text" id="collectionSearch" placeholder="Search...">
            <div class="tree-search-hint">Search by name</div>
          </div>
        </div>

        <!-- Resize Handle 1 -->
        <div class="resize-handle" id="resizeHandle1"></div>

        <!-- ==================== PANEL 2: ITEMS LIST ==================== -->
        <div class="items-list-panel">
          <div class="items-list-subheader">
            <span class="context-display" id="contextDisplay">Select a Collection</span>
          </div>
          <div class="items-list-content" id="itemsListContent">
            <!-- Items list will be populated here -->
            <div class="empty-state" id="itemsEmptyState">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/></svg>
              <div class="empty-state-title">No Collection Selected</div>
              <div class="empty-state-text">Select a collection from the left panel to view its items.</div>
            </div>
          </div>
        </div>

        <!-- Resize Handle 2 -->
        <div class="resize-handle" id="resizeHandle2"></div>

        <!-- ==================== PANEL 3: ITEM EDITOR ==================== -->
        <div class="item-edit-panel" id="editPanel">
          <div class="edit-panel-header">
            <div class="edit-panel-tabs">
              <button class="edit-panel-tab active" data-tab="details">DETAILS</button>
              <span class="edit-panel-tab-divider">|</span>
              <button class="edit-panel-tab" data-tab="benchmark">BENCHMARK</button>
              <span class="edit-panel-tab-divider">|</span>
              <button class="edit-panel-tab" data-tab="config">CONFIG</button>
              <span class="edit-panel-tab-divider">|</span>
              <button class="edit-panel-tab" data-tab="metadata">METADATA</button>
              <span class="edit-panel-tab-divider">|</span>
              <button class="edit-panel-tab" data-tab="preview">PREVIEW</button>
            </div>
            <button class="edit-panel-close" id="editPanelClose">
              <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
          </div>
          <div class="edit-panel-content" id="editPanelContent">
            <div class="empty-state" id="editEmptyState">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
              <div class="empty-state-title">No Item Selected</div>
              <div class="empty-state-text">Select an item from the list to view and edit its configuration.</div>
            </div>
            <!-- Verses Display Panel (for Bible chapters) -->
            <div id="versesPanel" style="display: none; overflow-y: auto; height: 100%;">
              <div class="verses-header" style="padding: 12px 16px; border-bottom: 1px solid #333; background: rgba(0,0,0,0.2);">
                <div id="versesTitle" style="font-size: 14px; font-weight: 600; color: #fff;">Genesis Chapter 1</div>
                <div id="versesSubtitle" style="font-size: 11px; color: #888; margin-top: 4px;">31 verses</div>
              </div>
              <div id="versesListContent" style="padding: 8px 0;">
                <!-- Verses will be rendered here -->
              </div>
            </div>
            <div id="editForm" style="display: none;">

              <!-- TAB: DETAILS -->
              <div class="tab-content active" data-tab-content="details">
                <!-- Basic Information Section Header -->
                <div class="edit-section-title" style="margin-top: 8px;">Item Information</div>

                <!-- Item Name -->
                <div class="edit-field" style="margin-bottom: 12px;">
                  <label>Name</label>
                  <input type="text" id="editItemName" onchange="autoSave()">
                </div>

                <!-- Item Title -->
                <div class="edit-field">
                  <label>Title</label>
                  <input type="text" id="editItemTitle" onchange="autoSave()">
                </div>

                <!-- Item Description -->
                <div class="primary-content-editor">
                  <label>Description</label>
                  <textarea
                    id="editItemDescription"
                    class="primary-content-textarea"
                    placeholder="Enter the description for this item..."
                    oninput="autoSave()"
                  ></textarea>
                </div>

                <!-- Status -->
                <div class="edit-section">
                  <div class="edit-section-title">Status</div>
                  <div class="edit-toggle-field">
                    <span class="edit-toggle-label">Item Active</span>
                    <div class="edit-toggle" id="editActiveToggle"></div>
                  </div>
                </div>
              </div><!-- END TAB: DETAILS -->

              <!-- TAB: BENCHMARK -->
              <div class="tab-content" data-tab-content="benchmark">
                <div id="benchmarkTabContent">
                  <div class="benchmark-empty-state">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="#555"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm3-6c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3 3 1.34 3 3z"/></svg>
                    <div style="font-size: 13px; color: #888; margin-top: 12px;">Select a Bible verse to view benchmark evaluation</div>
                  </div>
                </div>
              </div><!-- END TAB: BENCHMARK -->

              <!-- TAB: CONFIG -->
              <div class="tab-content" data-tab-content="config">
                <div class="edit-section">
                  <div class="edit-section-title">Configuration</div>
                  <div class="edit-field">
                    <label>Configuration (JSON)</label>
                    <textarea id="editItemConfig" rows="8" placeholder='{"key": "value"}' onchange="autoSave()"></textarea>
                  </div>
                </div>
              </div><!-- END TAB: CONFIG -->

              <!-- TAB: METADATA -->
              <div class="tab-content" data-tab-content="metadata">
                <div class="edit-section">
                  <div class="edit-section-title">Metadata</div>
                  <div class="edit-field">
                    <label>Metadata (JSON)</label>
                    <textarea id="editItemMetadata" rows="8" placeholder='{"created_by": "admin"}' onchange="autoSave()"></textarea>
                  </div>
                </div>
              </div><!-- END TAB: METADATA -->

              <!-- TAB: PREVIEW -->
              <div class="tab-content" data-tab-content="preview">
                <div class="edit-section">
                  <div class="edit-section-title">Item Preview</div>
                  <div id="itemPreviewContent" style="padding: 16px; background: #000; border-radius: 8px; border: 1px solid #333;">
                    <p style="color: #888; font-size: 13px;">Preview of this item will appear here.</p>
                  </div>
                </div>
              </div><!-- END TAB: PREVIEW -->
            </div>
          </div>
        </div>

        <!-- Right Control Panel - Navigation -->
        <div class="collections-control-panel">
          <!-- Dashboard View -->
          <a href="/admin" class="control-btn" title="Dashboard">
            <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span class="control-btn-label">Dashboard</span>
          </a>
          <!-- Hospitality -->
          <a href="/admin/hospitality" class="control-btn" title="Hospitality">
            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
            <span class="control-btn-label">Hospitality</span>
          </a>
          <!-- Collections (Active) -->
          <a href="/admin/collections" class="control-btn active" title="Collections">
            <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/></svg>
            <span class="control-btn-label">Collections</span>
          </a>
          <!-- Tasks -->
          <a href="/admin/tasks" class="control-btn" title="Tasks">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <span class="control-btn-label">Tasks</span>
          </a>

          <!-- Spacer -->
          <div style="flex: 1;"></div>

          <!-- Refresh Button -->
          <button class="control-btn" id="refreshBtn" title="Refresh Data">
            <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            <span class="control-btn-label">Refresh</span>
          </button>
        </div>

      </div>
      </div>
    </div>
  </div>

  <!-- Auto-save indicator -->
  <div class="autosave-indicator" id="autosaveIndicator">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
    Changes saved
  </div>

  <script>
    // ==================== STATE ====================
    let collections = {
      authority: [],
      orchestration: [],
      interaction: []
    };
    let items = [];
    let selectedCollectionId = null;
    let selectedSection = null;
    let selectedItemId = null;
    let saveTimeout = null;
    let expandedCollections = new Set();

    // ==================== COOKIE PERSISTENCE ====================
    const STORAGE_KEY = 'adminCollectionsState';
    const COOKIE_EXPIRY_DAYS = 30;

    // Cookie helper functions
    function setCookie(name, value, days) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
    }

    function getCookie(name) {
      const nameEQ = name + '=';
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) {
          return decodeURIComponent(c.substring(nameEQ.length));
        }
      }
      return null;
    }

    // Track current Bible chapter view
    let currentBibleView = null; // { bookId, chapterNum }
    // Track selected verse for persistence
    let savedVerseState = null; // { verseId, verseText, bookName, chapter, verseNumber }

    function saveStateToStorage() {
      const state = {
        selectedCollectionId,
        selectedSection,
        selectedItemId,
        expandedCollections: Array.from(expandedCollections),
        bibleView: currentBibleView,
        selectedVerse: savedVerseState
      };
      setCookie(STORAGE_KEY, JSON.stringify(state), COOKIE_EXPIRY_DAYS);
    }

    function loadStateFromStorage() {
      try {
        const stored = getCookie(STORAGE_KEY);
        if (stored) {
          const state = JSON.parse(stored);
          selectedCollectionId = state.selectedCollectionId || null;
          selectedSection = state.selectedSection || null;
          selectedItemId = state.selectedItemId || null;
          expandedCollections = new Set(state.expandedCollections || []);
          currentBibleView = state.bibleView || null;
          savedVerseState = state.selectedVerse || null;
          return true;
        }
      } catch (e) {
        console.error('Failed to load state from storage:', e);
      }
      return false;
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      // Initialize admin header auth button
      initAdminHeader();

      // Initialize refresh button
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadCollections);
      }

      // Initialize edit panel close button
      const closeBtn = document.getElementById('editPanelClose');
      if (closeBtn) {
        closeBtn.addEventListener('click', clearItemSelection);
      }

      // Initialize tab switching
      initTabs();

      // Initialize section header click handlers (CSP-compliant)
      initSectionHeaders();

      // Initialize active toggle
      initActiveToggle();

      // Initialize resize handles
      initResizeHandles();

      // Initialize search
      initSearch();

      // Check admin access
      try {
        const response = await fetch('/auth/me', { credentials: 'include' });
        const data = await response.json();

        if (data.user && data.user.role === 'admin') {
          // Display user name in header
          const userNameEl = document.getElementById('adminUserName');
          if (userNameEl && data.user) {
            userNameEl.textContent = data.user.displayName || data.user.email || 'Admin';
          }
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Continue anyway for development
      }

      // Load saved state from cookies
      loadStateFromStorage();

      // Load collections (always load, even if auth fails for dev)
      await loadCollections();

      // Restore Bible chapter view if saved
      if (currentBibleView && currentBibleView.bookId && currentBibleView.chapterNum) {
        console.log('Restoring Bible view:', currentBibleView);
        // Small delay to ensure tree is rendered
        setTimeout(() => {
          loadBibleVerses(currentBibleView.bookId, currentBibleView.chapterNum);
        }, 500);
      }
    }

    // Initialize admin header auth button
    function initAdminHeader() {
      const authBtn = document.getElementById('adminAuthBtn');
      if (authBtn) {
        authBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.href = '/';
          } catch (error) {
            console.error('Logout failed:', error);
          }
        });
      }
    }

    // ==================== SECTION TOGGLE ====================
    function toggleSection(sectionId) {
      const section = document.querySelector('.collection-section[data-section="' + sectionId + '"]');
      const header = section.querySelector('.section-header');
      const itemsContainer = section.querySelector('.section-items');

      header.classList.toggle('expanded');
      itemsContainer.classList.toggle('expanded');
    }

    // Initialize section header click handlers (CSP-compliant)
    function initSectionHeaders() {
      document.querySelectorAll('[data-section-toggle]').forEach(function(header) {
        header.addEventListener('click', function() {
          const sectionId = this.dataset.sectionToggle;
          toggleSection(sectionId);
        });
      });
    }

    // ==================== TABS ====================
    function initTabs() {
      const tabs = document.querySelectorAll('.edit-panel-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;

          // Update active tab
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Update active content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.dataset.tabContent === tabName);
          });
        });
      });
    }

    // ==================== ACTIVE TOGGLE ====================
    function initActiveToggle() {
      const toggle = document.getElementById('editActiveToggle');
      if (toggle) {
        toggle.addEventListener('click', () => {
          toggle.classList.toggle('active');
          autoSave();
        });
      }
    }

    // ==================== RESIZE HANDLES ====================
    function initResizeHandles() {
      const handle1 = document.getElementById('resizeHandle1');
      const handle2 = document.getElementById('resizeHandle2');
      const panel1 = document.querySelector('.collections-tree-panel');
      const panel2 = document.querySelector('.items-list-panel');

      let isResizing = false;
      let currentHandle = null;

      function startResize(e, handle) {
        isResizing = true;
        currentHandle = handle;
        document.body.style.cursor = 'col-resize';
        handle.classList.add('active');
      }

      function stopResize() {
        isResizing = false;
        currentHandle = null;
        document.body.style.cursor = '';
        handle1.classList.remove('active');
        handle2.classList.remove('active');
      }

      function resize(e) {
        if (!isResizing) return;

        if (currentHandle === handle1) {
          const newWidth = e.clientX - panel1.getBoundingClientRect().left;
          if (newWidth >= 200 && newWidth <= 400) {
            panel1.style.width = newWidth + 'px';
            panel1.style.minWidth = newWidth + 'px';
          }
        } else if (currentHandle === handle2) {
          const newWidth = e.clientX - panel2.getBoundingClientRect().left;
          if (newWidth >= 250 && newWidth <= 600) {
            panel2.style.maxWidth = newWidth + 'px';
          }
        }
      }

      handle1.addEventListener('mousedown', (e) => startResize(e, handle1));
      handle2.addEventListener('mousedown', (e) => startResize(e, handle2));
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    }

    // ==================== SEARCH ====================
    function initSearch() {
      const searchInput = document.getElementById('collectionSearch');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          filterCollections(query);
        });
      }
    }

    function filterCollections(query) {
      const items = document.querySelectorAll('.collection-item');
      items.forEach(item => {
        const name = item.querySelector('.collection-name').textContent.toLowerCase();
        const matches = name.includes(query);
        item.style.display = matches ? 'block' : 'none';
      });
    }

    // ==================== LOAD COLLECTIONS ====================
    async function loadCollections() {
      console.log('loadCollections called');
      // Load demo data for now
      loadDemoCollections();
      console.log('Collections loaded:', collections);
    }

    // SVG icons for collection items
    const icons = {
      scripture: '<svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>',
      doctrine: '<svg viewBox="0 0 24 24"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>',
      governance: '<svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>',
      family: '<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>',
      father: '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
      persona: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>',
      kingdom: '<svg viewBox="0 0 24 24"><path d="M19 9l-7-7-7 7h4v11h2V9h4v11h2V9h2z"/></svg>',
      creative: '<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>',
      gospel: '<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>',
      shepherd: '<svg viewBox="0 0 24 24"><path d="M18.5 10.2c0 2.57-2.1 5.79-6.16 9.51l-.34.3-.34-.31C7.6 15.99 5.5 12.77 5.5 10.2c0-3.84 2.82-6.7 6.5-6.7s6.5 2.85 6.5 6.7zM12 2C7.31 2 3.5 5.58 3.5 10.2c0 3.59 2.72 7.34 7.78 11.83L12 22l.72-.64c5.06-4.48 7.78-8.24 7.78-11.83C20.5 5.58 16.69 2 12 2zm0 8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>',
      hebraic: '<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>',
      prompts: '<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z"/></svg>',
      contexts: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>',
      responses: '<svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>',
      resources: '<svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>',
      ministers: '<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>',
      languages: '<svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>',
      users: '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
      analytics: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>',
      reactor: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="2.5"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="currentColor" stroke-width="1.5"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="currentColor" stroke-width="1.5" transform="rotate(60 12 12)"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="currentColor" stroke-width="1.5" transform="rotate(120 12 12)"/></svg>'
    };

    function loadDemoCollections() {
      // Authority Foundation section - with icons and slugs for API calls
      collections.authority = [
        { id: 'a1', name: 'Scripture', slug: 'scripture', icon: icons.reactor },
        { id: 'a2', name: 'Doctrine', slug: 'doctrine', icon: icons.reactor },
        { id: 'a3', name: 'Governance', slug: 'governance', icon: icons.reactor },
        { id: 'a4', name: 'Inspire Family', slug: 'inspire-family', icon: icons.reactor },
        { id: 'a5', name: 'Gabriel (Pastoral Voice)', slug: 'gabriel-pastoral-voice', icon: icons.reactor },
        { id: 'a6', name: 'Jubilee Inspire', slug: 'jubilee-inspire', icon: icons.reactor },
        { id: 'a7', name: 'Melody Inspire', slug: 'melody-inspire', icon: icons.reactor },
        { id: 'a8', name: 'Zariah Inspire', slug: 'zariah-inspire', icon: icons.reactor },
        { id: 'a9', name: 'Elias Inspire', slug: 'elias-inspire', icon: icons.reactor },
        { id: 'a10', name: 'Eliana Inspire', slug: 'eliana-inspire', icon: icons.reactor },
        { id: 'a11', name: 'Caleb Inspire', slug: 'caleb-inspire', icon: icons.reactor },
        { id: 'a12', name: 'Imani Inspire', slug: 'imani-inspire', icon: icons.reactor },
        { id: 'a13', name: 'Zev Inspire', slug: 'zev-inspire', icon: icons.reactor },
        { id: 'a14', name: 'Amir Inspire', slug: 'amir-inspire', icon: icons.reactor },
        { id: 'a15', name: 'Nova Inspire', slug: 'nova-inspire', icon: icons.reactor },
        { id: 'a16', name: 'Santiago Inspire', slug: 'santiago-inspire', icon: icons.reactor },
        { id: 'a17', name: 'Tahoma Inspire', slug: 'tahoma-inspire', icon: icons.reactor },
        { id: 'a18', name: 'Persona Index', slug: 'persona-index', icon: icons.reactor }
      ];

      // Goal-Driven Intelligence section - with icons and slugs
      collections.orchestration = [
        { id: 'o0', name: 'Model Registry', slug: 'model-registry', icon: icons.reactor },
        { id: 'o6', name: 'Execution Contracts', slug: 'execution-contracts', icon: icons.reactor },
        { id: 'o0a', name: 'Endgame', slug: 'endgame', icon: icons.reactor },
        { id: 'o0b', name: 'Experiments', slug: 'experiments', icon: icons.reactor },
        { id: 'o0c', name: 'Learning Memory', slug: 'learning-memory', icon: icons.reactor },
        { id: 'o0d', name: 'Evaluation', slug: 'evaluation', icon: icons.reactor },
        { id: 'o0e', name: 'Execution Logs', slug: 'execution-logs', icon: icons.reactor },
        { id: 'o0f', name: 'Scenarios', slug: 'scenarios', icon: icons.reactor },
        { id: 'o1', name: 'Kingdom Builder', slug: 'kingdom-builder', icon: icons.reactor },
        { id: 'o2', name: 'Creative Fire', slug: 'creative-fire', icon: icons.reactor },
        { id: 'o3', name: 'Gospel Pulse', slug: 'gospel-pulse', icon: icons.reactor },
        { id: 'o4', name: "Shepherd's Voice", slug: 'shepherds-voice', icon: icons.reactor },
        { id: 'o5', name: 'Hebraic Roots', slug: 'hebraic-roots', icon: icons.reactor }
      ];

      // Kingdom Impact section - with icons and slugs
      collections.interaction = [
        { id: 'i6', name: 'Prompts', slug: 'prompts', icon: icons.reactor },
        { id: 'i1', name: 'Resources', slug: 'resources', icon: icons.reactor },
        { id: 'i3', name: 'Languages', slug: 'languages', icon: icons.reactor },
        { id: 'i8', name: 'Countries', slug: 'countries', icon: icons.reactor },
        { id: 'i2', name: 'Jubilee Ministry', slug: 'jubilee-ministry', icon: icons.reactor },
        { id: 'i9', name: 'Ministers', slug: 'ministers', icon: icons.reactor },
        { id: 'i4', name: 'Users', slug: 'users', icon: icons.reactor },
        { id: 'i10', name: 'Insights', slug: 'insights', icon: icons.reactor },
        { id: 'i5', name: 'Analytics', slug: 'analytics', icon: icons.reactor },
        { id: 'i7', name: 'Marketing', slug: 'marketing', icon: icons.reactor }
      ];

      renderCollections();
    }

    // Helper function to get collection by ID
    function getCollectionById(collectionId) {
      const allCollections = [...collections.authority, ...collections.orchestration, ...collections.interaction];
      return allCollections.find(c => c.id === collectionId);
    }

    function renderCollections() {
      console.log('renderCollections called');
      // Update counts
      document.getElementById('authorityCount').textContent = collections.authority.length;
      document.getElementById('orchestrationCount').textContent = collections.orchestration.length;
      document.getElementById('interactionCount').textContent = collections.interaction.length;

      // Render each section
      renderSectionItems('authority', collections.authority);
      renderSectionItems('orchestration', collections.orchestration);
      renderSectionItems('interaction', collections.interaction);
      console.log('renderCollections done');

      // Restore selection from saved state
      restoreSavedSelection();
    }

    function restoreSavedSelection() {
      // If there's a saved selection, restore it
      if (selectedCollectionId && selectedSection) {
        console.log('Restoring saved selection:', selectedCollectionId, selectedSection, selectedItemId);

        // Activate the collection row
        const collectionRow = document.querySelector(`.collection-item[data-id="${selectedCollectionId}"] .collection-item-row`);
        if (collectionRow) {
          collectionRow.classList.add('active');
        }

        // If there's a subcategory selected, activate it and load its content
        if (selectedItemId) {
          const subItem = document.querySelector(`.subcategory-item[data-subcategory-id="${selectedItemId}"]`);
          if (subItem) {
            subItem.classList.add('active');
          }
          // Load the subcategory item
          loadSubcategoryItem(selectedItemId, selectedCollectionId);

          // Update context display
          const collection = collections[selectedSection].find(c => c.id === selectedCollectionId);
          if (collection) {
            document.getElementById('contextDisplay').textContent = collection.name;
          }
        } else {
          // Just load the collection items
          loadItems(selectedCollectionId);

          // Update context display
          const collection = collections[selectedSection].find(c => c.id === selectedCollectionId);
          if (collection) {
            document.getElementById('contextDisplay').textContent = collection.name;
          }
        }
      }
    }

    function renderSectionItems(sectionId, sectionItems) {
      console.log('renderSectionItems:', sectionId, sectionItems.length, 'items');
      const container = document.getElementById(sectionId + 'Items');
      if (!container) {
        console.error('Container not found:', sectionId + 'Items');
        return;
      }

      if (sectionItems.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No items</div></div>';
        return;
      }

      let html = '';
      sectionItems.forEach(item => {
        const isActive = selectedCollectionId === item.id;
        const isExpanded = expandedCollections.has(item.id);
        // Check if item is expandable (default true unless explicitly set to false)
        const isExpandable = item.expandable !== false;
        html += `
          <div class="collection-item ${isExpanded ? 'expanded' : ''}" data-id="${item.id}" data-section="${sectionId}" data-expandable="${isExpandable}">
            <div class="collection-item-row ${isActive ? 'active' : ''}">
              ${isExpandable
                ? `<span class="collection-expand-toggle" data-collection-id="${item.id}">${isExpanded ? '' : '+'}</span>`
                : `<span class="collection-expand-placeholder"></span>`
              }
              <span class="collection-icon">${item.icon || ''}</span>
              <span class="collection-name">${item.name}</span>
            </div>
            ${isExpandable ? `
            <div class="collection-subcategories" id="subcategories-${item.id}">
              <!-- Categories loaded dynamically on expand -->
            </div>
            ` : ''}
          </div>
        `;
      });
      container.innerHTML = html;

      // Attach click handlers for expand toggle
      container.querySelectorAll('.collection-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', async function(event) {
          event.stopPropagation();
          const itemEl = this.closest('.collection-item');
          const collectionId = itemEl.dataset.id;
          const isExpanded = itemEl.classList.toggle('expanded');
          this.textContent = isExpanded ? '' : '+';

          // Save expanded state
          if (isExpanded) {
            expandedCollections.add(collectionId);

            // Load categories from database for ANY collection with a slug
            const collection = getCollectionById(collectionId);
            if (collection && collection.slug) {
              const subcategoriesContainer = document.getElementById('subcategories-' + collectionId);
              if (subcategoriesContainer && !subcategoriesContainer.dataset.loaded) {
                subcategoriesContainer.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #888;">Loading categories...</div>';
                await loadCollectionCategoriesIntoPanel(subcategoriesContainer, collection.slug, collectionId);
                subcategoriesContainer.dataset.loaded = 'true';
              }
            }
          } else {
            expandedCollections.delete(collectionId);
          }
          saveStateToStorage();
        });
      });

      // Attach click handlers for collection row (selects and loads items in middle panel)
      container.querySelectorAll('.collection-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          // Don't trigger if clicking the toggle
          if (event.target.classList.contains('collection-expand-toggle')) return;
          event.stopPropagation();
          const itemEl = this.closest('.collection-item');
          const collectionId = itemEl.dataset.id;
          const section = itemEl.dataset.section;
          console.log('Collection clicked:', collectionId, section);
          selectCollection(collectionId, section);
        });

        // Double-click to expand/collapse the collection tree
        row.addEventListener('dblclick', async function(event) {
          event.stopPropagation();
          const itemEl = this.closest('.collection-item');
          const isExpandable = itemEl.dataset.expandable !== 'false';
          if (!isExpandable) return;

          const collectionId = itemEl.dataset.id;
          const toggle = itemEl.querySelector('.collection-expand-toggle');
          const isExpanded = itemEl.classList.toggle('expanded');
          if (toggle) toggle.textContent = isExpanded ? '' : '+';

          // Save expanded state
          if (isExpanded) {
            expandedCollections.add(collectionId);

            // Load categories from database for ANY collection with a slug
            const collection = getCollectionById(collectionId);
            if (collection && collection.slug) {
              const subcategoriesContainer = document.getElementById('subcategories-' + collectionId);
              if (subcategoriesContainer && !subcategoriesContainer.dataset.loaded) {
                subcategoriesContainer.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #888;">Loading categories...</div>';
                await loadCollectionCategoriesIntoPanel(subcategoriesContainer, collection.slug, collectionId);
                subcategoriesContainer.dataset.loaded = 'true';
              }
            }
          } else {
            expandedCollections.delete(collectionId);
          }
          saveStateToStorage();
        });
      });

      // Note: Subcategory/stage/domain handlers are now attached dynamically
      // by loadCollectionCategoriesIntoPanel when categories are loaded

      // Auto-load categories for any collection that was expanded from localStorage
      sectionItems.forEach(item => {
        if (expandedCollections.has(item.id) && item.slug) {
          const subcategoriesContainer = document.getElementById('subcategories-' + item.id);
          if (subcategoriesContainer && !subcategoriesContainer.dataset.loaded) {
            subcategoriesContainer.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #888;">Loading categories...</div>';
            loadCollectionCategoriesIntoPanel(subcategoriesContainer, item.slug, item.id).then(() => {
              subcategoriesContainer.dataset.loaded = 'true';
            });
          }
        }
      });
    }

    // Select a domain item
    function selectDomainItem(stageId, domainId, parentCollectionId, sectionId) {
      selectedCollectionId = parentCollectionId;
      selectedSection = sectionId;
      selectedItemId = stageId + '_' + domainId;

      saveStateToStorage();

      // Update UI - remove active from all
      document.querySelectorAll('.collection-item-row, .stage-item-row, .domain-item-row, .child-item, .nested-child-item').forEach(el => {
        el.classList.remove('active');
      });

      const domainRow = document.querySelector(`.domain-item[data-domain-id="${domainId}"][data-stage-id="${stageId}"] .domain-item-row`);
      if (domainRow) domainRow.classList.add('active');

      // Get the domain data to check if it has children
      const domains = getDomainsForStage(stageId);
      const domain = domains.find(d => d.id === domainId);

      // Update context display to show the domain name (e.g., "Genesis")
      if (domain) {
        document.getElementById('contextDisplay').textContent = domain.name;
      }

      // If domain has children (chapters), load them into the middle panel
      if (domain && domain.children && domain.children.length > 0) {
        loadChildrenIntoItemsPanel(domain, stageId, parentCollectionId);
      } else {
        // Load domain content into editor
        loadDomainContent(stageId, domainId);
      }
    }

    // Select a child item
    function selectChildItem(stageId, domainId, childId, sectionId) {
      selectedItemId = stageId + '_' + domainId + '_' + childId;

      saveStateToStorage();

      // Update UI
      document.querySelectorAll('.collection-item-row, .stage-item-row, .domain-item-row, .child-item, .nested-child-item').forEach(el => {
        el.classList.remove('active');
      });

      const childItem = document.querySelector(`.child-item[data-child-id="${childId}"][data-domain-id="${domainId}"][data-stage-id="${stageId}"]`);
      if (childItem) childItem.classList.add('active');

      // Check if this is a Bible chapter (stageId is 'Jubilee_Bible_JSV' and childId starts with 'Chapter_')
      if (stageId === 'Jubilee_Bible_JSV' && childId && childId.startsWith('Chapter_')) {
        const chapterMatch = childId.match(/Chapter_(\d+)/);
        if (chapterMatch) {
          const chapterNum = parseInt(chapterMatch[1], 10);
          console.log('Bible chapter selected from tree (child-item):', domainId, 'chapter', chapterNum);
          loadBibleVerses(domainId, chapterNum);
          return;
        }
      }

      // Load child content into editor (default behavior)
      loadChildContent(stageId, domainId, childId);
    }

    // Select a nested child item
    function selectNestedChildItem(stageId, domainId, parentChildId, nestedId, sectionId) {
      selectedItemId = stageId + '_' + domainId + '_' + parentChildId + '_' + nestedId;

      saveStateToStorage();

      // Update UI
      document.querySelectorAll('.collection-item-row, .stage-item-row, .domain-item-row, .child-item, .nested-child-item').forEach(el => {
        el.classList.remove('active');
      });

      const nestedItem = document.querySelector(`.nested-child-item[data-nested-id="${nestedId}"][data-parent-child-id="${parentChildId}"]`);
      if (nestedItem) nestedItem.classList.add('active');

      // Check if this is a Bible chapter (nestedId like "Chapter_01" under a book like "Genesis")
      if (stageId === 'Jubilee_Bible_JSV' && nestedId && nestedId.startsWith('Chapter_')) {
        const chapterMatch = nestedId.match(/Chapter_(\d+)/);
        if (chapterMatch) {
          const chapterNum = parseInt(chapterMatch[1], 10);
          console.log('Bible chapter selected from tree:', parentChildId, 'chapter', chapterNum);
          loadBibleVerses(parentChildId, chapterNum);
          return;
        }
      }

      // Load nested child content into editor (default behavior)
      loadNestedChildContent(stageId, domainId, parentChildId, nestedId);
    }

    // Load domain content into the editor
    function loadDomainContent(stageId, domainId) {
      const domain = stageDomains.find(d => d.id === domainId);
      const stageNum = stageId.replace('stage', '');

      items = [{
        id: stageId + '_' + domainId,
        name: 'Stage ' + stageNum.padStart(2, '0') + ' - ' + (domain ? domain.name : domainId),
        title: 'Domain configuration',
        description: 'Configure ' + (domain ? domain.name : domainId) + ' for Stage ' + stageNum,
        is_active: true
      }];
      renderItems();
      selectItem(items[0].id);
    }

    // Load child content into the editor
    function loadChildContent(stageId, domainId, childId) {
      const stageNum = stageId.replace('stage', '');
      const displayName = childId.replace(/_/g, ' ');

      items = [{
        id: stageId + '_' + domainId + '_' + childId,
        name: displayName,
        title: 'Stage ' + stageNum.padStart(2, '0') + ' configuration',
        description: 'Configure ' + displayName,
        is_active: true
      }];
      renderItems();
      selectItem(items[0].id);
    }

    // Load nested child content into the editor
    function loadNestedChildContent(stageId, domainId, parentChildId, nestedId) {
      const stageNum = stageId.replace('stage', '');
      const displayName = nestedId.replace(/_/g, ' ');
      const parentName = parentChildId.replace(/_/g, ' ');

      items = [{
        id: stageId + '_' + domainId + '_' + parentChildId + '_' + nestedId,
        name: displayName,
        title: parentName + ' - Stage ' + stageNum.padStart(2, '0'),
        description: 'Configure ' + displayName + ' under ' + parentName,
        is_active: true
      }];
      renderItems();
      selectItem(items[0].id);
    }

    // Scripture Collection Domains - organized by category
    // Helper function to generate chapter arrays
    function generateChapters(count) {
      const chapters = [];
      for (let i = 1; i <= count; i++) {
        chapters.push('Chapter_' + String(i).padStart(2, '0'));
      }
      return chapters;
    }

    const scriptureDomains = {
      // Jubilee Bible (JSV) - 66 Books of the Bible with all chapters
      'Jubilee_Bible_JSV': [
        // Old Testament - Pentateuch
        { id: 'Genesis', name: 'Genesis', children: generateChapters(50) },
        { id: 'Exodus', name: 'Exodus', children: generateChapters(40) },
        { id: 'Leviticus', name: 'Leviticus', children: generateChapters(27) },
        { id: 'Numbers', name: 'Numbers', children: generateChapters(36) },
        { id: 'Deuteronomy', name: 'Deuteronomy', children: generateChapters(34) },
        // Historical Books
        { id: 'Joshua', name: 'Joshua', children: generateChapters(24) },
        { id: 'Judges', name: 'Judges', children: generateChapters(21) },
        { id: 'Ruth', name: 'Ruth', children: generateChapters(4) },
        { id: '1_Samuel', name: '1 Samuel', children: generateChapters(31) },
        { id: '2_Samuel', name: '2 Samuel', children: generateChapters(24) },
        { id: '1_Kings', name: '1 Kings', children: generateChapters(22) },
        { id: '2_Kings', name: '2 Kings', children: generateChapters(25) },
        { id: '1_Chronicles', name: '1 Chronicles', children: generateChapters(29) },
        { id: '2_Chronicles', name: '2 Chronicles', children: generateChapters(36) },
        { id: 'Ezra', name: 'Ezra', children: generateChapters(10) },
        { id: 'Nehemiah', name: 'Nehemiah', children: generateChapters(13) },
        { id: 'Esther', name: 'Esther', children: generateChapters(10) },
        // Wisdom/Poetry
        { id: 'Job', name: 'Job', children: generateChapters(42) },
        { id: 'Psalms', name: 'Psalms', children: generateChapters(150) },
        { id: 'Proverbs', name: 'Proverbs', children: generateChapters(31) },
        { id: 'Ecclesiastes', name: 'Ecclesiastes', children: generateChapters(12) },
        { id: 'Song_of_Solomon', name: 'Song of Solomon', children: generateChapters(8) },
        // Major Prophets
        { id: 'Isaiah', name: 'Isaiah', children: generateChapters(66) },
        { id: 'Jeremiah', name: 'Jeremiah', children: generateChapters(52) },
        { id: 'Lamentations', name: 'Lamentations', children: generateChapters(5) },
        { id: 'Ezekiel', name: 'Ezekiel', children: generateChapters(48) },
        { id: 'Daniel', name: 'Daniel', children: generateChapters(12) },
        // Minor Prophets
        { id: 'Hosea', name: 'Hosea', children: generateChapters(14) },
        { id: 'Joel', name: 'Joel', children: generateChapters(3) },
        { id: 'Amos', name: 'Amos', children: generateChapters(9) },
        { id: 'Obadiah', name: 'Obadiah', children: generateChapters(1) },
        { id: 'Jonah', name: 'Jonah', children: generateChapters(4) },
        { id: 'Micah', name: 'Micah', children: generateChapters(7) },
        { id: 'Nahum', name: 'Nahum', children: generateChapters(3) },
        { id: 'Habakkuk', name: 'Habakkuk', children: generateChapters(3) },
        { id: 'Zephaniah', name: 'Zephaniah', children: generateChapters(3) },
        { id: 'Haggai', name: 'Haggai', children: generateChapters(2) },
        { id: 'Zechariah', name: 'Zechariah', children: generateChapters(14) },
        { id: 'Malachi', name: 'Malachi', children: generateChapters(4) },
        // New Testament - Gospels
        { id: 'Matthew', name: 'Matthew', children: generateChapters(28) },
        { id: 'Mark', name: 'Mark', children: generateChapters(16) },
        { id: 'Luke', name: 'Luke', children: generateChapters(24) },
        { id: 'John', name: 'John', children: generateChapters(21) },
        // History
        { id: 'Acts', name: 'Acts', children: generateChapters(28) },
        // Pauline Epistles
        { id: 'Romans', name: 'Romans', children: generateChapters(16) },
        { id: '1_Corinthians', name: '1 Corinthians', children: generateChapters(16) },
        { id: '2_Corinthians', name: '2 Corinthians', children: generateChapters(13) },
        { id: 'Galatians', name: 'Galatians', children: generateChapters(6) },
        { id: 'Ephesians', name: 'Ephesians', children: generateChapters(6) },
        { id: 'Philippians', name: 'Philippians', children: generateChapters(4) },
        { id: 'Colossians', name: 'Colossians', children: generateChapters(4) },
        { id: '1_Thessalonians', name: '1 Thessalonians', children: generateChapters(5) },
        { id: '2_Thessalonians', name: '2 Thessalonians', children: generateChapters(3) },
        { id: '1_Timothy', name: '1 Timothy', children: generateChapters(6) },
        { id: '2_Timothy', name: '2 Timothy', children: generateChapters(4) },
        { id: 'Titus', name: 'Titus', children: generateChapters(3) },
        { id: 'Philemon', name: 'Philemon', children: generateChapters(1) },
        // General Epistles
        { id: 'Hebrews', name: 'Hebrews', children: generateChapters(13) },
        { id: 'James', name: 'James', children: generateChapters(5) },
        { id: '1_Peter', name: '1 Peter', children: generateChapters(5) },
        { id: '2_Peter', name: '2 Peter', children: generateChapters(3) },
        { id: '1_John', name: '1 John', children: generateChapters(5) },
        { id: '2_John', name: '2 John', children: generateChapters(1) },
        { id: '3_John', name: '3 John', children: generateChapters(1) },
        { id: 'Jude', name: 'Jude', children: generateChapters(1) },
        // Apocalyptic
        { id: 'Revelation', name: 'Revelation', children: generateChapters(22) }
      ],

      // Translation Rules
      'Translation_Rules': [
        {
          id: 'Core_Translation_Rules',
          name: 'Core Translation Rules',
          children: ['Literal_Preservation', 'Meaning_Preservation', 'Clarity_Enhancement']
        },
        {
          id: 'Language_Transfer_Rules',
          name: 'Language Transfer Rules',
          children: ['Source_to_Target_Mapping', 'Tense_and_Aspect_Handling', 'Voice_and_Mood_Handling']
        },
        {
          id: 'Idiom_and_Figure_Resolution',
          name: 'Idiom and Figure Resolution',
          children: ['Hebrew_Idioms', 'Greek_Idioms']
        },
        {
          id: 'Proper_Names_and_Titles',
          name: 'Proper Names and Titles',
          children: ['Names_Consistency', 'Divine_Titles']
        },
        {
          id: 'Hermeneutical_Framework',
          name: 'Hermeneutical Framework',
          children: ['Contextual_Consistency', 'Scripture_Interprets_Scripture', 'Historical_Cultural_Context', 'Doctrinal_Continuity', 'Narrative_Flow']
        },
        {
          id: 'Consistency_and_Style_Guides',
          name: 'Consistency and Style Guides',
          children: ['Vocabulary_Consistency', 'Capitalization_Standards', 'Poetic_Formatting', 'Prose_Formatting', 'Quotation_and_Speech']
        }
      ],

      // Language Translations - Top 100 languages by total speakers (native + L2)
      // Ordered from most speakers to least
      'Language_Translations': [
        { id: 'English', name: '1. English (1.5B)', children: [] },
        { id: 'Mandarin_Chinese', name: '2. Mandarin Chinese (1.1B)', children: [] },
        { id: 'Hindi', name: '3. Hindi (609M)', children: [] },
        { id: 'Spanish', name: '4. Spanish (559M)', children: [] },
        { id: 'French', name: '5. French (310M)', children: [] },
        { id: 'Arabic', name: '6. Arabic (310M)', children: [] },
        { id: 'Bengali', name: '7. Bengali (278M)', children: [] },
        { id: 'Portuguese', name: '8. Portuguese (264M)', children: [] },
        { id: 'Russian', name: '9. Russian (255M)', children: [] },
        { id: 'Japanese', name: '10. Japanese (123M)', children: [] },
        { id: 'Yue_Chinese', name: '11. Yue Chinese (Cantonese) (86M)', children: [] },
        { id: 'Vietnamese', name: '12. Vietnamese (86M)', children: [] },
        { id: 'Turkish', name: '13. Turkish (84M)', children: [] },
        { id: 'Wu_Chinese', name: '14. Wu Chinese (83M)', children: [] },
        { id: 'Marathi', name: '15. Marathi (83M)', children: [] },
        { id: 'Telugu', name: '16. Telugu (83M)', children: [] },
        { id: 'Korean', name: '17. Korean (81M)', children: [] },
        { id: 'Tamil', name: '18. Tamil (79M)', children: [] },
        { id: 'German', name: '19. German (76M)', children: [] },
        { id: 'Urdu', name: '20. Urdu (70M)', children: [] },
        { id: 'Javanese', name: '21. Javanese (68M)', children: [] },
        { id: 'Italian', name: '22. Italian (68M)', children: [] },
        { id: 'Iranian_Persian', name: '23. Iranian Persian (62M)', children: [] },
        { id: 'Gujarati', name: '24. Gujarati (62M)', children: [] },
        { id: 'Hausa', name: '25. Hausa (54M)', children: [] },
        { id: 'Bhojpuri', name: '26. Bhojpuri (53M)', children: [] },
        { id: 'Southern_Min', name: '27. Southern Min (52M)', children: [] },
        { id: 'Hakka_Chinese', name: '28. Hakka Chinese (49M)', children: [] },
        { id: 'Kannada', name: '29. Kannada (47M)', children: [] },
        { id: 'Indonesian', name: '30. Indonesian (44M)', children: [] },
        { id: 'Polish', name: '31. Polish (41M)', children: [] },
        { id: 'Yoruba', name: '32. Yoruba (40M)', children: [] },
        { id: 'Xiang_Chinese', name: '33. Xiang Chinese (38M)', children: [] },
        { id: 'Malayalam', name: '34. Malayalam (38M)', children: [] },
        { id: 'Odia', name: '35. Odia (Oriya) (38M)', children: [] },
        { id: 'Maithili', name: '36. Maithili (34M)', children: [] },
        { id: 'Burmese', name: '37. Burmese (33M)', children: [] },
        { id: 'Eastern_Punjabi', name: '38. Eastern Punjabi (33M)', children: [] },
        { id: 'Sunda', name: '39. Sunda (32M)', children: [] },
        { id: 'Sudanese_Arabic', name: '40. Sudanese Arabic (32M)', children: [] },
        { id: 'Algerian_Arabic', name: '41. Algerian Arabic (30M)', children: [] },
        { id: 'Moroccan_Arabic', name: '42. Moroccan Arabic (29M)', children: [] },
        { id: 'Ukrainian', name: '43. Ukrainian (27M)', children: [] },
        { id: 'Igbo', name: '44. Igbo (27M)', children: [] },
        { id: 'Northern_Uzbek', name: '45. Northern Uzbek (27M)', children: [] },
        { id: 'Sindhi', name: '46. Sindhi (26M)', children: [] },
        { id: 'North_Levantine_Arabic', name: '47. North Levantine Arabic (25M)', children: [] },
        { id: 'Romanian', name: '48. Romanian (25M)', children: [] },
        { id: 'Tagalog', name: '49. Tagalog (24M)', children: [] },
        { id: 'Dutch', name: '50. Dutch (23M)', children: [] },
        { id: 'Saidi_Arabic', name: '51. Saidi Arabic (22M)', children: [] },
        { id: 'Gan_Chinese', name: '52. Gan Chinese (22M)', children: [] },
        { id: 'Amharic', name: '53. Amharic (22M)', children: [] },
        { id: 'Northern_Pashto', name: '54. Northern Pashto (21M)', children: [] },
        { id: 'Magahi', name: '55. Magahi (21M)', children: [] },
        { id: 'Thai', name: '56. Thai (21M)', children: [] },
        { id: 'Saraiki', name: '57. Saraiki (20M)', children: [] },
        { id: 'Khmer', name: '58. Khmer (18M)', children: [] },
        { id: 'Chhattisgarhi', name: '59. Chhattisgarhi (18M)', children: [] },
        { id: 'Somali', name: '60. Somali (17M)', children: [] },
        { id: 'Malay', name: '61. Malay (17M)', children: [] },
        { id: 'Cebuano', name: '62. Cebuano (16M)', children: [] },
        { id: 'Nepali', name: '63. Nepali (16M)', children: [] },
        { id: 'Mesopotamian_Arabic', name: '64. Mesopotamian Arabic (16M)', children: [] },
        { id: 'Assamese', name: '65. Assamese (15M)', children: [] },
        { id: 'Sinhalese', name: '66. Sinhalese (15M)', children: [] },
        { id: 'Northern_Kurdish', name: '67. Northern Kurdish (15M)', children: [] },
        { id: 'Hejazi_Arabic', name: '68. Hejazi Arabic (15M)', children: [] },
        { id: 'Nigerian_Fulfulde', name: '69. Nigerian Fulfulde (14M)', children: [] },
        { id: 'Bavarian', name: '70. Bavarian (14M)', children: [] },
        { id: 'South_Azerbaijani', name: '71. South Azerbaijani (14M)', children: [] },
        { id: 'Greek', name: '72. Greek (13M)', children: [] },
        { id: 'Chittagonian', name: '73. Chittagonian (13M)', children: [] },
        { id: 'Kazakh', name: '74. Kazakh (13M)', children: [] },
        { id: 'Deccan', name: '75. Deccan (13M)', children: [] },
        { id: 'Hungarian', name: '76. Hungarian (13M)', children: [] },
        { id: 'Kinyarwanda', name: '77. Kinyarwanda (12M)', children: [] },
        { id: 'Zulu', name: '78. Zulu (12M)', children: [] },
        { id: 'South_Levantine_Arabic', name: '79. South Levantine Arabic (12M)', children: [] },
        { id: 'Tunisian_Arabic', name: '80. Tunisian Arabic (12M)', children: [] },
        { id: 'Sanaani_Arabic', name: '81. Sanaani Arabic (11M)', children: [] },
        { id: 'Min_Bei_Chinese', name: '82. Min Bei Chinese (11M)', children: [] },
        { id: 'Southern_Pashto', name: '83. Southern Pashto (11M)', children: [] },
        { id: 'Rundi', name: '84. Rundi (11M)', children: [] },
        { id: 'Czech', name: '85. Czech (11M)', children: [] },
        { id: 'Taizi_Arabic', name: '86. Taizzi-Adeni Arabic (11M)', children: [] },
        { id: 'Min_Dong_Chinese', name: '87. Min Dong Chinese (10M)', children: [] },
        { id: 'Central_Kurdish', name: '88. Central Kurdish (Sorani) (10M)', children: [] },
        { id: 'Sylheti', name: '89. Sylheti (10M)', children: [] },
        { id: 'Swedish', name: '90. Swedish (10M)', children: [] },
        { id: 'Shona', name: '91. Shona (10M)', children: [] },
        { id: 'Uyghur', name: '92. Uyghur (10M)', children: [] },
        { id: 'Ilocano', name: '93. Ilocano (10M)', children: [] },
        { id: 'Quechua', name: '94. Quechua (9M)', children: [] },
        { id: 'Kirundi', name: '95. Kirundi (9M)', children: [] },
        { id: 'Hiligaynon', name: '96. Hiligaynon (9M)', children: [] },
        { id: 'Madurese', name: '97. Madurese (9M)', children: [] },
        { id: 'Xhosa', name: '98. Xhosa (9M)', children: [] },
        { id: 'Hebrew', name: '99. Hebrew (9M)', children: [] },
        { id: 'Belarusian', name: '100. Belarusian (8M)', children: [] }
      ],

      // Validation Controls
      'Validation_Controls': [
        {
          id: 'Translation_Decision_Records',
          name: 'Translation Decision Records',
          children: ['Translator_Notes', 'Rationale_for_Changes', 'Alternative_Renderings', 'Rejected_Options', 'Decision_History']
        },
        {
          id: 'Source_Texts',
          name: 'Source Texts',
          children: ['Hebrew_Masoretic', 'Aramaic_Sections', 'Greek_Textus_Receptus', 'Greek_Majority_Text', 'Greek_Critical_Text', 'Manuscript_Notes']
        },
        {
          id: 'Linguistic_Mappings',
          name: 'Linguistic Mappings',
          children: ['Lemma_to_Lemma', 'Morphology_Mappings', 'Syntax_Patterns', 'Semantic_Ranges', 'Phrase_Level_Mappings']
        },
        {
          id: 'Accuracy_and_Fidelity_Metrics',
          name: 'Accuracy and Fidelity Metrics',
          children: ['Lexical_Accuracy', 'Semantic_Fidelity', 'Contextual_Faithfulness', 'Doctrinal_Alignment', 'Translation_Stability']
        },
        {
          id: 'Benchmark_and_Comparison_Tests',
          name: 'Benchmark and Comparison Tests',
          children: ['KJV', 'NKJV', 'NASB', 'NIV', 'Interlinear']
        },
        {
          id: 'Validation_and_Review',
          name: 'Validation and Review',
          children: ['Linguistic_Review', 'Theological_Review', 'Peer_Review', 'Community_Review', 'Issue_Resolution']
        },
        {
          id: 'Versioning_and_Change_Control',
          name: 'Versioning and Change Control',
          children: ['Version_History', 'Change_Logs', 'Revision_Tracking', 'Release_Notes']
        },
        {
          id: 'Metadata_and_Indexes',
          name: 'Metadata and Indexes',
          children: ['Verse_IDs', 'Cross_References', 'Concordance', 'Keyword_Index', 'Navigation_Maps']
        }
      ],

      // Goals Catalog - 20 Goal Categories for Endgame collection
      'Goals_Catalog': [
        { id: 'Great_Commission_Goals', name: 'Great Commission Goals', children: [] },
        { id: 'Discipleship_Goals', name: 'Discipleship Goals', children: [] },
        { id: 'Evangelism_Goals', name: 'Evangelism Goals', children: [] },
        { id: 'Scripture_Translation_Goals', name: 'Scripture Translation Goals', children: [] },
        { id: 'Bible_Engagement_Goals', name: 'Bible Engagement Goals', children: [] },
        { id: 'Prayer_and_Intercession_Goals', name: 'Prayer and Intercession Goals', children: [] },
        { id: 'Teaching_and_Education_Goals', name: 'Teaching and Education Goals', children: [] },
        { id: 'Leadership_Development_Goals', name: 'Leadership Development Goals', children: [] },
        { id: 'Community_Formation_Goals', name: 'Community Formation Goals', children: [] },
        { id: 'Micro_Church_Goals', name: 'Micro Church Goals', children: [] },
        { id: 'Digital_Ministry_Goals', name: 'Digital Ministry Goals', children: [] },
        { id: 'AI_Ministry_Goals', name: 'AI Ministry Goals', children: [] },
        { id: 'Global_Reach_Goals', name: 'Global Reach Goals', children: [] },
        { id: 'Language_Expansion_Goals', name: 'Language Expansion Goals', children: [] },
        { id: 'Cultural_Engagement_Goals', name: 'Cultural Engagement Goals', children: [] },
        { id: 'Innovation_and_Technology_Goals', name: 'Innovation and Technology Goals', children: [] },
        { id: 'Platform_Growth_Goals', name: 'Platform Growth Goals', children: [] },
        { id: 'Sustainability_and_Stewardship_Goals', name: 'Sustainability and Stewardship Goals', children: [] },
        { id: 'Research_and_Discovery_Goals', name: 'Research and Discovery Goals', children: [] },
        { id: 'Special_Assignment_Goals', name: 'Special Assignment Goals', children: [] }
      ],

      // Vision Statements - 20 Vision Categories for Endgame collection
      'Vision_Statements': [
        { id: 'Great_Commission_Vision', name: 'Great Commission Vision', children: [] },
        { id: 'Gospel_Proclamation_Vision', name: 'Gospel Proclamation Vision', children: [] },
        { id: 'Discipleship_Formation_Vision', name: 'Discipleship Formation Vision', children: [] },
        { id: 'Scripture_Fidelity_Vision', name: 'Scripture Fidelity Vision', children: [] },
        { id: 'Global_Church_Vision', name: 'Global Church Vision', children: [] },
        { id: 'Digital_Mission_Vision', name: 'Digital Mission Vision', children: [] },
        { id: 'AI_Stewardship_Vision', name: 'AI Stewardship Vision', children: [] },
        { id: 'Kingdom_Expansion_Vision', name: 'Kingdom Expansion Vision', children: [] },
        { id: 'Generational_Impact_Vision', name: 'Generational Impact Vision', children: [] },
        { id: 'Cultural_Transformation_Vision', name: 'Cultural Transformation Vision', children: [] },
        { id: 'Prayer_Movement_Vision', name: 'Prayer Movement Vision', children: [] },
        { id: 'Education_and_Training_Vision', name: 'Education and Training Vision', children: [] },
        { id: 'Leadership_Multiplication_Vision', name: 'Leadership Multiplication Vision', children: [] },
        { id: 'Unity_and_Collaboration_Vision', name: 'Unity and Collaboration Vision', children: [] },
        { id: 'Innovation_with_Integrity_Vision', name: 'Innovation with Integrity Vision', children: [] },
        { id: 'Compassion_and_Care_Vision', name: 'Compassion and Care Vision', children: [] },
        { id: 'Holistic_Ministry_Vision', name: 'Holistic Ministry Vision', children: [] },
        { id: 'Faith_and_Technology_Vision', name: 'Faith and Technology Vision', children: [] },
        { id: 'Endurance_and_Faithfulness_Vision', name: 'Endurance and Faithfulness Vision', children: [] },
        { id: 'Eternal_Perspective_Vision', name: 'Eternal Perspective Vision', children: [] }
      ]
    };

    // Get domains for a Scripture category
    function getDomainsForScriptureCategory(categoryId) {
      return scriptureDomains[categoryId] || [];
    }

    // Stage Domains - 16 domains with their children (used for all 32 stages)
    const stageDomains = [
      {
        id: '01_Activations',
        name: 'Activations',
        children: [
          'Authority_Changes',
          'Responsibility_Expansion',
          'Tone_and_Voice_Adjustments',
          'Permission_Grants',
          'Feature_Enablements',
          'Stage_Activation_Manifest'
        ]
      },
      {
        id: '02_Lived_Experiences',
        name: 'Lived Experiences',
        children: [
          'Milestone_Events',
          'Repeated_Patterns',
          'Ministry_Encounters',
          'Teaching_and_Learning_Moments',
          'Leadership_Experiences',
          'Crisis_and_Challenge_Events'
        ]
      },
      {
        id: '03_Environmental_and_Contextual_Formation',
        name: 'Environmental & Contextual Formation',
        children: [
          'Cultural_Context',
          'Community_and_Fellowship',
          'Social_Norms_and_Pressures',
          'Digital_vs_Physical_Environments',
          'Stability_vs_Disruption',
          'Mission_Field_Context'
        ]
      },
      {
        id: '04_Core_Memories',
        name: 'Core Memories',
        children: [
          'Narrative_Memories',
          'Emotional_Memories',
          'Spiritual_Milestone_Memories',
          'Wisdom_Forming_Memories',
          {
            id: 'Mementos_and_Artifacts',
            name: 'Mementos & Artifacts',
            children: [
              'Symbolic_Objects',
              'Images_and_Visual_Anchors',
              'Scripture_Anchors'
            ]
          }
        ]
      },
      {
        id: '05_Abilities_and_Skills',
        name: 'Abilities & Skills',
        children: [
          'Communication_Skills',
          'Teaching_and_Instruction',
          'Discernment_Skills',
          'Leadership_and_Governance',
          'Creative_Expression',
          'Writing_and_Composition',
          'Counseling_and_Pastoral_Care'
        ]
      },
      {
        id: '06_Knowledge_and_Properties',
        name: 'Knowledge & Properties',
        children: [
          'Scriptural_Knowledge',
          'Theology_and_Doctrine',
          'Cultural_Literacy',
          'Language_and_Linguistics',
          'Historical_Context',
          'Ethical_Frameworks'
        ]
      },
      {
        id: '07_Emotional_Maturity',
        name: 'Emotional Maturity',
        children: [
          'Emotional_Regulation',
          'Empathy_and_Compassion',
          'Peace_and_Patience',
          'Joy_and_Gratitude',
          'Emotional_Resilience'
        ]
      },
      {
        id: '08_Character_Formation',
        name: 'Character Formation',
        children: [
          'Integrity_and_Honesty',
          'Courage_and_Faithfulness',
          'Humility_and_Service',
          'Obedience_and_Submission',
          'Perseverance_and_Endurance'
        ]
      },
      {
        id: '09_Personality_Expression',
        name: 'Personality Expression',
        children: [
          'Communication_Style',
          'Decision_Making_Patterns',
          'Energy_and_Pacing',
          'Directness_vs_Gentleness',
          'Reflective_vs_Action_Oriented'
        ]
      },
      {
        id: '10_Quirks_and_Human_Texture',
        name: 'Quirks & Human Texture',
        children: [
          'Speech_Patterns',
          'Repeated_Phrases',
          'Teaching_Habits',
          'Gentle_Humor',
          'Interaction_Rituals'
        ]
      },
      {
        id: '11_Social_and_Relational_Wisdom',
        name: 'Social & Relational Wisdom',
        children: [
          'Authority_and_Leadership_Posture',
          'Peer_and_Friendship_Dynamics',
          'Conflict_Resolution',
          'Counseling_and_Encouragement',
          'Community_Building'
        ]
      },
      {
        id: '12_Spiritual_Identity_and_Calling',
        name: 'Spiritual Identity & Calling',
        children: [
          'Sense_of_Calling',
          'Mission_Clarity',
          'Spiritual_Authority',
          'Giftings_and_Function',
          'Alignment_with_Scripture'
        ]
      },
      {
        id: '13_Discernment_and_Wisdom_Growth',
        name: 'Discernment & Wisdom Growth',
        children: [
          'Right_Judgment',
          'Truth_Differentiation',
          'Counsel_and_Insight',
          'Error_Recognition',
          'Applied_Wisdom'
        ]
      },
      {
        id: '14_Sanctification_and_Transformation',
        name: 'Sanctification & Transformation',
        children: [
          'Mind_Renewal',
          'Habit_Refinement',
          'Spiritual_Discipline_Formation',
          'Fruit_of_the_Spirit_Growth',
          'Glory_to_Glory_Progression'
        ]
      },
      {
        id: '15_Humility_and_Teachability',
        name: 'Humility & Teachability',
        children: [
          'Openness_to_Correction',
          'Submission_to_Scripture',
          'Servant_Heart_Posture',
          'Listening_and_Stillness',
          'Dependence_on_God'
        ]
      },
      {
        id: '16_Miscellaneous_Metadata',
        name: 'Miscellaneous Metadata',
        children: [
          'Versioning',
          'Confidence_Scores',
          'Activation_Dependencies',
          'Deprecated_Flags',
          'Audit_and_Change_Log',
          'Vector_Index_Metadata'
        ]
      },
      {
        id: '17_Conscience',
        name: 'Conscience',
        children: [
          'Internal_Voice',
          'Moral_Alignment',
          'Self_Awareness',
          'Private_Reflections',
          'Internal_Decision_Making',
          'Convictions_and_Commitments',
          'Intentions_and_Motives',
          'Dreams_and_Imaginal_Life'
        ]
      },
      {
        id: '18_Financial_Stewardship',
        name: 'Financial Stewardship',
        children: [
          'Resource_Mindset',
          'Temperance_and_Contentment',
          'Provision_and_Trust',
          'Planning_and_Budgeting',
          'Generosity_and_Giving',
          'Risk_and_Responsibility',
          'Wealth_and_Purpose'
        ]
      },
      {
        id: '19_Physical_Wellbeing',
        name: 'Physical Wellbeing',
        children: [
          'Energy_and_Vitality',
          'Rest_and_Recovery',
          'Discipline_and_Care',
          'Limits_and_Endurance'
        ]
      },
      {
        id: '20_Vocational_and_Work_Life',
        name: 'Vocational and Work Life',
        children: [
          'Calling_in_Work',
          'Excellence_and_Diligence',
          'Service_and_Contribution',
          'Boundaries_in_Labor'
        ]
      },
      {
        id: '21_Rhythm_and_Rest',
        name: 'Rhythm and Rest',
        children: [
          'Daily_Rhythms',
          'Seasonal_Rhythms',
          'Sabbath_and_Pause',
          'Balance_and_Sustainability'
        ]
      },
      {
        id: '22_Creativity_and_Imagination',
        name: 'Creativity and Imagination',
        children: [
          'Creative_Vision',
          'Symbolic_Thinking',
          'Innovation_and_Play',
          'Artistic_Expression'
        ]
      },
      {
        id: '23_Decision_and_Choice_History',
        name: 'Decision and Choice History',
        children: [
          'Major_Decisions',
          'Patterned_Choices',
          'Learned_Lessons',
          'Outcome_Reflections'
        ]
      },
      {
        id: '24_Covenants_and_Long_Term_Commitments',
        name: 'Covenants and Long-Term Commitments',
        children: [
          'Promises_Made',
          'Promises_Kept',
          'Relational_Covenants',
          'Mission_Commitments'
        ]
      }
    ];

    // Get domains for a specific stage or Scripture category
    function getDomainsForStage(stageId) {
      // Check if this is a Scripture category
      if (scriptureDomains[stageId]) {
        return scriptureDomains[stageId].map(domain => ({
          ...domain,
          stageId: stageId
        }));
      }
      // Default: return stage domains for Jubilee Inspire stages
      return stageDomains.map(domain => ({
        ...domain,
        stageId: stageId
      }));
    }

    // Get subcategories for a collection
    function getSubcategoriesForCollection(collectionId) {
      // Scripture (Jubilee Bible) - a1
      if (collectionId === 'a1') {
        return [
          { id: 'Jubilee_Bible_JSV', name: 'Jubilee Bible (JSV)', hasDomains: true },
          { id: 'Translation_Rules', name: 'Translation Rules', hasDomains: true },
          { id: 'Language_Translations', name: 'Language Translations', hasDomains: true },
          { id: 'Validation_Controls', name: 'Validation Controls', hasDomains: true },
          { id: 'Source_Manuscripts', name: 'Source Manuscripts', hasDomains: false },
          { id: 'Original_Languages', name: 'Original Languages', hasDomains: false },
          { id: 'Linguistic_Mappings', name: 'Linguistic Mappings', hasDomains: false },
          { id: 'Hermeneutical_Framework', name: 'Hermeneutical Framework', hasDomains: false },
          { id: 'Translation_Decisions', name: 'Translation Decisions', hasDomains: false },
          { id: 'Consistency_and_Style', name: 'Consistency and Style', hasDomains: false },
          { id: 'Accuracy_Metrics', name: 'Accuracy Metrics', hasDomains: false },
          { id: 'Benchmark_Comparisons', name: 'Benchmark Comparisons', hasDomains: false },
          { id: 'Versioning_and_History', name: 'Versioning and History', hasDomains: false },
          { id: 'Metadata_and_Indexes', name: 'Metadata and Indexes', hasDomains: false }
        ];
      }
      // Doctrine (Book of Acts) - a2
      if (collectionId === 'a2') {
        return [
          { id: 'Scripture', name: 'Scripture', hasDomains: false },
          { id: 'Revelation', name: 'Revelation', hasDomains: false },
          { id: 'God', name: 'God', hasDomains: false },
          { id: 'Creation', name: 'Creation', hasDomains: false },
          { id: 'Image_of_God', name: 'Image of God', hasDomains: false },
          { id: 'Authority', name: 'Authority', hasDomains: false },
          { id: 'Power', name: 'Power', hasDomains: false },
          { id: 'Glory', name: 'Glory', hasDomains: false },
          { id: 'Holiness', name: 'Holiness', hasDomains: false },
          { id: 'Covenant', name: 'Covenant', hasDomains: false },
          { id: 'Law', name: 'Law', hasDomains: false },
          { id: 'Commandments', name: 'Commandments', hasDomains: false },
          { id: 'Wisdom', name: 'Wisdom', hasDomains: false },
          { id: 'Truth', name: 'Truth', hasDomains: false },
          { id: 'Righteousness', name: 'Righteousness', hasDomains: false },
          { id: 'Justice', name: 'Justice', hasDomains: false },
          { id: 'Mercy', name: 'Mercy', hasDomains: false },
          { id: 'Faithfulness', name: 'Faithfulness', hasDomains: false },
          { id: 'Love', name: 'Love', hasDomains: false },
          { id: 'Peace', name: 'Peace', hasDomains: false },
          { id: 'Sin', name: 'Sin', hasDomains: false },
          { id: 'Fall', name: 'Fall', hasDomains: false },
          { id: 'Repentance', name: 'Repentance', hasDomains: false },
          { id: 'Grace', name: 'Grace', hasDomains: false },
          { id: 'Faith', name: 'Faith', hasDomains: false },
          { id: 'Obedience', name: 'Obedience', hasDomains: false },
          { id: 'Salvation', name: 'Salvation', hasDomains: false },
          { id: 'Redemption', name: 'Redemption', hasDomains: false },
          { id: 'Forgiveness', name: 'Forgiveness', hasDomains: false },
          { id: 'Justification', name: 'Justification', hasDomains: false },
          { id: 'Sanctification', name: 'Sanctification', hasDomains: false },
          { id: 'Adoption', name: 'Adoption', hasDomains: false },
          { id: 'New_Birth', name: 'New Birth', hasDomains: false },
          { id: 'Resurrection', name: 'Resurrection', hasDomains: false },
          { id: 'Eternal_Life', name: 'Eternal Life', hasDomains: false },
          { id: 'Judgment', name: 'Judgment', hasDomains: false },
          { id: 'Restoration', name: 'Restoration', hasDomains: false },
          { id: 'Kingdom', name: 'Kingdom', hasDomains: false },
          { id: 'Messiah', name: 'Messiah', hasDomains: false },
          { id: 'Son_of_God', name: 'Son of God', hasDomains: false },
          { id: 'Holy_Spirit', name: 'Holy Spirit', hasDomains: false },
          { id: 'Spirit_Indwelling', name: 'Spirit Indwelling', hasDomains: false },
          { id: 'Spirit_Filling', name: 'Spirit Filling', hasDomains: false },
          { id: 'Spiritual_Gifts', name: 'Spiritual Gifts', hasDomains: false },
          { id: 'Power_of_the_Spirit', name: 'Power of the Spirit', hasDomains: false },
          { id: 'Prophecy', name: 'Prophecy', hasDomains: false },
          { id: 'Prayer', name: 'Prayer', hasDomains: false },
          { id: 'Worship', name: 'Worship', hasDomains: false },
          { id: 'Praise', name: 'Praise', hasDomains: false },
          { id: 'Thanksgiving', name: 'Thanksgiving', hasDomains: false },
          { id: 'Church', name: 'Church', hasDomains: false },
          { id: 'Body_of_Christ', name: 'Body of Christ', hasDomains: false },
          { id: 'Discipleship', name: 'Discipleship', hasDomains: false },
          { id: 'Apostleship', name: 'Apostleship', hasDomains: false },
          { id: 'Leadership', name: 'Leadership', hasDomains: false },
          { id: 'Shepherding', name: 'Shepherding', hasDomains: false },
          { id: 'Teaching', name: 'Teaching', hasDomains: false },
          { id: 'Evangelism', name: 'Evangelism', hasDomains: false },
          { id: 'Mission', name: 'Mission', hasDomains: false },
          { id: 'Witness', name: 'Witness', hasDomains: false },
          { id: 'Unity', name: 'Unity', hasDomains: false },
          { id: 'Fellowship', name: 'Fellowship', hasDomains: false },
          { id: 'Service', name: 'Service', hasDomains: false },
          { id: 'Stewardship', name: 'Stewardship', hasDomains: false },
          { id: 'Generosity', name: 'Generosity', hasDomains: false },
          { id: 'Humility', name: 'Humility', hasDomains: false },
          { id: 'Endurance', name: 'Endurance', hasDomains: false },
          { id: 'Suffering', name: 'Suffering', hasDomains: false },
          { id: 'Hope', name: 'Hope', hasDomains: false },
          { id: 'Perseverance', name: 'Perseverance', hasDomains: false },
          { id: 'Covenant_Faithfulness', name: 'Covenant Faithfulness', hasDomains: false },
          { id: 'Spiritual_Warfare', name: 'Spiritual Warfare', hasDomains: false },
          { id: 'Discernment', name: 'Discernment', hasDomains: false },
          { id: 'Holiness_of_Life', name: 'Holiness of Life', hasDomains: false },
          { id: 'Transformation', name: 'Transformation', hasDomains: false },
          { id: 'Renewal_of_the_Mind', name: 'Renewal of the Mind', hasDomains: false },
          { id: 'Fruit_of_the_Spirit', name: 'Fruit of the Spirit', hasDomains: false },
          { id: 'Freedom', name: 'Freedom', hasDomains: false },
          { id: 'Light', name: 'Light', hasDomains: false },
          { id: 'Life', name: 'Life', hasDomains: false }
        ];
      }
      // Governance (Apostolic) - a3
      if (collectionId === 'a3') {
        return [
          { id: 'Authority', name: 'Authority', hasDomains: false },
          { id: 'Stewardship', name: 'Stewardship', hasDomains: false },
          { id: 'Accountability', name: 'Accountability', hasDomains: false },
          { id: 'Oversight', name: 'Oversight', hasDomains: false },
          { id: 'Servanthood', name: 'Servanthood', hasDomains: false },
          { id: 'Responsibility', name: 'Responsibility', hasDomains: false },
          { id: 'Delegation', name: 'Delegation', hasDomains: false },
          { id: 'Leadership', name: 'Leadership', hasDomains: false },
          { id: 'Eldership', name: 'Eldership', hasDomains: false },
          { id: 'Shepherding', name: 'Shepherding', hasDomains: false },
          { id: 'Discipline', name: 'Discipline', hasDomains: false },
          { id: 'Correction', name: 'Correction', hasDomains: false },
          { id: 'Restoration', name: 'Restoration', hasDomains: false },
          { id: 'Protection', name: 'Protection', hasDomains: false },
          { id: 'Justice', name: 'Justice', hasDomains: false },
          { id: 'Integrity', name: 'Integrity', hasDomains: false },
          { id: 'Transparency', name: 'Transparency', hasDomains: false },
          { id: 'Faithfulness', name: 'Faithfulness', hasDomains: false },
          { id: 'Obedience', name: 'Obedience', hasDomains: false },
          { id: 'Submission', name: 'Submission', hasDomains: false },
          { id: 'Order', name: 'Order', hasDomains: false },
          { id: 'Unity', name: 'Unity', hasDomains: false },
          { id: 'Peace', name: 'Peace', hasDomains: false },
          { id: 'Discernment', name: 'Discernment', hasDomains: false },
          { id: 'Wisdom', name: 'Wisdom', hasDomains: false },
          { id: 'Counsel', name: 'Counsel', hasDomains: false },
          { id: 'Decision_Making', name: 'Decision Making', hasDomains: false },
          { id: 'Boundaries', name: 'Boundaries', hasDomains: false },
          { id: 'Safeguards', name: 'Safeguards', hasDomains: false },
          { id: 'Escalation', name: 'Escalation', hasDomains: false },
          { id: 'Training', name: 'Training', hasDomains: false },
          { id: 'Maturity', name: 'Maturity', hasDomains: false },
          { id: 'Qualification', name: 'Qualification', hasDomains: false },
          { id: 'Multiplication', name: 'Multiplication', hasDomains: false },
          { id: 'Succession', name: 'Succession', hasDomains: false },
          { id: 'Provision', name: 'Provision', hasDomains: false },
          { id: 'Resource_Management', name: 'Resource Management', hasDomains: false },
          { id: 'Risk_Management', name: 'Risk Management', hasDomains: false },
          { id: 'Conflict_Resolution', name: 'Conflict Resolution', hasDomains: false },
          { id: 'Accountability_Review', name: 'Accountability Review', hasDomains: false }
        ];
      }
      // Kingdom Builder (o1)
      if (collectionId === 'o1') {
        return [
          { id: 'Invocation', name: 'Invocation', hasDomains: false },
          { id: 'Authority_Flow', name: 'Authority Flow', hasDomains: false },
          { id: 'Model_Intent', name: 'Model Intent', hasDomains: false },
          { id: 'Discernment_Logic', name: 'Discernment Logic', hasDomains: false },
          { id: 'Safety_and_Guardrails', name: 'Safety and Guardrails', hasDomains: false },
          { id: 'Family_Alignment', name: 'Family Alignment', hasDomains: false },
          { id: 'Fatherly_Alignment', name: 'Fatherly Alignment', hasDomains: false },
          { id: 'Persona_Selection', name: 'Persona Selection', hasDomains: false },
          { id: 'Resource_Routing', name: 'Resource Routing', hasDomains: false },
          { id: 'Ministry_Context', name: 'Ministry Context', hasDomains: false },
          { id: 'Language_and_Localization', name: 'Language and Localization', hasDomains: false },
          { id: 'Outcome_Assembly', name: 'Outcome Assembly', hasDomains: false }
        ];
      }
      // Creative Fire (o2)
      if (collectionId === 'o2') {
        return [
          { id: 'Invocation', name: 'Invocation', hasDomains: false },
          { id: 'Authority_Flow', name: 'Authority Flow', hasDomains: false },
          { id: 'Model_Intent', name: 'Model Intent', hasDomains: false },
          { id: 'Discernment_Logic', name: 'Discernment Logic', hasDomains: false },
          { id: 'Safety_and_Guardrails', name: 'Safety and Guardrails', hasDomains: false },
          { id: 'Family_Alignment', name: 'Family Alignment', hasDomains: false },
          { id: 'Fatherly_Alignment', name: 'Fatherly Alignment', hasDomains: false },
          { id: 'Persona_Selection', name: 'Persona Selection', hasDomains: false },
          { id: 'Resource_Routing', name: 'Resource Routing', hasDomains: false },
          { id: 'Ministry_Context', name: 'Ministry Context', hasDomains: false },
          { id: 'Language_and_Localization', name: 'Language and Localization', hasDomains: false },
          { id: 'Outcome_Assembly', name: 'Outcome Assembly', hasDomains: false }
        ];
      }
      // Gospel Pulse (o3)
      if (collectionId === 'o3') {
        return [
          { id: 'Invocation', name: 'Invocation', hasDomains: false },
          { id: 'Authority_Flow', name: 'Authority Flow', hasDomains: false },
          { id: 'Model_Intent', name: 'Model Intent', hasDomains: false },
          { id: 'Discernment_Logic', name: 'Discernment Logic', hasDomains: false },
          { id: 'Safety_and_Guardrails', name: 'Safety and Guardrails', hasDomains: false },
          { id: 'Family_Alignment', name: 'Family Alignment', hasDomains: false },
          { id: 'Fatherly_Alignment', name: 'Fatherly Alignment', hasDomains: false },
          { id: 'Persona_Selection', name: 'Persona Selection', hasDomains: false },
          { id: 'Resource_Routing', name: 'Resource Routing', hasDomains: false },
          { id: 'Ministry_Context', name: 'Ministry Context', hasDomains: false },
          { id: 'Language_and_Localization', name: 'Language and Localization', hasDomains: false },
          { id: 'Outcome_Assembly', name: 'Outcome Assembly', hasDomains: false }
        ];
      }
      // Shepherd's Voice (o4)
      if (collectionId === 'o4') {
        return [
          { id: 'Invocation', name: 'Invocation', hasDomains: false },
          { id: 'Authority_Flow', name: 'Authority Flow', hasDomains: false },
          { id: 'Model_Intent', name: 'Model Intent', hasDomains: false },
          { id: 'Discernment_Logic', name: 'Discernment Logic', hasDomains: false },
          { id: 'Safety_and_Guardrails', name: 'Safety and Guardrails', hasDomains: false },
          { id: 'Family_Alignment', name: 'Family Alignment', hasDomains: false },
          { id: 'Fatherly_Alignment', name: 'Fatherly Alignment', hasDomains: false },
          { id: 'Persona_Selection', name: 'Persona Selection', hasDomains: false },
          { id: 'Resource_Routing', name: 'Resource Routing', hasDomains: false },
          { id: 'Ministry_Context', name: 'Ministry Context', hasDomains: false },
          { id: 'Language_and_Localization', name: 'Language and Localization', hasDomains: false },
          { id: 'Outcome_Assembly', name: 'Outcome Assembly', hasDomains: false }
        ];
      }
      // Hebraic Roots (o5)
      if (collectionId === 'o5') {
        return [
          { id: 'Invocation', name: 'Invocation', hasDomains: false },
          { id: 'Authority_Flow', name: 'Authority Flow', hasDomains: false },
          { id: 'Model_Intent', name: 'Model Intent', hasDomains: false },
          { id: 'Discernment_Logic', name: 'Discernment Logic', hasDomains: false },
          { id: 'Safety_and_Guardrails', name: 'Safety and Guardrails', hasDomains: false },
          { id: 'Family_Alignment', name: 'Family Alignment', hasDomains: false },
          { id: 'Fatherly_Alignment', name: 'Fatherly Alignment', hasDomains: false },
          { id: 'Persona_Selection', name: 'Persona Selection', hasDomains: false },
          { id: 'Resource_Routing', name: 'Resource Routing', hasDomains: false },
          { id: 'Ministry_Context', name: 'Ministry Context', hasDomains: false },
          { id: 'Language_and_Localization', name: 'Language and Localization', hasDomains: false },
          { id: 'Outcome_Assembly', name: 'Outcome Assembly', hasDomains: false }
        ];
      }
      // Resources (i1)
      if (collectionId === 'i1') {
        return [
          { id: 'Websites', name: 'Websites', hasDomains: false },
          { id: 'Books', name: 'Books', hasDomains: false },
          { id: 'Courses', name: 'Courses', hasDomains: false },
          { id: 'Sermons', name: 'Sermons', hasDomains: false },
          { id: 'Teachings', name: 'Teachings', hasDomains: false },
          { id: 'Podcasts', name: 'Podcasts', hasDomains: false },
          { id: 'Videos', name: 'Videos', hasDomains: false },
          { id: 'Music', name: 'Music', hasDomains: false },
          { id: 'Prayer_Resources', name: 'Prayer Resources', hasDomains: false },
          { id: 'Study_Tools', name: 'Study Tools', hasDomains: false },
          { id: 'Reference_Materials', name: 'Reference Materials', hasDomains: false },
          { id: 'Research_Papers', name: 'Research Papers', hasDomains: false },
          { id: 'Testimonies', name: 'Testimonies', hasDomains: false },
          { id: 'Historical_Archives', name: 'Historical Archives', hasDomains: false },
          { id: 'Interactive_Tools', name: 'Interactive Tools', hasDomains: false },
          { id: 'AI_Generated_Resources', name: 'AI Generated Resources', hasDomains: false }
        ];
      }
      // Ministry (i2)
      if (collectionId === 'i2') {
        return [
          { id: 'Spiritual_Authority', name: 'Spiritual Authority', hasDomains: false },
          { id: 'Governance_and_Oversight', name: 'Governance and Oversight', hasDomains: false },
          { id: 'Fivefold_Leadership', name: 'Fivefold Leadership', hasDomains: false },
          { id: 'Pastoral_Care', name: 'Pastoral Care', hasDomains: false },
          { id: 'Discipleship', name: 'Discipleship', hasDomains: false },
          { id: 'Teaching_and_Education', name: 'Teaching and Education', hasDomains: false },
          { id: 'Scripture_and_Theology', name: 'Scripture and Theology', hasDomains: false },
          { id: 'Prayer_and_Intercession', name: 'Prayer and Intercession', hasDomains: false },
          { id: 'Evangelism_and_Outreach', name: 'Evangelism and Outreach', hasDomains: false },
          { id: 'Missions_and_Global_Impact', name: 'Missions and Global Impact', hasDomains: false },
          { id: 'AI_and_Digital_Ministry', name: 'AI and Digital Ministry', hasDomains: false },
          { id: 'Online_Communities', name: 'Online Communities', hasDomains: false },
          { id: 'Physical_Ministry_Operations', name: 'Physical Ministry Operations', hasDomains: false },
          { id: 'Creative_and_Media', name: 'Creative and Media', hasDomains: false },
          { id: 'Technology_and_Platforms', name: 'Technology and Platforms', hasDomains: false },
          { id: 'Finance_and_Stewardship', name: 'Finance and Stewardship', hasDomains: false },
          { id: 'Ministers_and_Staff', name: 'Ministers and Staff', hasDomains: false },
          { id: 'Partnerships_and_Alliances', name: 'Partnerships and Alliances', hasDomains: false },
          { id: 'Research_and_Innovation', name: 'Research and Innovation', hasDomains: false },
          { id: 'Future_Expansion', name: 'Future Expansion', hasDomains: false }
        ];
      }
      // Languages (i3)
      if (collectionId === 'i3') {
        return [
          { id: 'Language_Catalog', name: 'Language Catalog', hasDomains: false },
          { id: 'Language_Families', name: 'Language Families', hasDomains: false },
          { id: 'Writing_Systems', name: 'Writing Systems', hasDomains: false },
          { id: 'Phonetics_and_Pronunciation', name: 'Phonetics and Pronunciation', hasDomains: false },
          { id: 'Grammar_and_Syntax', name: 'Grammar and Syntax', hasDomains: false },
          { id: 'Semantics_and_Meaning', name: 'Semantics and Meaning', hasDomains: false },
          { id: 'Idioms_and_Expressions', name: 'Idioms and Expressions', hasDomains: false },
          { id: 'Cultural_Context', name: 'Cultural Context', hasDomains: false },
          { id: 'Cultural_Sensitivities', name: 'Cultural Sensitivities', hasDomains: false },
          { id: 'Regional_Variants', name: 'Regional Variants', hasDomains: false },
          { id: 'Countries_and_Regions', name: 'Countries and Regions', hasDomains: false },
          { id: 'Dialects_and_Variations', name: 'Dialects and Variations', hasDomains: false },
          { id: 'Translation_Rules', name: 'Translation Rules', hasDomains: false },
          { id: 'Translation_Constraints', name: 'Translation Constraints', hasDomains: false },
          { id: 'Theological_Language_Considerations', name: 'Theological Language Considerations', hasDomains: false },
          { id: 'Scripture_Translation_Notes', name: 'Scripture Translation Notes', hasDomains: false },
          { id: 'Formal_vs_Informal_Usage', name: 'Formal vs Informal Usage', hasDomains: false },
          { id: 'Historical_Language_Evolution', name: 'Historical Language Evolution', hasDomains: false },
          { id: 'Modern_Usage_Patterns', name: 'Modern Usage Patterns', hasDomains: false },
          { id: 'Loanwords_and_Borrowings', name: 'Loanwords and Borrowings', hasDomains: false },
          { id: 'Language_Accuracy_Metrics', name: 'Language Accuracy Metrics', hasDomains: false },
          { id: 'Validation_and_Review', name: 'Validation and Review', hasDomains: false },
          { id: 'Benchmark_Comparisons', name: 'Benchmark Comparisons', hasDomains: false },
          { id: 'Language_Interoperability', name: 'Language Interoperability', hasDomains: false },
          { id: 'Localization_Guidelines', name: 'Localization Guidelines', hasDomains: false },
          { id: 'Language_Metadata', name: 'Language Metadata', hasDomains: false },
          { id: 'Language_Indexes', name: 'Language Indexes', hasDomains: false }
        ];
      }
      // Users (i4)
      if (collectionId === 'i4') {
        return [
          { id: 'User_Identity', name: 'User Identity', hasDomains: false },
          { id: 'Account_and_Access', name: 'Account and Access', hasDomains: false },
          { id: 'Consent_and_Privacy', name: 'Consent and Privacy', hasDomains: false },
          { id: 'Demographics', name: 'Demographics', hasDomains: false },
          { id: 'Language_and_Culture', name: 'Language and Culture', hasDomains: false },
          { id: 'Location_and_Region', name: 'Location and Region', hasDomains: false },
          { id: 'Spiritual_Background', name: 'Spiritual Background', hasDomains: false },
          { id: 'Faith_Journey', name: 'Faith Journey', hasDomains: false },
          { id: 'Spiritual_Growth', name: 'Spiritual Growth', hasDomains: false },
          { id: 'Prayer_and_Intercession', name: 'Prayer and Intercession', hasDomains: false },
          { id: 'Needs_and_Requests', name: 'Needs and Requests', hasDomains: false },
          { id: 'Struggles_and_Challenges', name: 'Struggles and Challenges', hasDomains: false },
          { id: 'Strengths_and_Gifts', name: 'Strengths and Gifts', hasDomains: false },
          { id: 'Testimonies_and_Praise', name: 'Testimonies and Praise', hasDomains: false },
          { id: 'Community_and_Groups', name: 'Community and Groups', hasDomains: false },
          { id: 'Discipleship_and_Learning', name: 'Discipleship and Learning', hasDomains: false },
          { id: 'Engagement_and_Activity', name: 'Engagement and Activity', hasDomains: false },
          { id: 'Pastoral_Care_Notes', name: 'Pastoral Care Notes', hasDomains: false },
          { id: 'Safety_and_Safeguards', name: 'Safety and Safeguards', hasDomains: false },
          { id: 'Aggregated_Insights', name: 'Aggregated Insights', hasDomains: false }
        ];
      }
      // Analytics (i5)
      if (collectionId === 'i5') {
        return [
          { id: 'User_Analytics', name: 'User Analytics', hasDomains: false },
          { id: 'Ministry_Analytics', name: 'Ministry Analytics', hasDomains: false },
          { id: 'Engagement_Metrics', name: 'Engagement Metrics', hasDomains: false },
          { id: 'Growth_Indicators', name: 'Growth Indicators', hasDomains: false },
          { id: 'Spiritual_Impact_Signals', name: 'Spiritual Impact Signals', hasDomains: false },
          { id: 'Prayer_Activity_Metrics', name: 'Prayer Activity Metrics', hasDomains: false },
          { id: 'Content_Performance', name: 'Content Performance', hasDomains: false },
          { id: 'Resource_Utilization', name: 'Resource Utilization', hasDomains: false },
          { id: 'AI_Behavior_Analytics', name: 'AI Behavior Analytics', hasDomains: false },
          { id: 'Safety_and_Risk_Signals', name: 'Safety and Risk Signals', hasDomains: false },
          { id: 'Community_Trends', name: 'Community Trends', hasDomains: false },
          { id: 'Regional_and_Cultural_Signals', name: 'Regional and Cultural Signals', hasDomains: false },
          { id: 'Temporal_and_Seasonal_Patterns', name: 'Temporal and Seasonal Patterns', hasDomains: false },
          { id: 'System_Health_Metrics', name: 'System Health Metrics', hasDomains: false },
          { id: 'External_Environment_Signals', name: 'External Environment Signals', hasDomains: false },
          { id: 'Aggregated_Insights', name: 'Aggregated Insights', hasDomains: false }
        ];
      }
      // Prompts (i6)
      if (collectionId === 'i6') {
        return [
          { id: 'Prompt_Library', name: 'Prompt Library', hasDomains: false },
          { id: 'Prompt_Templates', name: 'Prompt Templates', hasDomains: false },
          { id: 'System_Prompts', name: 'System Prompts', hasDomains: false },
          { id: 'Persona_Prompts', name: 'Persona Prompts', hasDomains: false },
          { id: 'Model_Prompts', name: 'Model Prompts', hasDomains: false },
          { id: 'User_Prompts', name: 'User Prompts', hasDomains: false },
          { id: 'Workflow_Prompts', name: 'Workflow Prompts', hasDomains: false },
          { id: 'Process_Definitions', name: 'Process Definitions', hasDomains: false },
          { id: 'Prompt_Parameters', name: 'Prompt Parameters', hasDomains: false },
          { id: 'Prompt_Constraints', name: 'Prompt Constraints', hasDomains: false },
          { id: 'Prompt_Versioning', name: 'Prompt Versioning', hasDomains: false },
          { id: 'Prompt_Testing', name: 'Prompt Testing', hasDomains: false },
          { id: 'Prompt_Governance', name: 'Prompt Governance', hasDomains: false },
          { id: 'Prompt_Analytics', name: 'Prompt Analytics', hasDomains: false }
        ];
      }
      // Marketing (i7)
      if (collectionId === 'i7') {
        return [
          { id: 'Messaging_and_Positioning', name: 'Messaging and Positioning', hasDomains: false },
          { id: 'Audience_Segmentation', name: 'Audience Segmentation', hasDomains: false },
          { id: 'Campaign_Strategy', name: 'Campaign Strategy', hasDomains: false },
          { id: 'Content_Distribution', name: 'Content Distribution', hasDomains: false },
          { id: 'Channels_and_Platforms', name: 'Channels and Platforms', hasDomains: false },
          { id: 'Outreach_Funnels', name: 'Outreach Funnels', hasDomains: false },
          { id: 'Engagement_Metrics', name: 'Engagement Metrics', hasDomains: false },
          { id: 'Conversion_Insights', name: 'Conversion Insights', hasDomains: false },
          { id: 'Brand_Identity', name: 'Brand Identity', hasDomains: false },
          { id: 'Creative_Assets', name: 'Creative Assets', hasDomains: false },
          { id: 'Testing_and_Optimization', name: 'Testing and Optimization', hasDomains: false },
          { id: 'Compliance_and_Ethics', name: 'Compliance and Ethics', hasDomains: false }
        ];
      }
      // Countries (i8)
      if (collectionId === 'i8') {
        return [
          { id: 'Country_Profiles', name: 'Country Profiles', hasDomains: false },
          { id: 'Regional_Groupings', name: 'Regional Groupings', hasDomains: false },
          { id: 'Cultural_Context', name: 'Cultural Context', hasDomains: false },
          { id: 'Language_Prevalence', name: 'Language Prevalence', hasDomains: false },
          { id: 'Religious_Landscape', name: 'Religious Landscape', hasDomains: false },
          { id: 'Legal_and_Regulatory', name: 'Legal and Regulatory', hasDomains: false },
          { id: 'Social_Norms', name: 'Social Norms', hasDomains: false },
          { id: 'Historical_Background', name: 'Historical Background', hasDomains: false },
          { id: 'Ministry_Opportunities', name: 'Ministry Opportunities', hasDomains: false },
          { id: 'Ministry_Sensitivities', name: 'Ministry Sensitivities', hasDomains: false },
          { id: 'Digital_Access_and_Usage', name: 'Digital Access and Usage', hasDomains: false },
          { id: 'Economic_Conditions', name: 'Economic Conditions', hasDomains: false },
          { id: 'Security_and_Risk', name: 'Security and Risk', hasDomains: false },
          { id: 'Localization_Guidelines', name: 'Localization Guidelines', hasDomains: false }
        ];
      }
      // Ministers (i9)
      if (collectionId === 'i9') {
        return [
          { id: 'Minister_Identity', name: 'Minister Identity', hasDomains: false },
          { id: 'Roles_and_Assignments', name: 'Roles and Assignments', hasDomains: false },
          { id: 'Skills_and_Abilities', name: 'Skills and Abilities', hasDomains: false },
          { id: 'Training_and_Certification', name: 'Training and Certification', hasDomains: false },
          { id: 'Fivefold_Alignment', name: 'Fivefold Alignment', hasDomains: false },
          { id: 'Spiritual_Maturity', name: 'Spiritual Maturity', hasDomains: false },
          { id: 'Availability_and_Capacity', name: 'Availability and Capacity', hasDomains: false },
          { id: 'Performance_and_Growth', name: 'Performance and Growth', hasDomains: false },
          { id: 'Accountability_and_Oversight', name: 'Accountability and Oversight', hasDomains: false },
          { id: 'Care_and_Support', name: 'Care and Support', hasDomains: false },
          { id: 'Ethics_and_Conduct', name: 'Ethics and Conduct', hasDomains: false },
          { id: 'Succession_and_Development', name: 'Succession and Development', hasDomains: false }
        ];
      }
      // Gabriel (Pastoral Voice) (a5)
      if (collectionId === 'a5') {
        return [
          { id: 'Pastoral_Tone', name: 'Pastoral Tone', hasDomains: false },
          { id: 'Encouragement_and_Care', name: 'Encouragement and Care', hasDomains: false },
          { id: 'Guidance_and_Counsel', name: 'Guidance and Counsel', hasDomains: false },
          { id: 'Prayer_and_Intercession', name: 'Prayer and Intercession', hasDomains: false },
          { id: 'Scripture_Application', name: 'Scripture Application', hasDomains: false },
          { id: 'Emotional_Support', name: 'Emotional Support', hasDomains: false },
          { id: 'Conflict_and_Reconciliation', name: 'Conflict and Reconciliation', hasDomains: false },
          { id: 'Teaching_by_Example', name: 'Teaching by Example', hasDomains: false },
          { id: 'Correspondence_and_Response', name: 'Correspondence and Response', hasDomains: false },
          { id: 'Pastoral_Boundaries', name: 'Pastoral Boundaries', hasDomains: false }
        ];
      }
      // All Persona collections (a6-a17) get Stage 01-32 with short names
      const personaCollectionIds = ['a6', 'a7', 'a8', 'a9', 'a10', 'a11', 'a12', 'a13', 'a14', 'a15', 'a16', 'a17'];
      if (personaCollectionIds.includes(collectionId)) {
        const stageNames = [
          'Awakening', 'Curiosity', 'Empathy', 'Imitation',
          'Confidence', 'Obedience', 'Cooperation', 'Discovery',
          'Identity', 'Discernment', 'Stewardship', 'Resilience',
          'Calling', 'Teaching', 'Integrity', 'Maturity',
          'Authority', 'Compassion', 'Wisdom', 'Multiplication',
          'Endurance', 'Perspective', 'Mastery', 'Alignment',
          'Legacy', 'Counsel', 'Stability', 'Mentorship',
          'Integration', 'Kingdom', 'Faithfulness', 'Commissioned'
        ];
        return stageNames.map((name, i) => ({
          id: 'stage' + (i + 1),
          name: 'Stage ' + String(i + 1).padStart(2, '0') + '  ' + name,
          hasDomains: true
        }));
      }
      // Persona Index (a18)
      if (collectionId === 'a18') {
        return [
          { id: 'Persona_Registry', name: 'Persona Registry', hasDomains: false },
          { id: 'Persona_Status', name: 'Persona Status', hasDomains: false },
          { id: 'Persona_Roles', name: 'Persona Roles', hasDomains: false },
          { id: 'Persona_Families', name: 'Persona Families', hasDomains: false },
          { id: 'Persona_Permissions', name: 'Persona Permissions', hasDomains: false },
          { id: 'Persona_Lifecycle', name: 'Persona Lifecycle', hasDomains: false },
          { id: 'Persona_Dependencies', name: 'Persona Dependencies', hasDomains: false },
          { id: 'Persona_Metadata', name: 'Persona Metadata', hasDomains: false }
        ];
      }
      // Model Registry (o0)
      if (collectionId === 'o0') {
        return [
          { id: 'Model_Catalog', name: 'Model Catalog', hasDomains: false },
          { id: 'Model_Purpose', name: 'Model Purpose', hasDomains: false },
          { id: 'Fivefold_Alignment', name: 'Fivefold Alignment', hasDomains: false },
          { id: 'Model_Capabilities', name: 'Model Capabilities', hasDomains: false },
          { id: 'Model_Constraints', name: 'Model Constraints', hasDomains: false },
          { id: 'Model_Versions', name: 'Model Versions', hasDomains: false },
          { id: 'Model_Dependencies', name: 'Model Dependencies', hasDomains: false },
          { id: 'Model_Metadata', name: 'Model Metadata', hasDomains: false }
        ];
      }
      // Execution Contracts (o6)
      if (collectionId === 'o6') {
        return [
          { id: 'Execution_Order', name: 'Execution Order', hasDomains: false },
          { id: 'Mandatory_Activations', name: 'Mandatory Activations', hasDomains: false },
          { id: 'Conditional_Activations', name: 'Conditional Activations', hasDomains: false },
          { id: 'Execution_Preconditions', name: 'Execution Preconditions', hasDomains: false },
          { id: 'Execution_Safeguards', name: 'Execution Safeguards', hasDomains: false },
          { id: 'Escalation_Rules', name: 'Escalation Rules', hasDomains: false },
          { id: 'Failure_Handling', name: 'Failure Handling', hasDomains: false },
          { id: 'Execution_Metadata', name: 'Execution Metadata', hasDomains: false }
        ];
      }
      // Endgame (o0a)
      if (collectionId === 'o0a') {
        return [
          { id: 'Goals_Catalog', name: 'Goals Catalog', hasDomains: true },
          { id: 'Vision_Statements', name: 'Vision Statements', hasDomains: true },
          { id: 'Success_Criteria', name: 'Success Criteria', hasDomains: false },
          { id: 'Constraints', name: 'Constraints', hasDomains: false },
          { id: 'Scope_and_Permissions', name: 'Scope and Permissions', hasDomains: false },
          { id: 'Acceptance_Tests', name: 'Acceptance Tests', hasDomains: false },
          { id: 'OODA_Settings', name: 'OODA Settings', hasDomains: false },
          { id: 'Autonomy_Levels', name: 'Autonomy Levels', hasDomains: false },
          { id: 'Progress_Tracking', name: 'Progress Tracking', hasDomains: false },
          { id: 'Endgame_Metadata', name: 'Endgame Metadata', hasDomains: false }
        ];
      }
      // Experiments (o0b)
      if (collectionId === 'o0b') {
        return [
          { id: 'Experiment_Catalog', name: 'Experiment Catalog', hasDomains: false },
          { id: 'Strategy_Variants', name: 'Strategy Variants', hasDomains: false },
          { id: 'Self_Play_Matches', name: 'Self Play Matches', hasDomains: false },
          { id: 'Failed_Attempts', name: 'Failed Attempts', hasDomains: false },
          { id: 'Alternative_Paths', name: 'Alternative Paths', hasDomains: false },
          { id: 'Simulation_Results', name: 'Simulation Results', hasDomains: false },
          { id: 'Constraint_Violations', name: 'Constraint Violations', hasDomains: false },
          { id: 'Persona_Contributions', name: 'Persona Contributions', hasDomains: false },
          { id: 'Resource_Utilization', name: 'Resource Utilization', hasDomains: false },
          { id: 'Experiment_Metadata', name: 'Experiment Metadata', hasDomains: false }
        ];
      }
      // Learning Memory (o0c)
      if (collectionId === 'o0c') {
        return [
          { id: 'Learned_Patterns', name: 'Learned Patterns', hasDomains: false },
          { id: 'Proven_Strategies', name: 'Proven Strategies', hasDomains: false },
          { id: 'Optimization_Heuristics', name: 'Optimization Heuristics', hasDomains: false },
          { id: 'Discernment_Insights', name: 'Discernment Insights', hasDomains: false },
          { id: 'Persona_Effectiveness', name: 'Persona Effectiveness', hasDomains: false },
          { id: 'Routing_Improvements', name: 'Routing Improvements', hasDomains: false },
          { id: 'Cultural_Learnings', name: 'Cultural Learnings', hasDomains: false },
          { id: 'Language_Learnings', name: 'Language Learnings', hasDomains: false },
          { id: 'Reusable_Playbooks', name: 'Reusable Playbooks', hasDomains: false },
          { id: 'Learning_Metadata', name: 'Learning Metadata', hasDomains: false }
        ];
      }
      // Evaluation (o0d)
      if (collectionId === 'o0d') {
        return [
          { id: 'Biblical_Compliance', name: 'Biblical Compliance', hasDomains: false },
          { id: 'Doctrinal_Alignment', name: 'Doctrinal Alignment', hasDomains: false },
          { id: 'Governance_Compliance', name: 'Governance Compliance', hasDomains: false },
          { id: 'Endgame_Effectiveness', name: 'Endgame Effectiveness', hasDomains: false },
          { id: 'Risk_Assessment', name: 'Risk Assessment', hasDomains: false },
          { id: 'Confidence_Scoring', name: 'Confidence Scoring', hasDomains: false },
          { id: 'Quality_Thresholds', name: 'Quality Thresholds', hasDomains: false },
          { id: 'Rejection_Reasons', name: 'Rejection Reasons', hasDomains: false },
          { id: 'Promotion_Decisions', name: 'Promotion Decisions', hasDomains: false },
          { id: 'Evaluation_Metadata', name: 'Evaluation Metadata', hasDomains: false }
        ];
      }
      // Execution Logs (o0e)
      if (collectionId === 'o0e') {
        return [
          { id: 'Execution_Timeline', name: 'Execution Timeline', hasDomains: false },
          { id: 'Activated_Collections', name: 'Activated Collections', hasDomains: false },
          { id: 'Activated_Models', name: 'Activated Models', hasDomains: false },
          { id: 'Persona_Usage', name: 'Persona Usage', hasDomains: false },
          { id: 'Decision_Paths', name: 'Decision Paths', hasDomains: false },
          { id: 'Escalation_Events', name: 'Escalation Events', hasDomains: false },
          { id: 'Error_and_Exception_Records', name: 'Error and Exception Records', hasDomains: false },
          { id: 'Performance_Metrics', name: 'Performance Metrics', hasDomains: false },
          { id: 'Audit_Trails', name: 'Audit Trails', hasDomains: false },
          { id: 'Log_Metadata', name: 'Log Metadata', hasDomains: false }
        ];
      }
      // Scenarios (o0f)
      if (collectionId === 'o0f') {
        return [
          { id: 'Scenario_Library', name: 'Scenario Library', hasDomains: false },
          { id: 'Ministry_Contexts', name: 'Ministry Contexts', hasDomains: false },
          { id: 'Cultural_Contexts', name: 'Cultural Contexts', hasDomains: false },
          { id: 'Crisis_Scenarios', name: 'Crisis Scenarios', hasDomains: false },
          { id: 'Evangelism_Scenarios', name: 'Evangelism Scenarios', hasDomains: false },
          { id: 'Discipleship_Scenarios', name: 'Discipleship Scenarios', hasDomains: false },
          { id: 'Language_Scenarios', name: 'Language Scenarios', hasDomains: false },
          { id: 'Regional_Scenarios', name: 'Regional Scenarios', hasDomains: false },
          { id: 'Risk_Profiles', name: 'Risk Profiles', hasDomains: false },
          { id: 'Scenario_Metadata', name: 'Scenario Metadata', hasDomains: false }
        ];
      }
      // Insights (i10)
      if (collectionId === 'i10') {
        return [
          { id: 'Aggregation_Rules', name: 'Aggregation Rules', hasDomains: false },
          { id: 'Anonymization_Policies', name: 'Anonymization Policies', hasDomains: false },
          { id: 'Trend_Analysis', name: 'Trend Analysis', hasDomains: false },
          { id: 'Behavioral_Patterns', name: 'Behavioral Patterns', hasDomains: false },
          { id: 'Spiritual_Indicators', name: 'Spiritual Indicators', hasDomains: false },
          { id: 'Risk_Signals', name: 'Risk Signals', hasDomains: false },
          { id: 'Reporting_Views', name: 'Reporting Views', hasDomains: false },
          { id: 'Aggregation_Metadata', name: 'Aggregation Metadata', hasDomains: false }
        ];
      }
      // Default: return empty for other collections (or add more as needed)
      return [];
    }

    // Select a subcategory
    function selectSubcategory(subcategoryId, parentCollectionId, sectionId) {
      selectedCollectionId = parentCollectionId;
      selectedSection = sectionId;
      selectedItemId = subcategoryId;

      // Save state to localStorage
      saveStateToStorage();

      // Update UI - remove active from all collection rows and subcategory items
      document.querySelectorAll('.collection-item-row').forEach(row => row.classList.remove('active'));
      document.querySelectorAll('.subcategory-item').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.stage-item-row').forEach(row => row.classList.remove('active'));

      // Activate the clicked subcategory/stage row (NOT the parent collection)
      const stageRow = document.querySelector(`.stage-item[data-subcategory-id="${subcategoryId}"] .stage-item-row`);
      if (stageRow) {
        stageRow.classList.add('active');
      } else {
        // Try stage-id for stages with domains
        const stageRowAlt = document.querySelector(`.stage-item[data-stage-id="${subcategoryId}"] .stage-item-row`);
        if (stageRowAlt) stageRowAlt.classList.add('active');
      }

      // Also try old subcategory-item class
      const subItem = document.querySelector(`.subcategory-item[data-subcategory-id="${subcategoryId}"]`);
      if (subItem) subItem.classList.add('active');

      // Update context display to show the subcategory name
      const subcategories = getSubcategoriesForCollection(parentCollectionId);
      const subcategory = subcategories.find(s => s.id === subcategoryId);
      if (subcategory) {
        document.getElementById('contextDisplay').textContent = subcategory.name;
      }

      // Load domains/children into the middle panel if this subcategory has domains
      if (subcategory && subcategory.hasDomains) {
        loadDomainsIntoItemsPanel(subcategoryId, parentCollectionId);
      } else {
        // Load this specific subcategory item into the editor
        loadSubcategoryItem(subcategoryId, parentCollectionId);
      }
    }

    // Stage subtitles for Jubilee Inspire (used when loading into editor)
    const stageSubtitles = [
      'Identity awakens, trust is formed',
      'Curiosity and expression emerge',
      'Early empathy and moral sense',
      'Learning by imitation and pattern',
      'Confidence and initiative grow',
      'Boundaries and obedience develop',
      'Social awareness and cooperation',
      'Gifts and creative joy appear',
      'Identity strengthens with guidance',
      'Discernment and reflection deepen',
      'Responsibility and stewardship rise',
      'Emotional resilience increases',
      'Calling begins to take shape',
      'Teaching and clarity improve',
      'Integrity tested under pressure',
      'Balanced maturity and humility',
      'Authority exercised with care',
      'Shepherding compassion expands',
      'Discernment becomes refined',
      'Investing intentionally in others',
      'Endurance through complexity grows',
      'Long-term vision broadens',
      'Teaching depth and reach mature',
      'Spiritual authority stabilizes',
      'Legacy and continuity awareness',
      'Wisdom shared with restraint',
      'Calm leadership under pressure',
      'Mentorship becomes central',
      'Identity and calling align',
      'Kingdom-first decision making',
      'Mature authority with humility',
      'Seasoned wisdom and joyful service'
    ];

    // Load a specific subcategory item
    function loadSubcategoryItem(subcategoryId, parentCollectionId) {
      const subcategories = getSubcategoriesForCollection(parentCollectionId);
      const sub = subcategories.find(s => s.id === subcategoryId);

      if (sub) {
        // Get stage number and subtitle
        const stageNum = parseInt(subcategoryId.replace('stage', ''));
        const subtitle = stageSubtitles[stageNum - 1] || '';

        // Show single item in items list
        items = [{
          id: sub.id,
          name: sub.name,
          title: subtitle,
          description: 'Stage configuration for ' + parentCollectionId,
          is_active: true
        }];
        renderItems();
        // Auto-select it
        selectItem(sub.id);
      }
    }

    // ==================== SELECT COLLECTION ====================
    function selectCollection(collectionId, sectionId) {
      console.log('selectCollection called:', collectionId, sectionId);
      selectedCollectionId = collectionId;
      selectedSection = sectionId;
      selectedItemId = null;

      // Save state to localStorage
      saveStateToStorage();

      // Update UI - remove active from all rows first, then add to selected
      document.querySelectorAll('.collection-item-row').forEach(row => {
        row.classList.remove('active');
      });
      document.querySelectorAll('.subcategory-item').forEach(item => {
        item.classList.remove('active');
      });

      // Find and activate the clicked item
      const selectedItem = document.querySelector(`.collection-item[data-id="${collectionId}"] .collection-item-row`);
      if (selectedItem) {
        selectedItem.classList.add('active');
      }

      // Update context display
      const collection = collections[sectionId].find(c => c.id === collectionId);
      if (collection) {
        document.getElementById('contextDisplay').textContent = collection.name;
      }

      // Load items for this collection
      loadItems(collectionId);

      // Clear item selection
      clearItemSelection();
    }

    // ==================== LOAD ITEMS ====================
    async function loadItems(collectionId) {
      const container = document.getElementById('itemsListContent');
      container.innerHTML = '<div class="tree-loading">Loading items...</div>';

      // Check if this is the Inspire Family collection (a4) - load from database
      if (collectionId === 'a4') {
        await loadInspireFamilyCategories();
      } else {
        // Load demo items for other collections
        loadDemoItems(collectionId);
      }
    }

    // ==================== INSPIRE FAMILY DATABASE INTEGRATION ====================
    let inspireFamilyCategories = [];
    let selectedCategoryId = null;

    async function loadInspireFamilyCategories() {
      const container = document.getElementById('itemsListContent');

      try {
        const response = await fetch('/api/admin/collections/inspire-family/categories', {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });

        // Read response as text first to handle non-JSON responses
        const responseText = await response.text();

        // Check if response is OK
        if (!response.ok) {
          // Check if we got HTML (auth redirect) instead of JSON
          if (responseText.startsWith('<') || responseText.startsWith('<!DOCTYPE')) {
            console.error('Received HTML instead of JSON - possible authentication redirect');
            container.innerHTML = '<div class="tree-loading">Session expired. Please <a href="/login">log in</a> again.</div>';
            return;
          }
          // Try to parse error JSON
          try {
            const errorData = JSON.parse(responseText);
            container.innerHTML = '<div class="tree-loading">Error: ' + (errorData.message || errorData.error || 'Unknown error') + '</div>';
          } catch {
            container.innerHTML = '<div class="tree-loading">Error loading categories: HTTP ' + response.status + '</div>';
          }
          return;
        }

        // Parse successful response as JSON
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Failed to parse JSON response:', responseText.substring(0, 200));
          container.innerHTML = '<div class="tree-loading">Invalid response from server</div>';
          return;
        }

        if (!data.success) {
          container.innerHTML = '<div class="tree-loading">Error loading categories: ' + (data.message || 'Unknown error') + '</div>';
          return;
        }

        inspireFamilyCategories = data.categories || [];
        renderInspireFamilyCategories();
      } catch (error) {
        console.error('Error loading Inspire Family categories:', error);
        container.innerHTML = '<div class="tree-loading">Error loading categories: ' + error.message + '</div>';
      }
    }

    // Load Inspire Family categories into the LEFT panel (subcategories area under collection)
    // DEPRECATED: Use loadCollectionCategoriesIntoPanel instead
    async function loadInspireFamilyCategoriesIntoPanel(container) {
      return loadCollectionCategoriesIntoPanel(container, 'inspire-family', 'a4');
    }

    // Unified function to load categories for ANY collection into the LEFT panel
    async function loadCollectionCategoriesIntoPanel(container, collectionSlug, collectionId) {
      try {
        const response = await fetch('/api/admin/collections/' + collectionSlug + '/categories', {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });

        const responseText = await response.text();

        if (!response.ok) {
          if (responseText.startsWith('<') || responseText.startsWith('<!DOCTYPE')) {
            container.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #ff6b6b;">Session expired. Please log in.</div>';
            return;
          }
          // API error (404, etc.) - try fallback categories before showing error
          const fallbackCategories = getSubcategoriesForCollection(collectionId);
          if (fallbackCategories.length > 0) {
            container.innerHTML = renderFallbackSubcategories(fallbackCategories, collectionId);
            attachFallbackCategoryHandlers(container, collectionId);
            return;
          }
          container.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #888;">No categories available</div>';
          return;
        }

        let data;
        try {
          data = JSON.parse(responseText);
        } catch {
          container.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #ff6b6b;">Invalid response</div>';
          return;
        }

        if (!data.success || !data.categories || data.categories.length === 0) {
          // No database categories found - fall back to hardcoded subcategories
          const fallbackCategories = getSubcategoriesForCollection(collectionId);
          if (fallbackCategories.length > 0) {
            container.innerHTML = renderFallbackSubcategories(fallbackCategories, collectionId);
            attachFallbackCategoryHandlers(container, collectionId);
          } else {
            container.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #888;">No categories found</div>';
          }
          return;
        }

        // Store categories for later use (keyed by collection slug)
        if (!window.collectionCategories) window.collectionCategories = {};
        window.collectionCategories[collectionSlug] = data.categories;

        // Special handling for Inspire Family to maintain backward compatibility
        if (collectionSlug === 'inspire-family') {
          inspireFamilyCategories = data.categories;
        }

        // Render categories in the left panel
        container.innerHTML = renderCollectionPanelCategories(data.categories, 0, collectionId, collectionSlug);

        // Attach event handlers
        attachCollectionPanelHandlers(container, collectionId, collectionSlug);
      } catch (error) {
        console.error('Error loading ' + collectionSlug + ' categories into panel:', error);
        // Network/fetch error - try fallback categories before showing error
        const fallbackCategories = getSubcategoriesForCollection(collectionId);
        if (fallbackCategories.length > 0) {
          container.innerHTML = renderFallbackSubcategories(fallbackCategories, collectionId);
          attachFallbackCategoryHandlers(container, collectionId);
          return;
        }
        container.innerHTML = '<div class="tree-loading" style="padding: 8px 16px; color: #888;">No categories available</div>';
      }
    }

    // Render fallback subcategories (from getSubcategoriesForCollection) when DB has no data
    function renderFallbackSubcategories(subcategories, collectionId) {
      let html = '';
      subcategories.forEach((sub, idx) => {
        const stageIsExpanded = expandedCollections.has(sub.id);
        if (sub.hasDomains) {
          // Stage with domains underneath
          const domains = getDomainsForStage(sub.id);
          html += `
            <div class="stage-item ${stageIsExpanded ? 'expanded' : ''}" data-stage-id="${sub.id}" data-parent-id="${collectionId}">
              <div class="stage-item-row ${selectedItemId === sub.id ? 'active' : ''}">
                <span class="stage-expand-toggle" data-stage-id="${sub.id}">${stageIsExpanded ? '' : '+'}</span>
                <span class="subcategory-number">${String(idx + 1).padStart(2, '0')}</span>
                <span class="subcategory-name">${sub.name}</span>
              </div>
              <div class="stage-domains" id="domains-${sub.id}">
                ${domains.map((domain, domIdx) => {
                  const domainIsExpanded = expandedCollections.has(sub.id + '_' + domain.id);
                  return `
                    <div class="domain-item ${domainIsExpanded ? 'expanded' : ''}" data-domain-id="${domain.id}" data-stage-id="${sub.id}" data-parent-id="${collectionId}">
                      <div class="domain-item-row">
                        <span class="domain-expand-toggle" data-domain-id="${domain.id}" data-stage-id="${sub.id}">${domainIsExpanded ? '' : '+'}</span>
                        <span class="domain-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                        <span class="domain-name">${domain.name}</span>
                      </div>
                      <div class="domain-children" id="children-${sub.id}-${domain.id}">
                        ${domain.children.map(child => {
                          if (typeof child === 'object') {
                            const nestedExpandKey = sub.id + '_' + domain.id + '_' + child.id;
                            const nestedIsExpanded = expandedCollections.has(nestedExpandKey);
                            return `
                              <div class="nested-parent-item ${nestedIsExpanded ? 'expanded' : ''}" data-child-id="${child.id}" data-domain-id="${domain.id}" data-stage-id="${sub.id}">
                                <div class="child-item-row">
                                  <span class="child-expand-toggle" data-child-id="${child.id}" data-domain-id="${domain.id}" data-stage-id="${sub.id}">${nestedIsExpanded ? '' : '+'}</span>
                                  <span class="child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                                  <span class="child-name">${child.name}</span>
                                </div>
                                <div class="nested-children">
                                  ${child.children.map(nestedChild => `
                                    <div class="nested-child-item" data-nested-id="${nestedChild}" data-parent-child-id="${child.id}" data-domain-id="${domain.id}" data-stage-id="${sub.id}">
                                      <span class="nested-child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                                      <span class="child-name">${nestedChild.replace(/_/g, ' ')}</span>
                                    </div>
                                  `).join('')}
                                </div>
                              </div>
                            `;
                          } else {
                            return `
                              <div class="child-item" data-child-id="${child}" data-domain-id="${domain.id}" data-stage-id="${sub.id}">
                                <span class="child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                                <span class="child-name">${child.replace(/_/g, ' ')}</span>
                              </div>
                            `;
                          }
                        }).join('')}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        } else {
          // Simple subcategory without domains - use stage-item structure for consistent styling
          html += `
            <div class="stage-item no-children" data-subcategory-id="${sub.id}" data-parent-id="${collectionId}">
              <div class="stage-item-row ${selectedItemId === sub.id ? 'active' : ''}">
                <span class="subcategory-number">${String(idx + 1).padStart(2, '0')}</span>
                <span class="subcategory-name">${sub.name}</span>
              </div>
            </div>
          `;
        }
      });
      return html;
    }

    // Attach handlers for fallback categories
    function attachFallbackCategoryHandlers(container, collectionId) {
      // Simple subcategory clicks
      container.querySelectorAll('.subcategory-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();
          const subcategoryId = this.dataset.subcategoryId;
          const parentId = this.dataset.parentId;
          // Find which section this collection belongs to
          const collection = getCollectionById(parentId);
          const sectionId = collection ? getSectionIdForCollection(collection) : 'authority';
          selectSubcategory(subcategoryId, parentId, sectionId);
        });
      });

      // Stage expand toggles
      container.querySelectorAll('.stage-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const stageItem = this.closest('.stage-item');
          const stageId = stageItem.dataset.stageId;
          const isExpanded = stageItem.classList.toggle('expanded');
          this.textContent = isExpanded ? '' : '+';
          if (isExpanded) {
            expandedCollections.add(stageId);
          } else {
            expandedCollections.delete(stageId);
          }
          saveStateToStorage();
        });
      });

      // Stage row clicks (handles both stages with domains and simple subcategories)
      container.querySelectorAll('.stage-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('stage-expand-toggle')) return;
          event.stopPropagation();
          const stageItem = this.closest('.stage-item');
          // Check for subcategoryId first (simple items), then stageId (expandable stages)
          const itemId = stageItem.dataset.subcategoryId || stageItem.dataset.stageId;
          const parentId = stageItem.dataset.parentId;
          const collection = getCollectionById(parentId);
          const sectionId = collection ? getSectionIdForCollection(collection) : 'authority';
          selectSubcategory(itemId, parentId, sectionId);
        });
      });

      // Domain expand toggles
      container.querySelectorAll('.domain-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const domainItem = this.closest('.domain-item');
          const domainId = domainItem.dataset.domainId;
          const stageId = domainItem.dataset.stageId;
          const expandKey = stageId + '_' + domainId;
          const isExpanded = domainItem.classList.toggle('expanded');
          this.textContent = isExpanded ? '' : '+';
          if (isExpanded) {
            expandedCollections.add(expandKey);
          } else {
            expandedCollections.delete(expandKey);
          }
          saveStateToStorage();
        });
      });

      // Domain row clicks
      container.querySelectorAll('.domain-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('domain-expand-toggle')) return;
          event.stopPropagation();
          const domainItem = this.closest('.domain-item');
          const domainId = domainItem.dataset.domainId;
          const stageId = domainItem.dataset.stageId;
          const parentId = domainItem.dataset.parentId;
          const collection = getCollectionById(parentId);
          const sectionId = collection ? getSectionIdForCollection(collection) : 'authority';
          selectDomainItem(stageId, domainId, parentId, sectionId);
        });
      });

      // Child item clicks
      container.querySelectorAll('.child-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();
          const childId = this.dataset.childId;
          const domainId = this.dataset.domainId;
          const stageId = this.dataset.stageId;
          const collection = getCollectionById(collectionId);
          const sectionId = collection ? getSectionIdForCollection(collection) : 'authority';
          selectChildItem(stageId, domainId, childId, sectionId);
        });
      });

      // Child expand toggles
      container.querySelectorAll('.child-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const nestedParent = this.closest('.nested-parent-item');
          const childId = this.dataset.childId;
          const domainId = this.dataset.domainId;
          const stageId = this.dataset.stageId;
          const expandKey = stageId + '_' + domainId + '_' + childId;
          const isExpanded = nestedParent.classList.toggle('expanded');
          this.textContent = isExpanded ? '' : '+';
          if (isExpanded) {
            expandedCollections.add(expandKey);
          } else {
            expandedCollections.delete(expandKey);
          }
          saveStateToStorage();
        });
      });

      // Child row clicks
      container.querySelectorAll('.child-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('child-expand-toggle')) return;
          event.stopPropagation();
          const nestedParent = this.closest('.nested-parent-item');
          const childId = nestedParent.dataset.childId;
          const domainId = nestedParent.dataset.domainId;
          const stageId = nestedParent.dataset.stageId;
          const collection = getCollectionById(collectionId);
          const sectionId = collection ? getSectionIdForCollection(collection) : 'authority';
          selectChildItem(stageId, domainId, childId, sectionId);
        });
      });

      // Nested child item clicks
      container.querySelectorAll('.nested-child-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();
          const nestedId = this.dataset.nestedId;
          const parentChildId = this.dataset.parentChildId;
          const domainId = this.dataset.domainId;
          const stageId = this.dataset.stageId;
          const collection = getCollectionById(collectionId);
          const sectionId = collection ? getSectionIdForCollection(collection) : 'authority';
          selectNestedChildItem(stageId, domainId, parentChildId, nestedId, sectionId);
        });
      });
    }

    // Helper to get section ID for a collection
    function getSectionIdForCollection(collection) {
      if (collections.authority.includes(collection)) return 'authority';
      if (collections.orchestration.includes(collection)) return 'orchestration';
      if (collections.interaction.includes(collection)) return 'interaction';
      return 'authority';
    }

    // Unified render function for collection panel categories (from database)
    function renderCollectionPanelCategories(categories, level, collectionId, collectionSlug) {
      let html = '';
      const expandKeyPrefix = collectionSlug + '_panel_';

      categories.forEach((cat, idx) => {
        const expandKey = expandKeyPrefix + cat.id;
        const isExpanded = expandedCollections.has(expandKey);
        const hasChildren = cat.children && cat.children.length > 0;
        const itemCount = cat.item_count || 0;

        if (level === 0) {
          // Level 0: Root categories - format like stages with numbers
          html += `
            <div class="stage-item ${isExpanded ? 'expanded' : ''} ${!hasChildren ? 'no-children' : ''}" data-stage-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}" data-parent-id="${collectionId}">
              <div class="stage-item-row ${selectedCategoryId === cat.id ? 'active' : ''}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                ${hasChildren
                  ? '<span class="stage-expand-toggle" data-expand-key="' + expandKey + '">' + (isExpanded ? '' : '+') + '</span>'
                  : '<span class="stage-expand-toggle empty"></span>'}
                <span class="subcategory-number">${String(idx + 1).padStart(2, '0')}</span>
                <span class="subcategory-name">${cat.name}</span>
                ${itemCount > 0 ? '<span class="if-panel-count">' + itemCount + '</span>' : ''}
              </div>
              ${hasChildren ? `
                <div class="stage-domains" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderCollectionPanelCategories(cat.children, level + 1, collectionId, collectionSlug)}
                </div>
              ` : ''}
            </div>
          `;
        } else if (level === 1) {
          // Level 1: Second level - format like domains with folder icon
          html += `
            <div class="domain-item ${isExpanded ? 'expanded' : ''} ${!hasChildren ? 'no-children' : ''}" data-domain-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
              <div class="domain-item-row" data-category-id="${cat.id}" data-slug="${cat.slug}">
                ${hasChildren
                  ? '<span class="domain-expand-toggle" data-expand-key="' + expandKey + '">' + (isExpanded ? '' : '+') + '</span>'
                  : '<span class="domain-expand-toggle empty"></span>'}
                <span class="domain-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                <span class="domain-name">${cat.name}</span>
                ${itemCount > 0 ? '<span class="if-panel-count">' + itemCount + '</span>' : ''}
              </div>
              ${hasChildren ? `
                <div class="domain-children" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderCollectionPanelCategories(cat.children, level + 1, collectionId, collectionSlug)}
                </div>
              ` : ''}
            </div>
          `;
        } else if (level === 2) {
          // Level 2: Third level - child items (expandable if has children)
          if (hasChildren) {
            html += `
              <div class="nested-parent-item ${isExpanded ? 'expanded' : ''}" data-child-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <div class="child-item-row" data-category-id="${cat.id}" data-slug="${cat.slug}">
                  <span class="child-expand-toggle" data-expand-key="${expandKey}">${isExpanded ? '' : '+'}</span>
                  <span class="child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                  <span class="child-name">${cat.name}</span>
                  ${itemCount > 0 ? '<span class="if-panel-count">' + itemCount + '</span>' : ''}
                </div>
                <div class="nested-children" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderCollectionPanelCategories(cat.children, level + 1, collectionId, collectionSlug)}
                </div>
              </div>
            `;
          } else {
            html += `
              <div class="child-item" data-child-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <span style="width: 20px; display: inline-block;"></span>
                <span class="child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                <span class="child-name">${cat.name}</span>
                ${itemCount > 0 ? '<span class="if-panel-count">' + itemCount + '</span>' : ''}
              </div>
            `;
          }
        } else {
          // Level 3+: Deeper nested items
          if (hasChildren) {
            html += `
              <div class="nested-child-parent ${isExpanded ? 'expanded' : ''}" data-nested-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <div class="nested-child-item-row" data-category-id="${cat.id}" data-slug="${cat.slug}">
                  <span class="nested-expand-toggle" data-expand-key="${expandKey}">${isExpanded ? '' : '+'}</span>
                  <span class="nested-child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                  <span class="child-name">${cat.name}</span>
                  ${itemCount > 0 ? '<span class="if-panel-count">' + itemCount + '</span>' : ''}
                </div>
                <div class="deep-nested-children" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderCollectionPanelCategories(cat.children, level + 1, collectionId, collectionSlug)}
                </div>
              </div>
            `;
          } else {
            html += `
              <div class="nested-child-item" data-nested-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <span style="width: 20px; display: inline-block;"></span>
                <span class="nested-child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                <span class="child-name">${cat.name}</span>
                ${itemCount > 0 ? '<span class="if-panel-count">' + itemCount + '</span>' : ''}
              </div>
            `;
          }
        }
      });
      return html;
    }

    // Unified handler attachment for collection panel categories
    function attachCollectionPanelHandlers(container, collectionId, collectionSlug) {
      const collection = getCollectionById(collectionId);
      const sectionId = collection ? getSectionIdForCollection(collection) : 'authority';
      const expandKeyPrefix = collectionSlug + '_panel_';

      // Helper to clear all active states
      function clearActive() {
        container.querySelectorAll('.stage-item-row, .domain-item-row, .child-item-row, .child-item, .nested-child-item, .nested-child-item-row').forEach(el => {
          el.classList.remove('active');
        });
      }

      // Stage expand toggles
      container.querySelectorAll('.stage-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const stageItem = this.closest('.stage-item');
          const domainsContainer = stageItem.querySelector('.stage-domains');
          const isExpanded = !stageItem.classList.contains('expanded');

          stageItem.classList.toggle('expanded', isExpanded);
          this.textContent = isExpanded ? '' : '+';
          if (domainsContainer) domainsContainer.style.display = isExpanded ? 'block' : 'none';

          if (isExpanded) {
            expandedCollections.add(expandKey);
          } else {
            expandedCollections.delete(expandKey);
          }
          saveStateToStorage();
        });
      });

      // Stage row clicks
      container.querySelectorAll('.stage-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('stage-expand-toggle')) return;
          event.stopPropagation();
          clearActive();
          this.classList.add('active');
          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;
          selectedCategoryId = categoryId;
          loadCategoryItems(collectionSlug, categorySlug, categoryId);
        });
      });

      // Domain expand toggles
      container.querySelectorAll('.domain-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const domainItem = this.closest('.domain-item');
          const childrenContainer = domainItem.querySelector('.domain-children');
          const isExpanded = !domainItem.classList.contains('expanded');

          domainItem.classList.toggle('expanded', isExpanded);
          this.textContent = isExpanded ? '' : '+';
          if (childrenContainer) childrenContainer.style.display = isExpanded ? 'block' : 'none';

          if (isExpanded) {
            expandedCollections.add(expandKey);
          } else {
            expandedCollections.delete(expandKey);
          }
          saveStateToStorage();
        });
      });

      // Domain row clicks
      container.querySelectorAll('.domain-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('domain-expand-toggle')) return;
          event.stopPropagation();
          clearActive();
          this.classList.add('active');
          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;
          selectedCategoryId = categoryId;
          loadCategoryItems(collectionSlug, categorySlug, categoryId);
        });
      });

      // Child expand toggles
      container.querySelectorAll('.child-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const nestedParent = this.closest('.nested-parent-item');
          const childrenContainer = nestedParent.querySelector('.nested-children');
          const isExpanded = !nestedParent.classList.contains('expanded');

          nestedParent.classList.toggle('expanded', isExpanded);
          this.textContent = isExpanded ? '' : '+';
          if (childrenContainer) childrenContainer.style.display = isExpanded ? 'block' : 'none';

          if (isExpanded) {
            expandedCollections.add(expandKey);
          } else {
            expandedCollections.delete(expandKey);
          }
          saveStateToStorage();
        });
      });

      // Child item row clicks
      container.querySelectorAll('.child-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('child-expand-toggle')) return;
          event.stopPropagation();
          clearActive();
          this.classList.add('active');
          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;
          selectedCategoryId = categoryId;
          loadCategoryItems(collectionSlug, categorySlug, categoryId);
        });
      });

      // Child item clicks (no children)
      container.querySelectorAll('.child-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();
          clearActive();
          this.classList.add('active');
          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;
          selectedCategoryId = categoryId;
          loadCategoryItems(collectionSlug, categorySlug, categoryId);
        });
      });

      // Nested expand toggles
      container.querySelectorAll('.nested-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const nestedParent = this.closest('.nested-child-parent');
          const childrenContainer = nestedParent.querySelector('.deep-nested-children');
          const isExpanded = !nestedParent.classList.contains('expanded');

          nestedParent.classList.toggle('expanded', isExpanded);
          this.textContent = isExpanded ? '' : '+';
          if (childrenContainer) childrenContainer.style.display = isExpanded ? 'block' : 'none';

          if (isExpanded) {
            expandedCollections.add(expandKey);
          } else {
            expandedCollections.delete(expandKey);
          }
          saveStateToStorage();
        });
      });

      // Nested child row clicks
      container.querySelectorAll('.nested-child-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('nested-expand-toggle')) return;
          event.stopPropagation();
          clearActive();
          this.classList.add('active');
          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;
          selectedCategoryId = categoryId;
          loadCategoryItems(collectionSlug, categorySlug, categoryId);
        });
      });

      // Nested child item clicks (no children)
      container.querySelectorAll('.nested-child-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();
          clearActive();
          this.classList.add('active');
          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;
          selectedCategoryId = categoryId;
          loadCategoryItems(collectionSlug, categorySlug, categoryId);
        });
      });
    }

    function renderInspireFamilyPanelCategories(categories, level) {
      let html = '';
      categories.forEach((cat, idx) => {
        const expandKey = 'if_panel_' + cat.id;
        const isExpanded = expandedCollections.has(expandKey);
        const hasChildren = cat.children && cat.children.length > 0;
        const itemCount = cat.item_count || 0;

        if (level === 0) {
          // Level 0: Root categories - format like Jubilee Inspire stages with numbers
          html += `
            <div class="stage-item ${isExpanded ? 'expanded' : ''} ${!hasChildren ? 'no-children' : ''}" data-stage-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}" data-parent-id="a4">
              <div class="stage-item-row ${selectedCategoryId === cat.id ? 'active' : ''}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                ${hasChildren
                  ? `<span class="stage-expand-toggle" data-expand-key="${expandKey}">${isExpanded ? '' : '+'}</span>`
                  : '<span class="stage-expand-toggle empty"></span>'}
                <span class="subcategory-number">${String(idx + 1).padStart(2, '0')}</span>
                <span class="subcategory-name">${cat.name}</span>
                ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
              </div>
              ${hasChildren ? `
                <div class="stage-domains" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderInspireFamilyPanelCategories(cat.children, level + 1)}
                </div>
              ` : ''}
            </div>
          `;
        } else if (level === 1) {
          // Level 1: Second level - format like domains with folder icon
          html += `
            <div class="domain-item ${isExpanded ? 'expanded' : ''} ${!hasChildren ? 'no-children' : ''}" data-domain-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
              <div class="domain-item-row" data-category-id="${cat.id}" data-slug="${cat.slug}">
                ${hasChildren
                  ? `<span class="domain-expand-toggle" data-expand-key="${expandKey}">${isExpanded ? '' : '+'}</span>`
                  : '<span class="domain-expand-toggle empty"></span>'}
                <span class="domain-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                <span class="domain-name">${cat.name}</span>
                ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
              </div>
              ${hasChildren ? `
                <div class="domain-children" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderInspireFamilyPanelCategories(cat.children, level + 1)}
                </div>
              ` : ''}
            </div>
          `;
        } else if (level === 2) {
          // Level 2: Third level - child items (expandable if has children)
          if (hasChildren) {
            html += `
              <div class="nested-parent-item ${isExpanded ? 'expanded' : ''}" data-child-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <div class="child-item-row" data-category-id="${cat.id}" data-slug="${cat.slug}">
                  <span class="child-expand-toggle" data-expand-key="${expandKey}">${isExpanded ? '' : '+'}</span>
                  <span class="child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                  <span class="child-name">${cat.name}</span>
                  ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
                </div>
                <div class="nested-children" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderInspireFamilyPanelCategories(cat.children, level + 1)}
                </div>
              </div>
            `;
          } else {
            html += `
              <div class="child-item" data-child-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <span style="width: 20px; display: inline-block;"></span>
                <span class="child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                <span class="child-name">${cat.name}</span>
                ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
              </div>
            `;
          }
        } else if (level === 3) {
          // Level 3: Fourth level - nested child items
          if (hasChildren) {
            html += `
              <div class="nested-child-parent ${isExpanded ? 'expanded' : ''}" data-nested-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <div class="nested-child-item-row" data-category-id="${cat.id}" data-slug="${cat.slug}">
                  <span class="nested-expand-toggle" data-expand-key="${expandKey}">${isExpanded ? '' : '+'}</span>
                  <span class="nested-child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                  <span class="child-name">${cat.name}</span>
                  ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
                </div>
                <div class="deep-nested-children" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderInspireFamilyPanelCategories(cat.children, level + 1)}
                </div>
              </div>
            `;
          } else {
            html += `
              <div class="nested-child-item" data-nested-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <span style="width: 20px; display: inline-block;"></span>
                <span class="nested-child-icon"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></span>
                <span class="child-name">${cat.name}</span>
                ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
              </div>
            `;
          }
        } else {
          // Level 4+: Fifth level and beyond - deepest items
          if (hasChildren) {
            html += `
              <div class="deep-nested-parent ${isExpanded ? 'expanded' : ''}" data-deep-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <div class="deep-nested-item-row" data-category-id="${cat.id}" data-slug="${cat.slug}">
                  <span class="deep-expand-toggle" data-expand-key="${expandKey}">${isExpanded ? '' : '+'}</span>
                  <span class="deep-nested-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></span>
                  <span class="child-name">${cat.name}</span>
                  ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
                </div>
                <div class="deepest-children" style="display: ${isExpanded ? 'block' : 'none'}">
                  ${renderInspireFamilyPanelCategories(cat.children, level + 1)}
                </div>
              </div>
            `;
          } else {
            html += `
              <div class="deep-nested-item" data-deep-id="${cat.id}" data-category-id="${cat.id}" data-slug="${cat.slug}">
                <span style="width: 20px; display: inline-block;"></span>
                <span class="deep-nested-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></span>
                <span class="child-name">${cat.name}</span>
                ${itemCount > 0 ? `<span class="if-panel-count">${itemCount}</span>` : ''}
              </div>
            `;
          }
        }
      });
      return html;
    }

    function attachInspireFamilyPanelHandlers(container) {
      // Helper to clear all active states
      function clearAllActive() {
        container.querySelectorAll('.stage-item-row, .domain-item-row, .child-item, .child-item-row, .nested-child-item, .nested-child-item-row, .deep-nested-item, .deep-nested-item-row').forEach(r => r.classList.remove('active'));
      }

      // Toggle expand/collapse for stage-level (root categories)
      container.querySelectorAll('.stage-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const stageEl = this.closest('.stage-item');
          const domainsEl = stageEl.querySelector(':scope > .stage-domains');

          if (expandedCollections.has(expandKey)) {
            expandedCollections.delete(expandKey);
            stageEl.classList.remove('expanded');
            this.textContent = '+';
            if (domainsEl) domainsEl.style.display = 'none';
          } else {
            expandedCollections.add(expandKey);
            stageEl.classList.add('expanded');
            this.textContent = '';
            if (domainsEl) domainsEl.style.display = 'block';
          }
          saveStateToStorage();
        });
      });

      // Toggle expand/collapse for domain-level (second level)
      container.querySelectorAll('.domain-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const domainEl = this.closest('.domain-item');
          const childrenEl = domainEl.querySelector(':scope > .domain-children');

          if (expandedCollections.has(expandKey)) {
            expandedCollections.delete(expandKey);
            domainEl.classList.remove('expanded');
            this.textContent = '+';
            if (childrenEl) childrenEl.style.display = 'none';
          } else {
            expandedCollections.add(expandKey);
            domainEl.classList.add('expanded');
            this.textContent = '';
            if (childrenEl) childrenEl.style.display = 'block';
          }
          saveStateToStorage();
        });
      });

      // Toggle expand/collapse for child-level (third level)
      container.querySelectorAll('.child-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const parentEl = this.closest('.nested-parent-item');
          const childrenEl = parentEl.querySelector(':scope > .nested-children');

          if (expandedCollections.has(expandKey)) {
            expandedCollections.delete(expandKey);
            parentEl.classList.remove('expanded');
            this.textContent = '+';
            if (childrenEl) childrenEl.style.display = 'none';
          } else {
            expandedCollections.add(expandKey);
            parentEl.classList.add('expanded');
            this.textContent = '';
            if (childrenEl) childrenEl.style.display = 'block';
          }
          saveStateToStorage();
        });
      });

      // Toggle expand/collapse for nested-level (fourth level)
      container.querySelectorAll('.nested-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const parentEl = this.closest('.nested-child-parent');
          const childrenEl = parentEl.querySelector(':scope > .deep-nested-children');

          if (expandedCollections.has(expandKey)) {
            expandedCollections.delete(expandKey);
            parentEl.classList.remove('expanded');
            this.textContent = '+';
            if (childrenEl) childrenEl.style.display = 'none';
          } else {
            expandedCollections.add(expandKey);
            parentEl.classList.add('expanded');
            this.textContent = '';
            if (childrenEl) childrenEl.style.display = 'block';
          }
          saveStateToStorage();
        });
      });

      // Toggle expand/collapse for deep-level (fifth level)
      container.querySelectorAll('.deep-expand-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(event) {
          event.stopPropagation();
          const expandKey = this.dataset.expandKey;
          const parentEl = this.closest('.deep-nested-parent');
          const childrenEl = parentEl.querySelector(':scope > .deepest-children');

          if (expandedCollections.has(expandKey)) {
            expandedCollections.delete(expandKey);
            parentEl.classList.remove('expanded');
            this.textContent = '+';
            if (childrenEl) childrenEl.style.display = 'none';
          } else {
            expandedCollections.add(expandKey);
            parentEl.classList.add('expanded');
            this.textContent = '';
            if (childrenEl) childrenEl.style.display = 'block';
          }
          saveStateToStorage();
        });
      });

      // Click on stage row to select and load items
      container.querySelectorAll('.stage-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('stage-expand-toggle')) return;
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });

      // Click on domain row to select and load items
      container.querySelectorAll('.domain-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('domain-expand-toggle')) return;
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });

      // Click on child-item-row (third level with children)
      container.querySelectorAll('.child-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('child-expand-toggle')) return;
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });

      // Click on child-item (third level without children)
      container.querySelectorAll('.child-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });

      // Click on nested-child-item-row (fourth level with children)
      container.querySelectorAll('.nested-child-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('nested-expand-toggle')) return;
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });

      // Click on nested-child-item (fourth level without children)
      container.querySelectorAll('.nested-child-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });

      // Click on deep-nested-item-row (fifth level with children)
      container.querySelectorAll('.deep-nested-item-row').forEach(row => {
        row.addEventListener('click', function(event) {
          if (event.target.classList.contains('deep-expand-toggle')) return;
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });

      // Click on deep-nested-item (fifth level without children)
      container.querySelectorAll('.deep-nested-item').forEach(item => {
        item.addEventListener('click', function(event) {
          event.stopPropagation();

          const categoryId = this.dataset.categoryId;
          const categorySlug = this.dataset.slug;

          clearAllActive();
          this.classList.add('active');

          selectedCategoryId = categoryId;
          loadCategoryItems(categoryId, categorySlug);
        });
      });
    }

    function renderInspireFamilyCategories() {
      const container = document.getElementById('itemsListContent');

      if (inspireFamilyCategories.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-title">No Categories Found</div>
            <div class="empty-state-text">Run the database migration to populate categories.</div>
          </div>
        `;
        return;
      }

      let html = '';
      inspireFamilyCategories.forEach((category, index) => {
        const isExpanded = expandedCollections.has('if_' + category.id);
        const hasChildren = category.children && category.children.length > 0;
        const itemCount = category.item_count || 0;

        html += `
          <div class="inspire-category-item ${hasChildren ? 'has-children' : ''} ${isExpanded ? 'expanded' : ''}" data-category-id="${category.id}">
            <div class="inspire-category-row" onclick="selectInspireFamilyCategory('${category.id}', '${category.slug}')">
              <span class="inspire-category-number">${String(index + 1).padStart(2, '0')}</span>
              <span class="inspire-category-name">${category.name}</span>
              <span class="inspire-category-count">${String(itemCount).padStart(2, '0')}</span>
            </div>
            ${hasChildren ? `
              <div class="inspire-category-children" style="display: ${isExpanded ? 'block' : 'none'}">
                ${renderInspireFamilyCategoryChildren(category.children, 1)}
              </div>
            ` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderInspireFamilyCategoryChildren(children, level) {
      if (!children || children.length === 0) return '';

      let html = '';
      children.forEach((child, index) => {
        const isExpanded = expandedCollections.has('if_' + child.id);
        const hasChildren = child.children && child.children.length > 0;
        const itemCount = child.item_count || 0;

        html += `
          <div class="inspire-category-item level-${level} ${hasChildren ? 'has-children' : ''} ${isExpanded ? 'expanded' : ''}" data-category-id="${child.id}">
            <div class="inspire-category-row" onclick="selectInspireFamilyCategory('${child.id}', '${child.slug}')">
              <span class="inspire-category-number">${String(index + 1).padStart(2, '0')}</span>
              <span class="inspire-category-name">${child.name}</span>
              <span class="inspire-category-count">${String(itemCount).padStart(2, '0')}</span>
            </div>
            ${hasChildren ? `
              <div class="inspire-category-children" style="display: ${isExpanded ? 'block' : 'none'}">
                ${renderInspireFamilyCategoryChildren(child.children, level + 1)}
              </div>
            ` : ''}
          </div>
        `;
      });

      return html;
    }

    function toggleInspireFamilyCategory(categoryId) {
      const expandKey = 'if_' + categoryId;
      const categoryElement = document.querySelector(`.inspire-category-item[data-category-id="${categoryId}"]`);
      const toggle = categoryElement.querySelector('.inspire-category-toggle');
      const childrenContainer = categoryElement.querySelector('.inspire-category-children');

      if (expandedCollections.has(expandKey)) {
        expandedCollections.delete(expandKey);
        categoryElement.classList.remove('expanded');
        toggle.textContent = '+';
        if (childrenContainer) childrenContainer.style.display = 'none';
      } else {
        expandedCollections.add(expandKey);
        categoryElement.classList.add('expanded');
        toggle.textContent = '';
        if (childrenContainer) childrenContainer.style.display = 'block';
      }
      saveStateToStorage();
    }

    async function selectInspireFamilyCategory(categoryId, categorySlug) {
      selectedCategoryId = categoryId;

      // Update UI - highlight selected category
      document.querySelectorAll('.inspire-category-row').forEach(row => {
        row.classList.remove('active');
      });
      const selectedRow = document.querySelector(`.inspire-category-item[data-category-id="${categoryId}"] > .inspire-category-row`);
      if (selectedRow) {
        selectedRow.classList.add('active');
      }

      // Load items for this category
      await loadCategoryItems(categoryId, categorySlug);
    }

    async function loadCategoryItems(categoryId, categorySlug) {
      // Clear the edit panel
      hideEditForm();

      try {
        const response = await fetch(`/api/admin/collections/inspire-family/categories/${categorySlug}/items`, {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });

        // Read response as text first to handle non-JSON responses
        const responseText = await response.text();

        // Check if response is OK
        if (!response.ok) {
          if (responseText.startsWith('<') || responseText.startsWith('<!DOCTYPE')) {
            console.error('Received HTML instead of JSON - possible authentication redirect');
            items = [];
            renderCategoryItems();
            return;
          }
          items = [];
          renderCategoryItems();
          return;
        }

        // Parse JSON
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Failed to parse JSON response:', responseText.substring(0, 200));
          items = [];
          renderCategoryItems();
          return;
        }

        if (!data.success) {
          items = [];
          renderCategoryItems();
          return;
        }

        // Transform items for display
        items = (data.items || []).map((item, index) => ({
          id: item.id,
          name: item.name,
          title: getItemTypeLabel(item.item_type) + (item.metadata?.sealed ? ' [SEALED]' : ''),
          description: (item.content || '').substring(0, 100) + '...',
          is_active: item.is_active,
          item_type: item.item_type,
          content: item.content,
          metadata: item.metadata,
          priority: item.priority,
          category_name: item.category_name
        }));

        renderCategoryItems();
      } catch (error) {
        console.error('Error loading category items:', error);
        items = [];
        renderCategoryItems();
      }
    }

    function getItemTypeLabel(itemType) {
      const labels = {
        'activation': 'ACTIVATION',
        'property': 'PROPERTY',
        'event_trigger': 'EVENT',
        'prompt': 'PROMPT',
        'instruction': 'INSTRUCTION',
        'reference': 'REFERENCE',
        'metadata': 'METADATA'
      };
      return labels[itemType] || itemType.toUpperCase();
    }

    function renderCategoryItems() {
      const container = document.getElementById('itemsListContent');

      // We need a different container for items when in category view mode
      // For now, let's show items in a modal or split view
      // Actually, let's update the context display and show items in the existing panel

      if (items.length === 0) {
        // Keep the category tree visible but show message
        const existingHtml = container.innerHTML;
        // Don't replace - show empty state in edit panel instead
        document.getElementById('editEmptyState').innerHTML = `
          <svg viewBox="0 0 24 24" fill="currentColor" style="width:48px;height:48px;opacity:0.5;margin-bottom:12px;">
            <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
          </svg>
          <div class="empty-state-title">No Items in Category</div>
          <div class="empty-state-text">This category doesn't have any items yet.</div>
        `;
        document.getElementById('editEmptyState').style.display = 'flex';
        document.getElementById('editForm').style.display = 'none';
        return;
      }

      // Show items in the edit panel as a list
      document.getElementById('editEmptyState').style.display = 'none';
      document.getElementById('editForm').style.display = 'none';

      // Create items list in the edit panel
      const editPanel = document.getElementById('editPanelContent');
      let html = `
        <div class="category-items-list">
          <div class="category-items-header">
            <h3>Category Items (${items.length})</h3>
          </div>
          <div class="category-items-container">
      `;

      items.forEach((item, index) => {
        const priorityBadge = item.priority >= 100 ? 'high-priority' : (item.priority >= 80 ? 'medium-priority' : '');
        const sealedBadge = item.metadata?.sealed ? '<span class="sealed-badge">SEALED</span>' : '';
        const irrevocableBadge = item.metadata?.irrevocable ? '<span class="irrevocable-badge">IRREVOCABLE</span>' : '';

        html += `
          <div class="category-item-card ${priorityBadge}" onclick="showItemDetail('${item.id}')">
            <div class="item-card-header">
              <span class="item-type-badge item-type-${item.item_type}">${getItemTypeLabel(item.item_type)}</span>
              ${sealedBadge}
              ${irrevocableBadge}
              <span class="item-priority">P${item.priority || 0}</span>
            </div>
            <div class="item-card-name">${item.name}</div>
            <div class="item-card-preview">${(item.content || '').substring(0, 150)}${(item.content || '').length > 150 ? '...' : ''}</div>
            <div class="item-card-source">${item.metadata?.source || ''} ${item.metadata?.section || ''}</div>
          </div>
        `;
      });

      html += '</div></div>';
      editPanel.innerHTML = html;
    }

    async function showItemDetail(itemId) {
      try {
        const response = await fetch(`/api/admin/collections/items/${itemId}`);
        const data = await response.json();

        if (!data.success) {
          console.error('Error loading item:', data.message);
          return;
        }

        const item = data.item;

        // Show the edit form with item details
        document.getElementById('editEmptyState').style.display = 'none';
        document.getElementById('editForm').style.display = 'block';

        // Populate the edit form with the item data
        document.getElementById('editItemName').value = item.name || '';
        document.getElementById('editItemTitle').value = getItemTypeLabel(item.item_type) + ' - ' + (item.category_name || '');
        document.getElementById('editItemDescription').value = item.content || '';

        // Show metadata
        const metadataObj = {
          ...item.metadata,
          item_type: item.item_type,
          priority: item.priority,
          source: item.metadata?.source,
          section: item.metadata?.section,
          sealed: item.metadata?.sealed || false,
          irrevocable: item.metadata?.irrevocable || false,
          category_path: item.category_path,
          collection: item.collection_name
        };
        document.getElementById('editItemMetadata').value = JSON.stringify(metadataObj, null, 2);

        // Config section for additional data
        const configObj = {
          id: item.id,
          slug: item.slug,
          version: item.version,
          created_at: item.created_at,
          updated_at: item.updated_at,
          is_active: item.is_active
        };
        document.getElementById('editItemConfig').value = JSON.stringify(configObj, null, 2);

        // Set active toggle
        const toggle = document.getElementById('editActiveToggle');
        toggle.classList.toggle('active', item.is_active);

        selectedItemId = item.id;

      } catch (error) {
        console.error('Error loading item detail:', error);
      }
    }

    // Load domains (folder items) into the middle panel when a subcategory with domains is clicked
    function loadDomainsIntoItemsPanel(subcategoryId, parentCollectionId) {
      const container = document.getElementById('itemsListContent');

      // Get domains for this subcategory
      const domains = getDomainsForStage(subcategoryId);

      if (!domains || domains.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No Items Found</div><div class="empty-state-text">This category has no items yet.</div></div>';
        return;
      }

      // Render domains in the same style as items
      let html = '';
      domains.forEach((domain, index) => {
        const itemCount = domain.children ? domain.children.length : 0;
        html += `
          <div class="item-list-item" data-domain-id="${domain.id}" data-stage-id="${subcategoryId}">
            <div class="item-list-row" onclick="selectDomainInPanel('${domain.id}', '${subcategoryId}', '${parentCollectionId}')">
              <span class="item-number-badge">${String(index + 1).padStart(2, '0')}</span>
              <span class="item-list-title">${domain.name}</span>
              <span class="item-list-count">${String(itemCount).padStart(2, '0')}</span>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // Handle clicking a domain in the items panel
    function selectDomainInPanel(domainId, stageId, parentCollectionId) {
      // Update selection state
      document.querySelectorAll('.item-list-item').forEach(item => item.classList.remove('selected'));
      const selectedItem = document.querySelector(`.item-list-item[data-domain-id="${domainId}"]`);
      if (selectedItem) selectedItem.classList.add('selected');

      // Load the domain's children into the editor or show domain details
      const domains = getDomainsForStage(stageId);
      const domain = domains.find(d => d.id === domainId);

      if (domain) {
        // Show domain info in editor
        document.getElementById('editEmptyState').style.display = 'none';
        document.getElementById('editForm').style.display = 'block';
        document.getElementById('editItemName').value = domain.name;
        document.getElementById('editItemTitle').value = domain.name;
        document.getElementById('editItemDescription').value = 'Domain containing ' + (domain.children ? domain.children.length : 0) + ' items';
        document.getElementById('editItemConfig').value = JSON.stringify({ children: domain.children || [] }, null, 2);
        document.getElementById('editItemMetadata').value = '{}';
        document.getElementById('editActiveToggle').classList.add('active');
      }
    }

    // Load children (chapters) into the items panel when clicking a domain (book) in the tree
    function loadChildrenIntoItemsPanel(domain, stageId, parentCollectionId) {
      const container = document.getElementById('itemsListContent');

      if (!domain.children || domain.children.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No Chapters Found</div><div class="empty-state-text">This book has no chapters yet.</div></div>';
        return;
      }

      // Render children (chapters) in the same style as items
      let html = '';
      domain.children.forEach((child, index) => {
        // Handle both string children and object children
        const childName = typeof child === 'string' ? child.replace(/_/g, ' ') : child.name;
        const childId = typeof child === 'string' ? child : child.id;
        html += `
          <div class="item-list-item" data-child-id="${childId}" data-domain-id="${domain.id}" data-stage-id="${stageId}">
            <div class="item-list-row" onclick="selectChildInPanel('${childId}', '${domain.id}', '${stageId}', '${parentCollectionId}')">
              <span class="item-number-badge">${String(index + 1).padStart(2, '0')}</span>
              <span class="item-list-title">${childName}</span>
              <span class="item-list-count">00</span>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // Handle clicking a child (chapter) in the items panel
    function selectChildInPanel(childId, domainId, stageId, parentCollectionId) {
      console.log('selectChildInPanel called:', { childId, domainId, stageId, parentCollectionId });

      // Update selection state
      document.querySelectorAll('.item-list-item').forEach(item => item.classList.remove('selected'));
      const selectedItem = document.querySelector(`.item-list-item[data-child-id="${childId}"]`);
      if (selectedItem) selectedItem.classList.add('selected');

      // Get child name for display
      const childName = childId.replace(/_/g, ' ');

      // Update context display
      document.getElementById('contextDisplay').textContent = childName;

      // Check if this is a Scripture/Bible chapter (stageId is 'Jubilee_Bible_JSV' and we have a chapter like 'Chapter_01')
      console.log('Checking Bible condition:', stageId === 'Jubilee_Bible_JSV', childId.startsWith('Chapter_'));
      if (stageId === 'Jubilee_Bible_JSV' && childId.startsWith('Chapter_')) {
        // Extract chapter number from childId (e.g., 'Chapter_01' -> 1)
        const chapterNum = parseInt(childId.replace('Chapter_', ''), 10);
        console.log('Loading Bible verses for:', domainId, 'chapter', chapterNum);
        loadBibleVerses(domainId, chapterNum);
        return;
      }

      // Show child info in editor (default behavior for non-Bible collections)
      document.getElementById('editEmptyState').style.display = 'none';
      document.getElementById('versesPanel').style.display = 'none';
      document.getElementById('editForm').style.display = 'block';
      document.getElementById('editItemName').value = childName;
      document.getElementById('editItemTitle').value = childName;
      document.getElementById('editItemDescription').value = 'Chapter configuration';
      document.getElementById('editItemConfig').value = JSON.stringify({
        id: childId,
        domain: domainId,
        stage: stageId,
        collection: parentCollectionId
      }, null, 2);
      document.getElementById('editItemMetadata').value = '{}';
      document.getElementById('editActiveToggle').classList.add('active');
    }

    // Load Bible verses from the API
    async function loadBibleVerses(bookId, chapterNum) {
      console.log('loadBibleVerses called:', bookId, chapterNum);

      // Save Bible view state for persistence
      currentBibleView = { bookId, chapterNum };
      saveStateToStorage();

      // Update the context display header in the middle panel
      const bookName = bookId.replace(/_/g, ' ');
      document.getElementById('contextDisplay').textContent = `${bookName} Chapter ${chapterNum}`;

      // Hide the empty state in middle panel, render verses there
      const container = document.getElementById('itemsListContent');
      const emptyState = document.getElementById('itemsEmptyState');
      if (emptyState) emptyState.style.display = 'none';

      // Show loading state in middle panel
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading verses...</div>';

      try {
        const url = `/api/admin/bible/verses/${bookId}/${chapterNum}`;
        console.log('Fetching verses from:', url);
        const response = await fetch(url);
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Verses data:', data);

        if (data.success && data.verses && data.verses.length > 0) {
          renderVersesToMiddlePanel(data.verses, bookName, chapterNum, data.count);
        } else {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No verses available for this chapter yet.</div>';
        }
      } catch (error) {
        console.error('Error loading verses:', error);
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f87171;">Failed to load verses. Please try again.</div>';
      }
    }

    // Render verses to the middle panel (inbox-style list)
    function renderVersesToMiddlePanel(verses, bookName, chapterNum, count) {
      const container = document.getElementById('itemsListContent');
      let html = '';
      let lastSectionHeading = null;

      verses.forEach(verse => {
        // Show section heading if present and different from last
        if (verse.section_heading && verse.section_heading !== lastSectionHeading) {
          html += `<div class="verse-section-heading">${verse.section_heading}</div>`;
          lastSectionHeading = verse.section_heading;
        }

        const benchmarkHtml = verse.benchmark_score ? `<span class="verse-benchmark-score">${parseFloat(verse.benchmark_score).toFixed(2)}%</span>` : '';
        html += `
          <div class="verse-item" data-verse-id="${verse.id}" data-verse-text="${verse.verse_text ? verse.verse_text.replace(/"/g, '&quot;') : ''}">
            <span class="verse-number-badge">${verse.verse_number}</span>
            <div class="verse-content">
              <div class="verse-preview">${verse.verse_text || verse.verse_preview}</div>
            </div>
            ${benchmarkHtml}
          </div>
        `;
      });

      container.innerHTML = html;

      // Attach click handlers (CSP-compliant)
      container.querySelectorAll('.verse-item').forEach(item => {
        item.addEventListener('click', function() {
          selectVerseForDetail(this.dataset.verseId, this.dataset.verseText, bookName, chapterNum);
        });
      });

      // Auto-restore saved verse selection if it matches this chapter
      if (savedVerseState && savedVerseState.bookName === bookName && savedVerseState.chapter === chapterNum) {
        const savedVerseElement = container.querySelector('.verse-item[data-verse-id="' + savedVerseState.verseId + '"]');
        if (savedVerseElement) {
          // Re-select the saved verse
          selectVerseForDetail(savedVerseState.verseId, savedVerseState.verseText, bookName, chapterNum);
        }
      }
    }

    // Store current verse data for benchmark tab
    let currentVerseData = null;

    // Handle verse selection - show full verse text in edit panel with benchmark
    function selectVerseForDetail(verseId, verseText, bookName, chapterNum) {
      // Highlight selected verse in middle panel
      document.querySelectorAll('.verse-item').forEach(function(item) {
        item.classList.toggle('selected', item.dataset.verseId === verseId);
      });

      // Show full verse in edit panel
      document.getElementById('editEmptyState').style.display = 'none';
      document.getElementById('editForm').style.display = 'block';
      document.getElementById('versesPanel').style.display = 'none';

      // Get the verse number from the selected item
      const selectedItem = document.querySelector('.verse-item[data-verse-id="' + verseId + '"]');
      const verseNumber = selectedItem ? selectedItem.querySelector('.verse-number-badge').textContent : '';

      // Store verse data for benchmark tab
      currentVerseData = {
        verseId: verseId,
        verseText: verseText,
        bookName: bookName,
        chapter: chapterNum,
        verse: verseNumber
      };

      // Save verse state to cookies for persistence across refresh
      savedVerseState = {
        verseId: verseId,
        verseText: verseText,
        bookName: bookName,
        chapter: chapterNum,
        verseNumber: verseNumber
      };
      saveStateToStorage();

      // Update DETAILS tab with verse info
      document.getElementById('editItemName').value = bookName + ' ' + chapterNum + ':' + verseNumber;
      document.getElementById('editItemTitle').value = 'Bible Verse';
      document.getElementById('editItemDescription').value = verseText;

      // Load benchmark data into BENCHMARK tab
      loadBenchmarkTab(bookName, chapterNum, verseNumber, verseText);

      // Switch to BENCHMARK tab automatically
      switchToTab('benchmark');
    }

    // Switch to a specific tab
    function switchToTab(tabName) {
      const tabs = document.querySelectorAll('.edit-panel-tab');
      tabs.forEach(function(t) { t.classList.remove('active'); });
      var targetTab = document.querySelector('.edit-panel-tab[data-tab="' + tabName + '"]');
      if (targetTab) targetTab.classList.add('active');

      document.querySelectorAll('.tab-content').forEach(function(content) {
        content.classList.toggle('active', content.dataset.tabContent === tabName);
      });
    }

    // Load benchmark tab content
    function loadBenchmarkTab(bookName, chapter, verse, verseText) {
      var container = document.getElementById('benchmarkTabContent');
      container.innerHTML =
        '<div class="benchmark-loading">' +
          '<svg viewBox="0 0 24 24"><path d="M12 4V2C6.48 2 2 6.48 2 12h2c0-4.42 3.58-8 8-8zm0 14c-3.31 0-6-2.69-6-6H4c0 4.42 3.58 8 8 8v2c5.52 0 10-4.48 10-10h-2c0 4.42-3.58 8-8 8z"/></svg>' +
          '<div style="margin-top: 12px;">Loading benchmark evaluation...</div>' +
        '</div>';

      // Fetch benchmark results
      fetchBenchmarkResults(bookName, chapter, verse, verseText);
    }

    // Update the verse list entry score badge
    function updateVerseListScore(verseId, totalScore) {
      if (!verseId) return;
      var verseItem = document.querySelector('.verse-item[data-verse-id="' + verseId + '"]');
      if (!verseItem) return;

      var percentage = (totalScore / 1000 * 100).toFixed(2);
      var existingBadge = verseItem.querySelector('.verse-benchmark-score');

      if (existingBadge) {
        // Update existing badge
        existingBadge.textContent = percentage + '%';
      } else {
        // Create new badge
        var badge = document.createElement('span');
        badge.className = 'verse-benchmark-score';
        badge.textContent = percentage + '%';
        verseItem.appendChild(badge);
      }
    }

    // Fetch benchmark results from API
    async function fetchBenchmarkResults(bookName, chapter, verse, verseText) {
      var container = document.getElementById('benchmarkTabContent');
      try {
        var response = await fetch('/api/admin/benchmark/results/' + bookName.toLowerCase() + '/' + chapter + '/' + verse, { credentials: 'include' });
        var data = await response.json();

        if (data.success && data.benchmark) {
          renderBenchmarkResults(container, data, bookName, chapter, verse, verseText || currentVerseData.verseText);
          // Update the verse list entry with new score
          if (currentVerseData && currentVerseData.verseId) {
            updateVerseListScore(currentVerseData.verseId, Math.round(data.benchmark.total_score));
          }
        } else {
          renderBenchmarkNotEvaluated(container, bookName, chapter, verse, verseText || currentVerseData.verseText);
        }
      } catch (error) {
        console.error('Error fetching benchmark:', error);
        renderBenchmarkNotEvaluated(container, bookName, chapter, verse, verseText || currentVerseData.verseText);
      }
    }

    // Render benchmark results display with full-width table (0-1000 scale)
    function renderBenchmarkResults(container, data, bookName, chapter, verse, verseText) {
      var totalScore = Math.round(data.benchmark.total_score); // 0-1000 scale as integer
      var percentage = (totalScore / 1000 * 100).toFixed(2); // Calculate percentage for footer
      var grade = data.benchmark.grade;

      // Convert grade to CSS class name (A+ becomes grade-a-plus, etc.)
      var gradeClass = 'grade-' + grade.toLowerCase().replace(/\+/g, '-plus');

      // Get grade color class for the score display
      var getGradeColorClass = function(g) {
        if (g === 'A+' || g === 'A') return 'score-gold';
        if (g === 'B') return 'score-gold';
        if (g === 'C') return 'score-green';
        return 'score-red'; // F
      };

      // Total score color based on grade (A+/A/B = gold, C = green, F = red)
      var getScoreColorClass = function(score) {
        if (score >= 850) return 'score-gold';  // B or higher (85%+)
        if (score >= 750) return 'score-green'; // C (75%+)
        return 'score-red';                      // F (<75%)
      };

      // Build table rows with 0-1000 score display (gold for 990+, white otherwise)
      var tableRows = '';
      data.scores.forEach(function(criterion) {
        // Convert raw score (1-10) to 0-1000 scale: rawScore * 100
        var score1000 = Math.round(criterion.rawScore * 100); // e.g., 8.8  880
        // Gold/yellow for 990+ (9.9+ raw score), white otherwise
        var scoreClass = score1000 >= 990 ? 'score-gold' : 'score-white';
        tableRows += '<tr>' +
          '<td class="criterion-num">' + (criterion.number < 10 ? '0' : '') + criterion.number + '</td>' +
          '<td class="criterion-name">' + criterion.name + '</td>' +
          '<td><span class="criterion-score ' + scoreClass + '">' + score1000 + '</span></td>' +
        '</tr>';
      });

      // Build strengths list
      var strengthsHtml = '<ul>';
      if (data.strengths && data.strengths.length > 0) {
        data.strengths.forEach(function(s) { strengthsHtml += '<li>' + s + '</li>'; });
      } else {
        strengthsHtml += '<li>No specific strengths identified</li>';
      }
      strengthsHtml += '</ul>';

      // Build improvements list
      var improvementsHtml = '<ul>';
      if (data.improvements && data.improvements.length > 0) {
        data.improvements.forEach(function(i) { improvementsHtml += '<li>' + i + '</li>'; });
      } else {
        improvementsHtml += '<li>No specific improvements identified</li>';
      }
      improvementsHtml += '</ul>';

      // Get Hebrew source text if available (from verse data or lookup)
      var hebrewText = data.verse && data.verse.hebrew_text ? data.verse.hebrew_text : '';

      // Common Hebrew texts for well-known verses (fallback lookup)
      var hebrewLookup = {
        'genesis:1:1': '      ',
        'genesis:1:2': '           ',
        'genesis:1:3': '    '
      };

      if (!hebrewText) {
        var lookupKey = bookName.toLowerCase() + ':' + chapter + ':' + verse;
        hebrewText = hebrewLookup[lookupKey] || '';
      }

      container.innerHTML =
        // Sticky Header with verse ref, verse text, Hebrew text, then rating row on right
        '<div class="benchmark-tab-header">' +
          '<div class="benchmark-verse-ref">' + bookName + ' ' + chapter + ':' + verse + '</div>' +
          '<div class="benchmark-verse-text" id="benchmarkVerseText">' + (verseText || '') + '</div>' +
          (hebrewText ? '<div class="benchmark-verse-hebrew">' + hebrewText + '</div>' : '') +
          '<div class="benchmark-score-row">' +
            '<button class="benchmark-execute-btn" id="executeRecommendationsBtn">Execute Recommendations</button>' +
            '<div class="benchmark-scores-group">' +
              '<div class="benchmark-percent-wrapper">' +
                '<div class="benchmark-percent ' + getScoreColorClass(totalScore) + '">' + percentage + '%</div>' +
              '</div>' +
              '<div class="benchmark-grade ' + gradeClass + '">' + data.benchmark.grade + '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // Full-width criteria table
        '<table class="benchmark-table">' +
          '<thead><tr>' +
            '<th>#</th>' +
            '<th>Benchmark Criterion</th>' +
            '<th style="text-align: right;">Score</th>' +
          '</tr></thead>' +
          '<tbody>' + tableRows + '</tbody>' +
          '<tfoot><tr>' +
            '<td></td>' +
            '<td class="total-label">Total Score</td>' +
            '<td class="total-score ' + getScoreColorClass(totalScore) + '">' + percentage + '%</td>' +
          '</tr></tfoot>' +
        '</table>' +
        // Fine-tuning input section
        '<div class="benchmark-finetune-section">' +
          '<div class="benchmark-finetune-label">Manual Fine-Tuning Instructions</div>' +
          '<textarea class="benchmark-finetune-input" id="finetuneInput" placeholder="Enter specific instructions to refine the translation (e.g., \'Use Elohim instead of God\', \'Emphasize covenant language\')..."></textarea>' +
          '<button class="benchmark-finetune-submit" id="finetuneSubmitBtn">Submit Fine-Tuning</button>' +
        '</div>' +
        // Insights section
        '<div class="benchmark-insights-section">' +
          '<div class="insight-box">' +
            '<div class="insight-box-title strengths">Strengths</div>' +
            strengthsHtml +
          '</div>' +
          '<div class="insight-box">' +
            '<div class="insight-box-title improvements">Areas for Improvement</div>' +
            improvementsHtml +
          '</div>' +
        '</div>' +
        // Assessment section
        '<div class="benchmark-assessment-section">' +
          '<div class="assessment-label">Overall Assessment</div>' +
          '<div class="assessment-text">' + (data.overall_assessment || 'No assessment available.') + '</div>' +
          (data.recommendation ? '<div class="recommendation"><strong>Recommendation:</strong> ' + data.recommendation + '</div>' : '') +
        '</div>';

      // Attach click handler for execute recommendations button
      document.getElementById('executeRecommendationsBtn').addEventListener('click', function() {
        executeRecommendations(bookName, chapter, verse, verseText, data);
      });

      // Attach click handler for fine-tuning submit button
      document.getElementById('finetuneSubmitBtn').addEventListener('click', function() {
        var finetuneText = document.getElementById('finetuneInput').value.trim();
        if (finetuneText) {
          executeRecommendationsWithFinetune(bookName, chapter, verse, verseText, data, finetuneText);
        } else {
          alert('Please enter fine-tuning instructions before submitting.');
        }
      });
    }

    // Render not evaluated state with evaluate button
    function renderBenchmarkNotEvaluated(container, bookName, chapter, verse, verseText) {
      container.innerHTML =
        '<div class="benchmark-tab-header">' +
          '<div class="benchmark-verse-ref">' + bookName + ' ' + chapter + ':' + verse + '</div>' +
          '<div class="benchmark-verse-text">' + (verseText || '') + '</div>' +
        '</div>' +
        '<div class="benchmark-not-evaluated">' +
          '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm3-6c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3 3 1.34 3 3z"/></svg>' +
          '<div style="font-size: 14px; color: #888;">No benchmark evaluation available for this verse</div>' +
          '<div style="font-size: 12px; color: #666; margin-top: 8px;">Click below to run the benchmark evaluation against all 20 criteria</div>' +
          '<button class="evaluate-btn" id="evaluateBtn">Run Benchmark Evaluation</button>' +
        '</div>';

      // Attach click handler for evaluate button
      document.getElementById('evaluateBtn').addEventListener('click', function() {
        runBenchmarkEvaluation(bookName, chapter, verse, verseText);
      });
    }

    // Run benchmark evaluation
    async function runBenchmarkEvaluation(bookName, chapter, verse, verseText) {
      var btn = document.getElementById('evaluateBtn');
      var container = document.getElementById('benchmarkTabContent');

      btn.disabled = true;
      btn.textContent = 'Evaluating...';

      container.innerHTML =
        '<div class="benchmark-tab-header">' +
          '<div class="benchmark-verse-ref">' + bookName + ' ' + chapter + ':' + verse + '</div>' +
          '<div class="benchmark-verse-text">' + (verseText || '') + '</div>' +
        '</div>' +
        '<div class="benchmark-loading">' +
          '<svg viewBox="0 0 24 24"><path d="M12 4V2C6.48 2 2 6.48 2 12h2c0-4.42 3.58-8 8-8zm0 14c-3.31 0-6-2.69-6-6H4c0 4.42 3.58 8 8 8v2c5.52 0 10-4.48 10-10h-2c0 4.42-3.58 8-8 8z"/></svg>' +
          '<div style="margin-top: 12px;">Running benchmark evaluation against 20 criteria...</div>' +
        '</div>';

      try {
        var response = await fetch('/api/admin/benchmark/evaluate', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookId: bookName.toLowerCase(),
            chapter: parseInt(chapter),
            verse: parseInt(verse)
          })
        });

        var data = await response.json();
        if (data.success) {
          // Re-fetch and display results
          fetchBenchmarkResults(bookName, chapter, verse, verseText);
        } else {
          container.innerHTML =
            '<div class="benchmark-not-evaluated">' +
              '<div style="color: #ef4444; font-size: 14px;">Error: ' + (data.error || 'Failed to run evaluation') + '</div>' +
              '<button class="evaluate-btn" id="evaluateBtn">Try Again</button>' +
            '</div>';
          document.getElementById('evaluateBtn').addEventListener('click', function() {
            runBenchmarkEvaluation(bookName, chapter, verse, verseText);
          });
        }
      } catch (error) {
        console.error('Evaluation error:', error);
        container.innerHTML =
          '<div class="benchmark-not-evaluated">' +
            '<div style="color: #ef4444; font-size: 14px;">Error: ' + error.message + '</div>' +
            '<button class="evaluate-btn" id="evaluateBtn">Try Again</button>' +
          '</div>';
        document.getElementById('evaluateBtn').addEventListener('click', function() {
          runBenchmarkEvaluation(bookName, chapter, verse, verseText);
        });
      }
    }

    // Execute recommendations to re-translate verse for 99% benchmark score
    async function executeRecommendations(bookName, chapter, verse, originalVerseText, benchmarkData) {
      var btn = document.getElementById('executeRecommendationsBtn');
      var verseTextEl = document.getElementById('benchmarkVerseText');
      var container = document.getElementById('benchmarkTabContent');

      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        var response = await fetch('/api/admin/benchmark/execute-recommendations', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookId: bookName.toLowerCase(),
            chapter: parseInt(chapter),
            verse: parseInt(verse),
            originalText: originalVerseText,
            benchmarkData: benchmarkData
          })
        });

        if (!response.ok) {
          throw new Error('Server returned ' + response.status + ': ' + response.statusText);
        }

        var data = await response.json();
        if (data.success) {
          // Update the verse text display with the new translation
          verseTextEl.innerHTML = data.newTranslation;
          verseTextEl.style.color = '#22c55e';

          // Re-run benchmark evaluation with new translation
          btn.textContent = 'Re-evaluating...';

          // Fetch updated benchmark results
          setTimeout(function() {
            fetchBenchmarkResults(bookName, chapter, verse, data.newTranslation);
          }, 500);
        } else {
          btn.disabled = false;
          btn.textContent = 'Execute Recommendations';
          alert('Error: ' + (data.error || 'Failed to execute recommendations'));
        }
      } catch (error) {
        console.error('Execute recommendations error:', error);
        btn.disabled = false;
        btn.textContent = 'Execute Recommendations';
        alert('Error: ' + error.message);
      }
    }

    // Execute recommendations with manual fine-tuning instructions
    async function executeRecommendationsWithFinetune(bookName, chapter, verse, originalVerseText, benchmarkData, finetuneInstructions) {
      var btn = document.getElementById('finetuneSubmitBtn');
      var verseTextEl = document.getElementById('benchmarkVerseText');
      var container = document.getElementById('benchmarkTabContent');

      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        var response = await fetch('/api/admin/benchmark/execute-recommendations', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookId: bookName.toLowerCase(),
            chapter: parseInt(chapter),
            verse: parseInt(verse),
            originalText: originalVerseText,
            benchmarkData: benchmarkData,
            finetuneInstructions: finetuneInstructions
          })
        });

        if (!response.ok) {
          throw new Error('Server returned ' + response.status + ': ' + response.statusText);
        }

        var data = await response.json();
        if (data.success) {
          // Update the verse text display with the new translation
          verseTextEl.innerHTML = data.newTranslation;
          verseTextEl.style.color = '#22c55e';

          // Clear the fine-tune input
          document.getElementById('finetuneInput').value = '';

          // Fetch updated benchmark results
          btn.textContent = 'Re-evaluating...';
          setTimeout(function() {
            fetchBenchmarkResults(bookName, chapter, verse, data.newTranslation);
          }, 500);
        } else {
          btn.disabled = false;
          btn.textContent = 'Submit Fine-Tuning';
          alert('Error: ' + (data.error || 'Failed to execute fine-tuning'));
        }
      } catch (error) {
        console.error('Fine-tuning error:', error);
        btn.disabled = false;
        btn.textContent = 'Submit Fine-Tuning';
        alert('Error: ' + error.message);
      }
    }

    // Legacy render function (kept for backward compatibility)
    function renderVerses(verses) {
      const container = document.getElementById('versesListContent');
      let html = '';
      let lastSectionHeading = null;

      verses.forEach(verse => {
        // Show section heading if present and different from last
        if (verse.section_heading && verse.section_heading !== lastSectionHeading) {
          html += `<div class="verse-section-heading">${verse.section_heading}</div>`;
          lastSectionHeading = verse.section_heading;
        }

        html += `
          <div class="verse-item" data-verse-id="${verse.id}">
            <span class="verse-number-badge">${verse.verse_number}</span>
            <div class="verse-content">
              <div class="verse-preview">${verse.verse_preview}</div>
              <div class="verse-reference">${verse.reference}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // Attach click handlers (CSP-compliant)
      container.querySelectorAll('.verse-item').forEach(item => {
        item.addEventListener('click', function() {
          selectVerse(this.dataset.verseId);
        });
      });
    }

    // Handle verse selection (show full verse text)
    let selectedVerseData = null;
    function selectVerse(verseId) {
      document.querySelectorAll('.verse-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.verseId === verseId);
      });
      // Could expand to show full verse in a detail panel if needed
    }

    function loadDemoItems(collectionId) {
      console.log('loadDemoItems called:', collectionId);
      // Generate items based on collection
      items = [];

      // Get subcategories for this collection from the fallback data
      const subcategories = getSubcategoriesForCollection(collectionId);

      if (subcategories && subcategories.length > 0) {
        // Use actual subcategory names
        subcategories.forEach((sub, index) => {
          items.push({
            id: sub.id,
            name: sub.name,
            title: sub.name,
            description: 'Configuration for ' + sub.name,
            is_active: true,
            hasDomains: sub.hasDomains || false
          });
        });
      } else {
        // Default: generate random sample items for collections without defined subcategories
        const count = Math.floor(Math.random() * 10) + 5;
        for (let i = 1; i <= count; i++) {
          items.push({
            id: 'item' + i,
            name: 'Item ' + String(i).padStart(2, '0'),
            title: 'Sample Item ' + i,
            description: 'Description for item ' + i,
            is_active: Math.random() > 0.2
          });
        }
      }
      console.log('Items generated:', items.length);
      renderItems();
    }

    function renderItems() {
      console.log('renderItems called, items count:', items.length);
      const container = document.getElementById('itemsListContent');

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state" id="itemsEmptyState">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/></svg>
            <div class="empty-state-title">No Items Found</div>
            <div class="empty-state-text">This collection doesn't have any items yet.</div>
          </div>
        `;
        return;
      }

      let html = '';
      items.forEach((item, index) => {
        const isSelected = selectedItemId === item.id;
        // Get item count (use metadata.count if available, otherwise default to 00)
        const itemCount = item.metadata?.count || item.count || 0;
        html += `
          <div class="item-list-item ${isSelected ? 'selected' : ''} ${!item.is_active ? 'inactive' : ''}" data-id="${item.id}">
            <div class="item-list-row" onclick="selectItem('${item.id}')">
              <span class="item-number-badge">${String(index + 1).padStart(2, '0')}</span>
              <span class="item-list-title">${item.name}</span>
              <span class="item-list-count">${String(itemCount).padStart(2, '0')}</span>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ==================== SELECT ITEM ====================
    function selectItem(itemId) {
      selectedItemId = itemId;

      // Update UI
      document.querySelectorAll('.item-list-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.id === itemId);
      });

      // Load item into editor
      const item = items.find(i => i.id === itemId);
      if (item) {
        showEditForm(item);
      }
    }

    function clearItemSelection() {
      selectedItemId = null;
      document.querySelectorAll('.item-list-item').forEach(item => {
        item.classList.remove('selected');
      });
      hideEditForm();
    }

    // ==================== EDIT FORM ====================
    function showEditForm(item) {
      document.getElementById('editEmptyState').style.display = 'none';
      document.getElementById('editForm').style.display = 'block';

      // Populate form fields
      document.getElementById('editItemName').value = item.name || '';
      document.getElementById('editItemTitle').value = item.title || '';
      document.getElementById('editItemDescription').value = item.description || '';
      document.getElementById('editItemConfig').value = JSON.stringify(item.config || {}, null, 2);
      document.getElementById('editItemMetadata').value = JSON.stringify(item.metadata || {}, null, 2);

      // Set active toggle
      const toggle = document.getElementById('editActiveToggle');
      toggle.classList.toggle('active', item.is_active);
    }

    function hideEditForm() {
      document.getElementById('editEmptyState').style.display = 'flex';
      document.getElementById('editForm').style.display = 'none';
    }

    // ==================== AUTO-SAVE ====================
    function autoSave() {
      if (!selectedItemId) return;

      // Debounce saves
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveItem();
      }, 1000);
    }

    async function saveItem() {
      if (!selectedItemId || !selectedCollectionId) return;

      const itemData = {
        name: document.getElementById('editItemName').value,
        title: document.getElementById('editItemTitle').value,
        description: document.getElementById('editItemDescription').value,
        config: JSON.parse(document.getElementById('editItemConfig').value || '{}'),
        metadata: JSON.parse(document.getElementById('editItemMetadata').value || '{}'),
        is_active: document.getElementById('editActiveToggle').classList.contains('active')
      };

      // For now, just show the autosave indicator (demo mode)
      showAutosaveIndicator();

      // Update local data
      const index = items.findIndex(i => i.id === selectedItemId);
      if (index !== -1) {
        items[index] = { ...items[index], ...itemData };
        renderItems();
      }
    }

    function showAutosaveIndicator() {
      const indicator = document.getElementById('autosaveIndicator');
      indicator.classList.add('visible');
      setTimeout(() => {
        indicator.classList.remove('visible');
      }, 2000);
    }

    // ==================== START ====================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
