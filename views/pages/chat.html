
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JubileeVerse.com - Conversation</title>
    <link rel="icon" type="image/png" href="/images/personas/jubilee.png">
    <link rel="apple-touch-icon" href="/images/personas/jubilee.png">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/top-header.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <style>
        @font-face {
            font-family: 'Agency FB';
            font-weight: bold;
            font-display: swap;
            src: url('/fonts/AGENCYB.TTF');
        }
        @font-face {
            font-family: 'Agency FB';
            font-display: swap;
            src: url('/fonts/AGENCYR.TTF');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #000;
            color: #f2f2f2;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar styles are loaded from /css/sidebar.css */

        /* ==================== MAIN AREA ==================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-top: 34px;
        }

        /* ==================== TOOLBAR ==================== */
        .toolbar {
            display: flex;
            align-items: center;
            padding: 4px 16px;
            background-color: #0f0f0f;
            border-bottom: 1px solid #3a3a3a;
            border-top: 1px solid #3a3a3a;
            gap: 14px;
            flex-wrap: nowrap;
            overflow: hidden;
            position: relative;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 54px;
        }

        .toolbar-big {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 96px;
            cursor: pointer;
        }

        .toolbar-big svg {
            width: 26px;
            height: 26px;
            fill: #ffbd59;
        }

        .toolbar-big span {
            font-size: 10px;
            color: #e6e6e6;
        }

        .toolbar-divider {
            width: 1px;
            height: 52px;
            background-color: #3a3a3a;
            margin: 0 2px;
        }

        .toolbar-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e6e6e6;
            font-size: 10px;
            cursor: pointer;
            white-space: nowrap;
        }

        .toolbar-row svg {
            width: 18px;
            height: 18px;
            fill: #ffbd59;
        }

        /* Toolbar spacer to push pin to right */
        .toolbar-spacer {
            flex: 1;
        }

        /* Pin icon in toolbar */
        .toolbar-pin {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #555;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            position: absolute;
            right: 12px;
            flex-shrink: 0;
        }

        .toolbar-pin:hover {
            transform: scale(1.1);
            background-color: #666;
            box-shadow: 0 0 8px rgba(100, 100, 100, 0.5);
        }

        .toolbar-pin svg {
            width: 14px;
            height: 14px;
            fill: #fff;
            transition: transform 0.3s ease;
        }

        .toolbar-pin.is-collapsed svg {
            transform: rotate(45deg);
        }

        /* Collapsed Toolbar State */
        .toolbar.is-collapsed {
            padding: 6px 16px;
            gap: 8px;
        }

        .toolbar.is-collapsed .toolbar-group {
            height: auto;
            gap: 8px;
        }

        .toolbar.is-collapsed .toolbar-big {
            flex-direction: row;
            min-width: auto;
            gap: 6px;
            padding: 4px 10px;
            background-color: rgba(255, 189, 89, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(255, 189, 89, 0.3);
            margin-right: 3px;
        }

        .toolbar.is-collapsed .toolbar-big#newMessageBtn {
            margin-left: 5px;
        }

        .toolbar.is-collapsed .toolbar-big:hover {
            background-color: rgba(255, 189, 89, 0.2);
        }

        .toolbar.is-collapsed .toolbar-big svg {
            width: 16px;
            height: 16px;
        }

        .toolbar.is-collapsed .toolbar-big span {
            font-size: 11px;
        }

        .toolbar.is-collapsed .toolbar-stack {
            display: none;
        }

        .toolbar.is-collapsed .toolbar-divider {
            height: 24px;
            margin: 0 4px;
        }

        /* When toolbar is collapsed, right-rail and language panel move up */
        .right-rail.toolbar-collapsed {
            top: 68px; /* Header (30px) + collapsed toolbar (~38px) */
            height: calc(100vh - 68px);
        }

        .language-panel.toolbar-collapsed {
            top: 68px;
            height: calc(100vh - 68px);
        }

        .persona-rail-panel.toolbar-collapsed {
            top: 68px;
            height: calc(100vh - 68px);
        }

        /* ==================== CONTENT AREA ==================== */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .app-container.is-mailbox-collapsed .mailbox-panel {
            width: 0;
            flex-basis: 0;
            border-right: none;
            opacity: 0;
            transform: translateX(-100%);
            pointer-events: none;
        }

        .app-container.is-mailbox-collapsed .panel-resizer#mailboxResizer {
            display: none;
        }

        .conversation-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-right: 8px;
        }

        .inbox-header {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 6px 12px 6px 6px;
            background-color: #1a1a1a;
            border-bottom: 2px solid #ffffff;
        }

        .inbox-header svg {
            width: 16px;
            height: 16px;
            fill: #ffbd59;
        }

        .inbox-header span#inboxHeaderTitle {
            flex: 1;
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            color: #ffffff;
        }

        .inbox-header .community-label {
            margin-left: auto;
            color: #ffbd59;
            font-size: 12px;
            font-weight: 600;
        }

        .inbox-header .subject-text {
            display: block;
            width: 100%;
            font-size: 11px;
            color: #cccccc;
            margin-top: 2px;
        }

        .content-columns {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* ==================== LEFT PANEL (Mailbox) ==================== */
        .mailbox-panel {
            width: 240px;
            background-color: #1a1a1a;
            border-right: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s ease, flex-basis 0.2s ease, transform 0.2s ease, opacity 0.2s ease;
            will-change: width, flex-basis, transform, opacity;
        }

        .mailbox-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-bottom: 2px solid #fff;
            margin-bottom: 4px;
        }

        .mailbox-header svg {
            width: 16px;
            height: 16px;
            fill: #ffbd59;
        }

        .mailbox-header span {
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }

        .mailbox-item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px 6px 18px;
            cursor: pointer;
            transition: background-color 0.15s ease, color 0.15s ease;
            border-radius: 6px;
        }

        .mailbox-item::before {
            content: "";
            position: absolute;
            left: 6px;
            top: 1px;
            bottom: 1px;
            width: 4px;
            border-radius: 4px;
            background-color: transparent;
        }

        .mailbox-item:hover {
            background-color: rgba(255, 189, 89, 0.1);
        }

        .mailbox-item.active {
            background-color: #2d2d2d;
        }

        .mailbox-item.active::before {
            background-color: #ffbd59;
        }

        .mailbox-item.active svg {
            fill: #ffbd59;
        }

        .mailbox-item.chat-inbox-item span {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 700;
        }

        /* My Community styling */
        .mailbox-item.community-inbox-item span {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 700;
        }

        /* Kingdom Builder styling */
        .mailbox-item.bulletin-board-item span {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 700;
        }

        /* Category items styling */
        .mailbox-item.mailbox-category-item span {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 700;
        }

        .mailbox-item svg {
            width: 18px;
            height: 18px;
            fill: #9a9a9a;
        }

        .mailbox-item.active svg {
            fill: #ffbd59;
        }

        .mailbox-item span {
            font-size: 11px;
            color: #cfcfcf;
        }

        .mailbox-item.active span {
            color: #fff;
        }

        .mailbox-spacer {
            flex: 1;
        }

        .mailbox-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid #3a3a3a;
            cursor: pointer;
            position: relative;
        }

        .mailbox-footer:hover {
            background-color: rgba(255, 189, 89, 0.1);
        }

        .mailbox-footer svg {
            width: 20px;
            height: 20px;
            fill: #ffbd59;
        }

        .mailbox-footer span {
            font-size: 11px;
            color: #cfcfcf;
        }

        .mailbox-footer .community-caret {
            margin-left: auto;
            width: 14px;
            height: 14px;
            fill: #cfcfcf;
        }

        .community-menu {
            position: absolute;
            left: 12px;
            bottom: 52px;
            width: 220px;
            max-height: 240px;
            overflow-y: auto;
            background-color: #141414;
            border: 1px solid #3a3a3a;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            display: none;
            z-index: 20;
        }

        .community-menu.open {
            display: block;
        }

        .community-menu-item {
            padding: 10px 12px;
            font-size: 12px;
            color: #e6e6e6;
            cursor: pointer;
        }

        .community-menu-item:hover {
            background-color: rgba(255, 189, 89, 0.12);
        }

        .community-menu-item.active {
            background-color: rgba(255, 189, 89, 0.18);
            color: #ffbd59;
        }

        /* ==================== CONVERSATION LIST ==================== */
        .conversation-list {
            width: 320px;
            background-color: #0b0b0b;
            border-right: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .conversation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #3a3a3a;
        }

        .conversation-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conversation-header-left svg {
            width: 20px;
            height: 20px;
            fill: #ffbd59;
        }

        .conversation-header-left span {
            font-size: 14px;
            font-weight: 600;
            color: #ffbd59;
        }

        .conversation-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conversation-header-right svg {
            width: 16px;
            height: 16px;
            fill: #9a9a9a;
            cursor: pointer;
        }

        .conversation-header-right svg:hover {
            fill: #ffbd59;
        }

        .conversation-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid #3a3a3a;
            background-color: #0b0b0b;
        }

        .conversation-tabs {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .conversation-tab {
            font-size: 11px;
            color: #f2f2f2;
            font-weight: 700;
            text-transform: uppercase;
        }

        .conversation-tab.is-muted {
            color: #cfcfcf;
            font-weight: 500;
            text-transform: uppercase;
        }

        .conversation-toolbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conversation-toolbar-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.85;
        }

        .conversation-toolbar-icon svg {
            width: 18px;
            height: 18px;
            fill: #d0d0d0;
        }

        .conversation-items {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #2f2f2f;
            transition: background-color 0.15s ease;
            background-color: #0b0b0b;
        }

        .conversation-item:hover {
            background-color: #131313;
        }

        .conversation-item.active {
            background-color: #4b4b4b;
            box-shadow: inset 0 0 0 1px #6f6f6f;
        }

        .conversation-item.unread::before {
            content: "";
            position: absolute;
            left: 0;
            top: 6px;
            bottom: 6px;
            width: 4px;
            background-color: #ffbd59;
            border-radius: 2px;
        }

        .conversation-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid #6ab5ff;
            background-color: #0b0b0b;
        }

        .conversation-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .conversation-item .conversation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 0;
            border-bottom: none;
        }

        .conversation-name {
            font-size: 12px;
            font-weight: 700;
            color: #f2f2f2;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 10px;
            color: #a8a8a8;
            flex-shrink: 0;
        }

        .conversation-subject {
            font-size: 11px;
            font-weight: 400;
            color: #e6e6e6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: -2px;
        }

        .conversation-subject-edit {
            width: 100%;
            display: block;
            background-color: #1a1a1a;
            border: 1px solid #ffbd59;
            border-radius: 3px;
            color: #f2f2f2;
            font-size: 11px;
            padding: 2px 6px;
            outline: none;
        }

        .conversation-preview {
            font-size: 10px;
            color: #b5b5b5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item.unread .conversation-name {
            color: #ffffff;
            font-weight: 800;
        }

        .conversation-item.unread .conversation-subject {
            color: #ffffff;
            font-weight: 400;
        }

        .conversation-item.active .conversation-name,
        .conversation-item.active .conversation-preview,
        .conversation-item.active .conversation-subject,
        .conversation-item.active .conversation-time {
            color: #f2f2f2;
        }

        .conversation-delete {
            background: transparent;
            border: none;
            width: 12px;
            height: 12px;
            padding: 0;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s;
            flex-shrink: 0;
            margin-left: auto;
            margin-right: 6px;
        }

        .conversation-delete svg {
            width: 12px;
            height: 12px;
            fill: #cfcfcf;
        }

        .conversation-item.active .conversation-delete,
        .conversation-item:hover .conversation-delete {
            opacity: 1;
        }

        .conversation-delete:hover svg {
            fill: #ff6b6b;
        }

        /* ==================== CHAT PANEL ==================== */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            position: relative;
        }

        .chat-subject {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: #0b0b0b;
            border-bottom: 1px solid #3a3a3a;
            font-size: 11px;
            color: #cfcfcf;
        }

        .chat-subject-left {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
            flex: 1;
        }

        .chat-subject-mailbox {
            color: #ffffff;
            font-weight: 700;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .chat-subject-separator {
            color: #666;
            font-weight: 400;
        }

        .chat-subject-right {
            display: flex;
            align-items: center;
            margin-left: 12px;
            flex-shrink: 0;
        }

        .chat-subject-community {
            color: #ffbd59;
            font-weight: 600;
            font-size: 10px;
            letter-spacing: 0.3px;
        }

        .chat-subject strong {
            color: #f2f2f2;
            font-weight: 700;
        }

        .chat-subject-text {
            color: #f2f2f2;
            font-weight: 700;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.15s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-subject-text:hover {
            background-color: #2a2a2a;
        }

        .chat-subject-input {
            background-color: #1a1a1a;
            border: 1px solid #ffbd59;
            border-radius: 3px;
            color: #f2f2f2;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            outline: none;
            min-width: 200px;
        }

        .chat-subject-pending {
            color: #9a9a9a;
            font-style: italic;
            font-weight: 500;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #3a3a3a;
            background-color: #1a1a1a;
        }

        .chat-header-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-title {
            font-size: 12px;
            font-weight: 600;
            color: #ffbd59;
        }

        .chat-header-subtitle {
            font-size: 9px;
            color: #9a9a9a;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .messages-area::-webkit-scrollbar {
            width: 6px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 3px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }

        .message-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .message-avatar.user-initials {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            background-color: #3b82f6;
            color: #ffffff;
            font-weight: 700;
            font-size: 9.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .message-content {
            flex: 1;
        }

        .message-sender {
            font-size: 11px;
            font-weight: 700;
            margin-top: 2px;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .message.user .message-sender {
            color: #ffffff;
        }

        .message.assistant .message-sender {
            color: #ffffff;
        }

        .message-text {
            font-size: 11px;
            line-height: 1.6;
            color: #e0e0e0;
            text-align: justify;
        }

        /* Streaming indicator */
        .message-text.streaming {
            position: relative;
        }

        .message-text.streaming::after {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #ffffff;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
            animation: streamingPulse 1s infinite ease-in-out;
        }

        @keyframes streamingPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .message-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .message-action {
            width: 16px;
            height: 16px;
            fill: #6a6a6a;
            cursor: pointer;
        }

        .message-action:hover {
            fill: #ffbd59;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            gap: 12px;
            padding: 16px;
        }

        .typing-indicator.show {
            display: flex;
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #ffbd59;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-4px); }
        }

        /* ==================== INPUT AREA ==================== */
        /* Outer wrapper - provides the visual "border" via background color and padding */
        .input-area-wrapper {
            margin-top: 5px;
            padding: 2px;
            background-color: #3a3a3a;
            border-radius: 4px;
            overflow: visible;
            position: relative;
            transition: background-color 0.2s ease;
        }

        /* Active state - yellow background simulates yellow border */
        .input-area-wrapper.is-active {
            background-color: #ffbd59;
        }

        /* When panel is expanded, remove top border radius */
        .input-area-wrapper.panel-expanded {
            border-radius: 0 0 4px 4px;
        }

        /* Inner container - contains all the actual input elements */
        .input-area-inner {
            background-color: #4b4b4b;
            border-radius: 2px;
            overflow: visible;
        }

        /* When panel is expanded, inner container gets rounded bottom only */
        .input-area-wrapper.panel-expanded .input-area-inner {
            border-radius: 0 0 2px 2px;
        }

        .chatbox-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            border-bottom: 1px solid #3a3a3a;
            background-color: #4b4b4b;
            transition: border-color 0.2s ease;
        }

        .chatbox-recipient {
            display: flex;
            align-items: center;
            gap: 1px;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }

        .chatbox-to-label {
            font-size: 11px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.3px;
            flex-shrink: 0;
        }

        .chatbox-tabs {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-wrap: wrap;
            row-gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .chatbox-tab {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background-color: #3a3a3a;
            border: 1px solid #ffbd59;
            border-radius: 14px;
            font-size: 11px;
            color: #f2f2f2;
        }

        .chatbox-tab.community-tab {
            background-color: #3a3a3a;
            border-color: #ffbd59;
        }

        .chatbox-tab .community-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: #ffffff;
            font-size: 9px;
            font-weight: 700;
            margin-right: 4px;
        }

        .chatbox-separator {
            color: #888;
            margin: 0 2px;
            font-size: 12px;
        }

        .chatbox-tab.is-name-hidden span {
            display: none;
        }

        .chatbox-tab img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #8a8a8a;
        }

        .chatbox-close {
            border: none;
            background: transparent;
            color: #d0d0d0;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            padding: 0 2px;
        }

        .chatbox-close:hover {
            color: #ffffff;
        }

        .chatbox-persona-expand {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #6c6c6c;
            background-color: #4b4b4b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 4px;
            transition: all 0.2s ease;
        }

        .chatbox-persona-expand:hover {
            background-color: #ffbd59;
            border-color: #ffbd59;
        }

        .chatbox-persona-expand svg {
            width: 14px;
            height: 14px;
            fill: #d0d0d0;
        }

        .chatbox-persona-expand:hover svg {
            fill: #1a1a1a;
        }

        .chatbox-expand {
            width: 34px;
            height: 26px;
            border-radius: 4px;
            border: 1px solid #888888;
            background-color: #6a6a6a;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chatbox-expand:hover {
            background-color: #7a7a7a;
            border-color: #999999;
        }

        .chatbox-expand svg {
            width: 18px;
            height: 18px;
            fill: #ffffff;
        }

        .chatbox-expand svg {
            transition: transform 0.2s ease;
        }

        .chatbox-expand.is-expanded svg {
            transform: scale(1.05);
        }

        .chatbox-entry {
            padding: 4px 10px;
        }

        .chatbox-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 4px 8px 6px 8px;
        }

        .chatbox-left {
            display: flex;
            align-items: center;
        }

        .chatbox-add {
            width: 34px;
            height: 26px;
            border-radius: 4px;
            border: 1px solid #8a8a8a;
            background-color: #4b4b4b;
            color: #d0d0d0;
            font-size: 20px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: #f2f2f2;
            font-size: 10px;
            font-weight: 400;
            font-family: inherit;
            resize: none;
            height: 24px;
            min-height: 24px;
            line-height: 1.4;
            padding: 0;
            margin: 0;
        }

        .chat-input::placeholder {
            color: #c0c0c0;
            font-weight: 400;
            font-style: normal;
        }

        .chatbox-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chatbox-lock {
            width: 30px;
            height: 26px;
            border-radius: 4px;
            border: 1px solid #8a8a8a;
            background-color: #4b4b4b;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbox-lock svg {
            width: 16px;
            height: 16px;
            fill: #d0d0d0;
        }

        .chatbox-model {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background-color: #5a5a5a;
            border: 1px solid #6c6c6c;
            border-radius: 4px;
            font-size: 10px;
            color: #f2f2f2;
            white-space: nowrap;
            cursor: pointer;
        }

        .chatbox-model svg {
            width: 12px;
            height: 12px;
            fill: #d0d0d0;
        }

        .chatbox-submit {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: #ffbd59;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chatbox-submit:hover {
            background-color: #ffc970;
        }

        .chatbox-submit .play-icon {
            display: block;
        }

        .chatbox-submit .stop-icon {
            display: none;
        }

        .chatbox-submit.is-processing .play-icon {
            display: none;
        }

        .chatbox-submit.is-processing .stop-icon {
            display: block;
        }

        /* Legacy voice button styling */
        .chatbox-voice {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: #ffbd59;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chatbox-voice svg {
            width: 18px;
            height: 18px;
            stroke: #1a1a1a;
            stroke-width: 2;
            fill: none;
        }

        /* ==================== CUSTOM SCROLLBAR STYLES ==================== */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ffbd59 0%, #e0a040 100%);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ffc970 0%, #f0b050 100%);
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #ffbd59 #2a2a2a;
        }

        /* ==================== PERSONA SELECTION PANEL ==================== */
        /* Panel wrapper for the upward expansion visual border effect */
        .persona-selection-panel {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            z-index: 100;
            /* When expanded, this provides the 2px "border" via padding and background */
            padding: 0;
            background-color: transparent;
            border-radius: 6px 6px 0 0;
        }

        .persona-selection-panel.expanded {
            max-height: 330px;
            /* 2px padding on top and sides for yellow "border" effect, no bottom */
            padding: 2px 2px 0 2px;
            background-color: transparent;
        }

        /* When wrapper is active and panel is expanded, show yellow "border" */
        .input-area-wrapper.is-active .persona-selection-panel.expanded {
            background-color: #ffbd59;
        }

        /* When wrapper is inactive and panel is expanded, show gray "border" */
        .input-area-wrapper:not(.is-active) .persona-selection-panel.expanded {
            background-color: #3a3a3a;
        }

        /* Inner content of the panel */
        .persona-selection-panel .persona-panel-header,
        .persona-selection-panel .persona-panel-content {
            background-color: #4a4a4a;
        }

        .persona-selection-panel .persona-panel-header {
            padding: 8px;
            border-radius: 4px 4px 0 0;
        }

        .persona-selection-panel.expanded .persona-panel-content {
            padding: 8px;
            background-color: #4a4a4a;
        }

        .persona-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 6px;
            border-bottom: 1px solid #6c6c6c;
            margin-bottom: 6px;
        }

        .persona-panel-title {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ffffff;
            font-size: 10px;
            font-weight: 600;
        }

        .persona-panel-title svg {
            width: 12px;
            height: 12px;
            fill: #ffbd59;
        }

        .persona-panel-profile-header {
            display: none;
        }

        .persona-panel-expand-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.15s;
        }

        .persona-panel-expand-icon:hover {
            background-color: rgba(255, 189, 89, 0.2);
        }

        .persona-panel-expand-icon svg {
            width: 12px;
            height: 12px;
            fill: #d0d0d0;
        }

        .persona-panel-content {
            display: flex;
            gap: 0;
            height: 260px;
        }

        .persona-panel-left {
            flex: 2;
            max-height: 260px;
            overflow-y: auto;
            padding-right: 8px;
            border-right: 1px solid #6c6c6c;
        }

        .persona-panel-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 0 8px;
            background-color: transparent;
            border-radius: 0;
            border: none;
        }

        .persona-panel-right-header {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ffffff;
            font-size: 10px;
            font-weight: 600;
            width: 100%;
            padding-bottom: 6px;
            margin-bottom: 8px;
            border-bottom: 1px solid #6c6c6c;
        }

        .persona-panel-right-header svg {
            width: 12px;
            height: 12px;
            fill: #ffbd59;
        }

        .selected-persona-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .selected-persona-content.community-context {
            align-items: flex-start;
            justify-content: flex-start;
            width: 100%;
            gap: 8px;
        }

        .community-context-item {
            width: 100%;
        }

        .community-context-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: #9a9a9a;
            margin-bottom: 2px;
        }

        .community-context-value {
            font-size: 11px;
            color: #f2f2f2;
            font-weight: 600;
            line-height: 1.2;
        }

        .selected-persona-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ffbd59;
            margin-bottom: 8px;
        }

        .selected-persona-initials {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #6c6c6c;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            border: 2px solid #ffbd59;
            margin-bottom: 8px;
        }

        .selected-persona-name {
            color: #ffffff;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 2px;
        }

        .selected-persona-role {
            color: #9a9a9a;
            font-size: 9px;
            text-align: center;
        }

        .no-persona-selected {
            color: #9a9a9a;
            font-size: 9px;
            text-align: center;
            padding: 20px 0;
        }

        .persona-section {
            margin-bottom: 6px;
        }

        .persona-section-header {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 6px;
            background-color: #5a5a5a;
            border-radius: 3px;
            margin-bottom: 3px;
            cursor: pointer;
        }

        .persona-section-header svg {
            width: 12px;
            height: 12px;
            fill: #ffbd59;
        }

        .persona-section-header span {
            color: #ffffff;
            font-size: 9px;
            font-weight: 600;
        }

        .persona-list {
            padding-left: 4px;
        }

        .persona-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 5px;
            border-radius: 3px;
            cursor: default;
            transition: background-color 0.15s;
        }

        .persona-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .persona-item-checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid #6c6c6c;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .persona-item-checkbox.checked {
            background-color: #ffbd59;
            border-color: #ffbd59;
        }

        .persona-item-checkbox.checked svg {
            width: 10px;
            height: 10px;
            fill: #1a1a1a;
        }

        .persona-item-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #ffbd59;
        }

        .persona-item-initials {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #6c6c6c;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 600;
            color: #ffffff;
            flex-shrink: 0;
        }

        .persona-item-name {
            color: #f2f2f2;
            font-size: 9px;
            font-weight: 500;
        }

        /* ==================== INSPIRE DROPDOWN MENU ==================== */
        .inspire-dropdown-wrapper {
            position: relative;
        }

        .inspire-dropdown {
            display: flex;
            align-items: center;
            gap: 4px;
            background-color: #6b6b6b;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #ffffff;
            transition: all 0.15s;
            border: 1px solid #7b7b7b;
        }

        .inspire-dropdown:hover {
            background-color: #757575;
            color: #fff;
        }

        .inspire-dropdown svg {
            width: 10px;
            height: 10px;
            fill: #f0f0f0;
        }

        .inspire-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 8px;
            width: 280px;
            background-color: #3a3a3a;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid #ffbd59;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease;
            z-index: 1000;
            overflow: hidden;
        }

        .inspire-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .inspire-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 3px 14px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .inspire-menu-item::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background-color: #ffbd59;
            border-radius: 50%;
            z-index: 0;
        }

        .inspire-menu-item:hover {
            background-color: rgba(255, 189, 89, 0.15);
        }

        .inspire-menu-item.selected {
            background-color: #ffbd59;
            border-radius: 6px;
            margin: 2px 8px;
            padding: 3px 6px;
        }

        .inspire-menu-item.selected::before {
            background-color: #000000;
            left: 6px;
        }

        .inspire-menu-item.selected .inspire-menu-icon {
            filter: none;
            -webkit-filter: none;
        }

        .inspire-menu-item.selected .inspire-menu-title {
            color: #000000;
            font-weight: bold;
        }

        .inspire-menu-item.selected .inspire-menu-subtitle {
            color: #333333;
            font-weight: bold;
        }

        .inspire-menu-item.selected .inspire-menu-check svg {
            fill: #000000;
        }

        .inspire-menu-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background-color: transparent;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
            filter: brightness(0);
            -webkit-filter: brightness(0);
        }

        .inspire-menu-content {
            flex: 1;
        }

        .inspire-menu-title {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            margin-top: 2px;
        }

        .inspire-menu-subtitle {
            color: #c0c0c0;
            font-size: 11px;
            margin-top: -2px;
        }

        .inspire-menu-check {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inspire-menu-check svg {
            width: 16px;
            height: 16px;
            fill: #ffbd59;
        }

        .inspire-menu-divider {
            height: 1px;
            background-color: #4a4a4a;
            margin: 4px 14px;
        }

        .inspire-menu-footer {
            display: none;
        }

        .inspire-submenu {
            display: none;
        }

        .inspire-menu-footer:hover .inspire-submenu {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .inspire-submenu-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .inspire-submenu-item:hover {
            background-color: rgba(255, 189, 89, 0.1);
        }

        .inspire-submenu-item.selected {
            background-color: rgba(255, 189, 89, 0.15);
        }

        .inspire-submenu-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }

        .inspire-submenu-content {
            flex: 1;
        }

        .inspire-submenu-title {
            color: #ffffff;
            font-size: 10px;
            font-weight: 500;
        }

        .inspire-submenu-subtitle {
            color: #9a9a9a;
            font-size: 8px;
            margin-top: 1px;
        }

        /* ==================== RIGHT SIDEBAR (Mode + Icons) ==================== */
        .right-rail {
            position: fixed;
            right: 0;
            top: 94px; /* Below header + toolbar */
            height: calc(100vh - 94px);
            display: flex;
            align-items: stretch;
            flex-shrink: 0;
            width: 72px;
            background-color: #000;
            border-left: 2px solid #ffbd59;
            z-index: 600; /* Above content but below language panel when it slides */
        }

        .mode-banner {
            width: 30px;
            background-color: #ffbd59;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            margin-top: 0px;
            border-radius: 0;
            padding-top: 10px;
        }

        .mode-banner-text {
            font-family: Impact, "Arial Black", Arial, sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: #1a1a1a;
            letter-spacing: 1px;
            transform: rotate(180deg);
            margin-bottom: 0;
        }

        .right-icons {
            width: 34px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 10px;
        }

        .right-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .right-flag {
            width: 26px;
            height: 26px;
            border: 2px solid #ffbd59;
            border-radius: 50%;
            overflow: hidden;
            background-color: #2a2a2a;
        }

        .right-flag svg {
            width: 26px;
            height: 26px;
            border-radius: 50%;
        }

        .right-voice {
            width: 26px;
            height: 26px;
            background-color: #6a6a6a;
        }

        .right-voice svg {
            width: 14px;
            height: 14px;
            stroke: #ffffff;
        }

        .right-voice:hover {
            background-color: #ffbd59;
        }

        .right-voice:hover svg {
            stroke: #1a1a1a;
        }

        .right-voice.active {
            background-color: #ffbd59;
        }

        .right-voice.active svg {
            stroke: #1a1a1a;
        }

        /* Voice Panel Styles */
        .voice-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 400px;
            background-color: #2a2a2a;
            border-radius: 16px;
            border: 2px solid #ffbd59;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .voice-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .voice-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .voice-panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .voice-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #444;
        }

        .voice-panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .voice-panel-title svg {
            width: 20px;
            height: 20px;
            stroke: #ffbd59;
        }

        .voice-panel-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            background-color: transparent;
            transition: background-color 0.2s;
        }

        .voice-panel-close:hover {
            background-color: rgba(255, 189, 89, 0.2);
        }

        .voice-panel-close svg {
            width: 16px;
            height: 16px;
            fill: #888;
        }

        .voice-panel-content {
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .voice-panel-visualizer {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffbd59 0%, #1a1a1a 70%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .voice-panel-visualizer::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #ffbd59;
            animation: voice-pulse 2s infinite;
        }

        @keyframes voice-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        .voice-panel-visualizer.listening::before {
            animation: voice-pulse-active 0.5s infinite;
        }

        @keyframes voice-pulse-active {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .voice-panel-mic {
            width: 48px;
            height: 48px;
            background-color: #1a1a1a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
        }

        .voice-panel-mic:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        .voice-panel-mic svg {
            width: 24px;
            height: 24px;
            fill: #ffbd59;
        }

        .voice-panel-mic.recording {
            background-color: #ff4444;
        }

        .voice-panel-mic.recording svg {
            fill: #ffffff;
        }

        .voice-panel-status {
            color: #888;
            font-size: 14px;
            text-align: center;
        }

        .voice-panel-status.active {
            color: #ffbd59;
        }

        .voice-panel-persona {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: #3a3a3a;
            border-radius: 8px;
            width: 100%;
        }

        .voice-panel-persona-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .voice-panel-persona-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .voice-panel-persona-name {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
        }

        .voice-panel-persona-role {
            color: #888;
            font-size: 12px;
        }

        .voice-panel-footer {
            padding: 16px 20px;
            border-top: 1px solid #444;
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .voice-panel-btn {
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .voice-panel-btn-primary {
            background-color: #ffbd59;
            color: #1a1a1a;
        }

        .voice-panel-btn-primary:hover {
            background-color: #ffc970;
        }

        .voice-panel-btn-secondary {
            background-color: #4a4a4a;
            color: #ffffff;
        }

        .voice-panel-btn-secondary:hover {
            background-color: #5a5a5a;
        }

        .right-persona {
            width: 26px;
            height: 26px;
            background-color: #6a6a6a;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .right-persona svg {
            width: 14px;
            height: 14px;
            fill: #ffffff;
        }

        .right-persona:hover {
            background-color: #ffbd59;
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(255, 189, 89, 0.5);
        }

        .right-persona:hover svg {
            fill: #1a1a1a;
        }

        .right-icons-spacer {
            flex: 1;
        }

        .right-token {
            width: 26px;
            height: 26px;
        }

        .right-token-ring {
            width: 26px;
            height: 26px;
            position: relative;
        }

        .right-token-ring svg {
            width: 26px;
            height: 26px;
            transform: rotate(-90deg);
        }

        .right-token-ring circle {
            fill: none;
            stroke-width: 2;
        }

        .right-token-bg {
            stroke: #3a3a3a;
        }

        .right-token-progress {
            stroke: #ffbd59;
            stroke-dasharray: 69;
            stroke-dashoffset: 25;
            stroke-linecap: round;
        }

        .right-token-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 7px;
            font-weight: 700;
            color: #ffbd59;
        }

        .right-flag {
            cursor: pointer;
            transition: all 0.2s ease;
            pointer-events: auto;
            z-index: 100;
        }

        .right-flag:hover {
            transform: scale(1.1);
            border-color: #ffbd59;
            box-shadow: 0 0 8px rgba(255, 189, 89, 0.5);
        }

        .right-icons {
            pointer-events: auto;
        }

        /* Tooltip positioning - left of icons */
        .right-icon[title] {
            position: relative;
        }

        .right-icon[title]::before {
            content: attr(title);
            position: absolute;
            right: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
            background-color: #2a2a2a;
            color: #ffffff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid #4a4a4a;
        }

        .right-icon[title]::after {
            content: '';
            position: absolute;
            right: calc(100% + 4px);
            top: 50%;
            transform: translateY(-50%);
            border: 4px solid transparent;
            border-left-color: #2a2a2a;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .right-icon[title]:hover::before,
        .right-icon[title]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Inbox panel (slides in from right, similar to language panel) */
        .inbox-panel {
            position: fixed;
            top: 94px; /* Below header (30px) + toolbar (~64px) */
            right: -141px; /* Hidden: -213px + 72px (right-rail width) */
            width: 213px;
            height: calc(100vh - 94px);
            background-color: #1a1a1a;
            border-left: 2px solid #ffbd59;
            border-top: 4px solid #ffbd59;
            z-index: 545; /* Below right-rail (600) but above content */
            display: flex;
            flex-direction: row;
            transition: right 0.3s ease-in-out;
        }

        .inbox-panel.open {
            right: 72px; /* Position to the left of the fixed right-rail */
        }

        .inbox-panel-header {
            position: absolute;
            top: 8px;
            right: 10px;
            z-index: 501;
        }

        .inbox-panel-close {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #6b6b6b;
            border: none;
            color: #e6e6e6;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .inbox-panel-close:hover {
            background-color: #fff;
            color: #1a1a1a;
            transform: scale(1.1);
        }

        .inbox-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 40px 15px 20px 15px;
        }

        .inbox-message-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #3a3a3a;
        }

        .inbox-message-item:hover {
            background-color: #3a3a3a;
        }

        .inbox-message-item.active {
            background-color: #333;
            border: 1px solid #ffbd59;
        }

        .inbox-message-avatar {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }

        .inbox-message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .inbox-message-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .inbox-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inbox-message-name {
            font-size: 12px;
            font-weight: 600;
            color: #e6e6e6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inbox-message-time {
            font-size: 10px;
            color: #888;
            flex-shrink: 0;
        }

        .inbox-message-preview {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Content area adjustments when inbox panel is open */
        .content-area.inbox-panel-open {
            margin-right: 285px; /* 72px right-rail + 213px inbox panel */
        }

        /* ==================== LANGUAGE TRANSLATION PANEL ==================== */
        /* The panel slides under the ribbon bar and pushes content */
        .language-panel {
            position: fixed;
            top: 94px; /* Below header (30px) + toolbar (~64px) */
            right: -141px; /* Hidden: -213px + 72px (right-rail width) */
            width: 213px; /* Reduced from 320px by 1/3 */
            height: calc(100vh - 94px);
            background-color: #1a1a1a;
            border-left: 2px solid #ffbd59;
            border-top: 4px solid #ffbd59;
            z-index: 550; /* Below right-rail (600) but above content */
            display: flex;
            flex-direction: row;
            transition: right 0.3s ease-in-out;
        }

        .language-panel.open {
            right: 72px; /* Position to the left of the fixed right-rail */
        }

        /* Content area always has right margin for fixed right-rail */
        .content-area {
            margin-right: 72px; /* Space for fixed right-rail */
            transition: margin-right 0.3s ease-in-out;
        }

        /* When language panel is open, add additional margin for the panel */
        .content-area.language-panel-open {
            margin-right: 285px; /* 72px right-rail + 213px language panel */
        }

        .content-area.persona-panel-open {
            margin-right: 285px; /* 72px right-rail + 213px persona panel */
        }

        .language-panel-header {
            position: absolute;
            top: 5px;
            right: 10px;
            z-index: 501;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .language-panel-pin {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: transparent;
            border: none;
            color: #888888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .language-panel-pin:hover {
            color: #ffffff;
            transform: scale(1.1);
        }

        .language-panel-pin.is-pinned {
            color: #ffbd59;
            transform: rotate(45deg);
        }

        .language-panel-pin.is-pinned:hover {
            color: #ffbd59;
        }

        .language-panel-close {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #333333;
            border: none;
            color: #e6e6e6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .language-panel-close:hover {
            background-color: #555555;
            color: #ffffff;
            transform: scale(1.1);
        }

        .language-panel-title {
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            position: absolute;
            top: 6px;
            left: 16px;
            z-index: 10;
        }

        .language-panel-divider {
            height: 2px;
            background-color: #ffffff;
            position: absolute;
            top: 30px;
            left: 12px;
            right: 12px;
            opacity: 0.95;
        }

        .language-panel-header-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 35px;
            background-color: #1a1a1a;
            z-index: 1;
            border-radius: 8px 8px 0 0;
        }

        .language-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 35px 15px 20px 15px;
        }

        .language-section {
            margin-bottom: 14px;
        }

        .language-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #ffbd59;
            margin-bottom: 8px;
            padding-top: 10px;
            padding-bottom: 4px;
            border-bottom: 1px solid #3a3a3a;
            letter-spacing: 0.3px;
        }

        .language-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .language-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .language-item:hover {
            background-color: #2a2a2a;
        }

        .language-item.selected {
            background-color: #333;
            border: 1px solid #ffbd59;
        }

        .language-flag {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #4a4a4a;
        }

        .language-name {
            font-size: 11px;
            color: #e0e0e0;
            flex: 1;
        }

        .language-item.selected .language-name {
            color: #ffbd59;
        }

        /* Custom scrollbar for language panel */
        .language-panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .language-panel-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .language-panel-content::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 3px;
        }

        .language-panel-content::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* ==================== INSPIRE PERSONA PANEL ==================== */
        .persona-rail-panel {
            position: fixed;
            top: 94px; /* Below header (30px) + toolbar (~64px) */
            right: -141px; /* Hidden: -213px + 72px (right-rail width) */
            width: 213px; /* Match language panel width */
            height: calc(100vh - 94px);
            background-color: #1a1a1a;
            border-left: 2px solid #ffbd59;
            border-top: 4px solid #ffbd59;
            z-index: 545; /* Below right-rail (600) but above content */
            display: flex;
            flex-direction: row;
            transition: right 0.3s ease-in-out;
        }

        .persona-rail-panel.open {
            right: 72px; /* Position to the left of the fixed right-rail */
        }

        .persona-rail-header {
            position: absolute;
            top: 5px;
            right: 10px;
            z-index: 501;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .persona-rail-pin {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: transparent;
            border: none;
            color: #888888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .persona-rail-pin:hover {
            color: #ffffff;
            transform: scale(1.1);
        }

        .persona-rail-pin.is-pinned {
            color: #ffbd59;
            transform: rotate(45deg);
        }

        .persona-rail-pin.is-pinned:hover {
            color: #ffbd59;
        }

        .persona-rail-close {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #333333;
            border: none;
            color: #e6e6e6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .persona-rail-close:hover {
            background-color: #555555;
            color: #ffffff;
            transform: scale(1.1);
        }

        .persona-rail-header-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 37px;
            background-color: #1a1a1a;
            z-index: 10;
            border-radius: 8px 8px 0 0;
        }

        .persona-rail-title {
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 10px 15px 0 15px;
            letter-spacing: 0.5px;
            z-index: 10;
        }

        .persona-rail-divider {
            height: 2px;
            background-color: #ffffff;
            position: absolute;
            bottom: 4px;
            left: 15px;
            right: 15px;
            opacity: 0.95;
        }

        .persona-rail-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 40px 15px 20px 15px;
        }

        .persona-rail-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .persona-rail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid transparent;
        }

        .persona-rail-panel.is-readonly .persona-rail-item {
            cursor: default;
            opacity: 0.55;
        }

        .persona-rail-panel.is-readonly .persona-rail-item.selected {
            opacity: 1;
        }

        .persona-rail-item.is-hidden {
            display: none;
        }

        .persona-rail-item:hover {
            background-color: #2a2a2a;
        }

        .persona-rail-item.selected {
            background-color: #333;
            border: 1px solid #ffbd59;
        }

        .persona-rail-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #4a4a4a;
        }

        .persona-rail-item.selected .persona-rail-avatar {
            border-color: #ffbd59;
        }

        .persona-rail-name {
            font-size: 11px;
            color: #e0e0e0;
            flex: 1;
        }

        .persona-rail-item.selected .persona-rail-name {
            color: #ffbd59;
        }

        .persona-rail-content::-webkit-scrollbar {
            width: 6px;
        }

        .persona-rail-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .persona-rail-content::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 3px;
        }

        .persona-rail-content::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* ==================== RESIZE HANDLES ==================== */
        .panel-resizer {
            width: 6px;
            background-color: #141414;
            border-right: 1px solid #2a2a2a;
            cursor: col-resize;
            flex-shrink: 0;
        }

        .panel-resizer:hover,
        .panel-resizer.is-dragging {
            background-color: #1f1f1f;
        }

        .panel-resizer::before {
            content: "";
            display: block;
            width: 2px;
            height: 100%;
            margin: 0 auto;
            background-color: #2f2f2f;
        }

        /* ==================== FOOTER ==================== */
        .footer {
            text-align: center;
            padding: 6px 16px;
            color: #6a6a6a;
            font-size: 10px;
            background-color: #1a1a1a;
            border-top: 1px solid #3a3a3a;
        }

        .footer a {
            color: #6a6a6a;
            text-decoration: none;
        }

        .footer a:hover {
            color: #ffbd59;
        }

        /* ==================== TOKEN INDICATOR ==================== */
        .token-indicator {
            display: none;
        }

        .token-ring {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .token-ring svg {
            transform: rotate(-90deg);
            width: 26px;
            height: 26px;
        }

        .token-ring circle {
            fill: none;
            stroke-width: 2;
        }

        .token-bg-circle {
            stroke: #3a3a3a;
        }

        .token-progress-circle {
            stroke: #ffbd59;
            stroke-dasharray: 69;
            stroke-dashoffset: 25;
            stroke-linecap: round;
        }

        .token-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            font-weight: 700;
            color: #ffbd59;
        }

        /* ==================== PIN MODAL ==================== */
        .pin-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, background-color 0.3s ease, visibility 0.3s ease;
        }

        .pin-modal-overlay.open {
            opacity: 1;
            visibility: visible;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .pin-modal {
            background-color: #2b2b2b;
            border: 2px solid #ffbd59;
            border-radius: 16px;
            padding: 32px 40px;
            text-align: center;
            max-width: 360px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .pin-modal-overlay.open .pin-modal {
            transform: scale(1);
        }

        .pin-modal-title {
            color: #ffbd59;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .pin-modal-text {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 28px;
        }

        .pin-inputs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .pin-input {
            width: 56px;
            height: 64px;
            background-color: #1a1a1a;
            border: 2px solid #ffbd59;
            border-radius: 12px;
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            text-align: center;
            outline: none;
            transition: all 0.15s;
        }

        .pin-input:focus {
            border-color: #ffc970;
            box-shadow: 0 0 12px rgba(255, 189, 89, 0.4);
        }

        /* ==================== DELETE CONFIRMATION MODAL ==================== */
        .delete-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, background-color 0.3s ease, visibility 0.3s ease;
        }

        .delete-modal-overlay.open {
            opacity: 1;
            visibility: visible;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .delete-modal {
            background-color: #1a1a1a;
            border: 2px solid #ffbd59;
            border-radius: 16px;
            padding: 28px 32px;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .delete-modal-overlay.open .delete-modal {
            transform: scale(1);
        }

        .delete-modal-content {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 24px;
        }

        .delete-modal-icon {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-modal-icon svg {
            width: 40px;
            height: 40px;
            fill: #ffbd59;
        }

        .delete-modal-text {
            flex: 1;
        }

        .delete-modal-title {
            color: #ffbd59;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .delete-modal-message {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
        }

        .delete-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .delete-modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }

        .delete-modal-cancel {
            background-color: #3a3a3a;
            color: #e6e6e6;
            border: 1px solid #5a5a5a;
        }

        .delete-modal-cancel:hover {
            background-color: #4a4a4a;
        }

        .delete-modal-cancel:focus {
            box-shadow: 0 0 0 2px rgba(255, 189, 89, 0.3);
        }

        .delete-modal-ok {
            background-color: #ffbd59;
            color: #1a1a1a;
        }

        .delete-modal-ok:hover {
            background-color: #ffc970;
        }

        .delete-modal-ok:focus {
            box-shadow: 0 0 0 2px rgba(255, 189, 89, 0.5);
        }

        /* ==================== FILE ATTACHMENT DISPLAY ==================== */
        .chatbox-attachments {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background-color: #3a3a3a;
            border-radius: 4px;
            margin-left: 8px;
        }

        .chatbox-attachments.has-files {
            display: flex;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background-color: #5a5a5a;
            border-radius: 4px;
            font-size: 10px;
            color: #f2f2f2;
        }

        .attachment-item svg {
            width: 12px;
            height: 12px;
            fill: #ffbd59;
        }

        .attachment-remove {
            background: none;
            border: none;
            color: #d0d0d0;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            font-size: 14px;
            line-height: 1;
        }

        .attachment-remove:hover {
            color: #ff6b6b;
        }

        /* Hidden file input */
        #fileAttachmentInput {
            display: none;
        }
    </style>
</head>
<body>
    <!-- PIN Modal -->
    <div class="pin-modal-overlay" id="pinModalOverlay">
        <div class="pin-modal">
            <div class="pin-modal-title" id="pinModalTitle">Private Chat</div>
            <div class="pin-modal-text" id="pinModalText">Please enter a four digit pin to encrypt your conversation for privacy.</div>
            <div class="pin-inputs">
                <input type="text" class="pin-input" id="pin1" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                <input type="text" class="pin-input" id="pin2" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                <input type="text" class="pin-input" id="pin3" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
                <input type="text" class="pin-input" id="pin4" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-modal-overlay" id="deleteModalOverlay">
        <div class="delete-modal">
            <div class="delete-modal-content">
                <div class="delete-modal-icon">
                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </div>
                <div class="delete-modal-text">
                    <div class="delete-modal-title">Delete Conversation</div>
                    <div class="delete-modal-message" id="deleteModalMessage">Are you sure you want to delete this message?</div>
                </div>
            </div>
            <div class="delete-modal-buttons">
                <button type="button" class="delete-modal-btn delete-modal-cancel" id="deleteModalCancel">Cancel</button>
                <button type="button" class="delete-modal-btn delete-modal-ok" id="deleteModalOk">OK</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- LEFT SIDEBAR (loaded dynamically) -->
        <div id="sidebar-container"></div>

        <!-- MAIN AREA -->
        <div class="main-area">
            <!-- Top Header (loaded dynamically) -->
            <div id="header-container"></div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-group">
                    <div class="toolbar-big" id="newMessageBtn" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                        <span>New Message</span>
                    </div>
                    <div class="toolbar-big" id="myCommunitiesBtn" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        <span>My Communities</span>
                    </div>
                    <div class="toolbar-stack">
                        <div class="toolbar-row">
                            <svg viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>
                            <span>Reply to Message</span>
                        </div>
                        <div class="toolbar-row">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            <span>Remove Message</span>
                        </div>
                    </div>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <div class="toolbar-big">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <span>Search</span>
                    </div>
                    <div class="toolbar-stack">
                        <div class="toolbar-row">
                            <svg viewBox="0 0 24 24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>
                            <span>Filter Options</span>
                        </div>
                        <div class="toolbar-row">
                            <svg viewBox="0 0 24 24"><path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/></svg>
                            <span>Sort Settings</span>
                        </div>
                    </div>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <div class="toolbar-big">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
                        <span>Voice Mode</span>
                    </div>
                    <div class="toolbar-big">
                        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                        <span>Configuration</span>
                    </div>
                </div>
                <!-- Spacer to push pin to right -->
                <div class="toolbar-spacer"></div>
                <!-- Pin Toggle Button -->
                <div class="toolbar-pin" id="toolbarPinBtn" title="Toggle compact toolbar">
                    <svg viewBox="0 0 24 24"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/></svg>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Mailbox Panel -->
                <div class="mailbox-panel">
                    <div class="mailbox-header">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <span>Conversation Mailbox</span>
                    </div>
                    <div class="mailbox-item chat-inbox-item active" data-mailbox="chat_inbox">
                        <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                        <span>Chat Inbox</span>
                    </div>
                    <div class="mailbox-item community-inbox-item" data-mailbox="my_community">
                        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        <span>My Community</span>
                    </div>
                    <div class="mailbox-item bulletin-board-item" data-mailbox="kingdom_builder">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                        <span>Kingdom Builder</span>
                    </div>
                    <div class="mailbox-item mailbox-category-item" data-mailbox="creative_fire">
                        <svg viewBox="0 0 24 24"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>
                        <span>Creative Fire</span>
                    </div>
                    <div class="mailbox-item mailbox-category-item" data-mailbox="gospel_pulse">
                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        <span>Gospel Pulse</span>
                    </div>
                    <div class="mailbox-item mailbox-category-item" data-mailbox="shepherd_voice">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
                        <span>Shepherd Voice</span>
                    </div>
                    <div class="mailbox-item mailbox-category-item" data-mailbox="hebraic_roots">
                        <svg viewBox="0 0 24 24"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75C7 8 17 8 17 8z"/></svg>
                        <span>Hebraic Roots</span>
                    </div>
                    <div class="mailbox-spacer"></div>
                    <div class="mailbox-footer" id="communitySelector" role="button" aria-haspopup="true" aria-expanded="false">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <span id="communityName">Jubilee Community</span>
                        <svg class="community-caret" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        <div class="community-menu" id="communityMenu" role="menu"></div>
                    </div>
                </div>
                <div class="panel-resizer" id="mailboxResizer" aria-hidden="true"></div>

                <div class="conversation-panel">
                    <div class="inbox-header">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                        <span id="inboxHeaderTitle">Conversation Mailbox: Chat Inbox</span>
                    </div>
                    <div class="content-columns">
                        <!-- Conversation List -->
                        <div class="conversation-list">
                    <div class="conversation-toolbar">
                        <div class="conversation-tabs">
                            <span class="conversation-tab">Focused</span>
                            <span class="conversation-tab is-muted">|</span>
                            <span class="conversation-tab is-muted">Other</span>
                        </div>
                        <div class="conversation-toolbar-right">
                            <div class="conversation-toolbar-icon" title="Focused">
                                <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-8.5 13.5L6 12l1.4-1.4 3.1 3.1 6-6L18 9l-7.5 7.5z"/></svg>
                            </div>
                            <div class="conversation-toolbar-icon" title="Sort">
                                <svg viewBox="0 0 24 24"><path d="M16 17l-4 4-4-4h3v-6h2v6h3zm-4-14l4 4h-3v6h-2V7H8l4-4z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="conversation-items" id="conversationItems">
                        <!-- Conversations will be loaded dynamically from JSON -->
                    </div>
                </div>
                <div class="panel-resizer" id="inboxResizer" aria-hidden="true"></div>

                <!-- Chat Panel -->
                <div class="chat-panel">
                    <div class="chat-subject">
                        <div class="chat-subject-left">
                            <span class="chat-subject-text chat-subject-pending" id="chatSubjectText" title="Click to edit subject">Waiting for conversation...</span>
                        </div>
                    </div>
                    <div class="messages-area" id="messagesArea">
                        <!-- Messages will be dynamically added here -->
                    </div>

                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typingIndicator">
                        <img src="/images/personas/jubilee.png" class="message-avatar" alt="Jubilee">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>

                    <!-- Input Area Wrapper (outer container for visual border effect) -->
                    <div class="input-area-wrapper" id="inputAreaWrapper">
                        <!-- Persona Selection Panel (slides up when expand is clicked) -->
                        <div class="persona-selection-panel" id="personaSelectionPanel">
                            <div class="persona-panel-header">
                                <div class="persona-panel-title">
                                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
                                    <span>Community Context</span>
                                </div>
                                <div class="persona-panel-expand-icon" id="closePersonaPanel" title="Close">
                                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                </div>
                            </div>
                            <div class="persona-panel-content">
                                <div class="persona-panel-left custom-scrollbar">
                                    <!-- Community Participants Section -->
                                    <div class="persona-section">
                                        <div class="persona-section-header">
                                            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                            <span>Community Participants</span>
                                        </div>
                                        <div class="persona-list" id="usersList">
                                            <div class="persona-item" data-user="loading" data-name="Loading users..." data-role="Community Member" data-bound="true">
                                                <div class="persona-item-initials">...</div>
                                                <span class="persona-item-name">Loading users...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="persona-panel-right" id="selectedPersonaDisplay">
                                    <div class="persona-panel-right-header">
                                        <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 15h-2v-2h2v2zm1.07-7.75l-.9.92A2 2 0 0012 12h-1v-1c0-.53.21-1.04.59-1.41l1.08-1.09a1.5 1.5 0 10-2.12-2.12l-.5.5-1.06-1.06.5-.5a3 3 0 114.24 4.24z"/></svg>
                                        <span>Community Context</span>
                                    </div>
                                    <div class="selected-persona-content community-context">
                                        <div class="community-context-item">
                                            <div class="community-context-label">Mailbox</div>
                                            <div class="community-context-value" id="communityContextMailbox">Chat Inbox</div>
                                        </div>
                                        <div class="community-context-item">
                                            <div class="community-context-label">Community</div>
                                            <div class="community-context-value" id="communityContextName">Jubilee Community</div>
                                        </div>
                                        <div class="community-context-item">
                                            <div class="community-context-label">Visibility</div>
                                            <div class="community-context-value" id="communityContextVisibility">Private</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Inner content container -->
                        <div class="input-area-inner">
                            <div class="chatbox-top">
                            <div class="chatbox-recipient">
                                <span class="chatbox-to-label">TO:</span>
                                <div class="chatbox-tabs" id="chatboxTabs">
                                    <div class="chatbox-tab" data-persona="jubilee">
                                        <img src="/images/personas/jubilee.png" alt="Jubilee">
                                        <span>Jubilee Inspire</span>
                                        <button class="chatbox-close" type="button" aria-label="Remove Jubilee Inspire">&times;</button>
                                    </div>
                                </div>
                            </div>
                            <button class="chatbox-expand" type="button" aria-label="Expand Community" id="expandPersonaBtn">
                                <svg viewBox="0 0 24 24">
                                    <!-- Church icon -->
                                    <path d="M18 12.22V9l-5-2.5V5h2V3h-2V1h-2v2H9v2h2v1.5L6 9v3.22L4 13v8h7v-4c0-.55.45-1 1-1s1 .45 1 1v4h7v-8l-2-.78zM12 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="chatbox-entry">
                            <textarea class="chat-input" id="chatInput" placeholder="Type a Message" aria-label="Type a Message" rows="1"></textarea>
                        </div>
                        <div class="chatbox-row">
                            <div class="chatbox-left">
                                <button class="chatbox-add" type="button" aria-label="Attach File" id="attachFileBtn">+</button>
                                <input type="file" id="fileAttachmentInput" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt">
                                <div class="chatbox-attachments" id="chatboxAttachments">
                                    <!-- Attached files will be shown here -->
                                </div>
                            </div>
                            <div class="chatbox-controls">
                                <div class="chatbox-lock" id="chatboxLockBtn" title="Click to enable private mode" style="cursor:pointer;">
                                    <svg viewBox="0 0 24 24"><path d="M17 8h-1V6a4 4 0 00-8 0v2H7a2 2 0 00-2 2v8a2 2 0 002 2h10a2 2 0 002-2v-8a2 2 0 00-2-2zm-6 8v-3h2v3h-2zm3-8H10V6a2 2 0 114 0v2z"/></svg>
                                </div>
                                <div class="inspire-dropdown-wrapper">
                                    <div class="inspire-dropdown" id="inspireDropdown">
                                        <span>Inspire 8.0</span>
                                        <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                                    </div>
                                    <div class="inspire-menu" id="inspireMenu">
                                        <div class="inspire-menu-item" data-model="kingdombuilder">
                                            <div class="inspire-menu-icon"></div>
                                            <div class="inspire-menu-content">
                                                <div class="inspire-menu-title">Inspire 8.0: Kingdom Builder</div>
                                                <div class="inspire-menu-subtitle">Strategic Vision + Wisdom</div>
                                            </div>
                                            <div class="inspire-menu-check"></div>
                                        </div>
                                        <div class="inspire-menu-item" data-model="creativefire">
                                            <div class="inspire-menu-icon"></div>
                                            <div class="inspire-menu-content">
                                                <div class="inspire-menu-title">Inspire 8.0: Creative Fire</div>
                                                <div class="inspire-menu-subtitle">Poetic + Prophetic</div>
                                            </div>
                                            <div class="inspire-menu-check"></div>
                                        </div>
                                        <div class="inspire-menu-item selected" data-model="gospelpulse">
                                            <div class="inspire-menu-icon"></div>
                                            <div class="inspire-menu-content">
                                                <div class="inspire-menu-title">Inspire 8.0: Gospel Pulse</div>
                                                <div class="inspire-menu-subtitle">Gospel Fire + Reach</div>
                                            </div>
                                            <div class="inspire-menu-check">
                                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                            </div>
                                        </div>
                                        <div class="inspire-menu-item" data-model="shepherdvoice">
                                            <div class="inspire-menu-icon"></div>
                                            <div class="inspire-menu-content">
                                                <div class="inspire-menu-title">Inspire 8.0: Shepherd Voice</div>
                                                <div class="inspire-menu-subtitle">Pastoral + Healing</div>
                                            </div>
                                            <div class="inspire-menu-check"></div>
                                        </div>
                                        <div class="inspire-menu-item" data-model="hebraicroots">
                                            <div class="inspire-menu-icon"></div>
                                            <div class="inspire-menu-content">
                                                <div class="inspire-menu-title">Inspire 8.0: Hebraic Roots</div>
                                                <div class="inspire-menu-subtitle">Academic Depth + Doctrine</div>
                                            </div>
                                            <div class="inspire-menu-check"></div>
                                        </div>
                                    </div>
                                </div>
                                <button class="chatbox-submit" type="button" aria-label="Send Message" id="chatSubmitBtn">
                                    <!-- Play icon (right triangle) - shown by default -->
                                    <svg class="play-icon" viewBox="0 0 24 24" width="14" height="14">
                                        <path d="M8 5v14l11-7z" fill="#1a1a1a"/>
                                    </svg>
                                    <!-- Stop icon (square) - shown when processing -->
                                    <svg class="stop-icon" viewBox="0 0 24 24" width="12" height="12">
                                        <rect x="6" y="6" width="12" height="12" fill="#1a1a1a"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        </div><!-- End input-area-inner -->
                    </div><!-- End input-area-wrapper -->

                    <!-- Footer -->
                    <div class="footer">
                        Copyright &copy; <span id="currentYear"></span> JubileeVerse.com | All Rights Reserved. JubileeVerse and AI can make mistakes. |
                        <a href="#">Privacy Policy</a> | <a href="#">Terms of Use</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Rail (Mode + Icons) -->
                <div class="right-rail">
                    <div class="mode-banner">
                        <span class="mode-banner-text">JUBILEEVERSE CONVERSATION MODE</span>
                    </div>
                    <div class="right-icons" aria-hidden="true">
                        <div class="right-icon right-flag" id="languageToggleBtn" title="English (US)">
                            <svg viewBox="0 0 64 64" role="img" aria-label="United States" id="currentLanguageFlag">
                                <defs>
                                    <clipPath id="us-flag-clip-chat">
                                        <circle cx="32" cy="32" r="30"></circle>
                                    </clipPath>
                                </defs>
                                <g clip-path="url(#us-flag-clip-chat)">
                                    <rect width="64" height="64" fill="#b22234"></rect>
                                    <g fill="#fff">
                                        <rect y="8" width="64" height="8"></rect>
                                        <rect y="24" width="64" height="8"></rect>
                                        <rect y="40" width="64" height="8"></rect>
                                        <rect y="56" width="64" height="8"></rect>
                                    </g>
                                    <rect width="30" height="26" fill="#3c3b6e"></rect>
                                    <g fill="#fff">
                                        <circle cx="6" cy="6" r="1.4"></circle>
                                        <circle cx="12" cy="6" r="1.4"></circle>
                                        <circle cx="18" cy="6" r="1.4"></circle>
                                        <circle cx="24" cy="6" r="1.4"></circle>
                                        <circle cx="9" cy="12" r="1.4"></circle>
                                        <circle cx="15" cy="12" r="1.4"></circle>
                                        <circle cx="21" cy="12" r="1.4"></circle>
                                        <circle cx="6" cy="18" r="1.4"></circle>
                                        <circle cx="12" cy="18" r="1.4"></circle>
                                        <circle cx="18" cy="18" r="1.4"></circle>
                                        <circle cx="24" cy="18" r="1.4"></circle>
                                    </g>
                                </g>
                                <circle cx="32" cy="32" r="30" fill="none" stroke="#4b4b4b" stroke-width="2"></circle>
                            </svg>
                        </div>
                        <div class="right-icon right-persona" id="personaToggleBtn" title="AI Bible Personas">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                            </svg>
                        </div>
                        <div class="right-icon right-voice" title="Voice Chat">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                                <line x1="4" y1="12" x2="4" y2="12"></line>
                                <line x1="8" y1="8" x2="8" y2="16"></line>
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="16" y1="8" x2="16" y2="16"></line>
                                <line x1="20" y1="12" x2="20" y2="12"></line>
                            </svg>
                        </div>
                        <div class="right-icons-spacer"></div>
                        <div class="right-icon right-token" title="Token Balance: 63%">
                            <div class="right-token-ring">
                                <svg viewBox="0 0 26 26" aria-hidden="true">
                                    <circle class="right-token-bg" cx="13" cy="13" r="11"></circle>
                                    <circle class="right-token-progress" cx="13" cy="13" r="11"></circle>
                                </svg>
                                <div class="right-token-percent">63%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Translation Panel -->
    <div class="language-panel" id="languagePanel" style="border-top:2px solid #ffbd59 !important; border-bottom:2px solid #ffbd59 !important; border-radius:8px 0 0 8px !important;">
        <div class="language-panel-header">
            <button class="language-panel-close" id="languagePanelClose" type="button" aria-label="Close">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="language-panel-header-bg">
            <div class="language-panel-title">LANGUAGES</div>
            <div class="language-panel-divider"></div>
        </div>
        <div class="language-panel-content">
            <div class="language-section">
                <div class="language-section-title">RECENTLY USED</div>
                <div class="language-list" id="recentLanguages">
                    <div class="language-item selected" data-lang="en" data-name="English (Default)">
                        <img src="https://flagcdn.com/w40/us.png" alt="US" class="language-flag">
                        <span class="language-name">English (Default)</span>
                    </div>
                </div>
            </div>
            <div class="language-section">
                <div class="language-section-title">ALL LANGUAGES</div>
                <div class="language-list" id="allLanguages">
                    <!-- Languages will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Inbox Panel (slides in from right) -->
    <div class="inbox-panel" id="inboxPanel" style="border-top:2px solid #ffbd59 !important; border-bottom:2px solid #ffbd59 !important; border-radius:4px !important;">
        <div class="inbox-panel-header">
            <button class="inbox-panel-close" id="inboxPanelClose" type="button" aria-label="Close" style="background-color:#6b6b6b;color:#e6e6e6;">&times;</button>
        </div>
        <div class="inbox-panel-content" id="inboxPanelContent">
            <!-- Blank for now  content will be added later -->
        </div>
    </div>

    <!-- Inspire Personas Panel -->
    <div class="persona-rail-panel" id="personaPanel" style="border-top:2px solid #ffbd59 !important; border-bottom:2px solid #ffbd59 !important; border-radius:8px 0 0 8px !important;">
        <div class="persona-rail-header">
            <button class="persona-rail-close" id="personaPanelClose" type="button" aria-label="Close">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="persona-rail-header-bg">
            <div class="persona-rail-title">AI BIBLE PERSONAS</div>
            <div class="persona-rail-divider"></div>
        </div>
        <div class="persona-rail-content">
            <div class="persona-rail-list" id="personaPanelList">
                    <div class="persona-rail-item" data-persona="jubilee">
                        <img src="/images/personas/jubilee.png" alt="Jubilee" class="persona-rail-avatar">
                        <span class="persona-rail-name">Jubilee Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="melody">
                        <img src="/images/personas/melody.png" alt="Melody" class="persona-rail-avatar">
                        <span class="persona-rail-name">Melody Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="zariah">
                        <img src="/images/personas/zariah.png" alt="Zariah" class="persona-rail-avatar">
                        <span class="persona-rail-name">Zariah Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="elias">
                        <img src="/images/personas/elias.png" alt="Elias" class="persona-rail-avatar">
                        <span class="persona-rail-name">Elias Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="eliana">
                        <img src="/images/personas/eliana.png" alt="Eliana" class="persona-rail-avatar">
                        <span class="persona-rail-name">Eliana Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="caleb">
                        <img src="/images/personas/caleb.png" alt="Caleb" class="persona-rail-avatar">
                        <span class="persona-rail-name">Caleb Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="imani">
                        <img src="/images/personas/imani.png" alt="Imani" class="persona-rail-avatar">
                        <span class="persona-rail-name">Imani Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="zev">
                        <img src="/images/personas/zev.png" alt="Zev" class="persona-rail-avatar">
                        <span class="persona-rail-name">Zev Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="amir">
                        <img src="/images/personas/amir.png" alt="Amir" class="persona-rail-avatar">
                        <span class="persona-rail-name">Amir Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="nova">
                        <img src="/images/personas/nova.png" alt="Nova" class="persona-rail-avatar">
                        <span class="persona-rail-name">Nova Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="santiago">
                        <img src="/images/personas/santiago.png" alt="Santiago" class="persona-rail-avatar">
                        <span class="persona-rail-name">Santiago Inspire</span>
                    </div>
                    <div class="persona-rail-item" data-persona="tahoma">
                        <img src="/images/personas/tahoma.png" alt="Tahoma" class="persona-rail-avatar">
                        <span class="persona-rail-name">Tahoma Inspire</span>
                    </div>
            </div>
        </div>
    </div>

    <!-- Voice Chat Panel Overlay -->
    <div class="voice-panel-overlay" id="voicePanelOverlay"></div>

    <!-- Voice Chat Panel -->
    <div class="voice-panel" id="voicePanel">
        <div class="voice-panel-header">
            <div class="voice-panel-title">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                    <line x1="4" y1="12" x2="4" y2="12"></line>
                    <line x1="8" y1="8" x2="8" y2="16"></line>
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="16" y1="8" x2="16" y2="16"></line>
                    <line x1="20" y1="12" x2="20" y2="12"></line>
                </svg>
                <span>Voice Chat</span>
            </div>
            <div class="voice-panel-close" id="voicePanelClose">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </div>
        </div>
        <div class="voice-panel-content">
            <div class="voice-panel-visualizer" id="voiceVisualizer">
                <div class="voice-panel-mic" id="voiceMicBtn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
                    </svg>
                </div>
            </div>
            <div class="voice-panel-status" id="voiceStatus">Click the microphone to start speaking</div>
            <div class="voice-panel-persona" id="voicePanelPersona">
                <img src="/images/personas/jubilee.png" alt="Jubilee" class="voice-panel-persona-avatar" id="voicePersonaAvatar">
                <div class="voice-panel-persona-info">
                    <div class="voice-panel-persona-name" id="voicePersonaName">Jubilee Inspire</div>
                    <div class="voice-panel-persona-role" id="voicePersonaRole">AI Assistant</div>
                </div>
            </div>
        </div>
        <div class="voice-panel-footer">
            <button class="voice-panel-btn voice-panel-btn-secondary" id="voiceCancelBtn">Cancel</button>
            <button class="voice-panel-btn voice-panel-btn-primary" id="voiceStartBtn">Start Voice Chat</button>
        </div>
    </div>

    <!-- Component Loader for sidebar -->
    <script src="/js/modules/components.js"></script>

    <script>
        // Set current year
        var currentYearEl = document.getElementById('currentYear');
        if (currentYearEl) {
            currentYearEl.textContent = new Date().getFullYear();
        }

        // ==================== DELETE CONFIRMATION MODAL ====================
        var deleteModalOverlay = document.getElementById('deleteModalOverlay');
        var deleteModalMessage = document.getElementById('deleteModalMessage');
        var deleteModalOk = document.getElementById('deleteModalOk');
        var deleteModalCancel = document.getElementById('deleteModalCancel');
        var deleteModalCallback = null;
        var deleteModalPreviousFocus = null;

        /**
         * Show the delete confirmation modal
         * @param {string} message - The confirmation message to display
         * @param {function} onConfirm - Callback function to execute when OK is clicked
         */
        function showDeleteConfirmModal(message, onConfirm) {
            // Store the currently focused element to restore focus later
            deleteModalPreviousFocus = document.activeElement;

            // Set the message
            deleteModalMessage.textContent = message || 'Are you sure you want to delete this message?';

            // Store the callback
            deleteModalCallback = onConfirm;

            // Show the modal
            deleteModalOverlay.classList.add('open');

            // Focus the Cancel button (safer default)
            setTimeout(function() {
                deleteModalCancel.focus();
            }, 100);

            // Add escape key handler
            document.addEventListener('keydown', handleDeleteModalKeydown);
        }

        function hideDeleteConfirmModal() {
            deleteModalOverlay.classList.remove('open');
            deleteModalCallback = null;

            // Remove escape key handler
            document.removeEventListener('keydown', handleDeleteModalKeydown);

            // Restore focus to previous element
            if (deleteModalPreviousFocus && typeof deleteModalPreviousFocus.focus === 'function') {
                deleteModalPreviousFocus.focus();
            }
            deleteModalPreviousFocus = null;
        }

        function handleDeleteModalKeydown(e) {
            if (e.key === 'Escape') {
                e.preventDefault();
                hideDeleteConfirmModal();
            } else if (e.key === 'Tab') {
                // Trap focus within modal
                var focusableElements = [deleteModalCancel, deleteModalOk];
                var firstElement = focusableElements[0];
                var lastElement = focusableElements[focusableElements.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }
        }

        // OK button handler
        deleteModalOk.addEventListener('click', function() {
            var callback = deleteModalCallback;
            hideDeleteConfirmModal();
            if (typeof callback === 'function') {
                callback();
            }
        });

        // Cancel button handler
        deleteModalCancel.addEventListener('click', function() {
            hideDeleteConfirmModal();
        });

        // Close on overlay click (outside modal)
        deleteModalOverlay.addEventListener('click', function(e) {
            if (e.target === deleteModalOverlay) {
                hideDeleteConfirmModal();
            }
        });

        // ==================== SIDEBAR MENU BEHAVIOR ====================
        // On the chat page, menu button toggles the Conversation Mailbox panel
        // instead of the slide panel (which is used on home/search pages)
        // The ComponentLoader handles sidebar injection and will call our custom handler

        // ==================== AUTH STATUS CHECK ====================
        (function checkAuthStatus() {
            var authBtn = document.getElementById('authBtn');
            var authBtnText = document.getElementById('authBtnText');

            console.log('Checking auth status...');

            fetch('/auth/me', {
                credentials: 'include',
                headers: { 'Accept': 'application/json' }
            })
            .then(function(response) {
                if (!response.ok) {
                    console.log('User not authenticated (status:', response.status + ')');
                    return null;
                }
                return response.json();
            })
            .then(function(data) {
                if (!data) {
                    console.log('No auth data - user is guest');
                    return;
                }

                console.log('Auth response:', data);

                if (data.success && data.user) {
                    // Store user ID for WebSocket identification
                    window.currentUserId = data.user.id;

                    // If WebSocket is already connected, identify the user now
                    if (window.boardWebSocket && typeof window.boardWebSocket.identify === 'function') {
                        window.boardWebSocket.identify(data.user.id);
                    }

                    // Update auth button if it exists
                    if (authBtn && authBtnText) {
                        authBtnText.textContent = 'Sign Out';
                        authBtn.href = '#';
                        authBtn.onclick = function(e) {
                            e.preventDefault();
                            fetch('/auth/logout', {
                                method: 'POST',
                                headers: { 'Accept': 'application/json' }
                            })
                            .then(function() {
                                window.location.reload();
                            });
                        };
                    }
                    // Update sidebar avatar if user has avatar
                    if (data.user.avatar || data.user.avatarUrl) {
                        var sidebarAvatar = document.querySelector('.sidebar-avatar img');
                        if (sidebarAvatar) {
                            sidebarAvatar.src = data.user.avatar || data.user.avatarUrl;
                        }
                    }
                    // Set the current user name for chat messages
                    // Priority: displayName > firstName+lastName > name > email
                    if (data.user.displayName) {
                        window.currentUserFullName = data.user.displayName;
                    } else if (data.user.firstName || data.user.lastName) {
                        window.currentUserFullName = ((data.user.firstName || '') + ' ' + (data.user.lastName || '')).trim();
                    } else if (data.user.name) {
                        window.currentUserFullName = data.user.name;
                    } else if (data.user.email) {
                        window.currentUserFullName = data.user.email.split('@')[0];
                    }
                    console.log('User authenticated as:', window.currentUserFullName);

                    // Store user's default persona if set
                    if (data.user.defaultPersona && data.user.defaultPersona.slug) {
                        window.userDefaultPersonaSlug = data.user.defaultPersona.slug;
                        window.userDefaultPersona = data.user.defaultPersona;
                        console.log('User default persona:', window.userDefaultPersonaSlug);

                        // Update the defaultPersonaSlug if it's still the hardcoded value
                        // This is done by triggering a custom event that the persona selection can listen to
                        var event = new CustomEvent('userDefaultPersonaLoaded', {
                            detail: { persona: data.user.defaultPersona }
                        });
                        document.dispatchEvent(event);
                    }
                } else {
                    console.log('Auth response missing success or user:', data);
                }
            })
            .catch(function(err) {
                console.log('Auth check error:', err);
            });
        })();

        // ==================== TOOLBAR PIN TOGGLE ====================
        (function initToolbarPin() {
            var toolbar = document.querySelector('.toolbar');
            var toolbarPinBtn = document.getElementById('toolbarPinBtn');
            var rightRail = document.querySelector('.right-rail');
            var languagePanel = document.querySelector('.language-panel');
            var personaPanel = document.querySelector('.persona-rail-panel');
            var toolbarCollapsedCookie = 'jv_toolbar_collapsed';

            console.log('Toolbar pin init:', { toolbar: !!toolbar, toolbarPinBtn: !!toolbarPinBtn });

            if (!toolbar || !toolbarPinBtn) {
                console.warn('Toolbar pin elements not found');
                return;
            }

            function setCookie(name, value, days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = name + '=' + value + '; expires=' + date.toUTCString() + '; path=/';
            }

            function getCookie(name) {
                var nameEQ = name + '=';
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.indexOf(nameEQ) === 0) {
                        return cookie.substring(nameEQ.length);
                    }
                }
                return '';
            }

            function updateRailPositions(collapsed) {
                if (rightRail) {
                    rightRail.classList.toggle('toolbar-collapsed', collapsed);
                }
                if (languagePanel) {
                    languagePanel.classList.toggle('toolbar-collapsed', collapsed);
                }
                if (personaPanel) {
                    personaPanel.classList.toggle('toolbar-collapsed', collapsed);
                }
            }

            // Check if toolbar should be collapsed on load
            var isCollapsed = getCookie(toolbarCollapsedCookie) === 'true';
            if (isCollapsed) {
                toolbar.classList.add('is-collapsed');
                toolbarPinBtn.classList.add('is-collapsed');
                updateRailPositions(true);
            }

            // Toggle toolbar on pin click
            toolbarPinBtn.addEventListener('click', function() {
                console.log('Toolbar pin clicked');
                var collapsed = toolbar.classList.toggle('is-collapsed');
                toolbarPinBtn.classList.toggle('is-collapsed', collapsed);
                updateRailPositions(collapsed);
                setCookie(toolbarCollapsedCookie, collapsed ? 'true' : 'false', 30);
                console.log('Toolbar collapsed:', collapsed);
            });
        })();

        (function initResizablePanels() {
            var contentArea = document.querySelector('.content-area');
            var mailboxPanel = document.querySelector('.mailbox-panel');
            var mailboxResizer = document.getElementById('mailboxResizer');
            var conversationList = document.querySelector('.conversation-list');
            var inboxResizer = document.getElementById('inboxResizer');
            var mailboxCookieName = 'jv_mailbox_width';
            var inboxCookieName = 'jv_inbox_width';
            var mailboxMinWidth = 180;
            var inboxMinWidth = 220;
            var mailboxSaved = 0;
            var inboxSaved = 0;
            var appContainer = document.querySelector('.app-container');
            var menuToggle = document.getElementById('menuToggle');
            var mailboxCollapsed = false;
            var mailboxStoredWidth = 0;
            var mailboxExplicitlyClosed = false;

            if (!contentArea || !mailboxPanel || !mailboxResizer || !conversationList || !inboxResizer) {
                return;
            }

            function setCookie(name, value, days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = name + '=' + value + '; expires=' + date.toUTCString() + '; path=/';
            }

            function getCookie(name) {
                var nameEQ = name + '=';
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.indexOf(nameEQ) === 0) {
                        return cookie.substring(nameEQ.length);
                    }
                }
                return '';
            }

            function clampWidth(value, min, max) {
                return Math.min(max, Math.max(min, value));
            }

            function getMaxWidth() {
                return contentArea.clientWidth / 3;
            }

            function applyWidth(target, width) {
                target.style.width = width + 'px';
                target.style.flexBasis = width + 'px';
            }

            function applySavedWidths() {
                var maxWidth = getMaxWidth();
                var mailboxWidth = clampWidth(mailboxSaved, mailboxMinWidth, maxWidth);
                var inboxWidth = clampWidth(inboxSaved, inboxMinWidth, maxWidth);
                applyWidth(mailboxPanel, mailboxWidth);
                applyWidth(conversationList, inboxWidth);
            }

            function attachResizer(resizer, target, minWidth, onSave) {
                var startX = 0;
                var startWidth = 0;

                function onMouseMove(event) {
                    var maxWidth = getMaxWidth();
                    var newWidth = startWidth + (event.clientX - startX);
                    var clamped = clampWidth(newWidth, minWidth, maxWidth);
                    applyWidth(target, clamped);
                }

                function onMouseUp() {
                    resizer.classList.remove('is-dragging');
                    document.body.style.userSelect = '';
                    window.removeEventListener('mousemove', onMouseMove);
                    window.removeEventListener('mouseup', onMouseUp);
                    if (typeof onSave === 'function') {
                        onSave(target.getBoundingClientRect().width);
                    }
                }

                resizer.addEventListener('mousedown', function(event) {
                    event.preventDefault();
                    startX = event.clientX;
                    startWidth = target.getBoundingClientRect().width;
                    resizer.classList.add('is-dragging');
                    document.body.style.userSelect = 'none';
                    window.addEventListener('mousemove', onMouseMove);
                    window.addEventListener('mouseup', onMouseUp);
                });
            }

            mailboxSaved = parseInt(getCookie(mailboxCookieName), 10);
            inboxSaved = parseInt(getCookie(inboxCookieName), 10);

            if (!mailboxSaved || isNaN(mailboxSaved)) {
                mailboxSaved = Math.round(mailboxPanel.getBoundingClientRect().width);
                setCookie(mailboxCookieName, mailboxSaved, 30);
            }

            if (!inboxSaved || isNaN(inboxSaved)) {
                inboxSaved = Math.round(conversationList.getBoundingClientRect().width);
                setCookie(inboxCookieName, inboxSaved, 30);
            }

            applySavedWidths();

            attachResizer(mailboxResizer, mailboxPanel, mailboxMinWidth, function(value) {
                mailboxSaved = Math.round(value);
                setCookie(mailboxCookieName, mailboxSaved, 30);
            });

            attachResizer(inboxResizer, conversationList, inboxMinWidth, function(value) {
                inboxSaved = Math.round(value);
                setCookie(inboxCookieName, inboxSaved, 30);
            });

            function enforceMaxWidths() {
                if (mailboxCollapsed) {
                    return;
                }
                applySavedWidths();
            }

            window.addEventListener('resize', enforceMaxWidths);

            function collapseMailbox() {
                mailboxCollapsed = true;
                mailboxStoredWidth = mailboxPanel.getBoundingClientRect().width;
                appContainer.classList.add('is-mailbox-collapsed');
                mailboxPanel.style.width = '0px';
                mailboxPanel.style.flexBasis = '0px';
                mailboxResizer.style.display = 'none';
                if (menuToggle) {
                    menuToggle.setAttribute('aria-pressed', 'true');
                }
            }

            function expandMailbox() {
                mailboxCollapsed = false;
                appContainer.classList.remove('is-mailbox-collapsed');
                mailboxResizer.style.display = '';
                var maxWidth = getMaxWidth();
                var restored = clampWidth(mailboxStoredWidth || mailboxSaved, mailboxMinWidth, maxWidth);
                applyWidth(mailboxPanel, restored);
                if (menuToggle) {
                    menuToggle.setAttribute('aria-pressed', 'false');
                }
            }

            function setMailboxCollapsed(collapsed, options) {
                var explicit = options && options.explicit;
                if (collapsed) {
                    collapseMailbox();
                } else {
                    expandMailbox();
                }
                if (explicit) {
                    mailboxExplicitlyClosed = collapsed;
                }
            }

            function toggleMailbox(explicit) {
                setMailboxCollapsed(!mailboxCollapsed, { explicit: explicit });
            }

            function isMailboxExplicitlyClosed() {
                return mailboxExplicitlyClosed;
            }

            function isMailboxCollapsed() {
                return mailboxCollapsed;
            }

            // Register custom menu handler with ComponentLoader
            // On the chat page, menu button toggles the Mailbox panel (not the slide panel)
            if (typeof ComponentLoader !== 'undefined' && ComponentLoader.registerMenuHandler) {
                ComponentLoader.registerMenuHandler(function(e) {
                    toggleMailbox(true);
                });
            }

            // Also expose toggleMailbox globally for potential keyboard shortcuts or other triggers
            window.toggleMailbox = toggleMailbox;
            window.setMailboxCollapsed = setMailboxCollapsed;
            window.isMailboxExplicitlyClosed = isMailboxExplicitlyClosed;
            window.isMailboxCollapsed = isMailboxCollapsed;
        })();

        var messagesArea = document.getElementById('messagesArea');
        var chatInput = document.getElementById('chatInput');
        var typingIndicator = document.getElementById('typingIndicator');
        var conversationItemsContainer = document.getElementById('conversationItems');
        var conversationHistory = [];
        var allConversations = [];
        var personaDirectory = { bySlug: {}, byId: {} };
        var availableCommunities = [];
        // Save conversations to database via API
        async function saveConversationsToStorage() {
            return;
        }

        // Load conversations from database via API
        async function loadConversationsFromDatabase() {
            try {
                var languageCode = getSelectedLanguageCode();
                var url = '/chat/mailbox/chat_inbox';
                if (languageCode) {
                    url += '?language=' + encodeURIComponent(languageCode);
                }
                var response = await fetch(url);
                var result = await response.json();
                if (result.success && result.conversations) {
                    return result.conversations;
                }
                return [];
            } catch (error) {
                console.error('Error loading conversations from database:', error);
                return [];
            }
        }

        // Format date for display
        function formatConversationDate(dateString) {
            if (!dateString) return '';
            var date = new Date(dateString);
            var now = new Date();
            var diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays < 7) {
                return date.toLocaleDateString([], { weekday: 'short' });
            } else {
                return (date.getMonth() + 1) + '/' + date.getDate();
            }
        }

        // Create conversation item HTML
        function createConversationItemElement(conv, isActive) {
            var div = document.createElement('div');
            div.className = 'conversation-item' + (isActive ? ' active' : '') + (conv.isUnread ? ' unread' : '');
            div.setAttribute('data-conversation-id', conv.id);

            var personaName = conv.personaName || 'Jubilee Inspire';
            var avatarSrc = getPersonaImagePath(personaName);
            // Use subject as preview if it exists and is not the default, otherwise use message preview
            var preview = conv.subject && conv.subject !== 'Waiting for conversation...'
                ? sanitizeMessageText(conv.subject)
                : sanitizeMessageText(conv.preview || 'New conversation...');
            var dateStr = formatConversationDate(conv.updatedAt || conv.createdAt);

            div.innerHTML =
                '<img src="' + avatarSrc + '" class="conversation-avatar" alt="' + personaName + '">' +
                '<div class="conversation-info">' +
                    '<div class="conversation-name">' + personaName + '</div>' +
                    '<div class="conversation-preview">' + preview + '</div>' +
                '</div>' +
                '<div class="conversation-meta">' +
                    '<span class="conversation-date">' + dateStr + '</span>' +
                    '<svg class="conversation-delete" viewBox="0 0 24 24" title="Delete conversation"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                '</div>';

            // Click to load conversation
            div.addEventListener('click', function(e) {
                if (e.target.closest('.conversation-delete')) {
                    e.stopPropagation();
                    deleteConversation(conv.id);
                    return;
                }
                loadConversation(conv.id);
            });

            return div;
        }

        function moveConversationToTop(conversationId) {
            var index = allConversations.findIndex(function(c) { return c.id === conversationId; });
            if (index > 0) {
                var conv = allConversations.splice(index, 1)[0];
                allConversations.unshift(conv);
            }
        }

        // Render all conversations in the inbox panel
        function renderConversationList() {
            conversationItemsContainer.innerHTML = '';

            allConversations.forEach(function(conv) {
                var isActive = conv.id === chatState.conversationId;
                var element = createConversationItemElement(conv, isActive);
                conversationItemsContainer.appendChild(element);
            });

            // Update persona avatars
            updatePersonaAvatars();
        }

        // Update inbox header title based on selected conversation
        function updateInboxHeader(label, subject) {
            var headerTitle = document.getElementById('inboxHeaderTitle');
            if (!headerTitle) return;

            var mailboxLabel = (typeof mailboxNames !== 'undefined' && mailboxNames[chatState.currentMailbox])
                ? mailboxNames[chatState.currentMailbox]
                : 'Chat Inbox';
            var communityLabel = chatState.currentMailbox === 'chat_inbox'
                ? ''
                : (chatState.currentCommunityName || '');

            // Format: "Conversation Mailbox: [Board Name]" with community in yellow on the right
            var headerHtml = '<span class="mailbox-text">Conversation Mailbox: ' + escapeHtml(mailboxLabel) + '</span>';
            if (communityLabel) {
                headerHtml += '<span class="community-label">' + escapeHtml(communityLabel) + '</span>';
            }
            headerTitle.innerHTML = headerHtml;
        }

        function getPersonaIdFromName(personaName) {
            if (!personaName) return null;
            var nameLower = personaName.toLowerCase();
            for (var i = 0; i < inspirePersonas.length; i++) {
                if (nameLower.indexOf(inspirePersonas[i]) !== -1) {
                    return inspirePersonas[i];
                }
            }
            return null;
        }

        function updateChatboxTabPersona(tab, personaName) {
            if (!tab || !personaName) return;

            var personaId = getPersonaIdFromName(personaName);
            var nameSpan = tab.querySelector('span');
            if (nameSpan) {
                nameSpan.textContent = personaName;
            }

            var closeBtn = tab.querySelector('.chatbox-close');
            if (closeBtn) {
                closeBtn.setAttribute('aria-label', 'Remove ' + personaName);
            }

            if (personaId) {
                tab.setAttribute('data-persona', personaId);
                tab.removeAttribute('data-user');

                var avatar = tab.querySelector('img');
                var initials = tab.querySelector('.chatbox-tab-initials');
                if (!avatar) {
                    avatar = document.createElement('img');
                    if (initials) {
                        initials.replaceWith(avatar);
                    } else if (nameSpan) {
                        tab.insertBefore(avatar, nameSpan);
                    } else {
                        tab.insertBefore(avatar, tab.firstChild);
                    }
                }
                avatar.src = getPersonaImagePathByName(personaName);
                avatar.alt = personaName;
            }

            applyMelodyNameVisibility(tab, personaName);
        }

        function syncChatboxTabForConversation(personaName) {
            var tabsRoot = chatboxTabs || document.getElementById('chatboxTabs');
            if (!tabsRoot || !personaName) {
                return;
            }
            var tabs = tabsRoot.querySelectorAll('.chatbox-tab');
            if (tabs.length !== 1) {
                return;
            }
            updateChatboxTabPersona(tabs[0], personaName);
        }

        function setChatboxTabsForConversation(participants) {
            var slugs = [];
            if (participants && participants.length > 0) {
                participants.forEach(function(persona) {
                    if (persona && persona.slug && slugs.indexOf(persona.slug) === -1) {
                        slugs.push(persona.slug);
                    } else if (persona && persona.name) {
                        var inferred = getPersonaIdFromName(persona.name);
                        if (inferred && slugs.indexOf(inferred) === -1) {
                            slugs.push(inferred);
                        }
                    }
                });
            }

            if (slugs.length === 0) {
                slugs = [defaultPersonaSlug];
            }

            setPersonaSelection(slugs);
        }

        function addChatboxTabFromPersona(persona) {
            if (!persona) return;
            var tabsRoot = chatboxTabs || document.getElementById('chatboxTabs');
            if (!tabsRoot) return;
            var tab = document.createElement('div');
            tab.className = 'chatbox-tab';
            if (persona.slug) {
                tab.setAttribute('data-persona', persona.slug);
            }

            var avatarSrc = persona.avatar || getPersonaImagePathByName(persona.name);
            var isReadonly = chatState && chatState.currentMailbox !== 'chat_inbox';
            tab.innerHTML = '<img src="' + avatarSrc + '" alt="' + persona.name + '">' +
                '<span>' + persona.name + '</span>' +
                (isReadonly ? '' : '<button class="chatbox-close" type="button" aria-label="Remove ' + persona.name + '">&times;</button>');

            tabsRoot.appendChild(tab);

            var closeBtn = tab.querySelector('.chatbox-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var personaSlug = tab.getAttribute('data-persona');
                    removePersonaSelection(personaSlug);
                });
            }
        }

        // Load a specific conversation
        async function loadConversation(conversationId) {
            var conv = allConversations.find(function(c) { return c.id === conversationId; });
            if (!conv) return;

            chatState.conversationId = conversationId;
            chatState.subject = conv.title || null;
            chatState.subjectLocked = !!conv.subjectLocked;
            chatState.userMessageCount = 0;
            conversationHistory = [];

            updateSubject(conv.title || 'Waiting for conversation...', !conv.title, {
                skipSave: true,
                subjectLocked: chatState.subjectLocked
            });

            if (chatState.currentMailbox === 'chat_inbox') {
                updateInboxHeader(formatPersonaLabel(conv.participants || [], conv.persona), conv.title);
                setChatboxTabsForConversation(conv.participants || []);
            } else {
                var boardPersonaName = conv.personaName || (conv.persona ? conv.persona.name : null) || getBoardPersonaName(chatState.currentMailbox);
                updateInboxHeader(boardPersonaName, conv.title);
                applyMailboxPersonaSelection(chatState.currentMailbox);
            }

            updatePersonaAvatars();

            messagesArea.innerHTML = '';

            try {
                var url = '';
                var languageCode = getSelectedLanguageCode();
                if (chatState.currentMailbox === 'chat_inbox') {
                    url = '/chat/conversations/' + conversationId + '/messages?order=asc';
                    if (languageCode) {
                        url += '&language=' + encodeURIComponent(languageCode);
                    }
                } else {
                    url = '/boards/conversations/' + conversationId + '/messages?order=asc';
                    if (languageCode) {
                        url += '&language=' + encodeURIComponent(languageCode);
                    }
                }

                var response = await fetch(url);
                var result = await response.json();
                if (result.success && Array.isArray(result.messages)) {
                    conversationHistory = result.messages.map(function(msg) {
                        if (chatState.currentMailbox === 'chat_inbox') {
                            var role = msg.role || msg.type || 'user';
                            return {
                                id: msg.id || null,
                                role: role,
                                content: msg.content,
                                personaName: msg.personaName || null
                            };
                        }
                        return {
                            id: msg.id || null,
                            role: msg.isAiResponse ? 'assistant' : 'user',
                            content: msg.content,
                            personaName: msg.personaName || null,
                            authorName: msg.authorName || null
                        };
                    });

                    conversationHistory.forEach(function(msg) {
                        if (msg.role === 'user') {
                            var authorName = msg.authorName || window.currentUserFullName || 'Guest';
                            addMessage('user', msg.content, authorName, false, msg.id);
                        } else {
                            var assistantPersona = msg.personaName || conv.personaName || getBoardPersonaName(chatState.currentMailbox) || 'Jubilee Inspire';
                            addMessage('assistant', msg.content, assistantPersona, false, msg.id);
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load conversation messages:', error);
            }

            renderConversationList();
        }

        function resetConversationView() {
            chatState.conversationId = null;
            chatState.subject = null;
            chatState.userMessageCount = 0;
            chatState.subjectLocked = false;
            conversationHistory = [];
            messagesArea.innerHTML = '';
            updateSubject('Waiting for conversation...', true, {
                skipSave: true,
                subjectLocked: false
            });
        }

        // Delete a conversation
        function deleteConversation(conversationId) {
            showDeleteConfirmModal('Are you sure you want to delete this conversation?', async function() {
                try {
                    if (chatState.currentMailbox !== 'chat_inbox') {
                        alert('Community conversations cannot be deleted from here.');
                        return;
                    }

                    var response = await fetch('/chat/conversations/' + conversationId, {
                        method: 'DELETE'
                    });
                    var result = await response.json();

                    if (!response.ok || !result.success) {
                        alert('Failed to delete conversation: ' + (result.error || response.statusText || 'Server error'));
                        return;
                    }

                    // Only update UI after confirmed database deletion
                    allConversations = allConversations.filter(function(c) { return c.id !== conversationId; });

                    if (conversationId === chatState.conversationId) {
                        resetConversationView();
                    }

                    renderConversationList();
                } catch (error) {
                    console.error('Error deleting conversation:', error);
                    alert('Failed to delete conversation. Please try again.');
                }
            });
        }

        // Delete a board conversation (including all messages and translations)
        function deleteBoardConversation(conversationId) {
            showDeleteConfirmModal('Are you sure you want to delete this conversation? All messages and translations will be permanently removed.', async function() {
                try {
                    var response = await fetch('/boards/conversations/' + conversationId, {
                        method: 'DELETE'
                    });
                    var result = await response.json();
                    if (result.success) {
                        // Remove from local list
                        allConversations = allConversations.filter(function(c) { return c.id !== conversationId; });

                        // If this was the current conversation, clear the view
                        if (conversationId === chatState.conversationId) {
                            resetConversationView();
                            chatState.conversationId = null;

                            // Unsubscribe from WebSocket
                            if (typeof window.boardWebSocket !== 'undefined' && window.boardWebSocket.unsubscribe) {
                                window.boardWebSocket.unsubscribe(conversationId);
                            }
                        }

                        // Refresh the conversation list
                        renderConversationList();

                        // If there are remaining conversations, select the first one
                        if (allConversations.length > 0) {
                            selectConversation(allConversations[0].id);
                        }
                    } else {
                        alert('Failed to delete conversation: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting board conversation:', error);
                    alert('Failed to delete conversation. Please try again.');
                }
            });
        }

        // Create a new conversation
        function createNewConversation() {
            resetConversationView();
            updateInboxHeader();
            applyMailboxPersonaSelection(chatState.currentMailbox);
        }

        // Update current conversation in storage
        function updateCurrentConversation() {
            return;
        }

        // Initialize conversations on page load
        // Note: Cookie restoration is handled separately after selectMailbox is defined
        async function initConversations() {
            var conversations = await loadMailboxConversations(chatState.currentMailbox, chatState.focusedFilter);

            // If coming from search with a query (forceNewConversation), skip restoring saved conversation
            // and just reset the view - sendInitialQueryIfNeeded will handle creating the new conversation
            if (forceNewConversation) {
                resetConversationView();
                return;
            }

            // Try to restore the saved conversation if it exists
            var savedConversation = null;
            try {
                var nameEQ = 'jv_current_conversation=';
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) {
                        savedConversation = c.substring(nameEQ.length, c.length);
                        break;
                    }
                }
            } catch (e) {}

            if (savedConversation && conversations && conversations.length > 0) {
                var foundConversation = conversations.find(function(c) { return c.id === savedConversation; });
                if (foundConversation) {
                    loadConversation(savedConversation);
                    return;
                }
            }

            // Fall back to first conversation or reset view
            if (conversations && conversations.length > 0) {
                loadConversation(conversations[0].id);
            } else {
                resetConversationView();
            }
        }

        // Auto-resize textarea and close persona panel when typing
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 80) + 'px';

            // Close the Send Message To panel when user starts typing
            var panel = document.getElementById('personaSelectionPanel');
            if (panel && panel.classList.contains('expanded') && this.value.length > 0) {
                setPersonaPanelExpanded(false);
            }

            updateInputBorderState();
        });

        chatInput.addEventListener('focus', updateInputBorderState);
        chatInput.addEventListener('blur', updateInputBorderState);

        // Send message on Enter (Shift+Enter for new line)
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Submit button click handler
        var chatSubmitBtn = document.getElementById('chatSubmitBtn');
        if (chatSubmitBtn) {
            chatSubmitBtn.addEventListener('click', function() {
                if (!chatSubmitBtn.classList.contains('is-processing')) {
                    sendMessage();
                } else {
                    // Stop/cancel the current processing (if implemented)
                    console.log('Stop processing requested');
                }
            });
        }

        // Focus state for chatbox-top when clicking on persona tabs or other elements
        var chatboxTopEl = document.querySelector('.chatbox-top');
        if (chatboxTopEl) {
            chatboxTopEl.addEventListener('click', function(e) {
                // When clicking inside chatbox-top, focus the input and show borders
                chatInput.focus();
                updateInputBorderState();
            });
        }

        // Get current user name - use window.currentUserFullName which is set by auth check
        // Note: Always access window.currentUserFullName at time of use since auth is async

        // Inspire family persona names for dynamic image selection
        var inspirePersonas = ['jubilee', 'melody', 'zariah', 'elias', 'eliana', 'caleb', 'imani', 'zev', 'amir', 'nova', 'santiago', 'tahoma'];
        // Default persona: use user's stored preference if available, otherwise fall back to 'jubilee'
        var defaultPersonaSlug = window.userDefaultPersonaSlug || 'jubilee';
        var personaSelectionState = { selected: [] };

        // Listen for user's default persona being loaded from server
        document.addEventListener('userDefaultPersonaLoaded', function(e) {
            if (e.detail && e.detail.persona && e.detail.persona.slug) {
                var serverDefaultSlug = e.detail.persona.slug;
                // Only update if it's a valid inspire persona
                if (inspirePersonas.indexOf(serverDefaultSlug) !== -1) {
                    defaultPersonaSlug = serverDefaultSlug;
                    console.log('Updated default persona to server value:', defaultPersonaSlug);

                    // Sync localStorage with server value to prevent stale cache issues
                    // This ensures localStorage matches the authoritative PostgreSQL value
                    try {
                        localStorage.setItem('jv_selected_personas', JSON.stringify([serverDefaultSlug]));
                        console.log('Synced localStorage with server default persona');
                    } catch (syncError) {
                        console.warn('Could not sync localStorage:', syncError);
                    }

                    // If we're on a new conversation (no conversation selected), update the selection
                    if (chatState && !chatState.conversationId && chatState.currentMailbox === 'chat_inbox') {
                        setPersonaSelection([defaultPersonaSlug]);
                    }
                }
            }
        });

        function getStoredPersonaSelection() {
            // PRIORITY ORDER:
            // 1. Server-side default persona (PostgreSQL) - authoritative source
            // 2. localStorage (legacy fallback for non-authenticated users)
            // 3. Empty array (will be filled with defaultPersonaSlug later)

            // First check if user has a server-side default persona (PostgreSQL)
            // This is the authoritative source of truth for authenticated users
            if (window.userDefaultPersonaSlug && inspirePersonas.indexOf(window.userDefaultPersonaSlug) !== -1) {
                return [window.userDefaultPersonaSlug];
            }

            // Fallback to localStorage for non-authenticated users
            try {
                var stored = localStorage.getItem('jv_selected_personas');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {}

            return [];
        }

        function setStoredPersonaSelection(slugs) {
            try {
                localStorage.setItem('jv_selected_personas', JSON.stringify(slugs));
            } catch (e) {}
        }

        function normalizePersonaSelection(slugs, options) {
            var allowEmpty = options && options.allowEmpty;
            var next = [];
            if (Array.isArray(slugs)) {
                slugs.forEach(function(slug) {
                    if (!slug) return;
                    if (inspirePersonas.indexOf(slug) === -1) return;
                    if (next.indexOf(slug) === -1) {
                        next.push(slug);
                    }
                });
            }

            if (next.length === 0 && !allowEmpty) {
                next = [defaultPersonaSlug];
            }

            return next;
        }

        function getPersonaNameForSlug(slug) {
            if (!slug) return '';
            var nameEl = document.querySelector('.persona-item[data-persona="' + slug + '"] .persona-item-name');
            if (nameEl && nameEl.textContent) {
                return nameEl.textContent.trim();
            }
            var railNameEl = document.querySelector('.persona-rail-item[data-persona="' + slug + '"] .persona-rail-name');
            if (railNameEl && railNameEl.textContent) {
                return railNameEl.textContent.trim();
            }
            return slug.charAt(0).toUpperCase() + slug.slice(1) + ' Inspire';
        }

        function getPersonaAvatarForSlug(slug) {
            var personaName = getPersonaNameForSlug(slug);
            return getPersonaImagePathByName(personaName);
        }

        function setPersonaItemChecked(item, isChecked) {
            if (!item) return;
            var checkbox = item.querySelector('.persona-item-checkbox');
            if (!checkbox) return;
            checkbox.classList.toggle('checked', isChecked);
            checkbox.innerHTML = isChecked
                ? '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'
                : '';
        }

        function updateSendToPanelSelection(slugs) {
            var selected = {};
            slugs.forEach(function(slug) {
                selected[slug] = true;
            });

            document.querySelectorAll('.persona-item[data-persona]').forEach(function(item) {
                var slug = item.getAttribute('data-persona');
                setPersonaItemChecked(item, !!selected[slug]);
            });
        }

        function updatePersonaRailSelection(slugs) {
            var selected = {};
            slugs.forEach(function(slug) {
                selected[slug] = true;
            });

            document.querySelectorAll('.persona-rail-item[data-persona]').forEach(function(item) {
                var slug = item.getAttribute('data-persona');
                item.classList.toggle('selected', !!selected[slug]);
            });
        }

        function updateChatboxTabsFromSelection(slugs) {
            var tabsRoot = document.getElementById('chatboxTabs');
            if (!tabsRoot) return;

            tabsRoot.innerHTML = '';
            var isReadonly = chatState && chatState.currentMailbox !== 'chat_inbox';
            var isBoardMailbox = chatState && chatState.currentMailbox !== 'chat_inbox';

            // For board mailboxes, add community as the first recipient
            if (isBoardMailbox && chatState.currentCommunityName) {
                var communityTab = document.createElement('div');
                communityTab.className = 'chatbox-tab community-tab';
                communityTab.setAttribute('data-community', 'true');
                // Get initials from community name (e.g., "Jubilee Community" -> "JC")
                var communityInitials = chatState.currentCommunityName.split(' ')
                    .map(function(word) { return word.charAt(0).toUpperCase(); })
                    .join('').substring(0, 2);
                communityTab.innerHTML = '<span class="community-icon">' + escapeHtml(communityInitials) + '</span>' +
                    '<span>' + escapeHtml(chatState.currentCommunityName) + '</span>';
                tabsRoot.appendChild(communityTab);
            }

            slugs.forEach(function(slug) {
                var personaName = getPersonaNameForSlug(slug);
                if (!personaName) return;
                var avatarSrc = getPersonaAvatarForSlug(slug);
                var tab = document.createElement('div');
                tab.className = 'chatbox-tab';
                tab.setAttribute('data-persona', slug);
                tab.innerHTML = '<img src="' + avatarSrc + '" alt="' + personaName + '">' +
                    '<span>' + personaName + '</span>' +
                    (isReadonly ? '' : '<button class="chatbox-close" type="button" aria-label="Remove ' + personaName + '">&times;</button>');
                tabsRoot.appendChild(tab);
            });

            applyChatboxTabNameRules();
        }

        function syncPersonaSelectionUI(slugs) {
            updateSendToPanelSelection(slugs);
            updatePersonaRailSelection(slugs);
            updateChatboxTabsFromSelection(slugs);
            if (typeof updatePersonaAvatars === 'function') {
                updatePersonaAvatars();
            }
        }

        function setPersonaSelection(slugs, options) {
            var normalized = normalizePersonaSelection(slugs, options);
            personaSelectionState.selected = normalized.slice();

            if (!(options && options.persist === false)) {
                setStoredPersonaSelection(normalized);
            }

            if (chatState && chatState.currentMailbox === 'chat_inbox' && !(options && options.persist === false)) {
                chatState.chatInboxSelection = normalized.slice();
            }

            syncPersonaSelectionUI(normalized);
        }

        function getSelectedPersonaSlugs(options) {
            var allowEmpty = options && options.allowEmpty;
            var source = personaSelectionState.selected.length
                ? personaSelectionState.selected
                : getStoredPersonaSelection();
            var normalized = normalizePersonaSelection(source, { allowEmpty: allowEmpty });
            personaSelectionState.selected = normalized.slice();
            return normalized.slice();
        }

        function togglePersonaSelection(personaSlug) {
            if (!personaSlug) return;

            if (chatState && chatState.currentMailbox !== 'chat_inbox') {
                var boardPersona = getBoardPersonaForMailbox(chatState.currentMailbox);
                if (boardPersona) {
                    setPersonaSelection([boardPersona.slug], { persist: false });
                }
                return;
            }

            var current = getSelectedPersonaSlugs({ allowEmpty: true });
            var index = current.indexOf(personaSlug);
            if (index > -1) {
                current.splice(index, 1);
            } else {
                current.push(personaSlug);
            }
            setPersonaSelection(current);
        }

        function removePersonaSelection(personaSlug) {
            if (!personaSlug) return;
            if (chatState && chatState.currentMailbox !== 'chat_inbox') {
                var boardPersona = getBoardPersonaForMailbox(chatState.currentMailbox);
                if (boardPersona) {
                    setPersonaSelection([boardPersona.slug], { persist: false });
                }
                return;
            }
            var current = getSelectedPersonaSlugs({ allowEmpty: true });
            var index = current.indexOf(personaSlug);
            if (index > -1) {
                current.splice(index, 1);
                setPersonaSelection(current);
            }
        }

        function ensurePersonaSelection() {
            var current = getSelectedPersonaSlugs({ allowEmpty: true });
            if (current.length === 0) {
                setPersonaSelection([defaultPersonaSlug]);
            }
        }

        // Conversation state
        var chatState = {
            userMessageCount: 0,
            subject: null,
            subjectLocked: false,
            conversationId: null,
            currentMailbox: 'chat_inbox',
            focusedFilter: null,
            currentCommunityId: null,
            currentCommunityName: 'Jubilee Community',
            chatInboxSelection: []
        };

        function getSelectedLanguageCode() {
            // First try the global function if available
            if (typeof window.getSelectedResponseLanguage === 'function') {
                var lang = window.getSelectedResponseLanguage();
                if (lang && lang.code) {
                    return lang.code;
                }
            }
            // Fall back to reading directly from localStorage
            // This handles the case where conversations load before the language panel initializes
            try {
                var stored = localStorage.getItem('jv_selected_language');
                if (stored) {
                    var parsed = JSON.parse(stored);
                    if (parsed && parsed.code) {
                        return parsed.code;
                    }
                }
            } catch (e) {}
            return 'en';
        }

        // Subject line elements
        var chatSubjectText = document.getElementById('chatSubjectText');

        function getPersonaImagePath(personaName) {
            if (!personaName) return '/images/personas/jubilee.png';

            var nameLower = personaName.toLowerCase();

            // Check if persona name contains any of the inspire family names
            for (var i = 0; i < inspirePersonas.length; i++) {
                if (nameLower.indexOf(inspirePersonas[i]) !== -1) {
                    return '/images/personas/' + inspirePersonas[i] + '.png';
                }
            }

            // Default to jubilee if no match found
            return '/images/personas/jubilee.png';
        }

        function truncateSubjectLine(text, maxLen) {
            var trimmed = (text || '').trim();
            if (!trimmed) return '';
            if (trimmed.length <= maxLen) return trimmed;
            return trimmed.substring(0, Math.max(maxLen - 1, 1)).trim() + '';
        }

        // Generate subject from first user message
        function generateSubject(messages) {
            if (messages.length === 0) return 'New Conversation';

            var firstUserMessage = '';
            for (var i = 0; i < messages.length; i++) {
                if (messages[i].role === 'user') {
                    firstUserMessage = messages[i].content;
                    break;
                }
            }

            if (!firstUserMessage) return 'New Conversation';

            return truncateSubjectLine(firstUserMessage, 70) || 'New Conversation';
        }

        // Update the title bar (simplified - only subject text now)
        function updateTitleBar() {
            // Elements removed from UI, function kept for compatibility
        }

        // Update subject line
        function updateSubject(subject, isPending, options) {
            var opts = typeof options === 'boolean' ? { skipSave: options } : (options || {});
            var skipSave = !!opts.skipSave;
            if (typeof opts.subjectLocked === 'boolean') {
                chatState.subjectLocked = opts.subjectLocked;
            }
            if (opts.lockSubject) {
                chatState.subjectLocked = true;
            }
            chatState.subject = isPending ? null : subject;
            if (chatSubjectText) {
                // Add "SUBJECT: " prefix for all mailboxes
                chatSubjectText.textContent = isPending ? subject : 'SUBJECT: ' + subject;
            }

            if (isPending) {
                chatSubjectText.classList.add('chat-subject-pending');
            } else {
                chatSubjectText.classList.remove('chat-subject-pending');
            }

            // Update the title bar with current mailbox and community
            updateTitleBar();

            // Update inbox header when subject changes
            var conv = allConversations.find(function(c) { return c.id === chatState.conversationId; });
            if (conv) {
                var headerLabel = chatState.currentMailbox === 'chat_inbox'
                    ? formatPersonaLabel(conv.participants || [], conv.persona)
                    : (conv.personaName || (conv.persona ? conv.persona.name : null) || getBoardPersonaName(chatState.currentMailbox));
                updateInboxHeader(headerLabel, subject);
                // Update the conversation object's subject for inbox preview
                if (!isPending) {
                    conv.title = subject;
                }
                if (typeof opts.subjectLocked === 'boolean') {
                    conv.subjectLocked = opts.subjectLocked;
                }
                if (opts.lockSubject) {
                    conv.subjectLocked = true;
                }
                // Update the inbox row preview in real-time
                updateConversationItemPreview(conv.id, subject, isPending);
            }

            if (skipSave) {
                return;
            }

            if (chatState.currentMailbox !== 'chat_inbox') {
                return;
            }

            if (isPending || !chatState.conversationId) {
                return;
            }

            var payload = { title: subject };
            if (opts.lockSubject) {
                payload.subjectLocked = true;
            }

            fetch('/chat/conversations/' + chatState.conversationId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(function(error) {
                console.warn('Failed to update conversation title:', error);
            });
        }

        // Update the preview text of a specific conversation item in the inbox
        function updateConversationItemPreview(conversationId, subject, isPending) {
            var itemElement = document.querySelector('.conversation-item[data-id="' + conversationId + '"]');
            if (itemElement) {
                var previewEl = itemElement.querySelector('.conversation-preview');
                var subjectEl = itemElement.querySelector('.conversation-subject');
                if (previewEl) {
                    var conv = allConversations.find(function(c) { return c.id === conversationId; });
                    var previewText = '';
                    if (conv && conv.lastMessage) {
                        previewText = typeof conv.lastMessage === 'string' ? conv.lastMessage : conv.lastMessage.content;
                    }
                    if (!previewText) {
                        previewText = (!isPending && subject && subject !== 'Waiting for conversation...')
                            ? subject
                            : 'New conversation...';
                    }
                    previewEl.textContent = sanitizeMessageText(previewText);
                }
                if (subjectEl) {
                    var subjectText = (!isPending && subject && subject !== 'Waiting for conversation...')
                        ? subject
                        : 'New Conversation';
                    subjectEl.textContent = sanitizeMessageText(subjectText);
                }
            }
        }

        function attachSubjectEditHandler(subjectEl, conversationId) {
            if (!subjectEl || !conversationId) return;
            subjectEl.addEventListener('click', function(e) {
                if (chatState.currentMailbox !== 'chat_inbox') return;
                e.stopPropagation();
                startConversationSubjectEdit(conversationId, subjectEl);
            });
        }

        function saveConversationSubject(conversationId, newSubject) {
            if (chatState.currentMailbox !== 'chat_inbox') return;
            var conv = allConversations.find(function(c) { return c.id === conversationId; });
            if (conv) {
                conv.title = newSubject;
                conv.subjectLocked = true;
            }

            if (conversationId === chatState.conversationId) {
                updateSubject(newSubject, false, { lockSubject: true });
                return;
            }

            updateConversationItemPreview(conversationId, newSubject, false);

            fetch('/chat/conversations/' + conversationId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newSubject, subjectLocked: true })
            }).catch(function(error) {
                console.warn('Failed to update conversation title:', error);
            });
        }

        function startConversationSubjectEdit(conversationId, subjectEl) {
            if (!subjectEl || !conversationId) return;
            if (chatState.currentMailbox !== 'chat_inbox') return;

            var originalText = (subjectEl.textContent || '').trim();
            var input = document.createElement('input');
            input.type = 'text';
            input.className = 'conversation-subject-edit';
            input.value = originalText;

            subjectEl.replaceWith(input);
            input.focus();
            input.select();
            input.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            var committed = false;
            function finish(save) {
                if (committed) return;
                committed = true;

                var finalText = save ? (input.value.trim() || 'Untitled Conversation') : originalText;
                var replacement = document.createElement('div');
                replacement.className = 'conversation-subject';
                replacement.textContent = finalText;
                input.replaceWith(replacement);
                attachSubjectEditHandler(replacement, conversationId);

                if (save) {
                    saveConversationSubject(conversationId, finalText);
                }
            }

            input.addEventListener('blur', function() {
                finish(true);
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finish(true);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    finish(false);
                }
            });
        }

        // Make subject editable on click
        function initEditableSubject() {
            chatSubjectText.addEventListener('click', function() {
                if (chatState.currentMailbox !== 'chat_inbox') {
                    return;
                }
                var currentSubject = chatState.subject || '';
                if (currentSubject === 'Waiting for conversation...') {
                    currentSubject = '';
                }

                var input = document.createElement('input');
                input.type = 'text';
                input.className = 'chat-subject-input';
                input.value = currentSubject;
                input.placeholder = 'Enter subject...';

                chatSubjectText.style.display = 'none';
                chatSubjectText.parentNode.insertBefore(input, chatSubjectText.nextSibling);
                input.focus();
                input.select();

                function saveSubject() {
                    var newSubject = input.value.trim() || 'Untitled Conversation';
                    updateSubject(newSubject, false, { lockSubject: true });
                    input.remove();
                    chatSubjectText.style.display = '';
                }

                input.addEventListener('blur', saveSubject);
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveSubject();
                    } else if (e.key === 'Escape') {
                        input.remove();
                        chatSubjectText.style.display = '';
                    }
                });
            });
        }

        // Save conversation state to localStorage
        function saveConversationState() {
            return;
        }

        // Add message with optional streaming effect and message ID
        function addMessage(role, content, senderName, isStreaming, messageId) {
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role;

            // Set data-message-id if provided (for duplicate detection and translation updates)
            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            }

            // Get the latest user name (may have been set after page load by auth check)
            var userName = window.currentUserFullName || 'Guest';
            var sender = senderName || (role === 'user' ? userName : 'Jubilee Inspire');
            var avatarSrc = getPersonaImagePath(sender);

            if (role === 'user') {
                var initials = getInitials(sender);
                messageDiv.innerHTML =
                    '<div class="message-avatar user-initials">' + initials + '</div>' +
                    '<div class="message-content">' +
                        '<div class="message-sender">' + sender + '</div>' +
                        '<div class="message-text">' + escapeHtml(content) + '</div>' +
                    '</div>';

                // Track user message count for auto-subject
                chatState.userMessageCount++;
            } else {
                var streamingClass = isStreaming ? ' streaming' : '';
                messageDiv.innerHTML =
                    '<img src="' + avatarSrc + '" class="message-avatar" alt="' + sender + '">' +
                    '<div class="message-content">' +
                        '<div class="message-sender">' + sender + '</div>' +
                        '<div class="message-text' + streamingClass + '">' + escapeHtml(content) + '</div>' +
                    '</div>';
            }

            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;

            return messageDiv;
        }

        // Add streaming message (simulates text streaming)
        function addStreamingMessage(role, content, senderName) {
            var messageDiv = addMessage(role, '', senderName, true);
            var textEl = messageDiv.querySelector('.message-text');

            return new Promise(function(resolve) {
                var index = 0;
                var streamInterval = setInterval(function() {
                    if (index < content.length) {
                        var chunkSize = Math.floor(Math.random() * 3) + 1; // 1-3 chars at a time
                        var chunk = content.substring(index, index + chunkSize);
                        textEl.innerHTML = escapeHtml(content.substring(0, index + chunkSize));
                        textEl.classList.add('streaming');
                        index += chunkSize;
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    } else {
                        clearInterval(streamInterval);
                        textEl.classList.remove('streaming');
                        resolve(messageDiv);
                    }
                }, 20); // Original streaming speed
            });
        }

        // Initialize editable subject
        initEditableSubject();

        function getInitials(name) {
            var cleaned = (name || '').trim();
            if (!cleaned) {
                return 'Y';
            }
            var parts = cleaned.split(/\s+/);
            var first = parts[0] ? parts[0][0] : '';
            var last = parts.length > 1 ? parts[parts.length - 1][0] : '';
            var initials = (first + last).toUpperCase();
            return initials || 'Y';
        }

        function sanitizeMessageText(text) {
            return (text || '').replace(/[*#]/g, '');
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = sanitizeMessageText(text);
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function setTypingIndicatorPersona(personaName) {
            if (!typingIndicator || !personaName) return;
            var avatar = typingIndicator.querySelector('.message-avatar');
            if (avatar) {
                avatar.src = getPersonaImagePath(personaName);
                avatar.alt = personaName;
            }
        }

        function showTyping(personaName) {
            if (personaName) {
                setTypingIndicatorPersona(personaName);
            }
            typingIndicator.classList.add('show');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.classList.remove('show');
        }

        function setInputDisabled(disabled) {
            chatInput.disabled = disabled;
        }

        // Track the last user message element for setting message ID after API response
        var lastUserMessageElement = null;

        async function sendMessage() {
            var message = chatInput.value.trim();
            if (!message) return;

            var userName = window.currentUserFullName || 'Guest';

            // For non-English users on community boards, translate their message for display
            // This ensures consistency - all content shows in their selected language
            var isNonEnglish = typeof window.isNonEnglishLanguage === 'function' && window.isNonEnglishLanguage();
            var isCommunityBoard = chatState.currentMailbox !== 'chat_inbox';

            if (isNonEnglish && isCommunityBoard && typeof window.translateContentForDisplay === 'function') {
                // Show placeholder while translating
                lastUserMessageElement = addMessage('user', '', userName);

                // Translate and display with streaming effect
                var translatedMessage = await window.translateContentForDisplay(message);
                if (lastUserMessageElement) {
                    var textEl = lastUserMessageElement.querySelector('.message-text');
                    if (textEl && typeof window.simulateStreamingEffect === 'function') {
                        // Use simulated streaming for UX consistency
                        await window.simulateStreamingEffect(textEl, translatedMessage, 20);
                    } else if (textEl) {
                        // Fallback if streaming not available yet
                        textEl.textContent = translatedMessage;
                    }
                    lastUserMessageElement.setAttribute('data-original-content', message);
                }
            } else {
                // English users or chat inbox - show message directly
                lastUserMessageElement = addMessage('user', message, userName);
            }

            chatInput.value = '';
            chatInput.style.height = 'auto';

            conversationHistory.push({ role: 'user', content: message });

            setInputDisabled(true);

            var submitBtn = document.getElementById('chatSubmitBtn');
            if (submitBtn) {
                submitBtn.classList.add('is-processing');
            }

            try {
                if (chatState.currentMailbox === 'chat_inbox') {
                    await sendChatInboxMessage(message);
                } else {
                    await sendCommunityBoardMessage(message);
                }
            } catch (error) {
                console.error('Error:', error);
                hideTyping();
                // Use the appropriate persona for error messages based on the current mailbox
                var errorPersona = chatState.currentMailbox === 'chat_inbox'
                    ? 'Jubilee Inspire'
                    : (getBoardPersonaName(chatState.currentMailbox) || 'Bible Persona');
                addMessage('assistant', 'I apologize, but I encountered an error. Please try again.', errorPersona);
            }

            setInputDisabled(false);

            if (submitBtn) {
                submitBtn.classList.remove('is-processing');
            }

            chatInput.focus();
            updateInputBorderState();
        }

        function resolveDefaultPersonaId() {
            var defaultPersona = personaDirectory.bySlug['jubilee'];
            return defaultPersona ? defaultPersona.id : null;
        }

        async function sendChatInboxMessage(message) {
            if (!personaDirectory.bySlug || Object.keys(personaDirectory.bySlug).length === 0) {
                await loadPersonaDirectory();
            }
            var responseLanguage = getSelectedLanguageCode();
            var personaIds = getSelectedPersonaIds();
            if (personaIds.length === 0) {
                ensurePersonaSelection();
                personaIds = getSelectedPersonaIds();
            }

            if (personaIds.length === 0) {
                throw new Error('Please select at least one persona.');
            }

            if (!chatState.conversationId) {
                var title = chatState.subject || generateSubject([{ role: 'user', content: message }]);
                var createResponse = await fetch('/chat/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        personaIds: personaIds,
                        title: title,
                        responseLanguage: responseLanguage
                    })
                });
                var createData = await createResponse.json();
                if (!createData.success) {
                    throw new Error(createData.error || 'Failed to create conversation');
                }

                chatState.conversationId = createData.conversation.id;
                chatState.subject = createData.conversation.title;
                chatState.subjectLocked = !!createData.conversation.subjectLocked;
                updateSubject(createData.conversation.title, false, {
                    skipSave: true,
                    subjectLocked: chatState.subjectLocked
                });
            }

            // Show typing indicator BEFORE making the API call (immediate feedback)
            var selectedPersonaNames = getSelectedPersonaNames();
            var selectedPersonaName = selectedPersonaNames.length > 0 ? selectedPersonaNames[0] : 'Jubilee Inspire';
            showTyping(selectedPersonaName);

            var response = await fetch('/chat/conversations/' + chatState.conversationId + '/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: message,
                    personaIds: personaIds,
                    responseLanguage: responseLanguage
                })
            });

            var data = await response.json();

            if (data.success) {
                var assistantMessages = data.assistantMessages || [];
                if (assistantMessages.length === 0 && data.assistantMessage) {
                    assistantMessages = [{ message: data.assistantMessage, persona: data.persona || null }];
                }

                if (data.conversationTitle) {
                    updateSubject(data.conversationTitle, false, {
                        skipSave: true,
                        subjectLocked: data.subjectLocked
                    });
                } else if (typeof data.subjectLocked === 'boolean') {
                    chatState.subjectLocked = data.subjectLocked;
                    var convLock = allConversations.find(function(c) { return c.id === chatState.conversationId; });
                    if (convLock) {
                        convLock.subjectLocked = data.subjectLocked;
                    }
                }

                for (var i = 0; i < assistantMessages.length; i++) {
                    var item = assistantMessages[i];
                    var personaName = item.persona ? item.persona.name : 'Jubilee Inspire';
                    showTyping(personaName);
                    await addStreamingMessage('assistant', item.message.content, personaName);
                    hideTyping();
                    conversationHistory.push({ role: 'assistant', content: item.message.content, personaName: personaName });
                }

                // Update the conversation list in the sidebar without reloading current conversation
                await loadMailboxConversations('chat_inbox', chatState.focusedFilter);
                renderConversationList();
                // Do NOT call selectConversation - messages are already displayed
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        }

        async function sendCommunityBoardMessage(message) {
            var boardSlug = mailboxBoardSlug[chatState.currentMailbox];
            if (!boardSlug) {
                throw new Error('Invalid board mailbox');
            }
            var languageCode = getSelectedLanguageCode();

            if (!chatState.conversationId) {
                var title = chatState.subject || generateSubject([{ role: 'user', content: message }]);
                var payload = { title: title };
                if (chatState.currentCommunityId) {
                    payload.communityId = chatState.currentCommunityId;
                }
                var createResponse = await fetch('/boards/' + boardSlug + '/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                var createData = await createResponse.json();
                if (!createData.success) {
                    throw new Error(createData.error || 'Failed to create board conversation');
                }

                chatState.conversationId = createData.conversation.id;
                chatState.subject = createData.conversation.title;
                chatState.subjectLocked = false;
                updateSubject(createData.conversation.title, false, { skipSave: true });

                // Subscribe to the new conversation for real-time updates (including AI streaming)
                if (typeof window.boardWebSocket !== 'undefined' && window.boardWebSocket.subscribe) {
                    window.boardWebSocket.subscribe(chatState.conversationId);
                }
            }

            // Show typing indicator BEFORE making the API call (immediate feedback)
            var boardPersonaName = getBoardPersonaName(chatState.currentMailbox) || 'Bible Persona';
            showTyping(boardPersonaName);

            var response = await fetch('/boards/conversations/' + chatState.conversationId + '/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: message,
                    requestAiResponse: true
                })
            });

            var data = await response.json();

            if (data.success) {
                // Track these message IDs so WebSocket handlers ignore them (prevents duplicates)
                // Use window.sentMessageIds which is set globally by the WebSocket IIFE
                if (data.userMessage && data.userMessage.id) {
                    if (window.sentMessageIds) {
                        window.sentMessageIds.add(data.userMessage.id);
                    }
                    // Also set the ID on the DOM element for extra safety
                    if (lastUserMessageElement) {
                        lastUserMessageElement.setAttribute('data-message-id', data.userMessage.id);
                    }

                    // For non-English users, track this message for translation update
                    var isNonEnglish = typeof window.isNonEnglishLanguage === 'function' && window.isNonEnglishLanguage();
                    if (isNonEnglish && window.messagesAwaitingTranslation) {
                        window.messagesAwaitingTranslation.add(data.userMessage.id);
                    }
                }

                // AI response will be streamed via WebSocket to ALL users (including the sender)
                // The server broadcasts streaming chunks to everyone viewing this conversation
                // We no longer process aiMessage from HTTP response - it comes via WebSocket
                // This ensures consistent streaming experience for all users

                // Update the conversation list in the sidebar without reloading current conversation
                await loadMailboxConversations(chatState.currentMailbox, chatState.focusedFilter);
                renderConversationList();
                // Do NOT call selectConversation - messages are already displayed
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        }

        // Add or update a conversation in the inbox panel
        function addConversationToInbox(conversationData, personaName) {
            var inboxContent = document.getElementById('inboxPanelContent');
            if (!inboxContent) return;

            // Check if conversation already exists
            var existingItem = inboxContent.querySelector('[data-conversation-id="' + conversationData.id + '"]');

            if (existingItem) {
                // Update existing conversation
                var previewEl = existingItem.querySelector('.inbox-message-preview');
                var timeEl = existingItem.querySelector('.inbox-message-time');
                if (previewEl) previewEl.textContent = conversationData.lastMessage || '';
                if (timeEl) timeEl.textContent = formatInboxTime(conversationData.timestamp);
            } else {
                // Create new conversation item
                var item = document.createElement('div');
                item.className = 'inbox-message-item';
                item.setAttribute('data-conversation-id', conversationData.id);

                var avatarPath = getPersonaImagePath(personaName);
                var displayTime = formatInboxTime(conversationData.timestamp);

                item.innerHTML = '<div class="inbox-message-avatar">' +
                    '<img src="' + avatarPath + '" alt="' + personaName + '">' +
                    '</div>' +
                    '<div class="inbox-message-content">' +
                    '<div class="inbox-message-header">' +
                    '<span class="inbox-message-name">' + personaName + '</span>' +
                    '<span class="inbox-message-time">' + displayTime + '</span>' +
                    '</div>' +
                    '<div class="inbox-message-preview">' + (conversationData.lastMessage || conversationData.title || '') + '</div>' +
                    '</div>';

                // Add click handler
                item.addEventListener('click', function() {
                    loadConversationById(conversationData.id);
                });

                // Add to top of inbox
                if (inboxContent.firstChild) {
                    inboxContent.insertBefore(item, inboxContent.firstChild);
                } else {
                    inboxContent.appendChild(item);
                }
            }
        }

        // Format timestamp for inbox display
        function formatInboxTime(timestamp) {
            if (!timestamp) return '';
            var date = new Date(timestamp);
            var now = new Date();
            var diffMs = now - date;
            var diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + 'm ago';

            var diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return diffHours + 'h ago';

            var diffDays = Math.floor(diffHours / 24);
            if (diffDays < 7) return diffDays + 'd ago';

            return date.toLocaleDateString();
        }

        // Load a conversation by ID
        function loadConversationById(conversationId) {
            selectConversation(conversationId);
        }

        function selectConversation(conversationId) {
            if (!conversationId) return;

            // Save current conversation ID to cookie for session persistence
            if (typeof setCookie === 'function') {
                setCookie('jv_current_conversation', conversationId, 30);
            }

            loadConversation(conversationId);
        }

        function getQueryParam(name) {
            var search = window.location.search || '';
            if (!search) return null;
            try {
                var params = new URLSearchParams(search);
                var value = params.get(name);
                return value ? value.trim() : null;
            } catch (error) {
                var raw = search.replace('?', '');
                var pairs = raw.split('&');
                for (var i = 0; i < pairs.length; i++) {
                    var parts = pairs[i].split('=');
                    if (decodeURIComponent(parts[0] || '') === name) {
                        return decodeURIComponent(parts[1] || '').trim();
                    }
                }
            }
            return null;
        }

        var inboundQuery = getQueryParam('q');
        var inboundPersona = getQueryParam('persona') || getCookie('jv_default_persona');
        var inboundModel = getQueryParam('model');
        var inboundPrivate = getQueryParam('private');
        var inboundAttach = getQueryParam('attach');
        var pendingInitialPersona = inboundPersona ? inboundPersona.trim().toLowerCase() : null;
        var forceNewConversation = !!inboundQuery;

        // Apply inbound model if provided via URL
        if (inboundModel) {
            // Model ID to name mapping
            var modelNames = {
                'kingdombuilder': 'Inspire 8.0: Kingdom Builder',
                'creativefire': 'Inspire 8.0: Creative Fire',
                'gospelpulse': 'Inspire 8.0: Gospel Pulse',
                'shepherdvoice': 'Inspire 8.0: Shepherd Voice',
                'hebraicroots': 'Inspire 8.0: Hebraic Roots'
            };
            setCookie('selectedInspireModel', inboundModel, 30);
            if (modelNames[inboundModel]) {
                setCookie('selectedInspireModelName', modelNames[inboundModel], 30);
            }
        }

        // Handle privacy mode from search page or existing sessionStorage
        function initPrivacyModeFromSearch() {
            var lockIcon = document.getElementById('chatboxLockBtn');
            if (!lockIcon) return;

            // Check if privacy mode was enabled on search page OR if PIN exists in sessionStorage
            var existingPin = null;
            try {
                existingPin = sessionStorage.getItem('privateChatPin');
            } catch (e) {}

            if (inboundPrivate === '1' || existingPin) {
                // Enable privacy mode visually
                lockIcon.classList.add('unlocked');
            }
        }
        initPrivacyModeFromSearch();

        // Handle attach flag from search page - trigger file input after page loads
        if (inboundAttach === '1') {
            setTimeout(function() {
                var fileInput = document.getElementById('fileAttachmentInput');
                if (fileInput) {
                    fileInput.click();
                }
            }, 500);
        }

        // Handle initial query if provided
        var defaultInitialQuery = 'How are you doing today?';
        var initialQuery = inboundQuery || defaultInitialQuery;
        var pendingInitialQuery = initialQuery && initialQuery.trim() !== '' ? initialQuery.trim() : '';

        function getInitialQueryStorageKey(query) {
            return 'initialQuerySent:' + window.location.pathname + ':' + query.toLowerCase();
        }

        async function sendInitialQueryIfNeeded() {
            if (!pendingInitialQuery) return;

            // Check if this is a fresh search query (has timestamp) or a page refresh
            var inboundTimestamp = getQueryParam('t');
            var storageKey = getInitialQueryStorageKey(pendingInitialQuery);

            // If there's a timestamp, use timestamp-based deduplication instead of query-based
            // This allows the same query to be sent multiple times from search page
            if (inboundTimestamp) {
                var timestampKey = 'initialQuerySent:timestamp:' + inboundTimestamp;
                try {
                    if (sessionStorage.getItem(timestampKey)) {
                        // Already sent this exact search submission, skip (page refresh case)
                        return;
                    }
                } catch (error) {
                    console.warn('Unable to read initial query storage:', error);
                }
            } else {
                // No timestamp - fallback to old behavior for backwards compatibility
                try {
                    if (sessionStorage.getItem(storageKey)) {
                        return;
                    }
                } catch (error) {
                    console.warn('Unable to read initial query storage:', error);
                }
            }

            // Always create a new conversation when coming from search (forceNewConversation is true when inboundQuery exists)
            if (forceNewConversation) {
                if (chatState.currentMailbox !== 'chat_inbox') {
                    selectMailbox('chat_inbox', { skipAutoSelect: true });
                }
                createNewConversation();
            } else if (conversationHistory.length > 0) {
                return;
            }

            // Ensure persona directory is loaded before setting persona selection
            // This fixes a race condition where the persona slug can't be resolved to an ID
            if (!personaDirectory.bySlug || Object.keys(personaDirectory.bySlug).length === 0) {
                await loadPersonaDirectory();
            }

            if (pendingInitialPersona) {
                setPersonaSelection([pendingInitialPersona]);
            }

            chatInput.value = pendingInitialQuery;
            updateInputBorderState();
            await new Promise(function(resolve) { setTimeout(resolve, 50); }); // Reduced delay for faster response
            await sendMessage();

            // Store the appropriate key to prevent re-sending on page refresh
            try {
                if (inboundTimestamp) {
                    sessionStorage.setItem('initialQuerySent:timestamp:' + inboundTimestamp, '1');
                } else {
                    sessionStorage.setItem(storageKey, '1');
                }
            } catch (error) {
                console.warn('Unable to store initial query state:', error);
            }

            forceNewConversation = false;
        }

        // Update all persona avatars based on their names
        function updatePersonaAvatars() {
            // Update conversation list avatars
            document.querySelectorAll('.conversation-item').forEach(function(item) {
                var nameEl = item.querySelector('.conversation-name');
                var avatarEl = item.querySelector('.conversation-avatar');
                if (nameEl && avatarEl) {
                    avatarEl.src = getPersonaImagePath(nameEl.textContent);
                    avatarEl.alt = nameEl.textContent;
                }
            });

            // Update chatbox tab avatars
            document.querySelectorAll('.chatbox-tab').forEach(function(tab) {
                var nameEl = tab.querySelector('span');
                var avatarEl = tab.querySelector('img');
                if (nameEl && avatarEl) {
                    avatarEl.src = getPersonaImagePath(nameEl.textContent);
                    avatarEl.alt = nameEl.textContent;
                }
            });

            // Update typing indicator avatar
            var typingAvatar = document.querySelector('#typingIndicator .message-avatar');
            if (typingAvatar) {
                var personaName = '';
                if (chatState.currentMailbox !== 'chat_inbox') {
                    personaName = getBoardPersonaName(chatState.currentMailbox);
                } else {
                    var firstTab = document.querySelector('.chatbox-tab span');
                    if (firstTab) {
                        personaName = firstTab.textContent;
                    }
                }
                if (personaName) {
                    typingAvatar.src = getPersonaImagePath(personaName);
                    typingAvatar.alt = personaName;
                }
            }
        }

        var communitySelector = document.getElementById('communitySelector');
        var communityMenu = document.getElementById('communityMenu');
        var communityNameLabel = document.getElementById('communityName');
        var usersList = document.getElementById('usersList');

        function renderCommunityUsers(users) {
            if (!usersList) return;
            usersList.innerHTML = '';

            if (!users || users.length === 0) {
                var emptyItem = document.createElement('div');
                emptyItem.className = 'persona-item';
                emptyItem.setAttribute('data-bound', 'true');
                emptyItem.innerHTML = '<div class="persona-item-initials">--</div><span class="persona-item-name">No community users found.</span>';
                usersList.appendChild(emptyItem);
                return;
            }

            users.forEach(function(user) {
                var item = document.createElement('div');
                item.className = 'persona-item';
                item.setAttribute('data-user', user.id);
                item.setAttribute('data-name', user.name);
                item.setAttribute('data-role', 'Community Member');

                var avatarUrl = user.avatarUrl || user.imageUrl;
                if (avatarUrl) {
                    var avatar = document.createElement('img');
                    avatar.className = 'persona-item-avatar';
                    avatar.src = avatarUrl;
                    avatar.alt = user.name;
                    item.appendChild(avatar);
                } else {
                    var initials = document.createElement('div');
                    initials.className = 'persona-item-initials';
                    initials.textContent = getInitials(user.name);
                    item.appendChild(initials);
                }

                var nameSpan = document.createElement('span');
                nameSpan.className = 'persona-item-name';
                nameSpan.textContent = user.name;
                item.appendChild(nameSpan);

                usersList.appendChild(item);
            });
        }

        async function loadCommunityUsers() {
            if (!usersList || !chatState.currentCommunityId) return;
            try {
                var response = await fetch('/api/communities/' + chatState.currentCommunityId + '/members');
                var result = await response.json();
                if (result.success && Array.isArray(result.members)) {
                    renderCommunityUsers(result.members);
                } else {
                    renderCommunityUsers([]);
                }
            } catch (error) {
                console.error('Error loading community users:', error);
                renderCommunityUsers([]);
            }
        }

        async function loadPersonaDirectory() {
            try {
                var response = await fetch('/api/personas');
                var result = await response.json();
                if (result.success && Array.isArray(result.personas)) {
                    personaDirectory.bySlug = {};
                    personaDirectory.byId = {};
                    result.personas.forEach(function(persona) {
                        if (persona.slug) {
                            personaDirectory.bySlug[persona.slug] = persona;
                        }
                        if (persona.id) {
                            personaDirectory.byId[persona.id] = persona;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading personas:', error);
            }
        }

        function getSelectedPersonaIds() {
            var ids = [];
            var slugs = getSelectedPersonaSlugs({ allowEmpty: true });
            slugs.forEach(function(slug) {
                var persona = personaDirectory.bySlug[slug];
                if (persona && persona.id) {
                    ids.push(persona.id);
                }
            });
            return Array.from(new Set(ids));
        }

        function getSelectedPersonaNames() {
            var names = [];
            var slugs = getSelectedPersonaSlugs({ allowEmpty: true });
            slugs.forEach(function(slug) {
                var name = getPersonaNameForSlug(slug);
                if (name) {
                    names.push(name);
                }
            });
            return names;
        }

        function renderCommunityMenu(communities) {
            if (!communityMenu) return;
            communityMenu.innerHTML = '';

            if (!communities || communities.length === 0) {
                var emptyItem = document.createElement('div');
                emptyItem.className = 'community-menu-item';
                emptyItem.textContent = 'No communities';
                communityMenu.appendChild(emptyItem);
                return;
            }

            communities.forEach(function(community) {
                var item = document.createElement('div');
                item.className = 'community-menu-item' + (community.id === chatState.currentCommunityId ? ' active' : '');
                item.textContent = community.name;
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    setCurrentCommunity(community);
                    toggleCommunityMenu(false);
                });
                communityMenu.appendChild(item);
            });
        }

        function setCurrentCommunity(community, options) {
            if (!community) return;
            var silent = options && options.silent;

            chatState.currentCommunityId = community.id;
            chatState.currentCommunityName = community.name;

            if (communityNameLabel) {
                communityNameLabel.textContent = community.name;
            }

            updateCommunityContextPanel();
            updateTitleBar();

            renderCommunityMenu(availableCommunities);
            loadCommunityUsers();

            if (!silent && chatState.currentMailbox !== 'chat_inbox') {
                resetConversationView();
                loadMailboxConversations(chatState.currentMailbox, chatState.focusedFilter).then(function(conversations) {
                    if (conversations && conversations.length > 0) {
                        selectConversation(conversations[0].id);
                    }
                });
            } else {
                updateInboxHeader();
            }
        }

        function toggleCommunityMenu(forceState) {
            if (!communityMenu || !communitySelector) return;
            var isOpen = communityMenu.classList.contains('open');
            var nextState = typeof forceState === 'boolean' ? forceState : !isOpen;
            communityMenu.classList.toggle('open', nextState);
            communitySelector.setAttribute('aria-expanded', nextState ? 'true' : 'false');
        }

        async function loadCommunities() {
            try {
                var response = await fetch('/api/communities');
                var result = await response.json();
                if (result.success && Array.isArray(result.communities)) {
                    availableCommunities = result.communities;
                    var defaultCommunity = result.communities.find(function(c) { return c.slug === 'jubilee-community'; }) || result.communities[0];
                    renderCommunityMenu(result.communities);
                    if (defaultCommunity) {
                        setCurrentCommunity(defaultCommunity, { silent: chatState.currentMailbox === 'chat_inbox' });
                    }
                } else {
                    availableCommunities = [];
                    renderCommunityMenu([]);
                }
            } catch (error) {
                console.error('Error loading communities:', error);
                availableCommunities = [];
                renderCommunityMenu([]);
            }
        }

        // Run on page load
        updatePersonaAvatars();
        loadPersonaDirectory();

        // Note: initConversations is called later after selectMailbox is defined
        // to properly restore saved mailbox from cookie

        loadCommunities();

        if (communitySelector) {
            communitySelector.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleCommunityMenu();
            });
        }

        document.addEventListener('click', function(e) {
            if (!communityMenu || !communityMenu.classList.contains('open')) return;
            if (communitySelector && communitySelector.contains(e.target)) return;
            toggleCommunityMenu(false);
        });

        // ==================== MAILBOX NAVIGATION ====================
        var mailboxItems = document.querySelectorAll('.mailbox-item[data-mailbox]');
        var inboxHeaderTitle = document.getElementById('inboxHeaderTitle');
        var conversationTabs = document.querySelectorAll('.conversation-tab');

        // Mailbox display names
        var mailboxNames = {
            'chat_inbox': 'Chat Inbox',
            'my_community': 'My Community',
            'kingdom_builder': 'Kingdom Builder',
            'creative_fire': 'Creative Fire',
            'gospel_pulse': 'Gospel Pulse',
            'shepherd_voice': 'Shepherd Voice',
            'hebraic_roots': 'Hebraic Roots'
        };

        var mailboxPersonaMap = {
            'kingdom_builder': { slug: 'elias', name: 'Elias Inspire' },
            'creative_fire': { slug: 'santiago', name: 'Santiago Inspire' },
            'gospel_pulse': { slug: 'melody', name: 'Melody Inspire' },
            'shepherd_voice': { slug: 'caleb', name: 'Caleb Inspire' },
            'hebraic_roots': { slug: 'zev', name: 'Zev Inspire' }
        };

        function getBoardPersonaForMailbox(mailboxType) {
            return mailboxPersonaMap[mailboxType] || null;
        }

        function getBoardPersonaName(mailboxType) {
            var persona = getBoardPersonaForMailbox(mailboxType);
            return persona ? persona.name : (mailboxNames[mailboxType] || 'Discussion');
        }

        function applyMailboxPersonaSelection(mailboxType) {
            if (mailboxType === 'chat_inbox') {
                // For Chat Inbox new conversations, prioritize:
                // 1. User's server-side default persona (PostgreSQL) - authoritative
                // 2. Any previously selected personas for this session (chatInboxSelection)
                // 3. localStorage fallback for non-authenticated users
                // 4. System default (defaultPersonaSlug which is set from server or 'jubilee')

                var personaToUse;

                // If we have a server-side default persona, always use it for new conversations
                if (window.userDefaultPersonaSlug && inspirePersonas.indexOf(window.userDefaultPersonaSlug) !== -1) {
                    personaToUse = [window.userDefaultPersonaSlug];
                    console.log('Using server default persona for new conversation:', window.userDefaultPersonaSlug);
                } else if (chatState.chatInboxSelection && chatState.chatInboxSelection.length) {
                    // Use session selection if available
                    personaToUse = chatState.chatInboxSelection;
                } else {
                    // Fallback to stored selection or default
                    var stored = getStoredPersonaSelection();
                    personaToUse = stored && stored.length ? stored : [defaultPersonaSlug];
                }

                setPersonaSelection(personaToUse);
                syncPersonaPanelForMailbox(mailboxType);
                return;
            }

            var boardPersona = getBoardPersonaForMailbox(mailboxType);
            if (boardPersona) {
                setPersonaSelection([boardPersona.slug], { persist: false });
            }
            syncPersonaPanelForMailbox(mailboxType);
        }

        function syncPersonaPanelForMailbox(mailboxType) {
            var panel = document.getElementById('personaPanel');
            if (!panel) return;

            var boardPersona = getBoardPersonaForMailbox(mailboxType);
            var isBoard = mailboxType !== 'chat_inbox';
            panel.classList.toggle('is-readonly', isBoard);

            var items = panel.querySelectorAll('.persona-rail-item[data-persona]');
            items.forEach(function(item) {
                var slug = item.getAttribute('data-persona');
                if (isBoard) {
                    var isSelected = boardPersona && slug === boardPersona.slug;
                    item.classList.toggle('selected', isSelected);
                    item.classList.toggle('is-hidden', !isSelected);
                } else {
                    item.classList.remove('is-hidden');
                }
            });
        }

        var mailboxBoardSlug = {
            'kingdom_builder': 'kingdom-builder',
            'creative_fire': 'creative-fire',
            'gospel_pulse': 'gospel-pulse',
            'shepherd_voice': 'shepherds-voice',
            'hebraic_roots': 'hebraic-roots'
        };
        // Expose globally for WebSocket handlers
        window.mailboxBoardSlug = mailboxBoardSlug;

        // Handle mailbox item clicks
        mailboxItems.forEach(function(item) {
            item.addEventListener('click', function() {
                var mailboxType = this.getAttribute('data-mailbox');
                selectMailbox(mailboxType);
            });
        });

        // Handle Focused/Other tab clicks
        conversationTabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                if (this.classList.contains('is-muted') && this.textContent !== '|') {
                    // Toggle focused filter
                    conversationTabs.forEach(function(t) {
                        if (t.textContent !== '|') {
                            t.classList.toggle('is-muted');
                        }
                    });
                    var isFocused = !document.querySelector('.conversation-tab:first-child').classList.contains('is-muted');
                    chatState.focusedFilter = isFocused ? true : false;
                    loadMailboxConversations(chatState.currentMailbox, chatState.focusedFilter);
                }
            });
        });

        // Select a mailbox and load its conversations
        function selectMailbox(mailboxType, options) {
            var previousMailbox = chatState.currentMailbox;
            var skipAutoSelect = options && options.skipAutoSelect;
            // Update active state
            mailboxItems.forEach(function(item) {
                item.classList.remove('active');
                if (item.getAttribute('data-mailbox') === mailboxType) {
                    item.classList.add('active');
                }
            });

            // Update state
            if (previousMailbox === 'chat_inbox' && mailboxType !== 'chat_inbox') {
                chatState.chatInboxSelection = getSelectedPersonaSlugs({ allowEmpty: true });
            }

            chatState.currentMailbox = mailboxType;
            chatState.focusedFilter = null;

            // Save current mailbox to cookie for session persistence
            if (typeof setCookie === 'function') {
                setCookie('jv_current_mailbox', mailboxType, 30);
            }

            // Reset tab state
            conversationTabs.forEach(function(tab, index) {
                if (tab.textContent === '|') return;
                if (mailboxType === 'chat_inbox') {
                    tab.classList.toggle('is-muted', index > 0);
                } else {
                    tab.classList.add('is-muted');
                }
            });

            resetConversationView();
            updateInboxHeader();
            applyMailboxPersonaSelection(mailboxType);
            updateCommunityContextPanel();
            updateTitleBar();

            // Load conversations for this mailbox
            loadMailboxConversations(mailboxType, null).then(function(conversations) {
                if (skipAutoSelect) return;
                if (conversations && conversations.length > 0) {
                    selectConversation(conversations[0].id);
                }
            });
        }

        // Restore saved mailbox from cookie and initialize conversations
        // This runs after selectMailbox is defined
        (function restoreMailboxAndInit() {
            // Simple inline cookie reader
            function readCookie(name) {
                var nameEQ = name + '=';
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }

            var savedMailbox = readCookie('jv_current_mailbox');
            var validMailboxes = ['chat_inbox', 'my_community', 'kingdom_builder', 'creative_fire', 'gospel_pulse', 'shepherd_voice', 'hebraic_roots'];

            // If saved mailbox is valid and different from default, switch to it first
            if (savedMailbox && validMailboxes.indexOf(savedMailbox) !== -1 && savedMailbox !== 'chat_inbox') {
                selectMailbox(savedMailbox, { skipAutoSelect: true });
            }

            // Now initialize conversations (which will restore conversation within the mailbox)
            initConversations().then(function() {
                sendInitialQueryIfNeeded();
            });
        })();

        // Load conversations from the API by mailbox type
        async function loadMailboxConversations(mailboxType, focused) {
            var conversationItemsContainer = document.getElementById('conversationItems');
            if (!conversationItemsContainer) return;

            // Show loading state
            conversationItemsContainer.innerHTML = '<div class="loading-state" style="padding: 20px; text-align: center; color: #888;">Loading conversations...</div>';

            try {
                var url = '';
                var languageCode = getSelectedLanguageCode();
                if (mailboxType === 'chat_inbox') {
                    url = '/chat/mailbox/' + mailboxType;
                    var params = [];
                    if (focused !== null) {
                        params.push('focused=' + focused);
                    }
                    if (languageCode) {
                        params.push('language=' + encodeURIComponent(languageCode));
                    }
                    if (params.length > 0) {
                        url += '?' + params.join('&');
                    }
                } else if (mailboxType === 'my_community') {
                    // Community inbox - requires community to be selected
                    if (!chatState.currentCommunityId) {
                        conversationItemsContainer.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: #888;">Select a community to view community messages</div>';
                        return [];
                    }
                    url = '/api/communities/' + chatState.currentCommunityId + '/inbox';
                } else {
                    var boardSlug = mailboxBoardSlug[mailboxType];
                    if (!boardSlug) {
                        throw new Error('Unknown board mailbox');
                    }
                    url = '/boards/' + boardSlug + '/conversations';
                    if (chatState.currentCommunityId) {
                        url += '?communityId=' + chatState.currentCommunityId;
                    }
                }

                var response = await fetch(url);
                var result = await response.json();

                if (result.success && result.conversations) {
                    allConversations = result.conversations;
                    renderConversationList(result.conversations);
                    return result.conversations;
                } else {
                    conversationItemsContainer.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: #888;">No conversations in this mailbox</div>';
                }
            } catch (error) {
                console.error('Failed to load mailbox conversations:', error);
                conversationItemsContainer.innerHTML = '<div class="error-state" style="padding: 20px; text-align: center; color: #ff6b6b;">Failed to load conversations</div>';
            }

            return [];
        }
        // Expose globally for WebSocket handlers
        window.loadMailboxConversations = loadMailboxConversations;

        function formatPersonaLabel(participants, fallbackPersona) {
            if (participants && participants.length > 0) {
                var names = participants.map(function(p) { return p.name; }).filter(Boolean);
                if (names.length === 1) return names[0];
                if (names.length === 2) return names.join(', ');
                if (names.length > 2) return names[0] + ' +' + (names.length - 1);
            }
            if (fallbackPersona && fallbackPersona.name) {
                return fallbackPersona.name;
            }
            return 'Bible Persona';
        }

        function getPersonaAvatar(participants, fallbackPersona) {
            if (participants && participants.length > 0 && participants[0].avatar) {
                return participants[0].avatar;
            }
            if (fallbackPersona && fallbackPersona.avatar) {
                return fallbackPersona.avatar;
            }
            return '/images/personas/jubilee.png';
        }

        // Render conversation list from array
        function renderConversationList(conversations) {
            var conversationItemsContainer = document.getElementById('conversationItems');
            if (!conversationItemsContainer) return;

            var list = conversations || allConversations || [];
            if (!list || list.length === 0) {
                conversationItemsContainer.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: #888;">No conversations in this mailbox</div>';
                return;
            }

            conversationItemsContainer.innerHTML = '';

            list.forEach(function(conv) {
                var div = document.createElement('div');
                div.className = 'conversation-item' + (conv.id === chatState.conversationId ? ' active' : '');
                div.setAttribute('data-id', conv.id);

                if (chatState.currentMailbox === 'chat_inbox') {
                    var personaLabel = formatPersonaLabel(conv.participants || [], conv.persona);
                    var personaAvatar = getPersonaAvatar(conv.participants || [], conv.persona);
                    var lastMessage = '';
                    if (conv.lastMessage) {
                        lastMessage = typeof conv.lastMessage === 'string' ? conv.lastMessage : conv.lastMessage.content;
                    }
                    var timeAgo = conv.lastMessageAt ? formatTimeAgo(new Date(conv.lastMessageAt)) : '';
                    var subject = conv.title || 'New Conversation';
                    var preview = lastMessage || conv.preview || 'New conversation...';

                    div.innerHTML =
                        '<img src="' + personaAvatar + '" class="conversation-avatar" alt="' + personaLabel + '" onerror="this.src=\'/images/personas/jubilee.png\'">' +
                        '<div class="conversation-content">' +
                            '<div class="conversation-header">' +
                                '<span class="conversation-name">' + escapeHtml(personaLabel) + '</span>' +
                                '<button class="conversation-delete" title="Delete conversation">' +
                                    '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                                '</button>' +
                                '<span class="conversation-time">' + timeAgo + '</span>' +
                            '</div>' +
                            '<div class="conversation-subject">' + escapeHtml(subject) + '</div>' +
                        '</div>';

                    attachSubjectEditHandler(div.querySelector('.conversation-subject'), conv.id);
                } else {
                    // For board mailboxes (not chat_inbox), show community name as the "To" recipient
                    var communityName = chatState.currentCommunityName || 'Jubilee Community';
                    var boardPersonaName = conv.personaName || (conv.persona ? conv.persona.name : null) || getBoardPersonaName(chatState.currentMailbox);
                    var boardAvatar = getPersonaImagePath(boardPersonaName);
                    var lastActivity = conv.lastReplyAt || conv.updatedAt || conv.createdAt;
                    var timeAgo = lastActivity ? formatTimeAgo(new Date(lastActivity)) : '';
                    var subject = conv.title || 'New Discussion';

                    // Show community as recipient, only subject line (no preview line for board messages)
                    div.innerHTML =
                        '<img src="' + boardAvatar + '" class="conversation-avatar" alt="' + boardPersonaName + '" onerror="this.src=\'/images/personas/jubilee.png\'">' +
                        '<div class="conversation-content">' +
                            '<div class="conversation-header">' +
                                '<span class="conversation-name">' + escapeHtml(communityName) + '</span>' +
                                '<button class="conversation-delete" title="Delete conversation">' +
                                    '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.89 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                                '</button>' +
                                '<span class="conversation-time">' + timeAgo + '</span>' +
                            '</div>' +
                            '<div class="conversation-subject">' + escapeHtml(subject) + '</div>' +
                        '</div>';
                }

                div.addEventListener('click', function(e) {
                    if (e.target.closest('.conversation-delete')) {
                        e.stopPropagation();
                        if (chatState.currentMailbox === 'chat_inbox') {
                            deleteConversation(conv.id);
                        } else {
                            deleteBoardConversation(conv.id);
                        }
                    } else {
                        selectConversation(conv.id);
                    }
                });

                conversationItemsContainer.appendChild(div);
            });
        }

        // Helper function to truncate text
        function truncate(str, maxLen) {
            if (!str) return '';
            return str.length > maxLen ? str.substring(0, maxLen) + '...' : str;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to format time ago
        function formatTimeAgo(date) {
            if (!date) return '';
            var now = new Date();
            var diffMs = now - date;
            var diffMins = Math.floor(diffMs / 60000);
            var diffHours = Math.floor(diffMs / 3600000);
            var diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffHours < 24) return diffHours + 'h ago';
            if (diffDays < 7) return diffDays + 'd ago';
            return date.toLocaleDateString();
        }

        // Wire up the "+" button to create new conversations
        var addButton = document.querySelector('.chatbox-add');
        if (addButton) {
            addButton.addEventListener('click', function(e) {
                e.preventDefault();
                createNewConversation();
            });
        }

        updateInputBorderState();

        // ==================== PERSONA SELECTION PANEL ====================
        var personaSelectionPanel = document.getElementById('personaSelectionPanel');
        var expandPersonaBtn = document.getElementById('expandPersonaBtn');
        var closePersonaPanel = document.getElementById('closePersonaPanel');
        var addPersonaBtn = document.getElementById('addPersonaBtn');
        var chatboxTabs = document.getElementById('chatboxTabs');

        // Use the outer wrapper for focus/border state management
        var inputAreaWrapper = document.getElementById('inputAreaWrapper');
        var chatboxTop = document.querySelector('.chatbox-top');
        var inputAreaHover = false;
        var panelHover = false;

        function updateInputBorderState() {
            if (!inputAreaWrapper) return;
            var activeElement = document.activeElement;
            // Check if focus is anywhere inside the wrapper or the expanded panel
            var isFocused = inputAreaWrapper.contains(activeElement) ||
                (personaSelectionPanel && personaSelectionPanel.contains(activeElement));
            var shouldShow = isFocused || inputAreaHover || panelHover;
            // The outer wrapper handles the visual "border" via background color
            inputAreaWrapper.classList.toggle('is-active', shouldShow);
        }

        function setPersonaPanelExpanded(isExpanded) {
            if (!personaSelectionPanel) return;
            personaSelectionPanel.classList.toggle('expanded', isExpanded);
            if (inputAreaWrapper) {
                inputAreaWrapper.classList.toggle('panel-expanded', isExpanded);
            }
            if (expandPersonaBtn) {
                expandPersonaBtn.classList.toggle('is-expanded', isExpanded);
                expandPersonaBtn.setAttribute('aria-label', isExpanded ? 'Collapse' : 'Expand');
                expandPersonaBtn.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
            }
            updateInputBorderState();
        }

        function togglePersonaPanel() {
            setPersonaPanelExpanded(!personaSelectionPanel.classList.contains('expanded'));
        }

        function closePersonaPanelFunc() {
            setPersonaPanelExpanded(false);
        }

        if (expandPersonaBtn) {
            expandPersonaBtn.addEventListener('click', function() {
                togglePersonaPanel();
            });
        }

        if (closePersonaPanel) {
            closePersonaPanel.addEventListener('click', function() {
                closePersonaPanelFunc();
            });
        }

        if (addPersonaBtn) {
            addPersonaBtn.addEventListener('click', function() {
                togglePersonaPanel();
            });
        }

        setPersonaPanelExpanded(personaSelectionPanel && personaSelectionPanel.classList.contains('expanded'));

        // Attach hover and focus events to the outer wrapper
        if (inputAreaWrapper) {
            inputAreaWrapper.addEventListener('mouseenter', function() {
                inputAreaHover = true;
                updateInputBorderState();
            });
            inputAreaWrapper.addEventListener('mouseleave', function() {
                inputAreaHover = false;
                updateInputBorderState();
            });
            inputAreaWrapper.addEventListener('focusin', updateInputBorderState);
            inputAreaWrapper.addEventListener('focusout', function() {
                setTimeout(updateInputBorderState, 0);
            });
        }

        if (personaSelectionPanel) {
            personaSelectionPanel.addEventListener('mouseenter', function() {
                panelHover = true;
                updateInputBorderState();
            });
            personaSelectionPanel.addEventListener('mouseleave', function() {
                panelHover = false;
                updateInputBorderState();
            });
        }

        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            if (personaSelectionPanel && personaSelectionPanel.classList.contains('expanded')) {
                var isClickInsidePanel = personaSelectionPanel.contains(e.target);
                var isClickOnExpandBtn = expandPersonaBtn && expandPersonaBtn.contains(e.target);
                var isClickOnAddBtn = addPersonaBtn && addPersonaBtn.contains(e.target);
                var isClickOnInputWrapper = inputAreaWrapper && inputAreaWrapper.contains(e.target);

                if (!isClickInsidePanel && !isClickOnExpandBtn && !isClickOnAddBtn && !isClickOnInputWrapper) {
                    setPersonaPanelExpanded(false);
                }
            }
        });

        // Community context display elements
        var communityContextMailbox = document.getElementById('communityContextMailbox');
        var communityContextName = document.getElementById('communityContextName');
        var communityContextVisibility = document.getElementById('communityContextVisibility');

        function updateCommunityContextPanel() {
            var mailboxLabel = (typeof mailboxNames !== 'undefined' && mailboxNames[chatState.currentMailbox])
                ? mailboxNames[chatState.currentMailbox]
                : 'Chat Inbox';

            if (communityContextMailbox) {
                communityContextMailbox.textContent = mailboxLabel;
            }

            if (communityContextName) {
                communityContextName.textContent = chatState.currentCommunityName || 'Jubilee Community';
            }

            if (communityContextVisibility) {
                communityContextVisibility.textContent = chatState.currentMailbox === 'chat_inbox' ? 'Private' : 'Shared';
            }
        }

        // Helper function to get persona image path by name
        function getPersonaImagePathByName(personaName) {
            if (!personaName) return '/images/personas/jubilee.png';
            var nameLower = personaName.toLowerCase();
            var personas = ['jubilee', 'melody', 'zariah', 'elias', 'eliana', 'caleb', 'imani', 'zev', 'amir', 'nova', 'santiago', 'tahoma'];
            for (var i = 0; i < personas.length; i++) {
                if (nameLower.indexOf(personas[i]) !== -1) {
                    return '/images/personas/' + personas[i] + '.png';
                }
            }
            return '/images/personas/jubilee.png';
        }

        // Handle persona item selection
        function bindPersonaItem(item) {
            if (!item || item.getAttribute('data-bound') === 'true') {
                return;
            }
            item.setAttribute('data-bound', 'true');
            item.addEventListener('click', function() {
                var personaId = this.getAttribute('data-persona');
                if (!personaId) {
                    return;
                }
                togglePersonaSelection(personaId);
            });
        }

        function bindPersonaItems() {
            document.querySelectorAll('.persona-item').forEach(function(item) {
                bindPersonaItem(item);
            });
        }

        function applyMelodyNameVisibility(tab, personaName) {
            if (!tab) return;
            var isMelody = (personaName || '').toLowerCase().indexOf('melody') !== -1;
            tab.classList.toggle('is-name-hidden', isMelody);
        }

        function applyChatboxTabNameRules() {
            var tabsRoot = chatboxTabs || document.getElementById('chatboxTabs');
            if (!tabsRoot) return;
            tabsRoot.querySelectorAll('.chatbox-tab').forEach(function(tab) {
                var nameSpan = tab.querySelector('span');
                applyMelodyNameVisibility(tab, nameSpan ? nameSpan.textContent : '');
            });
        }

        bindPersonaItems();
        applyChatboxTabNameRules();
        applyMailboxPersonaSelection(chatState.currentMailbox);
        updateCommunityContextPanel();

        function addPersonaTab(personaId, personaName, itemElement) {
            if (!personaId) return;
            var current = getSelectedPersonaSlugs({ allowEmpty: true });
            if (current.indexOf(personaId) === -1) {
                current.push(personaId);
                setPersonaSelection(current);
            }
        }

        function removePersonaTab(personaId) {
            removePersonaSelection(personaId);
        }

        if (chatboxTabs) {
            chatboxTabs.addEventListener('click', function(e) {
                var closeBtn = e.target.closest('.chatbox-close');
                if (!closeBtn) return;
                e.stopPropagation();
                var tab = closeBtn.closest('.chatbox-tab');
                if (!tab) return;
                var personaId = tab.getAttribute('data-persona') || tab.getAttribute('data-user');
                removePersonaSelection(personaId);
            });
        }

        // ==================== INSPIRE DROPDOWN MENU ====================
        var inspireDropdown = document.getElementById('inspireDropdown');
        var inspireMenu = document.getElementById('inspireMenu');

        if (inspireDropdown && inspireMenu) {
            inspireDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                inspireMenu.classList.toggle('open');
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!inspireMenu.contains(e.target) && !inspireDropdown.contains(e.target)) {
                    inspireMenu.classList.remove('open');
                }
            });

            // Handle inspire menu item selection
            var inspireMenuItems = document.querySelectorAll('.inspire-menu-item');
            var submenuItems = document.querySelectorAll('.inspire-submenu-item');

            function selectInspireModel(modelId, modelName, isSubmenuItem) {
                // Remove selected class from all main menu items
                inspireMenuItems.forEach(function(i) {
                    i.classList.remove('selected');
                    i.querySelector('.inspire-menu-check').innerHTML = '';
                });

                // Remove selected class from all submenu items
                submenuItems.forEach(function(i) {
                    i.classList.remove('selected');
                });

                // Find and select the matching menu item if it exists in main menu
                var matchingItem = document.querySelector('.inspire-menu-item[data-model="' + modelId + '"]');
                if (matchingItem) {
                    matchingItem.classList.add('selected');
                    matchingItem.querySelector('.inspire-menu-check').innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                }

                // Find and select the matching submenu item if it exists
                var matchingSubmenuItem = document.querySelector('.inspire-submenu-item[data-model="' + modelId + '"]');
                if (matchingSubmenuItem) {
                    matchingSubmenuItem.classList.add('selected');
                }

                // Update dropdown text
                inspireDropdown.querySelector('span').textContent = modelName;

                // Save to cookie (30 days)
                setCookie('selectedInspireModel', modelId, 30);
                setCookie('selectedInspireModelName', modelName, 30);

                // Close menu
                inspireMenu.classList.remove('open');
            }

            inspireMenuItems.forEach(function(item) {
                item.addEventListener('click', function() {
                    var modelId = this.getAttribute('data-model');
                    var modelName = this.querySelector('.inspire-menu-title').textContent.replace('Inspire 8.0: ', 'Inspire 8.0: ');
                    selectInspireModel(modelId, modelName, false);
                });
            });

            // Handle submenu item selection (More Models)
            submenuItems.forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var modelId = this.getAttribute('data-model');
                    var modelName = this.querySelector('.inspire-submenu-title').textContent;
                    selectInspireModel(modelId, modelName, true);
                });
            });

            // Load saved model from cookie on page load
            var savedModelId = getCookie('selectedInspireModel');
            var savedModelName = getCookie('selectedInspireModelName');
            if (savedModelId && savedModelName) {
                // Clear default selection first
                inspireMenuItems.forEach(function(i) {
                    i.classList.remove('selected');
                    i.querySelector('.inspire-menu-check').innerHTML = '';
                });

                // Find and select the saved model in main menu
                var savedItem = document.querySelector('.inspire-menu-item[data-model="' + savedModelId + '"]');
                if (savedItem) {
                    savedItem.classList.add('selected');
                    savedItem.querySelector('.inspire-menu-check').innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                }

                // Find and select the saved model in submenu
                var savedSubmenuItem = document.querySelector('.inspire-submenu-item[data-model="' + savedModelId + '"]');
                if (savedSubmenuItem) {
                    savedSubmenuItem.classList.add('selected');
                }

                inspireDropdown.querySelector('span').textContent = savedModelName;
            }
        }

        // Cookie helper functions
        function setCookie(name, value, days) {
            var expires = '';
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = '; expires=' + date.toUTCString();
            }
            document.cookie = name + '=' + (value || '') + expires + '; path=/';
        }

        function getCookie(name) {
            var nameEQ = name + '=';
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // ==================== NEW MESSAGE BUTTON ====================
        var newMessageBtn = document.getElementById('newMessageBtn');

        function startNewMessage() {
            createNewConversation();
            setPersonaPanelExpanded(true);
            chatInput.focus();
        }

        if (newMessageBtn) {
            newMessageBtn.addEventListener('click', startNewMessage);
        }

        // ==================== LANGUAGE TRANSLATION PANEL ====================
        (function initLanguagePanel() {
            var languagePanel = document.getElementById('languagePanel');
            var languageToggleBtn = document.getElementById('languageToggleBtn');
            var languagePanelClose = document.getElementById('languagePanelClose');
            var allLanguagesContainer = document.getElementById('allLanguages');
            var recentLanguagesContainer = document.getElementById('recentLanguages');
            var personaPanel = document.getElementById('personaPanel');
            var appContainer = document.querySelector('.app-container');
            var contentArea = document.querySelector('.content-area');
            var mailboxAutoClosedByLanguagePanel = false;

            // Current selected language
            var selectedLanguage = {
                code: 'en',
                name: 'English (US)',
                flag: 'us'
            };

            // All available languages with flag codes
            var allLanguages = [
                { code: 'en', name: 'English', flag: 'us' },
                { code: 'af', name: 'Afrikaans', flag: 'za' },
                { code: 'sq', name: 'Albanian', flag: 'al' },
                { code: 'am', name: 'Amharic', flag: 'et' },
                { code: 'ar', name: 'Arabic', flag: 'sa' },
                { code: 'hy', name: 'Armenian', flag: 'am' },
                { code: 'az', name: 'Azerbaijani', flag: 'az' },
                { code: 'eu', name: 'Basque', flag: 'es' },
                { code: 'be', name: 'Belarusian', flag: 'by' },
                { code: 'bn', name: 'Bengali', flag: 'bd' },
                { code: 'bs', name: 'Bosnian', flag: 'ba' },
                { code: 'bg', name: 'Bulgarian', flag: 'bg' },
                { code: 'ca', name: 'Catalan', flag: 'es' },
                { code: 'zh', name: 'Chinese (Mandarin)', flag: 'cn' },
                { code: 'zh-tw', name: 'Chinese (Traditional)', flag: 'tw' },
                { code: 'hr', name: 'Croatian', flag: 'hr' },
                { code: 'cs', name: 'Czech', flag: 'cz' },
                { code: 'da', name: 'Danish', flag: 'dk' },
                { code: 'nl', name: 'Dutch', flag: 'nl' },
                { code: 'et', name: 'Estonian', flag: 'ee' },
                { code: 'fo', name: 'Faroese', flag: 'fo' },
                { code: 'fi', name: 'Finnish', flag: 'fi' },
                { code: 'fr', name: 'French', flag: 'fr' },
                { code: 'gl', name: 'Galician', flag: 'es' },
                { code: 'ka', name: 'Georgian', flag: 'ge' },
                { code: 'de', name: 'German', flag: 'de' },
                { code: 'el', name: 'Greek', flag: 'gr' },
                { code: 'gu', name: 'Gujarati', flag: 'in' },
                { code: 'ha', name: 'Hausa', flag: 'ng' },
                { code: 'he', name: 'Hebrew', flag: 'il' },
                { code: 'hi', name: 'Hindi', flag: 'in' },
                { code: 'hu', name: 'Hungarian', flag: 'hu' },
                { code: 'is', name: 'Icelandic', flag: 'is' },
                { code: 'ig', name: 'Igbo', flag: 'ng' },
                { code: 'id', name: 'Indonesian', flag: 'id' },
                { code: 'ga', name: 'Irish', flag: 'ie' },
                { code: 'it', name: 'Italian', flag: 'it' },
                { code: 'ja', name: 'Japanese', flag: 'jp' },
                { code: 'kn', name: 'Kannada', flag: 'in' },
                { code: 'kk', name: 'Kazakh', flag: 'kz' },
                { code: 'ko', name: 'Korean', flag: 'kr' },
                { code: 'ky', name: 'Kyrgyz', flag: 'kg' },
                { code: 'lv', name: 'Latvian', flag: 'lv' },
                { code: 'lt', name: 'Lithuanian', flag: 'lt' },
                { code: 'mk', name: 'Macedonian', flag: 'mk' },
                { code: 'ms', name: 'Malay', flag: 'my' },
                { code: 'ml', name: 'Malayalam', flag: 'in' },
                { code: 'mt', name: 'Maltese', flag: 'mt' },
                { code: 'mr', name: 'Marathi', flag: 'in' },
                { code: 'mn', name: 'Mongolian', flag: 'mn' },
                { code: 'ne', name: 'Nepali', flag: 'np' },
                { code: 'no', name: 'Norwegian', flag: 'no' },
                { code: 'ps', name: 'Pashto', flag: 'af' },
                { code: 'fa', name: 'Persian', flag: 'ir' },
                { code: 'pl', name: 'Polish', flag: 'pl' },
                { code: 'pt', name: 'Portuguese', flag: 'pt' },
                { code: 'pt-br', name: 'Portuguese (Brazil)', flag: 'br' },
                { code: 'pa', name: 'Punjabi', flag: 'in' },
                { code: 'ro', name: 'Romanian', flag: 'ro' },
                { code: 'ru', name: 'Russian', flag: 'ru' },
                { code: 'sr', name: 'Serbian', flag: 'rs' },
                { code: 'sk', name: 'Slovak', flag: 'sk' },
                { code: 'sl', name: 'Slovenian', flag: 'si' },
                { code: 'so', name: 'Somali', flag: 'so' },
                { code: 'es', name: 'Spanish', flag: 'es' },
                { code: 'sw', name: 'Swahili', flag: 'ke' },
                { code: 'sv', name: 'Swedish', flag: 'se' },
                { code: 'tl', name: 'Tagalog (Filipino)', flag: 'ph' },
                { code: 'tg', name: 'Tajik', flag: 'tj' },
                { code: 'ta', name: 'Tamil', flag: 'in' },
                { code: 'te', name: 'Telugu', flag: 'in' },
                { code: 'th', name: 'Thai', flag: 'th' },
                { code: 'tr', name: 'Turkish', flag: 'tr' },
                { code: 'tk', name: 'Turkmen', flag: 'tm' },
                { code: 'uk', name: 'Ukrainian', flag: 'ua' },
                { code: 'ur', name: 'Urdu', flag: 'pk' },
                { code: 'uz', name: 'Uzbek', flag: 'uz' },
                { code: 'vi', name: 'Vietnamese', flag: 'vn' },
                { code: 'cy', name: 'Welsh', flag: 'gb' },
                { code: 'xh', name: 'Xhosa', flag: 'za' },
                { code: 'yo', name: 'Yoruba', flag: 'ng' },
                { code: 'zu', name: 'Zulu', flag: 'za' }
            ];

            // Recently used languages (stored in localStorage)
            var recentLanguagesCookieName = 'jv_recent_languages';
            var selectedLanguageCookieName = 'jv_selected_language';

            function getRecentLanguages() {
                try {
                    var stored = localStorage.getItem(recentLanguagesCookieName);
                    if (stored) {
                        return JSON.parse(stored);
                    }
                } catch (e) {}
                return [{ code: 'en', name: 'English (US)', flag: 'us' }];
            }

            function saveRecentLanguages(languages) {
                try {
                    localStorage.setItem(recentLanguagesCookieName, JSON.stringify(languages));
                } catch (e) {}
            }

            function getSelectedLanguage() {
                try {
                    var stored = localStorage.getItem(selectedLanguageCookieName);
                    if (stored) {
                        return JSON.parse(stored);
                    }
                } catch (e) {}
                return { code: 'en', name: 'English (US)', flag: 'us' };
            }

            function saveSelectedLanguage(lang) {
                try {
                    localStorage.setItem(selectedLanguageCookieName, JSON.stringify(lang));
                } catch (e) {}
            }

            function closePersonaPanelIfOpen() {
                if (personaPanel && personaPanel.classList.contains('open')) {
                    personaPanel.classList.remove('open');
                    if (contentArea) {
                        contentArea.classList.remove('persona-panel-open');
                    }
                }
            }

            function createLanguageItem(lang, isSelected) {
                var item = document.createElement('div');
                item.className = 'language-item' + (isSelected ? ' selected' : '');
                item.setAttribute('data-lang', lang.code);
                item.setAttribute('data-name', lang.name);
                item.setAttribute('data-flag', lang.flag);
                item.innerHTML = '<img src="https://flagcdn.com/w40/' + lang.flag + '.png" alt="' + lang.name + '" class="language-flag">' +
                    '<span class="language-name">' + lang.name + '</span>';
                return item;
            }

            function renderLanguages() {
                // Render recent languages
                var recentLangs = getRecentLanguages();
                recentLanguagesContainer.innerHTML = '';
                recentLangs.forEach(function(lang) {
                    var isSelected = lang.code === selectedLanguage.code;
                    var item = createLanguageItem(lang, isSelected);
                    item.addEventListener('click', function() {
                        selectLanguage(lang);
                    });
                    recentLanguagesContainer.appendChild(item);
                });

                // Render all languages
                allLanguagesContainer.innerHTML = '';
                allLanguages.forEach(function(lang) {
                    var isSelected = lang.code === selectedLanguage.code;
                    var item = createLanguageItem(lang, isSelected);
                    item.addEventListener('click', function() {
                        selectLanguage(lang);
                    });
                    allLanguagesContainer.appendChild(item);
                });
            }

            function updateFlagIcon(lang) {
                if (languageToggleBtn) {
                    languageToggleBtn.innerHTML = '<img src="https://flagcdn.com/w40/' + lang.flag + '.png" alt="' + lang.name + '">';
                    languageToggleBtn.title = lang.name;
                }
            }

            function selectLanguage(lang) {
                selectedLanguage = lang;
                saveSelectedLanguage(lang);

                // Add to recent languages if not already there
                var recentLangs = getRecentLanguages();
                var existingIndex = recentLangs.findIndex(function(l) { return l.code === lang.code; });
                if (existingIndex > -1) {
                    recentLangs.splice(existingIndex, 1);
                }
                recentLangs.unshift(lang);
                if (recentLangs.length > 5) {
                    recentLangs = recentLangs.slice(0, 5);
                }
                saveRecentLanguages(recentLangs);

                // Update UI
                updateFlagIcon(lang);
                renderLanguages();
                closeLanguagePanel();

                if (typeof chatState !== 'undefined') {
                    if (chatState.currentMailbox === 'chat_inbox') {
                        if (chatState.conversationId) {
                            fetch('/chat/conversations/' + chatState.conversationId, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ responseLanguage: lang.code })
                            }).catch(function(error) {
                                console.warn('Failed to persist response language:', error);
                            });
                        }
                    } else {
                        // Update WebSocket language for real-time translations
                        if (typeof updateWebSocketLanguage === 'function') {
                            updateWebSocketLanguage();
                        }

                        if (chatState.conversationId) {
                            loadConversation(chatState.conversationId);
                        } else {
                            loadMailboxConversations(chatState.currentMailbox, chatState.focusedFilter).then(function(conversations) {
                                if (conversations && conversations.length > 0) {
                                    selectConversation(conversations[0].id);
                                }
                            });
                        }
                    }
                }
            }

            function openLanguagePanel() {
                mailboxAutoClosedByLanguagePanel = false;
                if (typeof window.isMailboxCollapsed === 'function' && typeof window.setMailboxCollapsed === 'function') {
                    if (!window.isMailboxCollapsed()) {
                        window.setMailboxCollapsed(true, { explicit: false });
                        mailboxAutoClosedByLanguagePanel = true;
                    }
                } else if (appContainer && !appContainer.classList.contains('is-mailbox-collapsed')) {
                    var menuToggle = document.getElementById('menuToggle');
                    if (menuToggle) {
                        menuToggle.click();
                        mailboxAutoClosedByLanguagePanel = true;
                    }
                }

                closePersonaPanelIfOpen();
                languagePanel.classList.add('open');
                // Add class to content area to push it left
                if (contentArea) {
                    contentArea.classList.add('language-panel-open');
                }
                renderLanguages();
            }

            function closeLanguagePanel() {
                languagePanel.classList.remove('open');
                // Remove class from content area
                if (contentArea) {
                    contentArea.classList.remove('language-panel-open');
                }
                if (mailboxAutoClosedByLanguagePanel) {
                    var keepClosed = typeof window.isMailboxExplicitlyClosed === 'function' && window.isMailboxExplicitlyClosed();
                    if (!keepClosed && typeof window.setMailboxCollapsed === 'function') {
                        window.setMailboxCollapsed(false, { explicit: false });
                    }
                }
                mailboxAutoClosedByLanguagePanel = false;
            }

            function toggleLanguagePanel() {
                if (languagePanel.classList.contains('open')) {
                    closeLanguagePanel();
                } else {
                    openLanguagePanel();
                }
            }

            // Initialize
            selectedLanguage = getSelectedLanguage();

            var queryLanguage = getQueryParam('lang') || getQueryParam('language');
            if (queryLanguage) {
                var normalizedCode = queryLanguage.toLowerCase();
                if (normalizedCode === 'en-us' || normalizedCode === 'en_us') {
                    normalizedCode = 'en';
                }
                var matchedLanguage = allLanguages.find(function(lang) {
                    return lang.code === normalizedCode;
                });
                if (matchedLanguage) {
                    selectedLanguage = {
                        code: matchedLanguage.code,
                        name: matchedLanguage.name,
                        flag: matchedLanguage.flag
                    };
                    saveSelectedLanguage(selectedLanguage);
                }
            }
            updateFlagIcon(selectedLanguage);

            // Event listeners
            if (languageToggleBtn) {
                console.log('Language toggle button found, adding click listener');
                languageToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Language toggle clicked');
                    toggleLanguagePanel();
                });
            } else {
                console.warn('Language toggle button not found');
            }

            if (languagePanelClose) {
                languagePanelClose.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeLanguagePanel();
                });
            }

            // Close panel when clicking outside
            document.addEventListener('click', function(e) {
                if (languagePanel.classList.contains('open') &&
                    !languagePanel.contains(e.target) &&
                    e.target !== languageToggleBtn &&
                    !languageToggleBtn.contains(e.target)) {
                    closeLanguagePanel();
                }
            });

            // Make the selected language available globally for AI responses
            window.getSelectedResponseLanguage = function() {
                return selectedLanguage;
            };
        })();

        // ==================== INSPIRE PERSONA PANEL ====================
        (function initPersonaPanel() {
            var personaPanel = document.getElementById('personaPanel');
            var personaToggleBtn = document.getElementById('personaToggleBtn');
            var personaPanelClose = document.getElementById('personaPanelClose');
            var chatboxPersonaExpand = document.getElementById('chatboxPersonaExpand');
            var languagePanel = document.getElementById('languagePanel');
            var appContainer = document.querySelector('.app-container');
            var contentArea = document.querySelector('.content-area');
            var chatboxTabs = document.getElementById('chatboxTabs');
            var mailboxAutoClosedByPersonaPanel = false;

            if (!personaPanel) {
                return;
            }

            // Get selected personas from localStorage
            function getSelectedPersonas() {
                return getSelectedPersonaSlugs({ allowEmpty: true });
            }

            // Save selected personas to localStorage
            function saveSelectedPersonas(personas) {
                setPersonaSelection(personas, { allowEmpty: true });
            }

            function closeLanguagePanelIfOpen() {
                if (languagePanel && languagePanel.classList.contains('open')) {
                    languagePanel.classList.remove('open');
                    if (contentArea) {
                        contentArea.classList.remove('language-panel-open');
                    }
                }
            }

            function openPersonaPanel() {
                mailboxAutoClosedByPersonaPanel = false;
                if (typeof window.isMailboxCollapsed === 'function' && typeof window.setMailboxCollapsed === 'function') {
                    if (!window.isMailboxCollapsed()) {
                        window.setMailboxCollapsed(true, { explicit: false });
                        mailboxAutoClosedByPersonaPanel = true;
                    }
                } else if (appContainer && !appContainer.classList.contains('is-mailbox-collapsed')) {
                    var menuToggle = document.getElementById('menuToggle');
                    if (menuToggle) {
                        menuToggle.click();
                        mailboxAutoClosedByPersonaPanel = true;
                    }
                }

                closeLanguagePanelIfOpen();
                personaPanel.classList.add('open');
                if (contentArea) {
                    contentArea.classList.add('persona-panel-open');
                }
                syncPersonaSelections();
                syncPersonaPanelForMailbox(chatState.currentMailbox);
            }

            function closePersonaPanel() {
                personaPanel.classList.remove('open');
                if (contentArea) {
                    contentArea.classList.remove('persona-panel-open');
                }
                if (mailboxAutoClosedByPersonaPanel) {
                    var keepClosed = typeof window.isMailboxExplicitlyClosed === 'function' && window.isMailboxExplicitlyClosed();
                    if (!keepClosed && typeof window.setMailboxCollapsed === 'function') {
                        window.setMailboxCollapsed(false, { explicit: false });
                    }
                }
                mailboxAutoClosedByPersonaPanel = false;
            }

            function togglePersonaPanel() {
                if (personaPanel.classList.contains('open')) {
                    closePersonaPanel();
                } else {
                    openPersonaPanel();
                }
            }

            // Sync persona selections with chatbox tabs
            function syncPersonaSelections() {
                var selectedPersonas = getSelectedPersonas();
                var personaItems = personaPanel.querySelectorAll('.persona-rail-item');

                personaItems.forEach(function(item) {
                    var personaId = item.getAttribute('data-persona');
                    if (selectedPersonas.indexOf(personaId) > -1) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            // Add persona to chatbox tabs
            function addPersonaToChatbox(personaId, personaName, avatarSrc) {
                if (!personaId) return;
                var current = getSelectedPersonaSlugs({ allowEmpty: true });
                if (current.indexOf(personaId) === -1) {
                    current.push(personaId);
                    setPersonaSelection(current);
                }
            }

            // Remove persona from chatbox tabs
            function removePersonaFromChatbox(personaId) {
                removePersonaSelection(personaId);
            }

            // Handle persona item click (multi-selection)
            function handlePersonaItemClick(item) {
                var personaId = item.getAttribute('data-persona');
                if (chatState && chatState.currentMailbox !== 'chat_inbox') {
                    return;
                }
                togglePersonaSelection(personaId);
            }

            // Bind click handlers to persona items
            var personaItems = personaPanel.querySelectorAll('.persona-rail-item');
            personaItems.forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handlePersonaItemClick(this);
                });
            });

            if (personaToggleBtn) {
                personaToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    togglePersonaPanel();
                });
            }

            if (chatboxPersonaExpand) {
                chatboxPersonaExpand.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    togglePersonaPanel();
                });
            }

            if (personaPanelClose) {
                personaPanelClose.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closePersonaPanel();
                });
            }

            document.addEventListener('click', function(e) {
                if (personaPanel.classList.contains('open') &&
                    !personaPanel.contains(e.target) &&
                    (personaToggleBtn ? (e.target !== personaToggleBtn && !personaToggleBtn.contains(e.target)) : true) &&
                    (chatboxPersonaExpand ? (e.target !== chatboxPersonaExpand && !chatboxPersonaExpand.contains(e.target)) : true)) {
                    closePersonaPanel();
                }
            });

            // Initialize selections on load
            syncPersonaSelections();
        })();

        // ==================== VOICE PANEL ====================
        (function initVoicePanel() {
            var voiceBtn = document.querySelector('.right-voice');
            var voicePanel = document.getElementById('voicePanel');
            var voicePanelOverlay = document.getElementById('voicePanelOverlay');
            var voicePanelClose = document.getElementById('voicePanelClose');
            var voiceCancelBtn = document.getElementById('voiceCancelBtn');
            var voiceStartBtn = document.getElementById('voiceStartBtn');
            var voiceMicBtn = document.getElementById('voiceMicBtn');
            var voiceVisualizer = document.getElementById('voiceVisualizer');
            var voiceStatus = document.getElementById('voiceStatus');
            var voicePersonaAvatar = document.getElementById('voicePersonaAvatar');
            var voicePersonaName = document.getElementById('voicePersonaName');
            var voicePersonaRole = document.getElementById('voicePersonaRole');

            if (!voiceBtn || !voicePanel) {
                return;
            }

            var isRecording = false;

            function openVoicePanel() {
                // Update persona info based on current selection
                updateVoicePersona();
                voicePanel.classList.add('open');
                voicePanelOverlay.classList.add('open');
                voiceBtn.classList.add('active');
            }

            function closeVoicePanel() {
                voicePanel.classList.remove('open');
                voicePanelOverlay.classList.remove('open');
                voiceBtn.classList.remove('active');
                stopRecording();
            }

            function toggleVoicePanel() {
                if (voicePanel.classList.contains('open')) {
                    closeVoicePanel();
                } else {
                    openVoicePanel();
                }
            }

            function updateVoicePersona() {
                // Get current persona from chatbox tabs
                var activeTab = document.querySelector('.chatbox-tab');
                if (activeTab) {
                    var personaSlug = activeTab.getAttribute('data-persona');
                    var personaNameEl = activeTab.querySelector('span');
                    var personaImg = activeTab.querySelector('img');

                    if (personaImg && voicePersonaAvatar) {
                        voicePersonaAvatar.src = personaImg.src;
                        voicePersonaAvatar.alt = personaImg.alt;
                    }
                    if (personaNameEl && voicePersonaName) {
                        voicePersonaName.textContent = personaNameEl.textContent;
                    }
                    if (voicePersonaRole) {
                        voicePersonaRole.textContent = 'AI Assistant';
                    }
                }
            }

            function startRecording() {
                isRecording = true;
                voiceMicBtn.classList.add('recording');
                voiceVisualizer.classList.add('listening');
                voiceStatus.textContent = 'Listening...';
                voiceStatus.classList.add('active');
                voiceStartBtn.textContent = 'Stop Voice Chat';
            }

            function stopRecording() {
                isRecording = false;
                voiceMicBtn.classList.remove('recording');
                voiceVisualizer.classList.remove('listening');
                voiceStatus.textContent = 'Click the microphone to start speaking';
                voiceStatus.classList.remove('active');
                voiceStartBtn.textContent = 'Start Voice Chat';
            }

            function toggleRecording() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }

            // Event listeners
            voiceBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleVoicePanel();
            });

            voicePanelClose.addEventListener('click', function(e) {
                e.stopPropagation();
                closeVoicePanel();
            });

            voicePanelOverlay.addEventListener('click', function(e) {
                closeVoicePanel();
            });

            voiceCancelBtn.addEventListener('click', function(e) {
                closeVoicePanel();
            });

            voiceStartBtn.addEventListener('click', function(e) {
                toggleRecording();
            });

            voiceMicBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleRecording();
            });

            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && voicePanel.classList.contains('open')) {
                    closeVoicePanel();
                }
            });
        })();

        // ==================== INBOX PANEL (Slide-in) ====================
        (function initInboxPanel() {
            var inboxPanel = document.getElementById('inboxPanel');
            var inboxToggleBtn = document.getElementById('inboxIconBtn');
            var inboxPanelClose = document.getElementById('inboxPanelClose');
            var languagePanel = document.getElementById('languagePanel');
            var personaPanel = document.getElementById('personaPanel');
            var appContainer = document.querySelector('.app-container');
            var contentArea = document.querySelector('.content-area');

            if (!inboxPanel || !inboxToggleBtn) {
                return;
            }

            function closePersonaPanelIfOpen() {
                if (personaPanel && personaPanel.classList.contains('open')) {
                    personaPanel.classList.remove('open');
                    if (contentArea) {
                        contentArea.classList.remove('persona-panel-open');
                    }
                }
            }

            function closeLanguagePanelIfOpen() {
                if (languagePanel && languagePanel.classList.contains('open')) {
                    languagePanel.classList.remove('open');
                    if (contentArea) {
                        contentArea.classList.remove('language-panel-open');
                    }
                }
            }

            function openInboxPanel() {
                if (typeof window.isMailboxCollapsed === 'function' && typeof window.setMailboxCollapsed === 'function') {
                    if (!window.isMailboxCollapsed()) {
                        window.setMailboxCollapsed(true, { explicit: false });
                    }
                } else if (appContainer && !appContainer.classList.contains('is-mailbox-collapsed')) {
                    var menuToggle = document.getElementById('menuToggle');
                    if (menuToggle) {
                        menuToggle.click();
                    }
                }

                // Close other panels
                closePersonaPanelIfOpen();
                closeLanguagePanelIfOpen();

                inboxPanel.classList.add('open');
                if (contentArea) {
                    contentArea.classList.add('inbox-panel-open');
                }
            }

            function closeInboxPanel() {
                inboxPanel.classList.remove('open');
                if (contentArea) {
                    contentArea.classList.remove('inbox-panel-open');
                }
            }

            function toggleInboxPanel() {
                if (inboxPanel.classList.contains('open')) {
                    closeInboxPanel();
                } else {
                    openInboxPanel();
                }
            }

            inboxToggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleInboxPanel();
            });

            if (inboxPanelClose) {
                inboxPanelClose.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeInboxPanel();
                });
            }

            document.addEventListener('click', function(e) {
                if (inboxPanel.classList.contains('open') &&
                    !inboxPanel.contains(e.target) &&
                    e.target !== inboxToggleBtn &&
                    !inboxToggleBtn.contains(e.target)) {
                    closeInboxPanel();
                }
            });
        })();

        // ==================== PIN MODAL FUNCTIONALITY ====================
        (function initPinModal() {
            var lockIcon = document.getElementById('chatboxLockBtn');
            var pinModalOverlay = document.getElementById('pinModalOverlay');
            var pinInputs = document.querySelectorAll('.pin-input');
            var pinModalTitle = document.getElementById('pinModalTitle');
            var pinModalText = document.getElementById('pinModalText');
            var isLocking = true;

            if (!lockIcon || !pinModalOverlay) return;

            // Open PIN modal when lock icon is clicked
            lockIcon.addEventListener('click', function() {
                // Determine if we're locking or unlocking
                if (this.classList.contains('unlocked')) {
                    isLocking = false;
                    if (pinModalTitle) pinModalTitle.textContent = 'Unlock Private Chat';
                    if (pinModalText) pinModalText.textContent = 'Please enter your four digit pin to unlock and exit private chat mode.';
                } else {
                    isLocking = true;
                    if (pinModalTitle) pinModalTitle.textContent = 'Private Chat';
                    if (pinModalText) pinModalText.textContent = 'Please enter a four digit pin to encrypt your conversation for privacy.';
                }

                // Show modal
                this.classList.add('active');
                pinModalOverlay.classList.add('open');

                // Clear all inputs and focus first one
                pinInputs.forEach(function(input) {
                    input.value = '';
                });
                setTimeout(function() {
                    if (pinInputs[0]) pinInputs[0].focus();
                }, 100);
            });

            // Close modal when clicking overlay (outside modal)
            pinModalOverlay.addEventListener('click', function(e) {
                if (e.target === pinModalOverlay) {
                    pinModalOverlay.classList.remove('open');
                    lockIcon.classList.remove('active');
                }
            });

            // Handle PIN input
            pinInputs.forEach(function(input, index) {
                // Only allow numbers
                input.addEventListener('input', function() {
                    // Remove non-numeric characters
                    this.value = this.value.replace(/[^0-9]/g, '');

                    if (this.value.length === 1) {
                        // Move to next input
                        if (index < pinInputs.length - 1) {
                            pinInputs[index + 1].focus();
                        } else {
                            // Last input filled - check if all are filled
                            var allFilled = true;
                            pinInputs.forEach(function(inp) {
                                if (inp.value.length !== 1) allFilled = false;
                            });

                            if (allFilled) {
                                // Get the full PIN
                                var pin = '';
                                pinInputs.forEach(function(inp) {
                                    pin += inp.value;
                                });

                                // Close modal and toggle lock state
                                pinModalOverlay.classList.remove('open');
                                lockIcon.classList.remove('active');

                                if (isLocking) {
                                    lockIcon.classList.add('unlocked');
                                } else {
                                    lockIcon.classList.remove('unlocked');
                                }

                                // Store PIN in session storage
                                if (isLocking) {
                                    sessionStorage.setItem('privateChatPin', pin);
                                } else {
                                    sessionStorage.removeItem('privateChatPin');
                                }
                            }
                        }
                    }
                });

                // Handle backspace to go to previous input
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                        pinInputs[index - 1].focus();
                    }
                    // Handle Escape to close modal
                    if (e.key === 'Escape') {
                        pinModalOverlay.classList.remove('open');
                        lockIcon.classList.remove('active');
                    }
                });

                // Handle paste
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    var pastedData = (e.clipboardData || window.clipboardData).getData('text');
                    var digits = pastedData.replace(/[^0-9]/g, '').split('');

                    digits.forEach(function(digit, i) {
                        if (index + i < pinInputs.length) {
                            pinInputs[index + i].value = digit;
                        }
                    });

                    // Focus last filled input or next empty one
                    var lastFilledIndex = Math.min(index + digits.length - 1, pinInputs.length - 1);
                    if (lastFilledIndex < pinInputs.length - 1) {
                        pinInputs[lastFilledIndex + 1].focus();
                    } else {
                        pinInputs[lastFilledIndex].focus();
                        // Trigger check for all filled
                        pinInputs[lastFilledIndex].dispatchEvent(new Event('input'));
                    }
                });
            });
        })();

        // ==================== FILE ATTACHMENT FUNCTIONALITY ====================
        (function initFileAttachment() {
            var attachFileBtn = document.getElementById('attachFileBtn');
            var fileInput = document.getElementById('fileAttachmentInput');
            var attachmentsContainer = document.getElementById('chatboxAttachments');

            if (!attachFileBtn || !fileInput || !attachmentsContainer) return;

            // Click the + button to trigger file input
            attachFileBtn.addEventListener('click', function() {
                fileInput.click();
            });

            // Handle file selection
            fileInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    var file = this.files[0];
                    displayAttachment(file);
                }
            });

            function displayAttachment(file) {
                // Create attachment item
                var attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.innerHTML =
                    '<span class="attachment-name">' + escapeHtml(file.name) + '</span>' +
                    '<button type="button" class="attachment-remove" aria-label="Remove attachment">&times;</button>';

                // Store file reference on the element
                attachmentItem.fileData = file;

                // Remove button handler
                attachmentItem.querySelector('.attachment-remove').addEventListener('click', function() {
                    attachmentItem.remove();
                    // Clear file input so the same file can be selected again
                    fileInput.value = '';
                    // Hide container if no files left
                    if (attachmentsContainer.children.length === 0) {
                        attachmentsContainer.classList.remove('has-files');
                    }
                });

                // Add to container (replace any existing attachment for now - single file)
                attachmentsContainer.innerHTML = '';
                attachmentsContainer.appendChild(attachmentItem);
                // Show the container
                attachmentsContainer.classList.add('has-files');
            }

            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        })();

        // ==================== WEBSOCKET REAL-TIME SYNC ====================
        (function() {
            var ws = null;
            var reconnectAttempts = 0;
            var maxReconnectAttempts = 5;
            var reconnectDelay = 2000;
            var currentBoardConversationId = null;

            function connectWebSocket() {
                if (ws && ws.readyState === WebSocket.OPEN) return;

                var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                var wsUrl = protocol + '//' + window.location.host + '/ws';

                try {
                    ws = new WebSocket(wsUrl);

                    ws.onopen = function() {
                        console.log('WebSocket connected');
                        reconnectAttempts = 0;

                        // Identify user to WebSocket server (required for excludeUserId to work)
                        if (window.currentUserId) {
                            ws.send(JSON.stringify({
                                type: 'identify',
                                userId: window.currentUserId
                            }));
                            console.log('WebSocket identified user:', window.currentUserId);
                        }

                        // Subscribe to current board conversation if viewing one
                        if (chatState && chatState.currentMailbox !== 'chat_inbox' && chatState.conversationId) {
                            subscribeToBoardConversation(chatState.conversationId);
                        }
                    };

                    ws.onmessage = function(event) {
                        try {
                            var data = JSON.parse(event.data);
                            handleWebSocketMessage(data);
                        } catch (e) {
                            console.error('WebSocket message parse error:', e);
                        }
                    };

                    ws.onclose = function(event) {
                        console.log('WebSocket disconnected', event.code);
                        ws = null;

                        // Attempt reconnection
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            setTimeout(connectWebSocket, reconnectDelay * reconnectAttempts);
                        }
                    };

                    ws.onerror = function(error) {
                        console.error('WebSocket error:', error);
                    };
                } catch (error) {
                    console.error('Failed to create WebSocket:', error);
                }
            }

            function subscribeToBoardConversation(conversationId) {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                if (!conversationId) return;

                // Unsubscribe from previous conversation
                if (currentBoardConversationId && currentBoardConversationId !== conversationId) {
                    ws.send(JSON.stringify({
                        type: 'unsubscribe_board',
                        conversationId: currentBoardConversationId
                    }));
                }

                // Subscribe to new conversation with language preference
                currentBoardConversationId = conversationId;
                var languageCode = getSelectedLanguageCode();
                ws.send(JSON.stringify({
                    type: 'subscribe_board',
                    conversationId: conversationId,
                    language: languageCode
                }));
            }

            // Update WebSocket language when user changes language selection
            function updateWebSocketLanguage() {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                var languageCode = getSelectedLanguageCode();
                ws.send(JSON.stringify({
                    type: 'set_language',
                    language: languageCode
                }));
            }

            function handleWebSocketMessage(data) {
                if (!data || !data.type) return;

                switch (data.type) {
                    case 'connected':
                    case 'subscribed_board':
                    case 'unsubscribed_board':
                        // Connection/subscription confirmations
                        break;

                    case 'board_message':
                        handleIncomingBoardMessage(data);
                        break;

                    case 'board_ai_response':
                        handleIncomingAiResponse(data);
                        break;

                    case 'board_ai_stream_start':
                        handleAiStreamStart(data);
                        break;

                    case 'board_ai_stream_chunk':
                        handleAiStreamChunk(data);
                        break;

                    case 'board_ai_stream_complete':
                        handleAiStreamComplete(data);
                        break;

                    case 'board_ai_stream_error':
                        handleAiStreamError(data);
                        break;

                    case 'board_message_translated':
                        handleMessageTranslation(data);
                        break;

                    case 'board_new_conversation':
                        handleNewBoardConversation(data);
                        break;

                    case 'board_conversation_deleted':
                        handleBoardConversationDeleted(data);
                        break;

                    case 'language_set':
                        // Language confirmation - nothing to do
                        break;

                    default:
                        console.log('Unknown WebSocket message type:', data.type);
                }
            }

            // Track message IDs that we sent ourselves (to ignore WebSocket echoes)
            // These MUST be global so sendCommunityBoardMessage can access them
            window.sentMessageIds = window.sentMessageIds || new Set();
            window.sentAiMessageIds = window.sentAiMessageIds || new Set();
            var sentMessageIds = window.sentMessageIds;
            var sentAiMessageIds = window.sentAiMessageIds;

            // Check if user is using a non-English language
            // Expose globally so sendMessage can use it
            function isNonEnglishLanguage() {
                var lang = getSelectedLanguageCode();
                return lang && lang !== 'en' && lang !== 'en-US' && lang !== 'en-GB';
            }
            window.isNonEnglishLanguage = isNonEnglishLanguage;

            // ==================== CLIENT-SIDE TRANSLATION LAYER ====================
            // All content is transmitted in English from the server.
            // This layer translates content to the user's selected language on the receiving side.

            // Translation cache to avoid redundant API calls
            var translationCache = {};

            /**
             * Translate content to the user's selected language
             * @param {string} content - English content from server
             * @returns {Promise<string>} Translated content (or original if English user)
             */
            async function translateContentForDisplay(content) {
                if (!content || !content.trim()) return content;

                // Skip translation for English users
                if (!isNonEnglishLanguage()) {
                    return content;
                }

                var targetLang = getSelectedLanguageCode();
                var cacheKey = targetLang + ':' + content.substring(0, 100); // Use first 100 chars as key

                // Check cache first
                if (translationCache[cacheKey]) {
                    return translationCache[cacheKey];
                }

                try {
                    var response = await fetch('/boards/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: content,
                            targetLanguage: targetLang
                        })
                    });

                    if (!response.ok) {
                        console.warn('Translation API error:', response.status);
                        return content;
                    }

                    var result = await response.json();
                    if (result.success && result.translatedText) {
                        // Cache the translation
                        translationCache[cacheKey] = result.translatedText;
                        return result.translatedText;
                    }

                    return content;
                } catch (error) {
                    console.error('Translation error:', error);
                    return content;
                }
            }

            // Expose for other functions
            window.translateContentForDisplay = translateContentForDisplay;
            // ==================== END TRANSLATION LAYER ====================

            // Track messages waiting for translation
            // Expose globally so sendMessage can add to it
            window.messagesAwaitingTranslation = window.messagesAwaitingTranslation || new Set();
            var messagesAwaitingTranslation = window.messagesAwaitingTranslation;

            // Queue for pending user messages being translated (to maintain order)
            // AI responses must wait for user messages to display first
            var pendingUserMessagePromise = Promise.resolve();

            function handleIncomingBoardMessage(data) {
                // Only process if we're viewing the same conversation
                if (!chatState || chatState.conversationId !== data.conversationId) return;
                if (!data.message) return;

                var msg = data.message;

                // Skip if this is a message we just sent (WebSocket echo)
                if (sentMessageIds.has(msg.id)) {
                    sentMessageIds.delete(msg.id);
                    return;
                }

                // Check if message is already displayed (avoid duplicates)
                var existingMsg = document.querySelector('[data-message-id="' + msg.id + '"]');
                if (existingMsg) return;

                // Create a promise that will resolve when the message is displayed
                // This ensures AI responses wait for user messages to display first
                pendingUserMessagePromise = (async function() {
                    var authorName = msg.authorName || 'Community Member';

                    // CLIENT-SIDE TRANSLATION: Server sends English, we translate for display
                    var displayContent = msg.content;
                    if (isNonEnglishLanguage()) {
                        displayContent = await translateContentForDisplay(msg.content);
                    }
                    var msgElement = addMessageWithId('user', displayContent, authorName, msg.id);

                    // Store original English content for reference
                    if (msgElement && isNonEnglishLanguage()) {
                        msgElement.setAttribute('data-original-content', msg.content);
                    }

                    // Add to conversation history (store original English for context)
                    conversationHistory.push({
                        role: 'user',
                        content: msg.content,
                        authorName: authorName
                    });
                })();
            }

            async function handleIncomingAiResponse(data) {
                // Only process if we're viewing the same conversation
                if (!chatState || chatState.conversationId !== data.conversationId) return;
                if (!data.message) return;

                var msg = data.message;

                // Skip if this is an AI response to a message we just sent (WebSocket echo)
                if (sentAiMessageIds.has(msg.id)) {
                    sentAiMessageIds.delete(msg.id);
                    return;
                }

                // Check if message is already displayed (avoid duplicates)
                var existingMsg = document.querySelector('[data-message-id="' + msg.id + '"]');
                if (existingMsg) return;

                // Determine persona name
                var personaName = msg.personaName || getBoardPersonaName(chatState.currentMailbox) || 'Bible Persona';

                // Hide typing indicator if shown
                hideTyping();

                // CLIENT-SIDE TRANSLATION: Server sends English, we translate for display
                var displayContent = msg.content;
                if (isNonEnglishLanguage()) {
                    displayContent = await translateContentForDisplay(msg.content);
                }

                // Add AI message to chat
                var msgElement = addMessageWithId('assistant', displayContent, personaName, msg.id);

                // Store original English content for reference
                if (msgElement && isNonEnglishLanguage()) {
                    msgElement.setAttribute('data-original-content', msg.content);
                }

                // Add to conversation history (store original English for context)
                conversationHistory.push({
                    role: 'assistant',
                    content: msg.content,
                    personaName: personaName
                });
            }

            // Track active streaming messages by streamingId
            var activeStreamingMessages = {};

            // Debounce timer for streaming translation
            var streamingTranslationTimers = {};

            /**
             * Simulate streaming effect for translated text (UX enhancement)
             * Makes AI responses feel more natural by displaying text in chunks
             * @param {HTMLElement} textElement - The element to stream text into
             * @param {string} fullText - The complete text to stream
             * @param {number} chunkDelay - Delay between chunks in ms (default 8ms)
             * @returns {Promise} Resolves when streaming is complete
             */
            function simulateStreamingEffect(textElement, fullText, chunkDelay) {
                chunkDelay = chunkDelay || 20;
                return new Promise(function(resolve) {
                    var currentIndex = 0;

                    function streamNextChunk() {
                        if (currentIndex < fullText.length) {
                            // Add 1-3 characters at a time for natural streaming
                            var chunkSize = Math.floor(Math.random() * 3) + 1;
                            currentIndex = Math.min(currentIndex + chunkSize, fullText.length);
                            textElement.innerHTML = escapeHtml(fullText.substring(0, currentIndex));

                            // Scroll to bottom
                            var messagesArea = document.getElementById('messagesArea');
                            if (messagesArea) {
                                messagesArea.scrollTop = messagesArea.scrollHeight;
                            }

                            // Schedule next chunk
                            setTimeout(streamNextChunk, chunkDelay);
                        } else {
                            // Done streaming
                            resolve();
                        }
                    }

                    streamNextChunk();
                });
            }

            // Expose globally for use in sendMessage
            window.simulateStreamingEffect = simulateStreamingEffect;

            // Handle AI streaming start - create placeholder message
            // Wait for any pending user message translation to complete first
            async function handleAiStreamStart(data) {
                // Only process if we're viewing the same conversation
                if (!chatState || chatState.conversationId !== data.conversationId) return;

                // Wait for pending user message to be displayed first (maintains order)
                await pendingUserMessagePromise;

                var streamingId = data.streamingId;
                var personaName = data.personaName || getBoardPersonaName(chatState.currentMailbox) || 'Bible Persona';

                // Hide typing indicator
                hideTyping();

                // Create a streaming message placeholder
                var msgDiv = addMessage('assistant', '', personaName, true);
                if (msgDiv) {
                    msgDiv.setAttribute('data-streaming-id', streamingId);
                    activeStreamingMessages[streamingId] = {
                        element: msgDiv,
                        textElement: msgDiv.querySelector('.message-text'),
                        personaName: personaName,
                        englishContent: '',           // Accumulate English content
                        translatedContent: '',        // Last translated content
                        lastTranslatedLength: 0,      // Track what we've translated
                        isTranslating: false          // Prevent concurrent translations
                    };
                }
            }

            // Translate streaming content with debouncing
            async function translateStreamingContent(streamingId) {
                var streaming = activeStreamingMessages[streamingId];
                if (!streaming || streaming.isTranslating) return;

                // Only translate if there's new content
                if (streaming.englishContent.length <= streaming.lastTranslatedLength) return;

                streaming.isTranslating = true;

                try {
                    // Translate the full accumulated content
                    var translated = await translateContentForDisplay(streaming.englishContent);

                    // Update if still active and we got a result
                    if (activeStreamingMessages[streamingId] && translated) {
                        streaming.translatedContent = translated;
                        streaming.lastTranslatedLength = streaming.englishContent.length;

                        // Update display with translated content
                        if (streaming.textElement) {
                            streaming.textElement.innerHTML = escapeHtml(translated);
                            // Scroll to bottom
                            var messagesArea = document.getElementById('messagesArea');
                            if (messagesArea) {
                                messagesArea.scrollTop = messagesArea.scrollHeight;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Streaming translation error:', error);
                } finally {
                    if (activeStreamingMessages[streamingId]) {
                        streaming.isTranslating = false;
                    }
                }
            }

            // Handle AI streaming chunk - update the message content
            function handleAiStreamChunk(data) {
                // Only process if we're viewing the same conversation
                if (!chatState || chatState.conversationId !== data.conversationId) return;

                var streamingId = data.streamingId;
                var streaming = activeStreamingMessages[streamingId];

                if (streaming && streaming.textElement) {
                    // For non-English users: don't show anything during chunks
                    // The simulated streaming effect will happen when complete
                    if (isNonEnglishLanguage()) {
                        // Just store the English content, streaming effect happens at end
                        streaming.englishContent = data.fullContent;
                        // Keep display empty - streaming simulation happens in handleAiStreamComplete
                    } else {
                        // English users: display chunks directly (real streaming)
                        streaming.textElement.innerHTML = escapeHtml(data.fullContent);

                        // Scroll to bottom
                        var messagesArea = document.getElementById('messagesArea');
                        if (messagesArea) {
                            messagesArea.scrollTop = messagesArea.scrollHeight;
                        }
                    }
                }
            }

            // Handle AI streaming complete - finalize the message
            async function handleAiStreamComplete(data) {
                // Only process if we're viewing the same conversation
                if (!chatState || chatState.conversationId !== data.conversationId) return;

                var streamingId = data.streamingId;
                var streaming = activeStreamingMessages[streamingId];
                var msg = data.message;

                // Check if this message already exists (avoid duplicates from race conditions)
                if (msg && msg.id) {
                    var existingMsg = document.querySelector('[data-message-id="' + msg.id + '"]');
                    if (existingMsg && !existingMsg.hasAttribute('data-streaming-id')) {
                        // Message already fully displayed (not a streaming placeholder), skip
                        console.log('Skipping duplicate AI message:', msg.id);
                        if (streaming) {
                            delete activeStreamingMessages[streamingId];
                        }
                        return;
                    }
                }

                // Clear any pending translation timer
                if (streamingTranslationTimers[streamingId]) {
                    clearTimeout(streamingTranslationTimers[streamingId]);
                    delete streamingTranslationTimers[streamingId];
                }

                if (streaming) {
                    // Set final message ID
                    if (streaming.element && msg && msg.id) {
                        streaming.element.setAttribute('data-message-id', msg.id);
                        streaming.element.removeAttribute('data-streaming-id');
                    }

                    // Final content display
                    if (msg && msg.content && streaming.textElement) {
                        if (isNonEnglishLanguage()) {
                            // Clear any partial content first
                            streaming.textElement.innerHTML = '';

                            // Translate the complete message
                            var translatedContent = await translateContentForDisplay(msg.content);

                            // Simulate streaming effect for translated content (UX)
                            await simulateStreamingEffect(streaming.textElement, translatedContent, 20);

                            // Apply markdown formatting after streaming completes
                            if (window.marked) {
                                streaming.textElement.innerHTML = window.marked.parse(translatedContent);
                            }
                        } else {
                            // English users already saw streaming, just apply final formatting
                            streaming.textElement.innerHTML = window.marked ? window.marked.parse(msg.content) : escapeHtml(msg.content);
                        }
                    }

                    // Remove streaming class after content is displayed
                    if (streaming.textElement) {
                        streaming.textElement.classList.remove('streaming');
                    }

                    // Add to conversation history (store original English for context)
                    if (msg && msg.content) {
                        conversationHistory.push({
                            role: 'assistant',
                            content: msg.content,
                            personaName: streaming.personaName
                        });
                    }

                    // Cleanup
                    delete activeStreamingMessages[streamingId];
                }
            }

            // Handle AI streaming error - show error message to user
            function handleAiStreamError(data) {
                // Only process if we're viewing the same conversation
                if (!chatState || chatState.conversationId !== data.conversationId) return;

                var streamingId = data.streamingId;
                var streaming = activeStreamingMessages[streamingId];

                // Clear any pending translation timer
                if (streamingTranslationTimers[streamingId]) {
                    clearTimeout(streamingTranslationTimers[streamingId]);
                    delete streamingTranslationTimers[streamingId];
                }

                // Hide typing indicator
                hideTyping();

                if (streaming && streaming.textElement) {
                    // Show error message in the streaming placeholder
                    var errorMessage = data.error || 'I apologize, but I encountered an error. Please try again.';
                    streaming.textElement.innerHTML = '<span class="error-text" style="color: #ff6b6b;">' + escapeHtml(errorMessage) + '</span>';
                    streaming.textElement.classList.remove('streaming');

                    // Remove streaming class from parent
                    if (streaming.element) {
                        streaming.element.classList.add('error-message');
                    }

                    // Cleanup
                    delete activeStreamingMessages[streamingId];
                } else {
                    // No streaming element found, add a new error message
                    var personaName = getBoardPersonaName(chatState.currentMailbox) || 'Bible Persona';
                    var msgDiv = addMessage('assistant', data.error || 'I apologize, but I encountered an error. Please try again.', personaName, false);
                    if (msgDiv) {
                        msgDiv.classList.add('error-message');
                        var textEl = msgDiv.querySelector('.message-text');
                        if (textEl) {
                            textEl.style.color = '#ff6b6b';
                        }
                    }
                }

                console.error('AI stream error:', data.error);
            }

            // Extended addMessage function that includes message ID
            function addMessageWithId(role, content, name, messageId) {
                if (typeof addMessage === 'function') {
                    // addMessage now supports messageId as 5th parameter
                    return addMessage(role, content, name, false, messageId);
                }
            }

            // Handle new board conversation created by another user
            function handleNewBoardConversation(data) {
                if (!data.boardSlug || !data.conversation) return;

                // Check if we're viewing the same board (use global mailboxBoardSlug)
                var boardSlugMap = window.mailboxBoardSlug || {};
                var currentBoardSlug = boardSlugMap[chatState.currentMailbox];
                if (!currentBoardSlug || currentBoardSlug !== data.boardSlug) return;

                // Check if we're in the same community
                if (data.communityId && chatState.currentCommunityId && data.communityId !== chatState.currentCommunityId) return;

                console.log('New board conversation received:', data.conversation.title);

                // Add the new conversation to our local list
                var conv = data.conversation;
                if (!allConversations.some(function(c) { return c.id === conv.id; })) {
                    allConversations.unshift(conv);
                }

                // Re-render the conversation list to show the new conversation
                renderConversationList();

                // DO NOT auto-select the conversation for other users
                // Auto-selecting causes duplicate messages because:
                // 1. loadConversation fetches messages from DB and displays them
                // 2. WebSocket events (board_message, board_ai_stream_*) also arrive and display
                // Let users click on the conversation if they want to view it
            }

            // Handle board conversation deleted by another user
            function handleBoardConversationDeleted(data) {
                if (!data.conversationId) return;

                console.log('Board conversation deleted:', data.conversationId);

                // Remove from local list
                allConversations = allConversations.filter(function(c) { return c.id !== data.conversationId; });

                // If this was the current conversation, clear the view
                if (chatState && chatState.conversationId === data.conversationId) {
                    resetConversationView();
                    chatState.conversationId = null;

                    // Unsubscribe from WebSocket
                    if (typeof window.boardWebSocket !== 'undefined' && window.boardWebSocket.unsubscribe) {
                        window.boardWebSocket.unsubscribe(data.conversationId);
                    }

                    // Select first remaining conversation if any
                    if (allConversations.length > 0) {
                        selectConversation(allConversations[0].id);
                    }
                }

                // Re-render the conversation list
                renderConversationList();
            }

            // Handle translated message updates from server
            function handleMessageTranslation(data) {
                if (!data.messageId || !data.translatedContent) return;

                // Only process if user's language matches the translation
                var currentLang = getSelectedLanguageCode();
                if (data.language !== currentLang) return;

                // Find the message element
                var msgElement = document.querySelector('[data-message-id="' + data.messageId + '"]');
                if (!msgElement) return;

                // Find the text element within the message
                var textElement = msgElement.querySelector('.message-text');
                if (!textElement) return;

                // Store original content as data attribute if not already stored
                if (!msgElement.hasAttribute('data-original-content')) {
                    msgElement.setAttribute('data-original-content', textElement.innerHTML);
                }

                // Update with translated content
                textElement.innerHTML = window.marked ? window.marked.parse(data.translatedContent) : escapeHtml(data.translatedContent);
                msgElement.setAttribute('data-translated-lang', data.language);

                // Clear the awaiting translation state
                msgElement.classList.remove('awaiting-translation');
                messagesAwaitingTranslation.delete(data.messageId);

                console.log('Message translated:', data.messageId, 'to', data.language);
            }

            // Hook into conversation loading to subscribe
            var originalLoadConversation = window.loadConversation;
            if (typeof loadConversation === 'function') {
                window.loadConversation = async function(conversationId) {
                    // Call original function
                    await originalLoadConversation(conversationId);

                    // Subscribe to board conversation for real-time updates
                    if (chatState && chatState.currentMailbox !== 'chat_inbox') {
                        subscribeToBoardConversation(conversationId);
                    } else if (currentBoardConversationId) {
                        // Unsubscribe when switching to personal inbox
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'unsubscribe_board',
                                conversationId: currentBoardConversationId
                            }));
                        }
                        currentBoardConversationId = null;
                    }
                };
            }

            // Connect on page load
            connectWebSocket();

            // Function to identify user on WebSocket
            function identifyUser(userId) {
                if (ws && ws.readyState === WebSocket.OPEN && userId) {
                    ws.send(JSON.stringify({
                        type: 'identify',
                        userId: userId
                    }));
                    console.log('WebSocket identified user (late):', userId);
                }
            }

            // Expose for debugging and external use
            window.boardWebSocket = {
                connect: connectWebSocket,
                subscribe: subscribeToBoardConversation,
                identify: identifyUser
            };
        })();
    </script>
</body>
</html>
