version: '3.8'

# Production Docker Compose for JubileeVerse
# Server: solarwinding (10.0.0.4)
# Database name: JubileeVerse
# Container names: JubileeVerse-postgres, JubileeVerse-qdrant, JubileeVerse-redis

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: JubileeVerse-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: JubileeVerse
      POSTGRES_USER: guardian
      POSTGRES_PASSWORD: askShaddai4e!
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      # Persistent data storage on host
      - C:/Data/JubileeVerse/.datastore/postgres:/var/lib/postgresql/data
      # Initialization scripts
      - ./scripts/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - jubileeverse-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U guardian -d JubileeVerse"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: JubileeVerse-qdrant
    restart: unless-stopped
    volumes:
      # Persistent storage for vector data
      - C:/Data/JubileeVerse/.datastore/qdrant:/qdrant/storage
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    networks:
      - jubileeverse-network
    environment:
      # Optional: Set collection settings
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Cache and Queue
  redis:
    image: redis:7-alpine
    container_name: JubileeVerse-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      # Persistent cache/queue data
      - C:/Data/JubileeVerse/.datastore/redis:/data
    ports:
      - "6379:6379"
    networks:
      - jubileeverse-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  jubileeverse-network:
    name: jubileeverse-network
    driver: bridge

# Volume definitions (for documentation)
# Actual paths are defined in service volumes above
volumes:
  postgres_data:
    driver: local
  qdrant_storage:
    driver: local
  redis_data:
    driver: local
